<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>LS-CAT PGPMAC: lskvs.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">LS-CAT PGPMAC
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('lskvs_8c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">lskvs.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Support for the remote access client key value pairs.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;<a class="el" href="pgpmac_8h_source.html">pgpmac.h</a>&quot;</code><br/>
</div>
<p><a href="lskvs_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structlskvs__kvs__struct.html">lskvs_kvs_struct</a></td></tr>
<tr class="memdesc:"><td class="mdescLeft">&#160;</td><td class="mdescRight">Storage for the key value pairs.  <a href="structlskvs__kvs__struct.html#details">More...</a><br/></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:a54bd386f945edb8a0311a20199e8f793"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="structlskvs__kvs__struct.html">lskvs_kvs_struct</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="lskvs_8c.html#a54bd386f945edb8a0311a20199e8f793">lskvs_kvs_t</a></td></tr>
<tr class="memdesc:a54bd386f945edb8a0311a20199e8f793"><td class="mdescLeft">&#160;</td><td class="mdescRight">Storage for the key value pairs.  <a href="#a54bd386f945edb8a0311a20199e8f793"></a><br/></td></tr>
<tr class="separator:a54bd386f945edb8a0311a20199e8f793"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ab04e99f92c761522972c4d80d85f4830"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="lskvs_8c.html#ab04e99f92c761522972c4d80d85f4830">lskvs_set</a> (char *k, char *v)</td></tr>
<tr class="memdesc:ab04e99f92c761522972c4d80d85f4830"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set the value of a kv pair Create the pair if the key does not exsist.  <a href="#ab04e99f92c761522972c4d80d85f4830"></a><br/></td></tr>
<tr class="separator:ab04e99f92c761522972c4d80d85f4830"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3bc37cbeae347da068124d23ba3c1905"><td class="memItemLeft" align="right" valign="top"><a class="el" href="lskvs_8c.html#a54bd386f945edb8a0311a20199e8f793">lskvs_kvs_t</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="lskvs_8c.html#a3bc37cbeae347da068124d23ba3c1905">lskvs_get</a> (char *k)</td></tr>
<tr class="memdesc:a3bc37cbeae347da068124d23ba3c1905"><td class="mdescLeft">&#160;</td><td class="mdescRight">Find the kv pair object Return with a pointer to the structure or NULL if not found.  <a href="#a3bc37cbeae347da068124d23ba3c1905"></a><br/></td></tr>
<tr class="separator:a3bc37cbeae347da068124d23ba3c1905"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae4c780cd3a394259ca74d447bdae3537"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="lskvs_8c.html#ae4c780cd3a394259ca74d447bdae3537">lskvs_init</a> ()</td></tr>
<tr class="memdesc:ae4c780cd3a394259ca74d447bdae3537"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize lskvs objects.  <a href="#ae4c780cd3a394259ca74d447bdae3537"></a><br/></td></tr>
<tr class="separator:ae4c780cd3a394259ca74d447bdae3537"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab67e0bf3edaa2cea837fe68814e025f5"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="lskvs_8c.html#ab67e0bf3edaa2cea837fe68814e025f5">lskvs_run</a> ()</td></tr>
<tr class="memdesc:ab67e0bf3edaa2cea837fe68814e025f5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Run things.  <a href="#ab67e0bf3edaa2cea837fe68814e025f5"></a><br/></td></tr>
<tr class="separator:ab67e0bf3edaa2cea837fe68814e025f5"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a14ca7cca8246dcfc266ad30d56701c0a"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="lskvs_8c.html#a54bd386f945edb8a0311a20199e8f793">lskvs_kvs_t</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="lskvs_8c.html#a14ca7cca8246dcfc266ad30d56701c0a">lskvs_kvs</a> = NULL</td></tr>
<tr class="memdesc:a14ca7cca8246dcfc266ad30d56701c0a"><td class="mdescLeft">&#160;</td><td class="mdescRight">our list (or at least the start of it  <a href="#a14ca7cca8246dcfc266ad30d56701c0a"></a><br/></td></tr>
<tr class="separator:a14ca7cca8246dcfc266ad30d56701c0a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad329bf890bd9eef896815dd53a323c2f"><td class="memItemLeft" align="right" valign="top">static pthread_rwlock_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="lskvs_8c.html#ad329bf890bd9eef896815dd53a323c2f">lskvs_rwlock</a></td></tr>
<tr class="memdesc:ad329bf890bd9eef896815dd53a323c2f"><td class="mdescLeft">&#160;</td><td class="mdescRight">needed to protect the list  <a href="#ad329bf890bd9eef896815dd53a323c2f"></a><br/></td></tr>
<tr class="separator:ad329bf890bd9eef896815dd53a323c2f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Support for the remote access client key value pairs. </p>
<dl class="section date"><dt>Date</dt><dd>2012 </dd></dl>
<dl class="section author"><dt>Author</dt><dd>Keith Brister </dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>All Rights Reserved </dd></dl>

<p>Definition in file <a class="el" href="lskvs_8c_source.html">lskvs.c</a>.</p>
</div><h2 class="groupheader">Typedef Documentation</h2>
<a class="anchor" id="a54bd386f945edb8a0311a20199e8f793"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="structlskvs__kvs__struct.html">lskvs_kvs_struct</a>  <a class="el" href="lskvs_8c.html#a54bd386f945edb8a0311a20199e8f793">lskvs_kvs_t</a></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Storage for the key value pairs. </p>
<p>the k's and v's are strings and to keep the memory management less crazy we'll calloc some space for these strings and only free and re-calloc if we need more space later. Only the values are ever going to be resized. </p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a3bc37cbeae347da068124d23ba3c1905"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="lskvs_8c.html#a54bd386f945edb8a0311a20199e8f793">lskvs_kvs_t</a>* lskvs_get </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>k</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Find the kv pair object Return with a pointer to the structure or NULL if not found. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">k</td><td>key name to search for </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lskvs_8c_source.html#l00137">137</a> of file <a class="el" href="lskvs_8c_source.html">lskvs.c</a>.</p>
<div class="fragment"><div class="line">                         {</div>
<div class="line">  <a class="code" href="structlskvs__kvs__struct.html" title="Storage for the key value pairs.">lskvs_kvs_t</a></div>
<div class="line">    *rtn;</div>
<div class="line"></div>
<div class="line">  pthread_rwlock_rdlock( &amp;<a class="code" href="lskvs_8c.html#ad329bf890bd9eef896815dd53a323c2f" title="needed to protect the list">lskvs_rwlock</a>);</div>
<div class="line">  rtn = <a class="code" href="lskvs_8c.html#a14ca7cca8246dcfc266ad30d56701c0a" title="our list (or at least the start of it">lskvs_kvs</a>;</div>
<div class="line">  pthread_rwlock_unlock( &amp;<a class="code" href="lskvs_8c.html#ad329bf890bd9eef896815dd53a323c2f" title="needed to protect the list">lskvs_rwlock</a>);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">while</span>(rtn != NULL) {</div>
<div class="line">    <span class="keywordflow">if</span>( strcmp( rtn-&gt;<a class="code" href="structlskvs__kvs__struct.html#afaaab7729ce9dbabd8f3e2c502a8e4c5" title="the key">k</a>, k) == 0)</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    rtn = rtn-&gt;<a class="code" href="structlskvs__kvs__struct.html#a6302f184418962708bd1efe3320d4347" title="the next kvpair">next</a>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> rtn;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ae4c780cd3a394259ca74d447bdae3537"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void lskvs_init </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize lskvs objects. </p>

<p>Definition at line <a class="el" href="lskvs_8c_source.html#l00158">158</a> of file <a class="el" href="lskvs_8c_source.html">lskvs.c</a>.</p>
<div class="fragment"><div class="line">                  {</div>
<div class="line">  pthread_rwlock_init( &amp;<a class="code" href="lskvs_8c.html#ad329bf890bd9eef896815dd53a323c2f" title="needed to protect the list">lskvs_rwlock</a>, NULL);</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ab67e0bf3edaa2cea837fe68814e025f5"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void lskvs_run </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Run things. </p>
<p>Really, there is nothing to run. There is no need for a worker thread here but this has been added so we can add lskvs just like any other module to the pgpmac project. Maybe one day we'll need to add a thread and this little routine can be celebrated as being far sighted, ahead of its time. </p>

<p>Definition at line <a class="el" href="lskvs_8c_source.html#l00168">168</a> of file <a class="el" href="lskvs_8c_source.html">lskvs.c</a>.</p>
<div class="fragment"><div class="line">                 {</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<a class="anchor" id="ab04e99f92c761522972c4d80d85f4830"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void lskvs_set </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>k</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>v</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Set the value of a kv pair Create the pair if the key does not exsist. </p>
<p>If more than one thread tries to create the same key at the same time it is possible for the list to contain multiple versions. Not good. But also not possible if only one thread has the job of create the pairs in the first place. Alternatively just grab the write lock at the beginning and hold it until the end. The advantage of having only one thread calling lskvs_set is that it wont slow down the other threads that just want to read things. In any case, we'll likely never see so much action for any of this to make a differene.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">k</td><td>The name of the key </td></tr>
    <tr><td class="paramname">v</td><td>The value to assign to the key </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="lskvs_8c_source.html#l00044">44</a> of file <a class="el" href="lskvs_8c_source.html">lskvs.c</a>.</p>
<div class="fragment"><div class="line">                                  {</div>
<div class="line">  <a class="code" href="structlskvs__kvs__struct.html" title="Storage for the key value pairs.">lskvs_kvs_t</a></div>
<div class="line">    *root,</div>
<div class="line">    *p;</div>
<div class="line"></div>
<div class="line">  <a class="code" href="lslogging_8c.html#a0e756b36671055ef02a8f04d2ba8a93b" title="The routine everyone will be talking about.">lslogging_log_message</a>( <span class="stringliteral">&quot;lskvs_set:  k: &#39;%s&#39;, v: &#39;%s&#39;&quot;</span>, k, v);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Don&#39;t bother with empty keys</span></div>
<div class="line">  <span class="comment">//</span></div>
<div class="line">  <span class="keywordflow">if</span>( k == NULL || *k == 0)</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">  pthread_rwlock_rdlock( &amp;<a class="code" href="lskvs_8c.html#ad329bf890bd9eef896815dd53a323c2f" title="needed to protect the list">lskvs_rwlock</a>);</div>
<div class="line">  root = <a class="code" href="lskvs_8c.html#a14ca7cca8246dcfc266ad30d56701c0a" title="our list (or at least the start of it">lskvs_kvs</a>;</div>
<div class="line">  pthread_rwlock_unlock( &amp;<a class="code" href="lskvs_8c.html#ad329bf890bd9eef896815dd53a323c2f" title="needed to protect the list">lskvs_rwlock</a>);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span>( p=root; p != NULL; p = p-&gt;<a class="code" href="structlskvs__kvs__struct.html#a6302f184418962708bd1efe3320d4347" title="the next kvpair">next</a>) {</div>
<div class="line">    <span class="keywordflow">if</span>( strcmp( p-&gt;<a class="code" href="structlskvs__kvs__struct.html#afaaab7729ce9dbabd8f3e2c502a8e4c5" title="the key">k</a>, k) == 0) {</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span>( p == NULL) {</div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Add a new list item</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    p = calloc( 1, <span class="keyword">sizeof</span>( *p));</div>
<div class="line">    <span class="keywordflow">if</span>( p == NULL) {</div>
<div class="line">      <a class="code" href="lslogging_8c.html#a0e756b36671055ef02a8f04d2ba8a93b" title="The routine everyone will be talking about.">lslogging_log_message</a>( <span class="stringliteral">&quot;lskvs_set: out of memory for kv struct (%d bytes&quot;</span>, <span class="keyword">sizeof</span>( *p));</div>
<div class="line">      exit( -1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    p-&gt;<a class="code" href="structlskvs__kvs__struct.html#afaaab7729ce9dbabd8f3e2c502a8e4c5" title="the key">k</a> = calloc( strlen(k)+1, <span class="keyword">sizeof</span>( *k));</div>
<div class="line">    <span class="keywordflow">if</span>( p-&gt;<a class="code" href="structlskvs__kvs__struct.html#afaaab7729ce9dbabd8f3e2c502a8e4c5" title="the key">k</a> == NULL) {</div>
<div class="line">      <a class="code" href="lslogging_8c.html#a0e756b36671055ef02a8f04d2ba8a93b" title="The routine everyone will be talking about.">lslogging_log_message</a>( <span class="stringliteral">&quot;lskvs_set: out of memory for k (%d bytes)&quot;</span>, strlen( k)+1);</div>
<div class="line">      exit( -1);</div>
<div class="line">    }</div>
<div class="line">    strcpy( p-&gt;<a class="code" href="structlskvs__kvs__struct.html#afaaab7729ce9dbabd8f3e2c502a8e4c5" title="the key">k</a>, k);</div>
<div class="line">    p-&gt;<a class="code" href="structlskvs__kvs__struct.html#afaaab7729ce9dbabd8f3e2c502a8e4c5" title="the key">k</a>[strlen(k)] = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// leave a little room to grow</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="keywordflow">if</span>( v == NULL || *v == 0)</div>
<div class="line">      p-&gt;<a class="code" href="structlskvs__kvs__struct.html#aa1c980ae62cdf78d8b358b3a51deda6a" title="the length of the calloced v">vl</a> = 32;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      p-&gt;<a class="code" href="structlskvs__kvs__struct.html#aa1c980ae62cdf78d8b358b3a51deda6a" title="the length of the calloced v">vl</a> = strlen(v) + 32;</div>
<div class="line"></div>
<div class="line">    p-&gt;<a class="code" href="structlskvs__kvs__struct.html#a27a0ae4415b6d65c8a9f9fac11c130f9" title="the value">v</a> = calloc( p-&gt;<a class="code" href="structlskvs__kvs__struct.html#aa1c980ae62cdf78d8b358b3a51deda6a" title="the length of the calloced v">vl</a>, <span class="keyword">sizeof</span>( *v));</div>
<div class="line">    <span class="keywordflow">if</span>( p-&gt;<a class="code" href="structlskvs__kvs__struct.html#a27a0ae4415b6d65c8a9f9fac11c130f9" title="the value">v</a> == NULL) {</div>
<div class="line">      <a class="code" href="lslogging_8c.html#a0e756b36671055ef02a8f04d2ba8a93b" title="The routine everyone will be talking about.">lslogging_log_message</a>( <span class="stringliteral">&quot;lskvs_set: out of memory for v (%d bytes)&quot;</span>, p-&gt;<a class="code" href="structlskvs__kvs__struct.html#aa1c980ae62cdf78d8b358b3a51deda6a" title="the length of the calloced v">vl</a>);</div>
<div class="line">      exit( -1);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span>( v == NULL || *v == 0)</div>
<div class="line">      *(p-&gt;<a class="code" href="structlskvs__kvs__struct.html#a27a0ae4415b6d65c8a9f9fac11c130f9" title="the value">v</a>) = 0;</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      strcpy( p-&gt;<a class="code" href="structlskvs__kvs__struct.html#a27a0ae4415b6d65c8a9f9fac11c130f9" title="the value">v</a>, v);</div>
<div class="line"></div>
<div class="line">    p-&gt;<a class="code" href="structlskvs__kvs__struct.html#a27a0ae4415b6d65c8a9f9fac11c130f9" title="the value">v</a>[p-&gt;<a class="code" href="structlskvs__kvs__struct.html#aa1c980ae62cdf78d8b358b3a51deda6a" title="the length of the calloced v">vl</a>-1] = 0;</div>
<div class="line">    </div>
<div class="line">    pthread_rwlock_init( &amp;p-&gt;<a class="code" href="structlskvs__kvs__struct.html#a45129c7f3d0bb2efc83b8a0d7ea2d814" title="our lock">l</a>, NULL);</div>
<div class="line"></div>
<div class="line">    pthread_rwlock_wrlock( &amp;<a class="code" href="lskvs_8c.html#ad329bf890bd9eef896815dd53a323c2f" title="needed to protect the list">lskvs_rwlock</a>);</div>
<div class="line">    p-&gt;<a class="code" href="structlskvs__kvs__struct.html#a6302f184418962708bd1efe3320d4347" title="the next kvpair">next</a>   = <a class="code" href="lskvs_8c.html#a14ca7cca8246dcfc266ad30d56701c0a" title="our list (or at least the start of it">lskvs_kvs</a>;</div>
<div class="line">    <a class="code" href="lskvs_8c.html#a14ca7cca8246dcfc266ad30d56701c0a" title="our list (or at least the start of it">lskvs_kvs</a> = p;</div>
<div class="line">    pthread_rwlock_unlock( &amp;<a class="code" href="lskvs_8c.html#ad329bf890bd9eef896815dd53a323c2f" title="needed to protect the list">lskvs_rwlock</a>);</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Just update the value</span></div>
<div class="line">    <span class="comment">// Assume the database only sent us an update because</span></div>
<div class="line">    <span class="comment">// the old and new values are different</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    pthread_rwlock_wrlock( &amp;(p-&gt;<a class="code" href="structlskvs__kvs__struct.html#a45129c7f3d0bb2efc83b8a0d7ea2d814" title="our lock">l</a>));</div>
<div class="line">    <span class="keywordflow">if</span>( strlen( v) &gt; p-&gt;<a class="code" href="structlskvs__kvs__struct.html#aa1c980ae62cdf78d8b358b3a51deda6a" title="the length of the calloced v">vl</a>-1) {</div>
<div class="line">      free( p-&gt;<a class="code" href="structlskvs__kvs__struct.html#a27a0ae4415b6d65c8a9f9fac11c130f9" title="the value">v</a>);</div>
<div class="line">      </div>
<div class="line">      p-&gt;<a class="code" href="structlskvs__kvs__struct.html#aa1c980ae62cdf78d8b358b3a51deda6a" title="the length of the calloced v">vl</a> = strlen(v) + 32;</div>
<div class="line">      p-&gt;<a class="code" href="structlskvs__kvs__struct.html#a27a0ae4415b6d65c8a9f9fac11c130f9" title="the value">v</a> = calloc( p-&gt;<a class="code" href="structlskvs__kvs__struct.html#aa1c980ae62cdf78d8b358b3a51deda6a" title="the length of the calloced v">vl</a>, 1);</div>
<div class="line">      <span class="keywordflow">if</span>( p-&gt;<a class="code" href="structlskvs__kvs__struct.html#a27a0ae4415b6d65c8a9f9fac11c130f9" title="the value">v</a> == NULL) {</div>
<div class="line">        <a class="code" href="lslogging_8c.html#a0e756b36671055ef02a8f04d2ba8a93b" title="The routine everyone will be talking about.">lslogging_log_message</a>( <span class="stringliteral">&quot;lskvs_set: out of memory for re-calloc of v (%d bytes)&quot;</span>, p-&gt;<a class="code" href="structlskvs__kvs__struct.html#aa1c980ae62cdf78d8b358b3a51deda6a" title="the length of the calloced v">vl</a>);</div>
<div class="line">        exit( -1);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    strcpy( p-&gt;<a class="code" href="structlskvs__kvs__struct.html#a27a0ae4415b6d65c8a9f9fac11c130f9" title="the value">v</a>, v);</div>
<div class="line">    p-&gt;<a class="code" href="structlskvs__kvs__struct.html#a27a0ae4415b6d65c8a9f9fac11c130f9" title="the value">v</a>[p-&gt;<a class="code" href="structlskvs__kvs__struct.html#aa1c980ae62cdf78d8b358b3a51deda6a" title="the length of the calloced v">vl</a>-1] = 0;</div>
<div class="line">    pthread_rwlock_unlock( &amp;(p-&gt;<a class="code" href="structlskvs__kvs__struct.html#a45129c7f3d0bb2efc83b8a0d7ea2d814" title="our lock">l</a>));</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a class="anchor" id="a14ca7cca8246dcfc266ad30d56701c0a"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="lskvs_8c.html#a54bd386f945edb8a0311a20199e8f793">lskvs_kvs_t</a>* lskvs_kvs = NULL</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>our list (or at least the start of it </p>

<p>Definition at line <a class="el" href="lskvs_8c_source.html#l00025">25</a> of file <a class="el" href="lskvs_8c_source.html">lskvs.c</a>.</p>

</div>
</div>
<a class="anchor" id="ad329bf890bd9eef896815dd53a323c2f"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">pthread_rwlock_t lskvs_rwlock</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>needed to protect the list </p>

<p>Definition at line <a class="el" href="lskvs_8c_source.html#l00026">26</a> of file <a class="el" href="lskvs_8c_source.html">lskvs.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="lskvs_8c.html">lskvs.c</a></li>
    <li class="footer">Generated on Wed Nov 14 2012 22:39:09 for LS-CAT PGPMAC by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.2 </li>
  </ul>
</div>
</body>
</html>
