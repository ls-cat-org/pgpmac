<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>LS-CAT PGPMAC: The LS-CAT pgpmac Project</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">LS-CAT PGPMAC
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">The LS-CAT pgpmac Project </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="el" href="pgpmac_8c.html" title="Main for the pgpmac project.">pgpmac.c</a></p>
<p>Some pmac defines, typedefs, functions suggested by Delta Tau Accessory 54E User Manual, October 23, 2003 (C) 2003 by Delta Tau Data Systems, Inc. All rights reserved.</p>
<p>Original work Copyright (C) 2012 by Keith Brister, Northwestern University, All rights reserved.</p>
<p>This project implements the MD2 communications required for operation at LS-CAT and is intended to replace Windows XP based .NET code provided by MAATEL.</p>
<p>The need to do this is driven by a desire to make the system as effecient and fast as possible by combining various operations. A proof-of-principle version of this code saw frame rates of 23/minute as opposed to the nominal 18/minute we normally quote for 1 second exposures.</p>
<p>Additionally, as we rapidly approach EOL for Windows XP an alternative is urgently needed.</p>
<h3>Structure</h3>
<p>The project is roughly broken down as follows: </p>
<pre>
    <a class="el" href="lsevents_8c.html" title="event subsystem for inter-pgpmac communication">lsevents.c</a>          Simple event queue</pre><pre>    <a class="el" href="lskvs_8c.html" title="Support for the remote access client key value pairs.">lskvs.c</a>             Receive key value pair updates from the px.kvs table in our database</pre><pre>    <a class="el" href="lslogging_8c.html" title="Logs messages to a file.">lslogging.c</a>         A logging utility to simplify debugging</pre><pre>    <a class="el" href="lspg_8c.html" title="Postgresql support for the LS-CAT pgpmac project.">lspg.c</a>              Handles communications with the controlling posgresql database</pre><pre>    <a class="el" href="lsupdate_8c.html" title="Brings this MD2 code and the database kvs table into agreement.">lsupdate.c</a>          Periodically update the px.kvs table with new positions.</pre><pre>    <a class="el" href="md2cmds_8c.html" title="Implements commands to run the md2 diffractometer attached to a PMAC controled by postgresql...">md2cmds.c</a>           Provides the equivilant (mostly) of the LS-CAT BLUMax code.</pre><pre>    <a class="el" href="pgpmac_8c.html" title="Main for the pgpmac project.">pgpmac.c</a>            Main: parses command line and starts up the various threads</pre><pre>    <a class="el" href="pgpmac_8h.html" title="Headers for the entire pgpmac project.">pgpmac.h</a>            All includes and defines.  The only file included by the .c files in this project.</pre><pre>    pmac_md2_ls-cat.pmc Code for the PMAC: compile and install with pmac exectutive program.</pre><pre>    pmac_md2.sql        Tables and procedures for the posgresql side of the project.
   </pre><p><b>Notes:</b> </p>
<ul>
<li>
<p class="startli">The postgresql and the pmac communications interfaces are asynchronous and rely heavyly on the unix "poll" routine. </p>
<p class="endli"></p>
</li>
<li>
<p class="startli">The project is multithreaded and based on "pthreads".</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Most threads maintain a queue of commands to simpify communications with each other.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Note that a MAATEL supported interface for a more recent version of Windows may be available, however, a bit of effort will be required to implement it at LS-CAT as the BLUMax code will likely require some revisions. This is still an option should the present project become intractable.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">An important constraint has been to run the MD2 either from the windows .NET environment or from the pgpmac environment. A consequence is that the pmac "pmc" file has been augmented to include new capabilities without destroying the code that the .NET interface requires.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Epics support could come by adapting the "e.c" code to work here directly or could come by making use of the existing kv pair mechanism already in place or, as is most likely, a combination of the two.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Ncurses support could include input lines for SQL queries and direct commands for supporting homing etc. Perhaps the F keys could change modes or use of special mode changing text commands. Output is not asynchronous. Although this is unlikely to cause a problem I'd hate to have the program hang because terminal output is hung up.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">PG queries come back as text instead of binary. We could reduce the numeric errors by using binary and things would run a tad faster, though it is unlikely anyone would notice or care about the speed. </p>
<p class="endli"></p>
</li>
</ul>
<h3>MD2 Motors and Coordinate Systems</h3>
<pre>
  CS       Motor</pre><pre>  1             1       X = Omega</pre><pre>  2             17      X = Center X
                18      Y = Center Y</pre><pre>  3             2       X = Alignment X
                3       Y = Alignment Y
                4       Z = Alignment Z</pre><pre>  --            5       Analyzer</pre><pre>  4             6       X = Zoom</pre><pre>  5             7       Y = Aperture Y
                8       Z = Aperture Z
                9       U = Capillary Y
               10       V = Capillary Z
               11       W = Scintillator Z</pre><pre>  6                     (None)</pre><pre>  7            19       X = Kappa
               20       Y = Phi</pre><pre></pre><p>MD2 Motion Programs</p>
<pre></pre><pre>before calling, set
   M4XX = 1:  flag to indicate we are running program XX
   P variables as arguments</pre><pre>Program         Description
  1             home omega
  2             home alignment table X
  3             home alignment table Y
  4             home alignment table Z
  6             home camera zoom
  7             home aperture Y
  8             home aperture Z
  9             home capillary Y
 10             home capillary Z
 11             home scintillator Z
 17             home center X
 18             home center Y
 19             home kappa
 20             home phi (Home position is not defined for phi ...)
 25             kappa stress test</pre><pre> 26             Combined Incremental move of X and Y in selected coordinate system
                        (Does not reset M426)
                        P170  = X increment
                        P171  = Y increment</pre><pre> 31             scan omega
                        P170  = Start
                        P171  = End
                        P173  = Velocity (float)
                        P174  = Sample Rate (I5049)
                        P175  = Acceleration time
                        P176  = Gathering source
                        P177  = Number of passes
                        P178  = Shutter rising distance (units of omega motion)
                        P179  = Shutter falling distance (units of omega motion)
                        P180  = Exposure Time</pre><pre> 34             Organ Scan
                        P169  = Motor Number
                        P170  = Start Position
                        P171  = End Position
                        P172  = Step Size
                        P173  = Motor Speed</pre><pre> 35             Organ Homing</pre><pre> 37             Organ Move   (microdiff_hard.ini says we don't use this anymore)
                        P169  = Capillary Z
                        P170  = Scintillator Z
                        P171  = Aperture Z</pre><pre> 50             Combined Incremental move of X and Y
                        P170  = X increment
                        P171  = Y increment</pre><pre> 52             X oscillation (while M320 == 1)
                        (Does not reset M452)</pre><pre> 53             Center X and Y Synchronized homing</pre><pre> 54             Combined X, Y, Z absolute move
                        P170  = X
                        P171  = Y
                        P172  = Z</pre><pre>131             LS-CAT Modified Omega Scan
                        P170    = Shutter open position, in counts
                        P171    = Delta omega, in counts
                        P173    = Omega velocity (counts/msec)
                        P175    = Acceleration Time (msec)
                        P177    = Number of passes
                        P178    = Shutter Rising Distance
                        P179    = Shutter Falling Distance
                        P180    = Exposure TIme (msec)</pre><pre>140             LS-CAT Move X Absolute
                        Q10    = X Value (cts)</pre><pre>141             LS-CAT Move Y Absolute
                        Q11    = Y Value (cts)</pre><pre>142             LS-CAT Move Z Absolute
                        Q12    = Z Value (cts)</pre><pre>150             LS-CAT Move X, Y Absolute
                        Q20    = X Value
                        Q21    = Y Value</pre><pre>160             LS-CAT Move X, Y, Z  Absolute
                        Q30    = X Value
                        Q31    = Y Value
                        Q32    = Z Value
</pre> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Nov 16 2012 20:50:37 for LS-CAT PGPMAC by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.2 </li>
  </ul>
</div>
</body>
</html>
