\hypertarget{lskvs_8c}{\section{lskvs.\-c File Reference}
\label{lskvs_8c}\index{lskvs.\-c@{lskvs.\-c}}
}


Support for the remote access client key value pairs.  


{\ttfamily \#include \char`\"{}pgpmac.\-h\char`\"{}}\\*
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
double \hyperlink{lskvs_8c_ad676b373a9a8a2938578c0decf9bd04b}{lskvs\-\_\-find\-\_\-preset\-\_\-position} (\hyperlink{pgpmac_8h_aa5067fcbaabc5bbfdc52492495518c96}{lspmac\-\_\-motor\-\_\-t} $\ast$mp, char $\ast$name, int $\ast$err)
\begin{DoxyCompactList}\small\item\em find a postion for a given preset name \end{DoxyCompactList}\item 
void \hyperlink{lskvs_8c_ac1a924903bc31ef067c08e5152e1b2eb}{lskvs\-\_\-regcomp} (regex\-\_\-t $\ast$preg, int cflags, char $\ast$fmt,...)
\begin{DoxyCompactList}\small\item\em Utility wrapper for regcomp providing printf style formating. \end{DoxyCompactList}\item 
void \hyperlink{lskvs_8c_ab04e99f92c761522972c4d80d85f4830}{lskvs\-\_\-set} (char $\ast$k, char $\ast$v)
\begin{DoxyCompactList}\small\item\em Set the value of a kv pair Create the pair if the key does not exsist. \end{DoxyCompactList}\item 
\hyperlink{pgpmac_8h_a54bd386f945edb8a0311a20199e8f793}{lskvs\-\_\-kvs\-\_\-t} $\ast$ \hyperlink{lskvs_8c_a3bc37cbeae347da068124d23ba3c1905}{lskvs\-\_\-get} (char $\ast$k)
\begin{DoxyCompactList}\small\item\em Find the kv pair object Return with a pointer to the structure or N\-U\-L\-L if not found. \end{DoxyCompactList}\item 
void \hyperlink{lskvs_8c_ae4c780cd3a394259ca74d447bdae3537}{lskvs\-\_\-init} ()
\begin{DoxyCompactList}\small\item\em Initialize lskvs objects. \end{DoxyCompactList}\item 
void \hyperlink{lskvs_8c_ab67e0bf3edaa2cea837fe68814e025f5}{lskvs\-\_\-run} ()
\begin{DoxyCompactList}\small\item\em Run things. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\hyperlink{pgpmac_8h_a54bd386f945edb8a0311a20199e8f793}{lskvs\-\_\-kvs\-\_\-t} $\ast$ \hyperlink{lskvs_8c_a14ca7cca8246dcfc266ad30d56701c0a}{lskvs\-\_\-kvs} = N\-U\-L\-L
\begin{DoxyCompactList}\small\item\em our list (or at least the start of it \end{DoxyCompactList}\item 
pthread\-\_\-rwlock\-\_\-t \hyperlink{lskvs_8c_ad329bf890bd9eef896815dd53a323c2f}{lskvs\-\_\-rwlock}
\begin{DoxyCompactList}\small\item\em needed to protect the list \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Support for the remote access client key value pairs. \begin{DoxyDate}{Date}
2012 
\end{DoxyDate}
\begin{DoxyAuthor}{Author}
Keith Brister 
\end{DoxyAuthor}
\begin{DoxyCopyright}{Copyright}
All Rights Reserved 
\end{DoxyCopyright}


Definition in file \hyperlink{lskvs_8c_source}{lskvs.\-c}.



\subsection{Function Documentation}
\hypertarget{lskvs_8c_ad676b373a9a8a2938578c0decf9bd04b}{\index{lskvs.\-c@{lskvs.\-c}!lskvs\-\_\-find\-\_\-preset\-\_\-position@{lskvs\-\_\-find\-\_\-preset\-\_\-position}}
\index{lskvs\-\_\-find\-\_\-preset\-\_\-position@{lskvs\-\_\-find\-\_\-preset\-\_\-position}!lskvs.c@{lskvs.\-c}}
\subsubsection[{lskvs\-\_\-find\-\_\-preset\-\_\-position}]{\setlength{\rightskip}{0pt plus 5cm}double lskvs\-\_\-find\-\_\-preset\-\_\-position (
\begin{DoxyParamCaption}
\item[{{\bf lspmac\-\_\-motor\-\_\-t} $\ast$}]{mp, }
\item[{char $\ast$}]{name, }
\item[{int $\ast$}]{err}
\end{DoxyParamCaption}
)}}\label{lskvs_8c_ad676b373a9a8a2938578c0decf9bd04b}


find a postion for a given preset name 


\begin{DoxyParams}{Parameters}
{\em mp} & Motor pointer \\
\hline
{\em name} & The preset to search for \\
\hline
{\em err} & set to non-\/zero on error, ignored if null \\
\hline
\end{DoxyParams}


Definition at line 21 of file lskvs.\-c.


\begin{DoxyCode}
                                                                             \{
  regmatch\_t pmatch[4], qmatch[4];
  \textcolor{keywordtype}{double} rtn;
  \hyperlink{structlskvs__kvs__list__struct}{lskvs\_kvs\_list\_t}
    *position\_kv = NULL,
    *name\_kv     = NULL;
  \textcolor{keywordtype}{int} e;

  *err = -4;
  \textcolor{keywordflow}{if}( name == NULL || *name == 0)
    \textcolor{keywordflow}{return} 0.0;

  *err = 0;
  \textcolor{keywordflow}{for}( name\_kv = mp->\hyperlink{structlspmac__motor__struct_a7c913e6abf9b203584c477ac49fdd517}{presets}; name\_kv != NULL; name\_kv = name\_kv->\hyperlink{structlskvs__kvs__list__struct_aa3ed4d35bdda99bb1c08793633579edc}{next}
      ) \{
    \textcolor{keywordflow}{if}( strcmp( name, name\_kv->kvs->v) == 0) \{
      \textcolor{comment}{//}
      \textcolor{comment}{// We found the correct preset, now get the index}
      \textcolor{comment}{//}
      e = regexec( &(mp->\hyperlink{structlspmac__motor__struct_a1df97b771d18bc9a6eed78f3a66fd15c}{preset\_regex}), name\_kv->kvs->k, 4, pmatch,
       0);
      \textcolor{keywordflow}{if}( e != 0) \{
        \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"
      lskvs\_find\_preset\_position: could not parse name key '%s'"}, name\_kv->kvs->k);
        \textcolor{keywordflow}{if}( err != NULL)
          *err = e;
        \textcolor{keywordflow}{return} 0.0;
      \}

      \textcolor{keywordflow}{for}( position\_kv = mp->\hyperlink{structlspmac__motor__struct_a7c913e6abf9b203584c477ac49fdd517}{presets}; position\_kv != NULL; position\_kv =
       position\_kv->\hyperlink{structlskvs__kvs__list__struct_aa3ed4d35bdda99bb1c08793633579edc}{next}) \{
        \textcolor{keywordflow}{if}( position\_kv == name\_kv)
          \textcolor{keywordflow}{continue};

        e = regexec( &(mp->\hyperlink{structlspmac__motor__struct_a1df97b771d18bc9a6eed78f3a66fd15c}{preset\_regex}), position\_kv->\hyperlink{structlskvs__kvs__list__struct_a7f5620fa24157783bb02e6dd82bdcb22}{kvs}->\hyperlink{structlskvs__kvs__struct_afaaab7729ce9dbabd8f3e2c502a8e4c5}{k}, 
      4, qmatch, 0);
        \textcolor{keywordflow}{if}( e != 0) \{
          \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"
      lskvs\_find\_preset\_position: could not parse position key '%s'"}, position\_kv->\hyperlink{structlskvs__kvs__list__struct_a7f5620fa24157783bb02e6dd82bdcb22}{kvs}->\hyperlink{structlskvs__kvs__struct_afaaab7729ce9dbabd8f3e2c502a8e4c5}{k});
          \textcolor{keywordflow}{if}( err != NULL)
            *err = e;
          \textcolor{keywordflow}{return} 0.0;
        \}

        \textcolor{keywordflow}{if}( strncmp( name\_kv->kvs->k, position\_kv->\hyperlink{structlskvs__kvs__list__struct_a7f5620fa24157783bb02e6dd82bdcb22}{kvs}->\hyperlink{structlskvs__kvs__struct_afaaab7729ce9dbabd8f3e2c502a8e4c5}{k}, qmatch[2].rm\_eo 
      + 1) == 0) \{
          \textcolor{keywordflow}{break};
        \}
      \}
      \textcolor{keywordflow}{if}( position\_kv != NULL)
        \textcolor{keywordflow}{break};
    \}
  \}

  \textcolor{keywordflow}{if}( name\_kv != NULL || position\_kv != NULL) \{
    errno = 0;
    rtn = strtod( position\_kv->\hyperlink{structlskvs__kvs__list__struct_a7f5620fa24157783bb02e6dd82bdcb22}{kvs}->\hyperlink{structlskvs__kvs__struct_a27a0ae4415b6d65c8a9f9fac11c130f9}{v}, NULL);
    \textcolor{keywordflow}{if}( errno != 0) \{
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"lskvs\_find\_preset\_position:
       bad preset value for motor %s, preset %s, value '%s'"}, mp->\hyperlink{structlspmac__motor__struct_aa90af2f6f1489f1befe1d0891e51575a}{name}, name, 
      position\_kv->\hyperlink{structlskvs__kvs__list__struct_a7f5620fa24157783bb02e6dd82bdcb22}{kvs}->\hyperlink{structlskvs__kvs__struct_a27a0ae4415b6d65c8a9f9fac11c130f9}{v});
      \textcolor{keywordflow}{if}( err != NULL)
        *err = -2;
      \textcolor{keywordflow}{return} 0.0;
    \}
    \textcolor{keywordflow}{return} rtn;
  \}
  \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"lskvs\_find\_preset\_position:
       could not find preset for motor %s, preset %s"}, mp->\hyperlink{structlspmac__motor__struct_aa90af2f6f1489f1befe1d0891e51575a}{name}, name);
  \textcolor{keywordflow}{if}( err != NULL)
    *err = -3;
  \textcolor{keywordflow}{return} 0.0;
\}
\end{DoxyCode}
\hypertarget{lskvs_8c_a3bc37cbeae347da068124d23ba3c1905}{\index{lskvs.\-c@{lskvs.\-c}!lskvs\-\_\-get@{lskvs\-\_\-get}}
\index{lskvs\-\_\-get@{lskvs\-\_\-get}!lskvs.c@{lskvs.\-c}}
\subsubsection[{lskvs\-\_\-get}]{\setlength{\rightskip}{0pt plus 5cm}{\bf lskvs\-\_\-kvs\-\_\-t}$\ast$ lskvs\-\_\-get (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{k}
\end{DoxyParamCaption}
)}}\label{lskvs_8c_a3bc37cbeae347da068124d23ba3c1905}


Find the kv pair object Return with a pointer to the structure or N\-U\-L\-L if not found. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em k} & key name to search for \\
\hline
\end{DoxyParams}


Definition at line 252 of file lskvs.\-c.


\begin{DoxyCode}
                         \{
  \hyperlink{structlskvs__kvs__struct}{lskvs\_kvs\_t}
    *rtn;

  pthread\_rwlock\_rdlock( &\hyperlink{lskvs_8c_ad329bf890bd9eef896815dd53a323c2f}{lskvs\_rwlock});
  rtn = \hyperlink{lskvs_8c_a14ca7cca8246dcfc266ad30d56701c0a}{lskvs\_kvs};
  pthread\_rwlock\_unlock( &\hyperlink{lskvs_8c_ad329bf890bd9eef896815dd53a323c2f}{lskvs\_rwlock});

  \textcolor{keywordflow}{while}(rtn != NULL) \{
    \textcolor{keywordflow}{if}( strcmp( rtn->\hyperlink{structlskvs__kvs__struct_afaaab7729ce9dbabd8f3e2c502a8e4c5}{k}, k) == 0)
      \textcolor{keywordflow}{break};
    rtn = rtn->\hyperlink{structlskvs__kvs__struct_a6302f184418962708bd1efe3320d4347}{next};
  \}
  \textcolor{keywordflow}{return} rtn;
\}
\end{DoxyCode}
\hypertarget{lskvs_8c_ae4c780cd3a394259ca74d447bdae3537}{\index{lskvs.\-c@{lskvs.\-c}!lskvs\-\_\-init@{lskvs\-\_\-init}}
\index{lskvs\-\_\-init@{lskvs\-\_\-init}!lskvs.c@{lskvs.\-c}}
\subsubsection[{lskvs\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}void lskvs\-\_\-init (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{lskvs_8c_ae4c780cd3a394259ca74d447bdae3537}


Initialize lskvs objects. 



Definition at line 273 of file lskvs.\-c.


\begin{DoxyCode}
                  \{
  pthread\_rwlock\_init( &\hyperlink{lskvs_8c_ad329bf890bd9eef896815dd53a323c2f}{lskvs\_rwlock}, NULL);
\}
\end{DoxyCode}
\hypertarget{lskvs_8c_ac1a924903bc31ef067c08e5152e1b2eb}{\index{lskvs.\-c@{lskvs.\-c}!lskvs\-\_\-regcomp@{lskvs\-\_\-regcomp}}
\index{lskvs\-\_\-regcomp@{lskvs\-\_\-regcomp}!lskvs.c@{lskvs.\-c}}
\subsubsection[{lskvs\-\_\-regcomp}]{\setlength{\rightskip}{0pt plus 5cm}void lskvs\-\_\-regcomp (
\begin{DoxyParamCaption}
\item[{regex\-\_\-t $\ast$}]{preg, }
\item[{int}]{cflags, }
\item[{char $\ast$}]{fmt, }
\item[{}]{...}
\end{DoxyParamCaption}
)}}\label{lskvs_8c_ac1a924903bc31ef067c08e5152e1b2eb}


Utility wrapper for regcomp providing printf style formating. 


\begin{DoxyParams}{Parameters}
{\em preg} & Buffer for the compile regex object \\
\hline
{\em cflags} & See regcomp man page \\
\hline
{\em fmt} & Printf style formating string \\
\hline
{\em ...} & Argument list specified by fmt \\
\hline
\end{DoxyParams}
$<$ no reason our search strings should ever be this big 

Definition at line 92 of file lskvs.\-c.


\begin{DoxyCode}
                                                               \{
  \textcolor{keyword}{struct }regerror\_struct \{
    \textcolor{keywordtype}{int} errcode;
    \textcolor{keywordtype}{char} *errstr;
  \};
  \textcolor{keyword}{static} \textcolor{keyword}{struct }regerror\_struct regerrors[] = \{
    \{ REG\_BADBR,    \textcolor{stringliteral}{"Invalid use of back reference operator."}\},
    \{ REG\_BADPAT,   \textcolor{stringliteral}{"Invalid use of pattern operators such as group or list."}\},
    \{ REG\_BADRPT,   \textcolor{stringliteral}{"Invalid use of repetition operators such as using '*' as
       the first character."}\},
    \{ REG\_EBRACE,   \textcolor{stringliteral}{"Un-matched brace interval operators."}\},
    \{ REG\_EBRACK,   \textcolor{stringliteral}{"Un-matched bracket list operators."}\},
    \{ REG\_ECOLLATE, \textcolor{stringliteral}{"Invalid collating element."}\},
    \{ REG\_ECTYPE,   \textcolor{stringliteral}{"Unknown character class name."}\},
    \{ REG\_EEND,     \textcolor{stringliteral}{"Non specific error.  This is not defined by POSIX.2."}\},
    \{ REG\_EESCAPE,  \textcolor{stringliteral}{"Trailing backslash."}\},
    \{ REG\_EPAREN,   \textcolor{stringliteral}{"Un-matched parenthesis group operators."}\},
    \{ REG\_ERANGE,   \textcolor{stringliteral}{"Invalid use of the range operator, e.g., the ending point
       of the range occurs prior to the starting point."}\},
    \{ REG\_ESIZE,    \textcolor{stringliteral}{"Compiled regular expression requires a pattern buffer
       larger than 64Kb.  This is not defined by POSIX.2."}\},
    \{ REG\_ESPACE,   \textcolor{stringliteral}{"The regex routines ran out of memory."}\},
    \{ REG\_ESUBREG,  \textcolor{stringliteral}{"Invalid back reference to a subexpression."}\},
    \{ 0,            \textcolor{stringliteral}{"No errors"}\}
  \};



  va\_list arg\_ptr;
  \textcolor{keywordtype}{char} s[512];          
  \textcolor{keywordtype}{int} err;

  va\_start( arg\_ptr, fmt);
  vsnprintf( s, \textcolor{keyword}{sizeof}(s)-1, fmt, arg\_ptr);
  s[ \textcolor{keyword}{sizeof}(s)-1] = 0;
  va\_end( arg\_ptr);

  err = regcomp( preg, s, cflags);
  \textcolor{keywordflow}{if}( err != 0) \{
    \textcolor{keywordtype}{int} i;

    \textcolor{keywordflow}{for}( i=0; regerrors[i].errcode != 0; i++)
      \textcolor{keywordflow}{if}( regerrors[i].errcode == err)
        \textcolor{keywordflow}{break};

    \textcolor{keywordflow}{if}( regerrors[i].errcode != 0) \{
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"lskvs\_regcomp: could not
       compile regular experssion '%s'"}, s);
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"lskvs\_regcomp: regcomp
       returned %d: %s"}, err, regerrors[i]);
    \}
  \}
\}
\end{DoxyCode}
\hypertarget{lskvs_8c_ab67e0bf3edaa2cea837fe68814e025f5}{\index{lskvs.\-c@{lskvs.\-c}!lskvs\-\_\-run@{lskvs\-\_\-run}}
\index{lskvs\-\_\-run@{lskvs\-\_\-run}!lskvs.c@{lskvs.\-c}}
\subsubsection[{lskvs\-\_\-run}]{\setlength{\rightskip}{0pt plus 5cm}void lskvs\-\_\-run (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{lskvs_8c_ab67e0bf3edaa2cea837fe68814e025f5}


Run things. 

Really, there is nothing to run. There is no need for a worker thread here but this has been added so we can add lskvs just like any other module to the pgpmac project. Maybe one day we'll need to add a thread and this little routine can be celebrated as being far sighted, ahead of its time. 

Definition at line 283 of file lskvs.\-c.


\begin{DoxyCode}
                 \{
\}
\end{DoxyCode}
\hypertarget{lskvs_8c_ab04e99f92c761522972c4d80d85f4830}{\index{lskvs.\-c@{lskvs.\-c}!lskvs\-\_\-set@{lskvs\-\_\-set}}
\index{lskvs\-\_\-set@{lskvs\-\_\-set}!lskvs.c@{lskvs.\-c}}
\subsubsection[{lskvs\-\_\-set}]{\setlength{\rightskip}{0pt plus 5cm}void lskvs\-\_\-set (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{k, }
\item[{char $\ast$}]{v}
\end{DoxyParamCaption}
)}}\label{lskvs_8c_ab04e99f92c761522972c4d80d85f4830}


Set the value of a kv pair Create the pair if the key does not exsist. 

If more than one thread tries to create the same key at the same time it is possible for the list to contain multiple versions. Not good. But also not possible if only one thread has the job of create the pairs in the first place. Alternatively just grab the write lock at the beginning and hold it until the end. The advantage of having only one thread calling lskvs\-\_\-set is that it wont slow down the other threads that just want to read things. In any case, we'll likely never see so much action for any of this to make a differene.


\begin{DoxyParams}{Parameters}
{\em k} & The name of the key \\
\hline
{\em v} & The value to assign to the key \\
\hline
\end{DoxyParams}


Definition at line 156 of file lskvs.\-c.


\begin{DoxyCode}
                                  \{
  \hyperlink{structlskvs__kvs__struct}{lskvs\_kvs\_t}
    *root,
    *p;

  \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"lskvs\_set:  k: '%s', v: '%s'"}, k
      , v);

  \textcolor{comment}{// Don't bother with empty keys}
  \textcolor{comment}{//}
  \textcolor{keywordflow}{if}( k == NULL || *k == 0)
    \textcolor{keywordflow}{return};

  pthread\_rwlock\_rdlock( &\hyperlink{lskvs_8c_ad329bf890bd9eef896815dd53a323c2f}{lskvs\_rwlock});
  root = \hyperlink{lskvs_8c_a14ca7cca8246dcfc266ad30d56701c0a}{lskvs\_kvs};
  pthread\_rwlock\_unlock( &\hyperlink{lskvs_8c_ad329bf890bd9eef896815dd53a323c2f}{lskvs\_rwlock});

  \textcolor{keywordflow}{for}( p=root; p != NULL; p = p->\hyperlink{structlskvs__kvs__struct_a6302f184418962708bd1efe3320d4347}{next}) \{
    \textcolor{keywordflow}{if}( strcmp( p->\hyperlink{structlskvs__kvs__struct_afaaab7729ce9dbabd8f3e2c502a8e4c5}{k}, k) == 0) \{
      \textcolor{keywordflow}{break};
    \}
  \}

  \textcolor{keywordflow}{if}( p == NULL) \{
    \textcolor{comment}{//}
    \textcolor{comment}{// Add a new list item}
    \textcolor{comment}{//}
    p = calloc( 1, \textcolor{keyword}{sizeof}( *p));
    \textcolor{keywordflow}{if}( p == NULL) \{
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"lskvs\_set: out of memory for
       kv struct (%d bytes"}, \textcolor{keyword}{sizeof}( *p));
      exit( -1);
    \}


    p->\hyperlink{structlskvs__kvs__struct_afaaab7729ce9dbabd8f3e2c502a8e4c5}{k} = calloc( strlen(k)+1, \textcolor{keyword}{sizeof}( *k));
    \textcolor{keywordflow}{if}( p->\hyperlink{structlskvs__kvs__struct_afaaab7729ce9dbabd8f3e2c502a8e4c5}{k} == NULL) \{
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"lskvs\_set: out of memory for
       k (%d bytes)"}, strlen( k)+1);
      exit( -1);
    \}
    strcpy( p->\hyperlink{structlskvs__kvs__struct_afaaab7729ce9dbabd8f3e2c502a8e4c5}{k}, k);
    p->\hyperlink{structlskvs__kvs__struct_afaaab7729ce9dbabd8f3e2c502a8e4c5}{k}[strlen(k)] = 0;

    \textcolor{comment}{// leave a little room to grow}
    \textcolor{comment}{//}
    \textcolor{keywordflow}{if}( v == NULL || *v == 0)
      p->\hyperlink{structlskvs__kvs__struct_aa1c980ae62cdf78d8b358b3a51deda6a}{vl} = 32;
    \textcolor{keywordflow}{else}
      p->\hyperlink{structlskvs__kvs__struct_aa1c980ae62cdf78d8b358b3a51deda6a}{vl} = strlen(v) + 32;

    p->\hyperlink{structlskvs__kvs__struct_a27a0ae4415b6d65c8a9f9fac11c130f9}{v} = calloc( p->\hyperlink{structlskvs__kvs__struct_aa1c980ae62cdf78d8b358b3a51deda6a}{vl}, \textcolor{keyword}{sizeof}( *v));
    \textcolor{keywordflow}{if}( p->\hyperlink{structlskvs__kvs__struct_a27a0ae4415b6d65c8a9f9fac11c130f9}{v} == NULL) \{
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"lskvs\_set: out of memory for
       v (%d bytes)"}, p->\hyperlink{structlskvs__kvs__struct_aa1c980ae62cdf78d8b358b3a51deda6a}{vl});
      exit( -1);
    \}
    
    \textcolor{keywordflow}{if}( v == NULL || *v == 0)
      *(p->\hyperlink{structlskvs__kvs__struct_a27a0ae4415b6d65c8a9f9fac11c130f9}{v}) = 0;
    \textcolor{keywordflow}{else}
      strcpy( p->\hyperlink{structlskvs__kvs__struct_a27a0ae4415b6d65c8a9f9fac11c130f9}{v}, v);

    p->\hyperlink{structlskvs__kvs__struct_a27a0ae4415b6d65c8a9f9fac11c130f9}{v}[p->\hyperlink{structlskvs__kvs__struct_aa1c980ae62cdf78d8b358b3a51deda6a}{vl}-1] = 0;
    
    pthread\_rwlock\_init( &p->\hyperlink{structlskvs__kvs__struct_a45129c7f3d0bb2efc83b8a0d7ea2d814}{l}, NULL);

    pthread\_rwlock\_wrlock( &\hyperlink{lskvs_8c_ad329bf890bd9eef896815dd53a323c2f}{lskvs\_rwlock});
    p->\hyperlink{structlskvs__kvs__struct_a6302f184418962708bd1efe3320d4347}{next}   = \hyperlink{lskvs_8c_a14ca7cca8246dcfc266ad30d56701c0a}{lskvs\_kvs};
    \hyperlink{lskvs_8c_a14ca7cca8246dcfc266ad30d56701c0a}{lskvs\_kvs} = p;
    pthread\_rwlock\_unlock( &\hyperlink{lskvs_8c_ad329bf890bd9eef896815dd53a323c2f}{lskvs\_rwlock});

    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"NewKV"});

  \} \textcolor{keywordflow}{else} \{
    \textcolor{comment}{//}
    \textcolor{comment}{// Just update the value}
    \textcolor{comment}{// Assume the database only sent us an update because}
    \textcolor{comment}{// the old and new values are different}
    \textcolor{comment}{//}
    pthread\_rwlock\_wrlock( &(p->\hyperlink{structlskvs__kvs__struct_a45129c7f3d0bb2efc83b8a0d7ea2d814}{l}));
    \textcolor{keywordflow}{if}( strlen( v) > p->\hyperlink{structlskvs__kvs__struct_aa1c980ae62cdf78d8b358b3a51deda6a}{vl}-1) \{
      free( p->\hyperlink{structlskvs__kvs__struct_a27a0ae4415b6d65c8a9f9fac11c130f9}{v});
      
      p->\hyperlink{structlskvs__kvs__struct_aa1c980ae62cdf78d8b358b3a51deda6a}{vl} = strlen(v) + 32;
      p->\hyperlink{structlskvs__kvs__struct_a27a0ae4415b6d65c8a9f9fac11c130f9}{v} = calloc( p->\hyperlink{structlskvs__kvs__struct_aa1c980ae62cdf78d8b358b3a51deda6a}{vl}, 1);
      \textcolor{keywordflow}{if}( p->\hyperlink{structlskvs__kvs__struct_a27a0ae4415b6d65c8a9f9fac11c130f9}{v} == NULL) \{
        \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"lskvs\_set: out of memory
       for re-calloc of v (%d bytes)"}, p->\hyperlink{structlskvs__kvs__struct_aa1c980ae62cdf78d8b358b3a51deda6a}{vl});
        exit( -1);
      \}
    \}
    strcpy( p->\hyperlink{structlskvs__kvs__struct_a27a0ae4415b6d65c8a9f9fac11c130f9}{v}, v);
    p->\hyperlink{structlskvs__kvs__struct_a27a0ae4415b6d65c8a9f9fac11c130f9}{v}[p->\hyperlink{structlskvs__kvs__struct_aa1c980ae62cdf78d8b358b3a51deda6a}{vl}-1] = 0;
    pthread\_rwlock\_unlock( &(p->\hyperlink{structlskvs__kvs__struct_a45129c7f3d0bb2efc83b8a0d7ea2d814}{l}));
  \}
\}
\end{DoxyCode}


\subsection{Variable Documentation}
\hypertarget{lskvs_8c_a14ca7cca8246dcfc266ad30d56701c0a}{\index{lskvs.\-c@{lskvs.\-c}!lskvs\-\_\-kvs@{lskvs\-\_\-kvs}}
\index{lskvs\-\_\-kvs@{lskvs\-\_\-kvs}!lskvs.c@{lskvs.\-c}}
\subsubsection[{lskvs\-\_\-kvs}]{\setlength{\rightskip}{0pt plus 5cm}{\bf lskvs\-\_\-kvs\-\_\-t}$\ast$ lskvs\-\_\-kvs = N\-U\-L\-L}}\label{lskvs_8c_a14ca7cca8246dcfc266ad30d56701c0a}


our list (or at least the start of it 



Definition at line 11 of file lskvs.\-c.

\hypertarget{lskvs_8c_ad329bf890bd9eef896815dd53a323c2f}{\index{lskvs.\-c@{lskvs.\-c}!lskvs\-\_\-rwlock@{lskvs\-\_\-rwlock}}
\index{lskvs\-\_\-rwlock@{lskvs\-\_\-rwlock}!lskvs.c@{lskvs.\-c}}
\subsubsection[{lskvs\-\_\-rwlock}]{\setlength{\rightskip}{0pt plus 5cm}pthread\-\_\-rwlock\-\_\-t lskvs\-\_\-rwlock}}\label{lskvs_8c_ad329bf890bd9eef896815dd53a323c2f}


needed to protect the list 



Definition at line 12 of file lskvs.\-c.

