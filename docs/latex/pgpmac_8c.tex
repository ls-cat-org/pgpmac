\hypertarget{pgpmac_8c}{
\section{pgpmac.c File Reference}
\label{pgpmac_8c}\index{pgpmac.c@{pgpmac.c}}
}


Main for the pgpmac project.  
{\ttfamily \#include \char`\"{}pgpmac.h\char`\"{}}\par
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{pgpmac_8c_a9127a8f722451b5996ffbc6966f4aa95}{stdinService} (struct pollfd $\ast$evt)
\begin{DoxyCompactList}\small\item\em Handle keyboard input. \item\end{DoxyCompactList}\item 
void \hyperlink{pgpmac_8c_a7762ca7b97b44b979e23ce88ca3b4249}{pgpmac\_\-printf} (char $\ast$fmt,...)
\begin{DoxyCompactList}\small\item\em Terminal output routine ala printf. \item\end{DoxyCompactList}\item 
int \hyperlink{pgpmac_8c_a3c04138a5bfe5d72780bb7e82a18e627}{main} (int argc, char $\ast$$\ast$argv)
\begin{DoxyCompactList}\small\item\em Our main routine. \item\end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
WINDOW $\ast$ \hyperlink{pgpmac_8c_a65daf0f4a5bc6def23a9df98ff5ca57e}{term\_\-output}
\begin{DoxyCompactList}\small\item\em place to print stuff out \item\end{DoxyCompactList}\item 
WINDOW $\ast$ \hyperlink{pgpmac_8c_ab0487111dbe3c05d0bd835eb2fb9a3f7}{term\_\-input}
\begin{DoxyCompactList}\small\item\em place to put the cursor \item\end{DoxyCompactList}\item 
WINDOW $\ast$ \hyperlink{pgpmac_8c_ae746a6903fb8a4ea216def88eccedc3c}{term\_\-status}
\begin{DoxyCompactList}\small\item\em shutter, lamp, air, etc status \item\end{DoxyCompactList}\item 
WINDOW $\ast$ \hyperlink{pgpmac_8c_ae2d7da3afeb756716e6e4ee9cab78f8a}{term\_\-status2}
\begin{DoxyCompactList}\small\item\em shutter, lamp, air, etc status \item\end{DoxyCompactList}\item 
pthread\_\-mutex\_\-t \hyperlink{pgpmac_8c_ad128c64890c7c0d4f836d9ec6e99216a}{ncurses\_\-mutex}
\begin{DoxyCompactList}\small\item\em allow more than one thread access to the screen \item\end{DoxyCompactList}\item 
static struct pollfd \hyperlink{pgpmac_8c_a6dc08e82e698d914ccb09077dd33668a}{stdinfda}
\begin{DoxyCompactList}\small\item\em Handle input from the keyboard. \item\end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Main for the pgpmac project. \begin{DoxyDate}{Date}
2012 
\end{DoxyDate}
\begin{DoxyAuthor}{Author}
Keith Brister  All Rights Reserved 
\end{DoxyAuthor}


Definition in file \hyperlink{pgpmac_8c_source}{pgpmac.c}.

\subsection{Function Documentation}
\hypertarget{pgpmac_8c_a3c04138a5bfe5d72780bb7e82a18e627}{
\index{pgpmac.c@{pgpmac.c}!main@{main}}
\index{main@{main}!pgpmac.c@{pgpmac.c}}
\subsubsection[{main}]{\setlength{\rightskip}{0pt plus 5cm}int main (int {\em argc}, \/  char $\ast$$\ast$ {\em argv})}}
\label{pgpmac_8c_a3c04138a5bfe5d72780bb7e82a18e627}


Our main routine. 
\begin{DoxyParams}{Parameters}
\item[\mbox{$\leftarrow$} {\em argc}]Number of arguments \item[\mbox{$\leftarrow$} {\em argv}]Vector of argument strings \end{DoxyParams}


Definition at line 340 of file pgpmac.c.


\begin{DoxyCode}
343            {
344   static nfds_t nfds;
345 
346   static struct pollfd fda[3], *fdp;    // input for poll: room for postgres, pma
      c, and stdin
347   static int nfd = 0;                   // number of items in fda
348   static int pollrtn = 0;
349   static struct option long_options[] = {
350     { "i-vars", 0, NULL, 'i'},
351     { "m-vars", 0, NULL, 'm'},
352     { NULL,     0, NULL, 0}
353   };
354   int c;
355   int ivars, mvars;
356   mvars=0;
357   ivars=0;
358 
359   int i;                                // standard loop counter
360 
361   while( 1) {
362     c=getopt_long( argc, argv, "im", long_options, NULL);
363     if( c == -1)
364       break;
365 
366     switch( c) {
367     case 'i':
368       ivars=1;
369       break;
370 
371     case 'm':
372       mvars=1;
373       break;
374 
375     }
376   }
377 
378   stdinfda.fd = 0;
379   stdinfda.events = POLLIN;
380 
381   initscr();                            // Start ncurses
382   raw();                                // Line buffering disabled, control chars
       trapped
383   keypad( stdscr, TRUE);                // Why is F1 nifty?
384   refresh();
385 
386   pthread_mutex_init( &ncurses_mutex, NULL);    // don't lock this mutex yet beca
      use we are not multi-threaded until the "_run" functions
387 
388   //
389   // Since the modules reference objects in other modules it is important
390   // that everyone is initiallized before anyone runs
391   //
392   lspmac_init( ivars, mvars);
393   lspg_init();
394   lsupdate_init();
395   md2cmds_init();
396 
397   term_status = newwin( LS_DISPLAY_WINDOW_HEIGHT, LS_DISPLAY_WINDOW_WIDTH, 3*
      LS_DISPLAY_WINDOW_HEIGHT, 0*LS_DISPLAY_WINDOW_WIDTH);
398   box( term_status, 0, 0);
399   wnoutrefresh( term_status);
400                                                       
401   term_status2 = newwin( LS_DISPLAY_WINDOW_HEIGHT, LS_DISPLAY_WINDOW_WIDTH, 3*
      LS_DISPLAY_WINDOW_HEIGHT, 1*LS_DISPLAY_WINDOW_WIDTH);
402   box( term_status2, 0, 0);
403   wnoutrefresh( term_status2);
404                                                       
405   term_output = newwin( 10, 5*LS_DISPLAY_WINDOW_WIDTH, 4*
      LS_DISPLAY_WINDOW_HEIGHT, 0);
406   scrollok( term_output, 1);                          
407   wnoutrefresh( term_output);                         
408                                                       
409   term_input  = newwin( 3, 5*LS_DISPLAY_WINDOW_WIDTH, 10+4*
      LS_DISPLAY_WINDOW_HEIGHT, 0);
410   box( term_input, 0, 0);                             
411   mvwprintw( term_input, 1, 1, "PMAC> ");             
412   nodelay( term_input, TRUE);                         
413   keypad( term_input, TRUE);                          
414   wnoutrefresh( term_input);                          
415                                                       
416   doupdate();                                         
417 
418   lspmac_run();
419   lspg_run();
420   lsupdate_run();
421   md2cmds_run();
422 
423   while( 1) {
424     //
425     // Big loop
426     //
427 
428     nfd = 0;
429 
430     //
431     // keyboard
432     //
433     memcpy( &(fda[nfd++]), &stdinfda, sizeof( struct pollfd));
434     
435 
436     if( nfd == 0) {
437       //
438       // No connectons yet.  Wait a bit and try again.
439       //
440       sleep( 10);
441       //
442       // go try to connect again
443       //
444       continue;
445     }
446 
447 
448     pollrtn = poll( fda, nfd, 10);
449 
450     for( i=0; pollrtn>0 && i<nfd; i++) {
451       if( fda[i].revents) {
452         pollrtn--;
453         if( fda[i].fd == 0) {
454           stdinService( &fda[i]);
455         }
456       }
457     }
458   }
459 }
\end{DoxyCode}
\hypertarget{pgpmac_8c_a7762ca7b97b44b979e23ce88ca3b4249}{
\index{pgpmac.c@{pgpmac.c}!pgpmac\_\-printf@{pgpmac\_\-printf}}
\index{pgpmac\_\-printf@{pgpmac\_\-printf}!pgpmac.c@{pgpmac.c}}
\subsubsection[{pgpmac\_\-printf}]{\setlength{\rightskip}{0pt plus 5cm}void pgpmac\_\-printf (char $\ast$ {\em fmt}, \/   {\em ...})}}
\label{pgpmac_8c_a7762ca7b97b44b979e23ce88ca3b4249}


Terminal output routine ala printf. 
\begin{DoxyParams}{Parameters}
\item[\mbox{$\leftarrow$} {\em fmt}]Printf style formating string \end{DoxyParams}


Definition at line 317 of file pgpmac.c.


\begin{DoxyCode}
320                      {
321   va_list arg_ptr;
322 
323   pthread_mutex_lock( &ncurses_mutex);
324 
325   va_start( arg_ptr, fmt);
326   vwprintw( term_output, fmt, arg_ptr);
327   va_end( arg_ptr);
328 
329   wnoutrefresh( term_output);
330   wnoutrefresh( term_input);
331   doupdate();
332 
333   pthread_mutex_unlock( &ncurses_mutex);
334 
335 }
\end{DoxyCode}
\hypertarget{pgpmac_8c_a9127a8f722451b5996ffbc6966f4aa95}{
\index{pgpmac.c@{pgpmac.c}!stdinService@{stdinService}}
\index{stdinService@{stdinService}!pgpmac.c@{pgpmac.c}}
\subsubsection[{stdinService}]{\setlength{\rightskip}{0pt plus 5cm}void stdinService (struct pollfd $\ast$ {\em evt})}}
\label{pgpmac_8c_a9127a8f722451b5996ffbc6966f4aa95}


Handle keyboard input. 
\begin{DoxyParams}{Parameters}
\item[\mbox{$\leftarrow$} {\em evt}]The pollfd object that caused this call \end{DoxyParams}


Definition at line 245 of file pgpmac.c.


\begin{DoxyCode}
247                     {
248   static char cmds[1024];
249   static char cntrlcmd[2];
250   static char cmds_on = 0;
251   int ch;
252 
253 
254   for( ch=wgetch(term_input); ch != ERR; ch=wgetch(term_input)) {
255     // wprintw( term_output, "%04x\n", ch);
256     // wnoutrefresh( term_output);
257 
258     switch( ch) {
259     case KEY_F(1):
260       endwin();
261       exit(0);
262       break;
263 
264     case 0x0001:        // Control-A
265     case 0x0002:        // Control-B
266     case 0x0003:        // Control-C
267     case 0x0004:        // Control-D
268     case 0x0005:        // Control-E
269     case 0x0006:        // Control-F
270     case 0x0007:        // Control-G
271     case 0x000b:        // Control-K
272     case 0x000f:        // Control-O
273     case 0x0010:        // Control-P
274     case 0x0011:        // Control-Q
275     case 0x0012:        // Control-R
276     case 0x0013:        // Control-Q
277     case 0x0016:        // Control-V
278       cntrlcmd[0] = ch;
279       cntrlcmd[1] = 0;
280       lspmac_SockSendline( cntrlcmd);
281       //      PmacSockSendControlCharPrint( ch);
282       break;
283 
284     case KEY_BACKSPACE:
285       cmds[cmds_on] = 0;
286       cmds_on == 0 ? 0 : cmds_on--;
287       break;
288       
289     case KEY_ENTER:
290     case 0x000a:
291       if( cmds_on > 0 && strlen( cmds) > 0) {
292         lspmac_SockSendline( cmds);
293       }
294       memset( cmds, 0, sizeof(cmds));
295       cmds_on = 0;
296       break;
297       
298     default:
299       if( cmds_on < sizeof( cmds)-1) {
300         cmds[cmds_on++] = ch;
301         cmds[cmds_on] = 0;
302       }
303       break;
304     }
305     
306     mvwprintw( term_input, 1, 1, "PMAC> %s", cmds);
307     wclrtoeol( term_input);
308     box( term_input, 0, 0);
309     wnoutrefresh( term_input);
310     doupdate();
311 
312   }
313 }
\end{DoxyCode}


\subsection{Variable Documentation}
\hypertarget{pgpmac_8c_ad128c64890c7c0d4f836d9ec6e99216a}{
\index{pgpmac.c@{pgpmac.c}!ncurses\_\-mutex@{ncurses\_\-mutex}}
\index{ncurses\_\-mutex@{ncurses\_\-mutex}!pgpmac.c@{pgpmac.c}}
\subsubsection[{ncurses\_\-mutex}]{\setlength{\rightskip}{0pt plus 5cm}pthread\_\-mutex\_\-t {\bf ncurses\_\-mutex}}}
\label{pgpmac_8c_ad128c64890c7c0d4f836d9ec6e99216a}


allow more than one thread access to the screen 

Definition at line 233 of file pgpmac.c.\hypertarget{pgpmac_8c_a6dc08e82e698d914ccb09077dd33668a}{
\index{pgpmac.c@{pgpmac.c}!stdinfda@{stdinfda}}
\index{stdinfda@{stdinfda}!pgpmac.c@{pgpmac.c}}
\subsubsection[{stdinfda}]{\setlength{\rightskip}{0pt plus 5cm}struct pollfd {\bf stdinfda}\hspace{0.3cm}{\ttfamily  \mbox{[}static\mbox{]}}}}
\label{pgpmac_8c_a6dc08e82e698d914ccb09077dd33668a}


Handle input from the keyboard. 

Definition at line 239 of file pgpmac.c.\hypertarget{pgpmac_8c_ab0487111dbe3c05d0bd835eb2fb9a3f7}{
\index{pgpmac.c@{pgpmac.c}!term\_\-input@{term\_\-input}}
\index{term\_\-input@{term\_\-input}!pgpmac.c@{pgpmac.c}}
\subsubsection[{term\_\-input}]{\setlength{\rightskip}{0pt plus 5cm}WINDOW$\ast$ {\bf term\_\-input}}}
\label{pgpmac_8c_ab0487111dbe3c05d0bd835eb2fb9a3f7}


place to put the cursor 

Definition at line 229 of file pgpmac.c.\hypertarget{pgpmac_8c_a65daf0f4a5bc6def23a9df98ff5ca57e}{
\index{pgpmac.c@{pgpmac.c}!term\_\-output@{term\_\-output}}
\index{term\_\-output@{term\_\-output}!pgpmac.c@{pgpmac.c}}
\subsubsection[{term\_\-output}]{\setlength{\rightskip}{0pt plus 5cm}WINDOW$\ast$ {\bf term\_\-output}}}
\label{pgpmac_8c_a65daf0f4a5bc6def23a9df98ff5ca57e}


place to print stuff out 

Definition at line 228 of file pgpmac.c.\hypertarget{pgpmac_8c_ae746a6903fb8a4ea216def88eccedc3c}{
\index{pgpmac.c@{pgpmac.c}!term\_\-status@{term\_\-status}}
\index{term\_\-status@{term\_\-status}!pgpmac.c@{pgpmac.c}}
\subsubsection[{term\_\-status}]{\setlength{\rightskip}{0pt plus 5cm}WINDOW$\ast$ {\bf term\_\-status}}}
\label{pgpmac_8c_ae746a6903fb8a4ea216def88eccedc3c}


shutter, lamp, air, etc status 

Definition at line 230 of file pgpmac.c.\hypertarget{pgpmac_8c_ae2d7da3afeb756716e6e4ee9cab78f8a}{
\index{pgpmac.c@{pgpmac.c}!term\_\-status2@{term\_\-status2}}
\index{term\_\-status2@{term\_\-status2}!pgpmac.c@{pgpmac.c}}
\subsubsection[{term\_\-status2}]{\setlength{\rightskip}{0pt plus 5cm}WINDOW$\ast$ {\bf term\_\-status2}}}
\label{pgpmac_8c_ae2d7da3afeb756716e6e4ee9cab78f8a}


shutter, lamp, air, etc status 

Definition at line 231 of file pgpmac.c.