\hypertarget{kvredis_8c}{\section{kvredis.\-c File Reference}
\label{kvredis_8c}\index{kvredis.\-c@{kvredis.\-c}}
}
{\ttfamily \#include $<$stdio.\-h$>$}\\*
{\ttfamily \#include $<$stdlib.\-h$>$}\\*
{\ttfamily \#include $<$hiredis/hiredis.\-h$>$}\\*
{\ttfamily \#include $<$hiredis/async.\-h$>$}\\*
{\ttfamily \#include $<$poll.\-h$>$}\\*
{\ttfamily \#include $<$postgresql/libpq-\/fe.\-h$>$}\\*
{\ttfamily \#include $<$string.\-h$>$}\\*
\subsection*{Data Structures}
\begin{DoxyCompactItemize}
\item 
struct \hyperlink{structlspgQueryQueueStruct}{lspg\-Query\-Queue\-Struct}
\begin{DoxyCompactList}\small\item\em Store each query along with it's callback function. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{kvredis_8c_a08fe83fe8226002ee8b80ce0a914fd11}{L\-S\-\_\-\-P\-G\-\_\-\-Q\-U\-E\-R\-Y\-\_\-\-Q\-U\-E\-U\-E\-\_\-\-L\-E\-N\-G\-T\-H}~512
\item 
\#define \hyperlink{kvredis_8c_a3a8ef1b4b5994d6dd12bf74454ea891b}{L\-S\-\_\-\-P\-G\-\_\-\-Q\-U\-E\-R\-Y\-\_\-\-S\-T\-R\-I\-N\-G\-\_\-\-L\-E\-N\-G\-T\-H}~512
\item 
\#define \hyperlink{kvredis_8c_af443092447378c73bf93aa143576aba4}{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-N\-I\-T}~-\/4
\item 
\#define \hyperlink{kvredis_8c_ae7ea5876846b5f04c419aee22d3c0aa1}{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-N\-I\-T\-\_\-\-P\-O\-L\-L}~-\/3
\item 
\#define \hyperlink{kvredis_8c_accda8c3a598dc7f5b107b04986d8ab50}{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-S\-E\-T}~-\/2
\item 
\#define \hyperlink{kvredis_8c_ac70a1141f3b138055ea7143bd493187c}{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-S\-E\-T\-\_\-\-P\-O\-L\-L}~-\/1
\item 
\#define \hyperlink{kvredis_8c_aaf1dd8ba4dafb91c296554c4cbf312e3}{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-D\-L\-E}~1
\item 
\#define \hyperlink{kvredis_8c_a3c6eb19f262a990e1f9ba630d9edc309}{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-S\-E\-N\-D}~2
\item 
\#define \hyperlink{kvredis_8c_a88a7e80c12fb0449c4b0857a0c7deb21}{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-S\-E\-N\-D\-\_\-\-F\-L\-U\-S\-H}~3
\item 
\#define \hyperlink{kvredis_8c_a373e668840b4795ff9a71bc3f744d209}{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-C\-V}~4
\end{DoxyCompactItemize}
\subsection*{Typedefs}
\begin{DoxyCompactItemize}
\item 
typedef struct \hyperlink{structlspgQueryQueueStruct}{lspg\-Query\-Queue\-Struct} \hyperlink{kvredis_8c_ae57432c0a6ac48a50457815dab2c5b4c}{lspg\-\_\-query\-\_\-queue\-\_\-t}
\begin{DoxyCompactList}\small\item\em Store each query along with it's callback function. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{kvredis_8c_aa1941e6515a254f76cfd1f18d3c8fac3}{redis\-Disconnect\-C\-B} (const redis\-Async\-Context $\ast$ac, int status)
\item 
void \hyperlink{kvredis_8c_a5dbdf77c680c97996882abbb6a142321}{debug\-C\-B} (redis\-Async\-Context $\ast$ac, void $\ast$reply, void $\ast$privdata)
\item 
void \hyperlink{kvredis_8c_a95668f6d7a4b8882c6a502af3b0a4705}{add\-Read} (void $\ast$data)
\item 
void \hyperlink{kvredis_8c_ad3f87d428857a2d8e526e2443fadd410}{del\-Read} (void $\ast$data)
\item 
void \hyperlink{kvredis_8c_aacb58922ba249c3e15491826e682023c}{add\-Write} (void $\ast$data)
\item 
void \hyperlink{kvredis_8c_a5d4f324dd0beeea83848e05550b5cf39}{del\-Write} (void $\ast$data)
\item 
void \hyperlink{kvredis_8c_a93a6e6dd9f422d01eeaa03d6ba4738a0}{cleanup} (void $\ast$data)
\item 
void \hyperlink{kvredis_8c_afb8d1ff1e0f4fcdc85ad9c684271cb3d}{lspg\-\_\-allkvs\-\_\-cb} (\hyperlink{kvredis_8c_ae57432c0a6ac48a50457815dab2c5b4c}{lspg\-\_\-query\-\_\-queue\-\_\-t} $\ast$qqp, P\-Gresult $\ast$pgr)
\item 
P\-Qnotice\-Processor \hyperlink{kvredis_8c_a62b110949d206fb22789191207e1d066}{lspg\-\_\-notice\-\_\-processor} (void $\ast$arg, const char $\ast$msg)
\item 
\hyperlink{kvredis_8c_ae57432c0a6ac48a50457815dab2c5b4c}{lspg\-\_\-query\-\_\-queue\-\_\-t} $\ast$ \hyperlink{kvredis_8c_ad5f3ec8f197cc330c83dba70f310533c}{lspg\-\_\-query\-\_\-next} ()
\begin{DoxyCompactList}\small\item\em Return the next item in the postgresql queue. \end{DoxyCompactList}\item 
void \hyperlink{kvredis_8c_a3847589e641f7e16a0cd68ef30e37cca}{lspg\-\_\-query\-\_\-reply\-\_\-next} ()
\begin{DoxyCompactList}\small\item\em Remove the oldest item in the queue. \end{DoxyCompactList}\item 
\hyperlink{kvredis_8c_ae57432c0a6ac48a50457815dab2c5b4c}{lspg\-\_\-query\-\_\-queue\-\_\-t} $\ast$ \hyperlink{kvredis_8c_ae6bf4f54117bedf903360883bb32699f}{lspg\-\_\-query\-\_\-reply\-\_\-peek} ()
\begin{DoxyCompactList}\small\item\em Return the next item in the reply queue but don't pop it since we may need it more than once. \end{DoxyCompactList}\item 
void \hyperlink{kvredis_8c_a0bb9ef42da8fa21c4df48ec384ab69f4}{lspg\-\_\-query\-\_\-push} (void($\ast$cb)(\hyperlink{kvredis_8c_ae57432c0a6ac48a50457815dab2c5b4c}{lspg\-\_\-query\-\_\-queue\-\_\-t} $\ast$, P\-Gresult $\ast$), char $\ast$fmt,...)
\begin{DoxyCompactList}\small\item\em Place a query on the queue. \end{DoxyCompactList}\item 
void \hyperlink{kvredis_8c_a038c5af23469b789fc1c55d21cb43029}{lspg\-\_\-receive} ()
\begin{DoxyCompactList}\small\item\em Receive a result of a query. \end{DoxyCompactList}\item 
void \hyperlink{kvredis_8c_a581c18be0368425665a40b4b7f7d9714}{lspg\-\_\-pg\-\_\-connect} ()
\begin{DoxyCompactList}\small\item\em Connect to the pg server. \end{DoxyCompactList}\item 
void \hyperlink{kvredis_8c_af6485ac1749c5de3008dd0e0badaa09c}{lspg\-\_\-flush} ()
\begin{DoxyCompactList}\small\item\em Flush psql output buffer (ie, send the query) \end{DoxyCompactList}\item 
void \hyperlink{kvredis_8c_ab52a8c8245bf6561f40c0f224fc07ff4}{lspg\-\_\-next\-\_\-state} ()
\begin{DoxyCompactList}\small\item\em Implements our state machine Does not strictly only set the next state as it also calls some functions that, perhaps, alters the state mid-\/function. \end{DoxyCompactList}\item 
void \hyperlink{kvredis_8c_a714b15e117ffe7bfce4f2f2ce4725b0a}{lspg\-\_\-send\-\_\-next\-\_\-query} ()
\begin{DoxyCompactList}\small\item\em send the next queued query to the D\-B server \end{DoxyCompactList}\item 
void \hyperlink{kvredis_8c_aa8d1fed4b461c2139a21826d524777d5}{lspg\-\_\-pg\-\_\-service} (struct pollfd $\ast$evt)
\begin{DoxyCompactList}\small\item\em I/\-O control to/from the postgresql server. \end{DoxyCompactList}\item 
void \hyperlink{kvredis_8c_a79856d1a06c278688563be6e5219cee5}{fd\-\_\-service} (struct pollfd $\ast$evt)
\item 
\hyperlink{kvredis_8c_a51af30a60f9f02777c6396b8247e356f}{main} ()
\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
static redis\-Async\-Context $\ast$ \hyperlink{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}{subac}
\item 
static redis\-Async\-Context $\ast$ \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}
\item 
static int \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\-\_\-pg\-\_\-state} = \hyperlink{lspg_8c_af443092447378c73bf93aa143576aba4}{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-N\-I\-T}
\begin{DoxyCompactList}\small\item\em State of the lspg state machine. \end{DoxyCompactList}\item 
static struct timeval \\*
lspg\-\_\-time\-\_\-sent \hyperlink{kvredis_8c_ad40ac52086f6b774928af45b09d54c6e}{now}
\begin{DoxyCompactList}\small\item\em used to ensure we do not inundate the db server with connection requests \end{DoxyCompactList}\item 
static int \hyperlink{kvredis_8c_a6b15f24b2416f362a9e0039efc586fbb}{kvseq} = 0
\begin{DoxyCompactList}\small\item\em used to synchronize pg.\-kvs and redis \end{DoxyCompactList}\item 
static \hyperlink{kvredis_8c_ae57432c0a6ac48a50457815dab2c5b4c}{lspg\-\_\-query\-\_\-queue\-\_\-t} \hyperlink{kvredis_8c_a357d9d98f0b8c9625ccebcebfcdce955}{lspg\-\_\-query\-\_\-queue} \mbox{[}\hyperlink{lspg_8c_a08fe83fe8226002ee8b80ce0a914fd11}{L\-S\-\_\-\-P\-G\-\_\-\-Q\-U\-E\-R\-Y\-\_\-\-Q\-U\-E\-U\-E\-\_\-\-L\-E\-N\-G\-T\-H}\mbox{]}
\begin{DoxyCompactList}\small\item\em Our query queue. \end{DoxyCompactList}\item 
static unsigned int \hyperlink{kvredis_8c_a3cbe7f3161b3c1838ebc56a3bbcfd8a6}{lspg\-\_\-query\-\_\-queue\-\_\-on} = 0
\begin{DoxyCompactList}\small\item\em Next position to add something to the queue. \end{DoxyCompactList}\item 
static unsigned int \hyperlink{kvredis_8c_aca86bb77d6cecfae9251743f4171bafb}{lspg\-\_\-query\-\_\-queue\-\_\-off} = 0
\begin{DoxyCompactList}\small\item\em The last item still being used (on == off means nothing in queue) \end{DoxyCompactList}\item 
static unsigned int \hyperlink{kvredis_8c_a2603b071afdbff7c0924b13de2454264}{lspg\-\_\-query\-\_\-queue\-\_\-reply} = 0
\begin{DoxyCompactList}\small\item\em The current item being digested. \end{DoxyCompactList}\item 
static P\-Gconn $\ast$ \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q} = N\-U\-L\-L
\begin{DoxyCompactList}\small\item\em Database connector. \end{DoxyCompactList}\item 
static Postgres\-Polling\-Status\-Type \hyperlink{kvredis_8c_a69ae04978986e6413ca7cefcb692b645}{lspg\-\_\-connect\-Poll\-\_\-response}
\begin{DoxyCompactList}\small\item\em Used to determine state while connecting. \end{DoxyCompactList}\item 
static Postgres\-Polling\-Status\-Type \hyperlink{kvredis_8c_a06c5a937e41a6c706a247777642ec1fb}{lspg\-\_\-reset\-Poll\-\_\-response}
\begin{DoxyCompactList}\small\item\em Used to determine state while reconnecting. \end{DoxyCompactList}\item 
static struct pollfd \hyperlink{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}{lspgfd}
\begin{DoxyCompactList}\small\item\em our poll info \end{DoxyCompactList}\item 
static struct pollfd \hyperlink{kvredis_8c_a0cd3bdc79d035eb1595371c845d14367}{subfd}
\begin{DoxyCompactList}\small\item\em poll info for redis subscribe channel \end{DoxyCompactList}\item 
static struct pollfd \hyperlink{kvredis_8c_a9b0e607f794ed78360d09a52bb4feaef}{cmdfd}
\begin{DoxyCompactList}\small\item\em poll info for redis command channel \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Macro Definition Documentation}
\hypertarget{kvredis_8c_a08fe83fe8226002ee8b80ce0a914fd11}{\index{kvredis.\-c@{kvredis.\-c}!L\-S\-\_\-\-P\-G\-\_\-\-Q\-U\-E\-R\-Y\-\_\-\-Q\-U\-E\-U\-E\-\_\-\-L\-E\-N\-G\-T\-H@{L\-S\-\_\-\-P\-G\-\_\-\-Q\-U\-E\-R\-Y\-\_\-\-Q\-U\-E\-U\-E\-\_\-\-L\-E\-N\-G\-T\-H}}
\index{L\-S\-\_\-\-P\-G\-\_\-\-Q\-U\-E\-R\-Y\-\_\-\-Q\-U\-E\-U\-E\-\_\-\-L\-E\-N\-G\-T\-H@{L\-S\-\_\-\-P\-G\-\_\-\-Q\-U\-E\-R\-Y\-\_\-\-Q\-U\-E\-U\-E\-\_\-\-L\-E\-N\-G\-T\-H}!kvredis.c@{kvredis.\-c}}
\subsubsection[{L\-S\-\_\-\-P\-G\-\_\-\-Q\-U\-E\-R\-Y\-\_\-\-Q\-U\-E\-U\-E\-\_\-\-L\-E\-N\-G\-T\-H}]{\setlength{\rightskip}{0pt plus 5cm}\#define L\-S\-\_\-\-P\-G\-\_\-\-Q\-U\-E\-R\-Y\-\_\-\-Q\-U\-E\-U\-E\-\_\-\-L\-E\-N\-G\-T\-H~512}}\label{kvredis_8c_a08fe83fe8226002ee8b80ce0a914fd11}


Definition at line 12 of file kvredis.\-c.

\hypertarget{kvredis_8c_a3a8ef1b4b5994d6dd12bf74454ea891b}{\index{kvredis.\-c@{kvredis.\-c}!L\-S\-\_\-\-P\-G\-\_\-\-Q\-U\-E\-R\-Y\-\_\-\-S\-T\-R\-I\-N\-G\-\_\-\-L\-E\-N\-G\-T\-H@{L\-S\-\_\-\-P\-G\-\_\-\-Q\-U\-E\-R\-Y\-\_\-\-S\-T\-R\-I\-N\-G\-\_\-\-L\-E\-N\-G\-T\-H}}
\index{L\-S\-\_\-\-P\-G\-\_\-\-Q\-U\-E\-R\-Y\-\_\-\-S\-T\-R\-I\-N\-G\-\_\-\-L\-E\-N\-G\-T\-H@{L\-S\-\_\-\-P\-G\-\_\-\-Q\-U\-E\-R\-Y\-\_\-\-S\-T\-R\-I\-N\-G\-\_\-\-L\-E\-N\-G\-T\-H}!kvredis.c@{kvredis.\-c}}
\subsubsection[{L\-S\-\_\-\-P\-G\-\_\-\-Q\-U\-E\-R\-Y\-\_\-\-S\-T\-R\-I\-N\-G\-\_\-\-L\-E\-N\-G\-T\-H}]{\setlength{\rightskip}{0pt plus 5cm}\#define L\-S\-\_\-\-P\-G\-\_\-\-Q\-U\-E\-R\-Y\-\_\-\-S\-T\-R\-I\-N\-G\-\_\-\-L\-E\-N\-G\-T\-H~512}}\label{kvredis_8c_a3a8ef1b4b5994d6dd12bf74454ea891b}


Definition at line 13 of file kvredis.\-c.

\hypertarget{kvredis_8c_aaf1dd8ba4dafb91c296554c4cbf312e3}{\index{kvredis.\-c@{kvredis.\-c}!L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-D\-L\-E@{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-D\-L\-E}}
\index{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-D\-L\-E@{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-D\-L\-E}!kvredis.c@{kvredis.\-c}}
\subsubsection[{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-D\-L\-E}]{\setlength{\rightskip}{0pt plus 5cm}\#define L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-D\-L\-E~1}}\label{kvredis_8c_aaf1dd8ba4dafb91c296554c4cbf312e3}


Definition at line 19 of file kvredis.\-c.

\hypertarget{kvredis_8c_af443092447378c73bf93aa143576aba4}{\index{kvredis.\-c@{kvredis.\-c}!L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-N\-I\-T@{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-N\-I\-T}}
\index{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-N\-I\-T@{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-N\-I\-T}!kvredis.c@{kvredis.\-c}}
\subsubsection[{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-N\-I\-T}]{\setlength{\rightskip}{0pt plus 5cm}\#define L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-N\-I\-T~-\/4}}\label{kvredis_8c_af443092447378c73bf93aa143576aba4}


Definition at line 15 of file kvredis.\-c.

\hypertarget{kvredis_8c_ae7ea5876846b5f04c419aee22d3c0aa1}{\index{kvredis.\-c@{kvredis.\-c}!L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-N\-I\-T\-\_\-\-P\-O\-L\-L@{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-N\-I\-T\-\_\-\-P\-O\-L\-L}}
\index{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-N\-I\-T\-\_\-\-P\-O\-L\-L@{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-N\-I\-T\-\_\-\-P\-O\-L\-L}!kvredis.c@{kvredis.\-c}}
\subsubsection[{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-N\-I\-T\-\_\-\-P\-O\-L\-L}]{\setlength{\rightskip}{0pt plus 5cm}\#define L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-N\-I\-T\-\_\-\-P\-O\-L\-L~-\/3}}\label{kvredis_8c_ae7ea5876846b5f04c419aee22d3c0aa1}


Definition at line 16 of file kvredis.\-c.

\hypertarget{kvredis_8c_a373e668840b4795ff9a71bc3f744d209}{\index{kvredis.\-c@{kvredis.\-c}!L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-C\-V@{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-C\-V}}
\index{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-C\-V@{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-C\-V}!kvredis.c@{kvredis.\-c}}
\subsubsection[{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-C\-V}]{\setlength{\rightskip}{0pt plus 5cm}\#define L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-C\-V~4}}\label{kvredis_8c_a373e668840b4795ff9a71bc3f744d209}


Definition at line 22 of file kvredis.\-c.

\hypertarget{kvredis_8c_accda8c3a598dc7f5b107b04986d8ab50}{\index{kvredis.\-c@{kvredis.\-c}!L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-S\-E\-T@{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-S\-E\-T}}
\index{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-S\-E\-T@{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-S\-E\-T}!kvredis.c@{kvredis.\-c}}
\subsubsection[{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-S\-E\-T}]{\setlength{\rightskip}{0pt plus 5cm}\#define L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-S\-E\-T~-\/2}}\label{kvredis_8c_accda8c3a598dc7f5b107b04986d8ab50}


Definition at line 17 of file kvredis.\-c.

\hypertarget{kvredis_8c_ac70a1141f3b138055ea7143bd493187c}{\index{kvredis.\-c@{kvredis.\-c}!L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-S\-E\-T\-\_\-\-P\-O\-L\-L@{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-S\-E\-T\-\_\-\-P\-O\-L\-L}}
\index{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-S\-E\-T\-\_\-\-P\-O\-L\-L@{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-S\-E\-T\-\_\-\-P\-O\-L\-L}!kvredis.c@{kvredis.\-c}}
\subsubsection[{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-S\-E\-T\-\_\-\-P\-O\-L\-L}]{\setlength{\rightskip}{0pt plus 5cm}\#define L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-R\-E\-S\-E\-T\-\_\-\-P\-O\-L\-L~-\/1}}\label{kvredis_8c_ac70a1141f3b138055ea7143bd493187c}


Definition at line 18 of file kvredis.\-c.

\hypertarget{kvredis_8c_a3c6eb19f262a990e1f9ba630d9edc309}{\index{kvredis.\-c@{kvredis.\-c}!L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-S\-E\-N\-D@{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-S\-E\-N\-D}}
\index{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-S\-E\-N\-D@{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-S\-E\-N\-D}!kvredis.c@{kvredis.\-c}}
\subsubsection[{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-S\-E\-N\-D}]{\setlength{\rightskip}{0pt plus 5cm}\#define L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-S\-E\-N\-D~2}}\label{kvredis_8c_a3c6eb19f262a990e1f9ba630d9edc309}


Definition at line 20 of file kvredis.\-c.

\hypertarget{kvredis_8c_a88a7e80c12fb0449c4b0857a0c7deb21}{\index{kvredis.\-c@{kvredis.\-c}!L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-S\-E\-N\-D\-\_\-\-F\-L\-U\-S\-H@{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-S\-E\-N\-D\-\_\-\-F\-L\-U\-S\-H}}
\index{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-S\-E\-N\-D\-\_\-\-F\-L\-U\-S\-H@{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-S\-E\-N\-D\-\_\-\-F\-L\-U\-S\-H}!kvredis.c@{kvredis.\-c}}
\subsubsection[{L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-S\-E\-N\-D\-\_\-\-F\-L\-U\-S\-H}]{\setlength{\rightskip}{0pt plus 5cm}\#define L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-S\-E\-N\-D\-\_\-\-F\-L\-U\-S\-H~3}}\label{kvredis_8c_a88a7e80c12fb0449c4b0857a0c7deb21}


Definition at line 21 of file kvredis.\-c.



\subsection{Typedef Documentation}
\hypertarget{kvredis_8c_ae57432c0a6ac48a50457815dab2c5b4c}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-query\-\_\-queue\-\_\-t@{lspg\-\_\-query\-\_\-queue\-\_\-t}}
\index{lspg\-\_\-query\-\_\-queue\-\_\-t@{lspg\-\_\-query\-\_\-queue\-\_\-t}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-query\-\_\-queue\-\_\-t}]{\setlength{\rightskip}{0pt plus 5cm}typedef struct {\bf lspg\-Query\-Queue\-Struct}  {\bf lspg\-\_\-query\-\_\-queue\-\_\-t}}}\label{kvredis_8c_ae57432c0a6ac48a50457815dab2c5b4c}


Store each query along with it's callback function. 

All calls are asynchronous 

\subsection{Function Documentation}
\hypertarget{kvredis_8c_a95668f6d7a4b8882c6a502af3b0a4705}{\index{kvredis.\-c@{kvredis.\-c}!add\-Read@{add\-Read}}
\index{add\-Read@{add\-Read}!kvredis.c@{kvredis.\-c}}
\subsubsection[{add\-Read}]{\setlength{\rightskip}{0pt plus 5cm}void add\-Read (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{data}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_a95668f6d7a4b8882c6a502af3b0a4705}


Definition at line 108 of file kvredis.\-c.


\begin{DoxyCode}
                          \{
  \textcolor{keyword}{struct }pollfd *pfd;
  pfd = (\textcolor{keyword}{struct }pollfd *)data;
  pfd->events |= POLLIN;
\}
\end{DoxyCode}
\hypertarget{kvredis_8c_aacb58922ba249c3e15491826e682023c}{\index{kvredis.\-c@{kvredis.\-c}!add\-Write@{add\-Write}}
\index{add\-Write@{add\-Write}!kvredis.c@{kvredis.\-c}}
\subsubsection[{add\-Write}]{\setlength{\rightskip}{0pt plus 5cm}void add\-Write (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{data}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_aacb58922ba249c3e15491826e682023c}


Definition at line 118 of file kvredis.\-c.


\begin{DoxyCode}
                           \{
  \textcolor{keyword}{struct }pollfd *pfd;
  pfd = (\textcolor{keyword}{struct }pollfd *)data;
  pfd->events |= POLLOUT;
\}
\end{DoxyCode}
\hypertarget{kvredis_8c_a93a6e6dd9f422d01eeaa03d6ba4738a0}{\index{kvredis.\-c@{kvredis.\-c}!cleanup@{cleanup}}
\index{cleanup@{cleanup}!kvredis.c@{kvredis.\-c}}
\subsubsection[{cleanup}]{\setlength{\rightskip}{0pt plus 5cm}void cleanup (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{data}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_a93a6e6dd9f422d01eeaa03d6ba4738a0}


Definition at line 128 of file kvredis.\-c.


\begin{DoxyCode}
                          \{
  \textcolor{keyword}{struct }pollfd *pfd;
  pfd = (\textcolor{keyword}{struct }pollfd *)data;
  pfd->events &= ~(POLLOUT | POLLIN);
\}
\end{DoxyCode}
\hypertarget{kvredis_8c_a5dbdf77c680c97996882abbb6a142321}{\index{kvredis.\-c@{kvredis.\-c}!debug\-C\-B@{debug\-C\-B}}
\index{debug\-C\-B@{debug\-C\-B}!kvredis.c@{kvredis.\-c}}
\subsubsection[{debug\-C\-B}]{\setlength{\rightskip}{0pt plus 5cm}void debug\-C\-B (
\begin{DoxyParamCaption}
\item[{redis\-Async\-Context $\ast$}]{ac, }
\item[{void $\ast$}]{reply, }
\item[{void $\ast$}]{privdata}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_a5dbdf77c680c97996882abbb6a142321}


Definition at line 63 of file kvredis.\-c.


\begin{DoxyCode}
                                                                  \{
  redisReply *r;
  \textcolor{keywordtype}{int} i;

  r = (redisReply *)reply;

  \textcolor{keywordflow}{if}( r == NULL) \{
    printf( \textcolor{stringliteral}{"Null reply.  Odd\(\backslash\)n"});
    \textcolor{keywordflow}{return};
  \}
  
  \textcolor{keywordflow}{switch}( r->type) \{
  \textcolor{keywordflow}{case} REDIS\_REPLY\_STATUS:
    printf( \textcolor{stringliteral}{"STATUS: %s\(\backslash\)n"}, r->str);
    \textcolor{keywordflow}{break};

  \textcolor{keywordflow}{case} REDIS\_REPLY\_ERROR:
    printf( \textcolor{stringliteral}{"ERROR: %s\(\backslash\)n"}, r->str);
    \textcolor{keywordflow}{break};

  \textcolor{keywordflow}{case} REDIS\_REPLY\_INTEGER:
    printf( \textcolor{stringliteral}{"Integer: %lld\(\backslash\)n"}, r->integer);
    \textcolor{keywordflow}{break};

  \textcolor{keywordflow}{case} REDIS\_REPLY\_NIL:
    printf( \textcolor{stringliteral}{"(nil)\(\backslash\)n"});
    \textcolor{keywordflow}{break};

  \textcolor{keywordflow}{case} REDIS\_REPLY\_STRING:
    printf( \textcolor{stringliteral}{"STRING: %s\(\backslash\)n"}, r->str);
    \textcolor{keywordflow}{break};

  \textcolor{keywordflow}{case} REDIS\_REPLY\_ARRAY:
    printf( \textcolor{stringliteral}{"ARRAY of %d elements\(\backslash\)n"}, (\textcolor{keywordtype}{int})r->elements);
    \textcolor{keywordflow}{for}( i=0; i<r->elements; i++)
      \hyperlink{kvredis_8c_a5dbdf77c680c97996882abbb6a142321}{debugCB}( ac, r->element[i], NULL);
    \textcolor{keywordflow}{break};
    
  \textcolor{keywordflow}{default}:
    printf( \textcolor{stringliteral}{"Unknown type %d\(\backslash\)n"}, r->type);
    
  \}

\}
\end{DoxyCode}
\hypertarget{kvredis_8c_ad3f87d428857a2d8e526e2443fadd410}{\index{kvredis.\-c@{kvredis.\-c}!del\-Read@{del\-Read}}
\index{del\-Read@{del\-Read}!kvredis.c@{kvredis.\-c}}
\subsubsection[{del\-Read}]{\setlength{\rightskip}{0pt plus 5cm}void del\-Read (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{data}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_ad3f87d428857a2d8e526e2443fadd410}


Definition at line 113 of file kvredis.\-c.


\begin{DoxyCode}
                          \{
  \textcolor{keyword}{struct }pollfd *pfd;
  pfd = (\textcolor{keyword}{struct }pollfd *)data;
  pfd->events &= ~POLLIN;
\}
\end{DoxyCode}
\hypertarget{kvredis_8c_a5d4f324dd0beeea83848e05550b5cf39}{\index{kvredis.\-c@{kvredis.\-c}!del\-Write@{del\-Write}}
\index{del\-Write@{del\-Write}!kvredis.c@{kvredis.\-c}}
\subsubsection[{del\-Write}]{\setlength{\rightskip}{0pt plus 5cm}void del\-Write (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{data}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_a5d4f324dd0beeea83848e05550b5cf39}


Definition at line 123 of file kvredis.\-c.


\begin{DoxyCode}
                           \{
  \textcolor{keyword}{struct }pollfd *pfd;
  pfd = (\textcolor{keyword}{struct }pollfd *)data;
  pfd->events &= ~POLLOUT;
\}
\end{DoxyCode}
\hypertarget{kvredis_8c_a79856d1a06c278688563be6e5219cee5}{\index{kvredis.\-c@{kvredis.\-c}!fd\-\_\-service@{fd\-\_\-service}}
\index{fd\-\_\-service@{fd\-\_\-service}!kvredis.c@{kvredis.\-c}}
\subsubsection[{fd\-\_\-service}]{\setlength{\rightskip}{0pt plus 5cm}void fd\-\_\-service (
\begin{DoxyParamCaption}
\item[{struct pollfd $\ast$}]{evt}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_a79856d1a06c278688563be6e5219cee5}


Definition at line 634 of file kvredis.\-c.


\begin{DoxyCode}
                                     \{
  \textcolor{keywordflow}{if}( evt->fd == \hyperlink{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}{subac}->c.fd) \{
    \textcolor{keywordflow}{if}( evt->revents & POLLIN)
      redisAsyncHandleRead( \hyperlink{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}{subac});
    \textcolor{keywordflow}{if}( evt->revents & POLLOUT)
      redisAsyncHandleWrite( \hyperlink{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}{subac});
  \}
  \textcolor{keywordflow}{if}( evt->fd == \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}->c.fd) \{
    \textcolor{keywordflow}{if}( evt->revents & POLLIN)
      redisAsyncHandleRead( \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac});
    \textcolor{keywordflow}{if}( evt->revents & POLLOUT)
      redisAsyncHandleWrite( \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac});
  \}
  \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q} && evt->fd == PQsocket( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q}))
    \hyperlink{kvredis_8c_aa8d1fed4b461c2139a21826d524777d5}{lspg\_pg\_service}( evt);
\}
\end{DoxyCode}
\hypertarget{kvredis_8c_afb8d1ff1e0f4fcdc85ad9c684271cb3d}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-allkvs\-\_\-cb@{lspg\-\_\-allkvs\-\_\-cb}}
\index{lspg\-\_\-allkvs\-\_\-cb@{lspg\-\_\-allkvs\-\_\-cb}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-allkvs\-\_\-cb}]{\setlength{\rightskip}{0pt plus 5cm}void lspg\-\_\-allkvs\-\_\-cb (
\begin{DoxyParamCaption}
\item[{{\bf lspg\-\_\-query\-\_\-queue\-\_\-t} $\ast$}]{qqp, }
\item[{P\-Gresult $\ast$}]{pgr}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_afb8d1ff1e0f4fcdc85ad9c684271cb3d}


Definition at line 134 of file kvredis.\-c.


\begin{DoxyCode}
                                                             \{
  \textcolor{keywordtype}{int} kvname\_col, kvvalue\_col, kvseq\_col, kvdbrtype\_col;
  \textcolor{keywordtype}{int} i;
  \textcolor{keywordtype}{int} need\_quotes;
  \textcolor{keywordtype}{int} seq;
  
  kvname\_col    = PQfnumber( pgr, \textcolor{stringliteral}{"rname"});
  kvvalue\_col   = PQfnumber( pgr, \textcolor{stringliteral}{"rvalue"});
  kvseq\_col     = PQfnumber( pgr, \textcolor{stringliteral}{"rseq"});
  kvdbrtype\_col = PQfnumber( pgr, \textcolor{stringliteral}{"rdbrtype"});
  
  \textcolor{keywordflow}{if}( kvname\_col == -1 || kvvalue\_col == -1 || kvseq\_col == -1 || kvdbrtype\_col
       == -1) \{
    fprintf( stderr, \textcolor{stringliteral}{"lspg\_allkvs\_cb: bad column number(s)\(\backslash\)n"});
    \textcolor{keywordflow}{return};
  \}

  redisAsyncCommand( \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}, \hyperlink{kvredis_8c_a5dbdf77c680c97996882abbb6a142321}{debugCB}, NULL, \textcolor{stringliteral}{"MULTI"});
  \textcolor{keywordflow}{for}( i=0; i<PQntuples( pgr); i++) \{
    seq = atoi( PQgetvalue( pgr, i, kvseq\_col));
    \hyperlink{kvredis_8c_a6b15f24b2416f362a9e0039efc586fbb}{kvseq} = \hyperlink{kvredis_8c_a6b15f24b2416f362a9e0039efc586fbb}{kvseq} < seq ? seq : \hyperlink{kvredis_8c_a6b15f24b2416f362a9e0039efc586fbb}{kvseq};

    need\_quotes = strchr( PQgetvalue( pgr, i, kvvalue\_col), \textcolor{charliteral}{' '}) == NULL ? 0 : 
      1;
    redisAsyncCommand( \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}, \hyperlink{kvredis_8c_a5dbdf77c680c97996882abbb6a142321}{debugCB}, NULL, \textcolor{stringliteral}{"HMSET %s VALUE %s%s%s
       SEQ %d DBRTYPE %d"},
                       PQgetvalue( pgr, i, kvname\_col),
                       need\_quotes ? \textcolor{stringliteral}{"\(\backslash\)0x42"} : \textcolor{stringliteral}{""},
                       PQgetvalue( pgr, i, kvvalue\_col),
                       need\_quotes ? \textcolor{stringliteral}{"\(\backslash\)0x42"} : \textcolor{stringliteral}{""},
                       atoi(PQgetvalue( pgr, i, kvseq\_col)),
                       atoi(PQgetvalue( pgr, i, kvdbrtype\_col))
                       );
    \textcolor{keywordflow}{if}( need\_quotes)
      fprintf( stderr, \textcolor{stringliteral}{"lspg\_allkvs\_cb: %s %s\(\backslash\)n"}, PQgetvalue( pgr, i, 
      kvname\_col), PQgetvalue( pgr, i, kvvalue\_col));


  \}

  redisAsyncCommand( \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}, NULL, NULL, \textcolor{stringliteral}{"SET redis.kvseq %d"}, \hyperlink{kvredis_8c_a6b15f24b2416f362a9e0039efc586fbb}{kvseq});
  redisAsyncCommand( \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}, \hyperlink{kvredis_8c_a5dbdf77c680c97996882abbb6a142321}{debugCB}, NULL, \textcolor{stringliteral}{"EXEC"});
  
  \textcolor{keywordflow}{for}( i=0; i<PQntuples( pgr); i++) \{
    redisAsyncCommand( \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}, \hyperlink{kvredis_8c_a5dbdf77c680c97996882abbb6a142321}{debugCB}, NULL, \textcolor{stringliteral}{"PUBLISH
       REDIS\_KV\_CONNECTOR '%s %s'"}, PQgetvalue( pgr, i, kvname\_col), PQgetvalue( pgr, i, kvseq\_col))
      ;
  \}
\}
\end{DoxyCode}
\hypertarget{kvredis_8c_af6485ac1749c5de3008dd0e0badaa09c}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-flush@{lspg\-\_\-flush}}
\index{lspg\-\_\-flush@{lspg\-\_\-flush}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-flush}]{\setlength{\rightskip}{0pt plus 5cm}void lspg\-\_\-flush (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_af6485ac1749c5de3008dd0e0badaa09c}


Flush psql output buffer (ie, send the query) 



Definition at line 410 of file kvredis.\-c.


\begin{DoxyCode}
                  \{
  \textcolor{keywordtype}{int} err;

  err = PQflush( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q});
  \textcolor{keywordflow}{switch}( err) \{
  \textcolor{keywordflow}{case} -1:
    \textcolor{comment}{// an error occured}

    fprintf( stderr, \textcolor{stringliteral}{"flush failed: %s\(\backslash\)n"}, PQerrorMessage( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q}));

    \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_aaf1dd8ba4dafb91c296554c4cbf312e3}{LS\_PG\_STATE\_IDLE};
    \textcolor{comment}{//}
    \textcolor{comment}{// We should probably reset the connection and start from scratch. 
       Probably the connection died.}
    \textcolor{comment}{//}
    \textcolor{keywordflow}{break};
          
  \textcolor{keywordflow}{case} 0:
    \textcolor{comment}{// goodness and joy.}
    \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_a373e668840b4795ff9a71bc3f744d209}{LS\_PG\_STATE\_RECV};
    \textcolor{keywordflow}{break};

  \textcolor{keywordflow}{case} 1:
    \textcolor{comment}{// more sending to do}
    \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_a88a7e80c12fb0449c4b0857a0c7deb21}{LS\_PG\_STATE\_SEND\_FLUSH};
    \textcolor{keywordflow}{break};
  \}
\}
\end{DoxyCode}
\hypertarget{kvredis_8c_ab52a8c8245bf6561f40c0f224fc07ff4}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-next\-\_\-state@{lspg\-\_\-next\-\_\-state}}
\index{lspg\-\_\-next\-\_\-state@{lspg\-\_\-next\-\_\-state}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-next\-\_\-state}]{\setlength{\rightskip}{0pt plus 5cm}void lspg\-\_\-next\-\_\-state (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_ab52a8c8245bf6561f40c0f224fc07ff4}


Implements our state machine Does not strictly only set the next state as it also calls some functions that, perhaps, alters the state mid-\/function. 



Definition at line 442 of file kvredis.\-c.


\begin{DoxyCode}
                       \{
  \textcolor{comment}{//}
  \textcolor{comment}{// connect to the database}
  \textcolor{comment}{//}
  \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q} == NULL ||
      \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} == \hyperlink{kvredis_8c_af443092447378c73bf93aa143576aba4}{LS\_PG\_STATE\_INIT} ||
      \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} == \hyperlink{kvredis_8c_accda8c3a598dc7f5b107b04986d8ab50}{LS\_PG\_STATE\_RESET} ||
      \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} == \hyperlink{kvredis_8c_ae7ea5876846b5f04c419aee22d3c0aa1}{LS\_PG\_STATE\_INIT\_POLL} ||
      \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} == \hyperlink{kvredis_8c_ac70a1141f3b138055ea7143bd493187c}{LS\_PG\_STATE\_RESET\_POLL})
    \hyperlink{kvredis_8c_a581c18be0368425665a40b4b7f7d9714}{lspg\_pg\_connect}( \hyperlink{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}{lspgfd});


  \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} == \hyperlink{kvredis_8c_aaf1dd8ba4dafb91c296554c4cbf312e3}{LS\_PG\_STATE\_IDLE} && 
      \hyperlink{kvredis_8c_a3cbe7f3161b3c1838ebc56a3bbcfd8a6}{lspg\_query\_queue\_on} != \hyperlink{kvredis_8c_aca86bb77d6cecfae9251743f4171bafb}{lspg\_query\_queue\_off}
      )
    \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_a3c6eb19f262a990e1f9ba630d9edc309}{LS\_PG\_STATE\_SEND};

  \textcolor{keywordflow}{switch}( \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state}) \{
  \textcolor{keywordflow}{case} \hyperlink{kvredis_8c_ae7ea5876846b5f04c419aee22d3c0aa1}{LS\_PG\_STATE\_INIT\_POLL}:
    \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a69ae04978986e6413ca7cefcb692b645}{lspg\_connectPoll\_response} == 
      PGRES\_POLLING\_WRITING)
      \hyperlink{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}{lspgfd}.events = POLLOUT;
    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a69ae04978986e6413ca7cefcb692b645}{lspg\_connectPoll\_response} == 
      PGRES\_POLLING\_READING)
      \hyperlink{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}{lspgfd}.events = POLLIN;
    \textcolor{keywordflow}{else}
      \hyperlink{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}{lspgfd}.events = 0;
    \textcolor{keywordflow}{break};
      
  \textcolor{keywordflow}{case} \hyperlink{kvredis_8c_ac70a1141f3b138055ea7143bd493187c}{LS\_PG\_STATE\_RESET\_POLL}:
    \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a06c5a937e41a6c706a247777642ec1fb}{lspg\_resetPoll\_response} == PGRES\_POLLING\_WRITING
      )
      \hyperlink{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}{lspgfd}.events = POLLOUT;
    \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a06c5a937e41a6c706a247777642ec1fb}{lspg\_resetPoll\_response} == 
      PGRES\_POLLING\_READING)
      \hyperlink{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}{lspgfd}.events = POLLIN;
    \textcolor{keywordflow}{else}
      \hyperlink{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}{lspgfd}.events = 0;
    \textcolor{keywordflow}{break};

  \textcolor{keywordflow}{case} \hyperlink{kvredis_8c_aaf1dd8ba4dafb91c296554c4cbf312e3}{LS\_PG\_STATE\_IDLE}:
  \textcolor{keywordflow}{case} \hyperlink{kvredis_8c_a373e668840b4795ff9a71bc3f744d209}{LS\_PG\_STATE\_RECV}:
    \hyperlink{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}{lspgfd}.events = POLLIN;
    \textcolor{keywordflow}{break};

  \textcolor{keywordflow}{case} \hyperlink{kvredis_8c_a3c6eb19f262a990e1f9ba630d9edc309}{LS\_PG\_STATE\_SEND}:
  \textcolor{keywordflow}{case} \hyperlink{kvredis_8c_a88a7e80c12fb0449c4b0857a0c7deb21}{LS\_PG\_STATE\_SEND\_FLUSH}:
    \hyperlink{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}{lspgfd}.events = POLLOUT;
    \textcolor{keywordflow}{break};

  \textcolor{keywordflow}{default}:
    \hyperlink{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}{lspgfd}.events = 0;
  \}
\}
\end{DoxyCode}
\hypertarget{kvredis_8c_a62b110949d206fb22789191207e1d066}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-notice\-\_\-processor@{lspg\-\_\-notice\-\_\-processor}}
\index{lspg\-\_\-notice\-\_\-processor@{lspg\-\_\-notice\-\_\-processor}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-notice\-\_\-processor}]{\setlength{\rightskip}{0pt plus 5cm}P\-Qnotice\-Processor lspg\-\_\-notice\-\_\-processor (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{arg, }
\item[{const char $\ast$}]{msg}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_a62b110949d206fb22789191207e1d066}


Definition at line 180 of file kvredis.\-c.


\begin{DoxyCode}
                                                                     \{
  fprintf( stderr, \textcolor{stringliteral}{"lspg: %s"}, msg);
\}
\end{DoxyCode}
\hypertarget{kvredis_8c_a581c18be0368425665a40b4b7f7d9714}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-pg\-\_\-connect@{lspg\-\_\-pg\-\_\-connect}}
\index{lspg\-\_\-pg\-\_\-connect@{lspg\-\_\-pg\-\_\-connect}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-pg\-\_\-connect}]{\setlength{\rightskip}{0pt plus 5cm}void lspg\-\_\-pg\-\_\-connect (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_a581c18be0368425665a40b4b7f7d9714}


Connect to the pg server. 



Definition at line 323 of file kvredis.\-c.


\begin{DoxyCode}
                       \{
  PGresult *pgr;
  \textcolor{keywordtype}{int} wait\_interval = 1;
  \textcolor{keywordtype}{int} connection\_init = 0;
  \textcolor{keywordtype}{int} i, err;

  \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q} == NULL)
    \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_af443092447378c73bf93aa143576aba4}{LS\_PG\_STATE\_INIT};

  \textcolor{keywordflow}{switch}( \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state}) \{
  \textcolor{keywordflow}{case} \hyperlink{kvredis_8c_af443092447378c73bf93aa143576aba4}{LS\_PG\_STATE\_INIT}:

    \textcolor{keywordflow}{if}( lspg\_time\_sent.tv\_sec != 0) \{
      \textcolor{comment}{//}
      \textcolor{comment}{// Reality check: if it's less the about 10 seconds since the last failed
       attempt}
      \textcolor{comment}{// the just chill.}
      \textcolor{comment}{//}
      gettimeofday( &\hyperlink{kvredis_8c_ad40ac52086f6b774928af45b09d54c6e}{now}, NULL);
      \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_sec - lspg\_time\_sent.tv\_sec < 10) \{
        \textcolor{keywordflow}{return};
      \}
    \}

    \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q} = PQconnectStart( \textcolor{stringliteral}{"dbname=ls user=lsuser hostaddr=10.1.0.3"});
    \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q} == NULL) \{
      fprintf( stderr, \textcolor{stringliteral}{"Out of memory (lspg\_pg\_connect)"});
      exit( -1);
    \}

    err = PQstatus( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q});
    \textcolor{keywordflow}{if}( err == CONNECTION\_BAD) \{
      fprintf( stderr, \textcolor{stringliteral}{"Trouble connecting to database"});

      gettimeofday( &lspg\_time\_sent, NULL);
      \textcolor{keywordflow}{return};
    \}
    err = PQsetnonblocking( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q}, 1);
    \textcolor{keywordflow}{if}( err != 0) \{
      fprintf( stderr, \textcolor{stringliteral}{"Odd, could not set database connection to nonblocking"})
      ;
    \}

    \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_ae7ea5876846b5f04c419aee22d3c0aa1}{LS\_PG\_STATE\_INIT\_POLL};
    \hyperlink{kvredis_8c_a69ae04978986e6413ca7cefcb692b645}{lspg\_connectPoll\_response} = PGRES\_POLLING\_WRITING;
    \textcolor{comment}{//}
    \textcolor{comment}{// set up the connection for poll}
    \textcolor{comment}{//}
    \hyperlink{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}{lspgfd}.fd = PQsocket( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q});
    \textcolor{keywordflow}{break};

  \textcolor{keywordflow}{case} \hyperlink{kvredis_8c_ae7ea5876846b5f04c419aee22d3c0aa1}{LS\_PG\_STATE\_INIT\_POLL}:
    \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a69ae04978986e6413ca7cefcb692b645}{lspg\_connectPoll\_response} == 
      PGRES\_POLLING\_FAILED) \{
      PQfinish( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q});
      \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q} = NULL;
      \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_af443092447378c73bf93aa143576aba4}{LS\_PG\_STATE\_INIT};
    \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a69ae04978986e6413ca7cefcb692b645}{lspg\_connectPoll\_response} == 
      PGRES\_POLLING\_OK) \{
      PQsetNoticeProcessor( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q}, (PQnoticeProcessor)\hyperlink{kvredis_8c_a62b110949d206fb22789191207e1d066}{lspg\_notice\_processor}
      , NULL);

      \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_aaf1dd8ba4dafb91c296554c4cbf312e3}{LS\_PG\_STATE\_IDLE};
    \}
    \textcolor{keywordflow}{break};

  \textcolor{keywordflow}{case} \hyperlink{kvredis_8c_accda8c3a598dc7f5b107b04986d8ab50}{LS\_PG\_STATE\_RESET}:
    err = PQresetStart( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q});
    \textcolor{keywordflow}{if}( err == 0) \{
      PQfinish( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q});
      \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q} = NULL;
      \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_af443092447378c73bf93aa143576aba4}{LS\_PG\_STATE\_INIT};
    \} \textcolor{keywordflow}{else} \{
      \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_ac70a1141f3b138055ea7143bd493187c}{LS\_PG\_STATE\_RESET\_POLL};
      \hyperlink{kvredis_8c_a06c5a937e41a6c706a247777642ec1fb}{lspg\_resetPoll\_response} = PGRES\_POLLING\_WRITING;
    \}
    \textcolor{keywordflow}{break};

  \textcolor{keywordflow}{case} \hyperlink{kvredis_8c_ac70a1141f3b138055ea7143bd493187c}{LS\_PG\_STATE\_RESET\_POLL}:
    \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a06c5a937e41a6c706a247777642ec1fb}{lspg\_resetPoll\_response} == PGRES\_POLLING\_FAILED)
       \{
      PQfinish( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q});
      \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q} = NULL;
      \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_af443092447378c73bf93aa143576aba4}{LS\_PG\_STATE\_INIT};
    \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a06c5a937e41a6c706a247777642ec1fb}{lspg\_resetPoll\_response} == 
      PGRES\_POLLING\_OK) \{
      \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_aaf1dd8ba4dafb91c296554c4cbf312e3}{LS\_PG\_STATE\_IDLE};
    \}
    \textcolor{keywordflow}{break};
  \}
\}
\end{DoxyCode}
\hypertarget{kvredis_8c_aa8d1fed4b461c2139a21826d524777d5}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-pg\-\_\-service@{lspg\-\_\-pg\-\_\-service}}
\index{lspg\-\_\-pg\-\_\-service@{lspg\-\_\-pg\-\_\-service}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-pg\-\_\-service}]{\setlength{\rightskip}{0pt plus 5cm}void lspg\-\_\-pg\-\_\-service (
\begin{DoxyParamCaption}
\item[{struct pollfd $\ast$}]{evt}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_aa8d1fed4b461c2139a21826d524777d5}


I/\-O control to/from the postgresql server. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em evt} & The pollfd object that we are responding to \\
\hline
\end{DoxyParams}


Definition at line 541 of file kvredis.\-c.


\begin{DoxyCode}
                       \{
  \textcolor{comment}{//}
  \textcolor{comment}{// Currently just used to check for notifies}
  \textcolor{comment}{// Other socket communication is done syncronously}
  \textcolor{comment}{//}

  \textcolor{keywordflow}{if}( evt->revents & POLLIN) \{
    \textcolor{keywordtype}{int} err;

    \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} == \hyperlink{kvredis_8c_ae7ea5876846b5f04c419aee22d3c0aa1}{LS\_PG\_STATE\_INIT\_POLL}) \{
      \hyperlink{kvredis_8c_a69ae04978986e6413ca7cefcb692b645}{lspg\_connectPoll\_response} = PQconnectPoll( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q});
      \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a69ae04978986e6413ca7cefcb692b645}{lspg\_connectPoll\_response} == 
      PGRES\_POLLING\_FAILED) \{
        \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_accda8c3a598dc7f5b107b04986d8ab50}{LS\_PG\_STATE\_RESET};
      \}
      \textcolor{keywordflow}{return};
    \}

    \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} == \hyperlink{kvredis_8c_ac70a1141f3b138055ea7143bd493187c}{LS\_PG\_STATE\_RESET\_POLL})
       \{
      \hyperlink{kvredis_8c_a06c5a937e41a6c706a247777642ec1fb}{lspg\_resetPoll\_response} = PQresetPoll( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q});
      \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a06c5a937e41a6c706a247777642ec1fb}{lspg\_resetPoll\_response} == 
      PGRES\_POLLING\_FAILED) \{
        \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_accda8c3a598dc7f5b107b04986d8ab50}{LS\_PG\_STATE\_RESET};
      \}
      \textcolor{keywordflow}{return};
    \}


    \textcolor{comment}{//}
    \textcolor{comment}{// if in IDLE or RECV we need to call consumeInput first}
    \textcolor{comment}{//}
    \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} == \hyperlink{kvredis_8c_aaf1dd8ba4dafb91c296554c4cbf312e3}{LS\_PG\_STATE\_IDLE}) \{
      err = PQconsumeInput( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q});
      \textcolor{keywordflow}{if}( err != 1) \{
        fprintf( stderr, \textcolor{stringliteral}{"consume input failed: %s"}, PQerrorMessage( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q}));
        \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} == \hyperlink{kvredis_8c_accda8c3a598dc7f5b107b04986d8ab50}{LS\_PG\_STATE\_RESET};
        \textcolor{keywordflow}{return};
      \}
    \}      

    \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} == \hyperlink{kvredis_8c_a373e668840b4795ff9a71bc3f744d209}{LS\_PG\_STATE\_RECV}) \{
      \hyperlink{kvredis_8c_a038c5af23469b789fc1c55d21cb43029}{lspg\_receive}();
    \}

    \textcolor{comment}{//}
    \textcolor{comment}{// Check for notifies regardless of our state}
    \textcolor{comment}{// Push as many requests as we have notifies.}
    \textcolor{comment}{//}
    \{
      PGnotify *pgn;

      \textcolor{keywordflow}{while}( 1) \{
        pgn = PQnotifies( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q});
        \textcolor{keywordflow}{if}( pgn == NULL)
          \textcolor{keywordflow}{break};
        
        \hyperlink{kvredis_8c_a0bb9ef42da8fa21c4df48ec384ab69f4}{lspg\_query\_push}( \hyperlink{kvredis_8c_afb8d1ff1e0f4fcdc85ad9c684271cb3d}{lspg\_allkvs\_cb}, \textcolor{stringliteral}{"SELECT *
       FROM px.redis\_kv\_update(%d)"}, \hyperlink{kvredis_8c_a6b15f24b2416f362a9e0039efc586fbb}{kvseq});

        PQfreemem( pgn);
      \}
    \}
  \}

  \textcolor{keywordflow}{if}( evt->revents & POLLOUT) \{

    \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} == \hyperlink{kvredis_8c_ae7ea5876846b5f04c419aee22d3c0aa1}{LS\_PG\_STATE\_INIT\_POLL}) \{
      \hyperlink{kvredis_8c_a69ae04978986e6413ca7cefcb692b645}{lspg\_connectPoll\_response} = PQconnectPoll( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q});
      \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a69ae04978986e6413ca7cefcb692b645}{lspg\_connectPoll\_response} == 
      PGRES\_POLLING\_FAILED) \{
        \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_accda8c3a598dc7f5b107b04986d8ab50}{LS\_PG\_STATE\_RESET};
      \}
      \textcolor{keywordflow}{return};
    \}

    \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} == \hyperlink{kvredis_8c_ac70a1141f3b138055ea7143bd493187c}{LS\_PG\_STATE\_RESET\_POLL})
       \{
      \hyperlink{kvredis_8c_a06c5a937e41a6c706a247777642ec1fb}{lspg\_resetPoll\_response} = PQresetPoll( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q});
      \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a06c5a937e41a6c706a247777642ec1fb}{lspg\_resetPoll\_response} == 
      PGRES\_POLLING\_FAILED) \{
        \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_accda8c3a598dc7f5b107b04986d8ab50}{LS\_PG\_STATE\_RESET};
      \}
      \textcolor{keywordflow}{return};
    \}


    \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} == \hyperlink{kvredis_8c_a3c6eb19f262a990e1f9ba630d9edc309}{LS\_PG\_STATE\_SEND}) \{
      \hyperlink{kvredis_8c_a714b15e117ffe7bfce4f2f2ce4725b0a}{lspg\_send\_next\_query}();
    \}

    \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} == \hyperlink{kvredis_8c_a88a7e80c12fb0449c4b0857a0c7deb21}{LS\_PG\_STATE\_SEND\_FLUSH})
       \{
      \hyperlink{kvredis_8c_af6485ac1749c5de3008dd0e0badaa09c}{lspg\_flush}();
    \}
  \}
\}
\end{DoxyCode}
\hypertarget{kvredis_8c_ad5f3ec8f197cc330c83dba70f310533c}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-query\-\_\-next@{lspg\-\_\-query\-\_\-next}}
\index{lspg\-\_\-query\-\_\-next@{lspg\-\_\-query\-\_\-next}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-query\-\_\-next}]{\setlength{\rightskip}{0pt plus 5cm}{\bf lspg\-\_\-query\-\_\-queue\-\_\-t}$\ast$ lspg\-\_\-query\-\_\-next (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_ad5f3ec8f197cc330c83dba70f310533c}


Return the next item in the postgresql queue. 

If there is an item left in the queue then it is returned. Otherwise, N\-U\-L\-L is returned. 

Definition at line 189 of file kvredis.\-c.


\begin{DoxyCode}
                                      \{
  \hyperlink{structlspgQueryQueueStruct}{lspg\_query\_queue\_t} *rtn;
  
  \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_aca86bb77d6cecfae9251743f4171bafb}{lspg\_query\_queue\_off} == \hyperlink{kvredis_8c_a3cbe7f3161b3c1838ebc56a3bbcfd8a6}{lspg\_query\_queue\_on}
      )
    \textcolor{comment}{// Queue is empty}
    rtn = NULL;
  \textcolor{keywordflow}{else} \{
    rtn = &(\hyperlink{kvredis_8c_a357d9d98f0b8c9625ccebcebfcdce955}{lspg\_query\_queue}[(\hyperlink{kvredis_8c_aca86bb77d6cecfae9251743f4171bafb}{lspg\_query\_queue\_off}
      ++) % \hyperlink{kvredis_8c_a08fe83fe8226002ee8b80ce0a914fd11}{LS\_PG\_QUERY\_QUEUE\_LENGTH}]); 

  \}
  \textcolor{keywordflow}{return} rtn;
\}
\end{DoxyCode}
\hypertarget{kvredis_8c_a0bb9ef42da8fa21c4df48ec384ab69f4}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-query\-\_\-push@{lspg\-\_\-query\-\_\-push}}
\index{lspg\-\_\-query\-\_\-push@{lspg\-\_\-query\-\_\-push}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-query\-\_\-push}]{\setlength{\rightskip}{0pt plus 5cm}void lspg\-\_\-query\-\_\-push (
\begin{DoxyParamCaption}
\item[{void($\ast$)({\bf lspg\-\_\-query\-\_\-queue\-\_\-t} $\ast$, P\-Gresult $\ast$)}]{cb, }
\item[{char $\ast$}]{fmt, }
\item[{}]{...}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_a0bb9ef42da8fa21c4df48ec384ab69f4}


Place a query on the queue. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em cb} & Our callback function that deals with the response \\
\hline
\mbox{\tt in}  & {\em fmt} & Printf style function to generate the query \\
\hline
\end{DoxyParams}


Definition at line 232 of file kvredis.\-c.


\begin{DoxyCode}
                       \{
  \textcolor{keywordtype}{int} idx;
  va\_list arg\_ptr;


  \textcolor{comment}{//}
  \textcolor{comment}{// Pause the thread while we service the queue}
  \textcolor{comment}{//}
  \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a3cbe7f3161b3c1838ebc56a3bbcfd8a6}{lspg\_query\_queue\_on} + 1 == \hyperlink{kvredis_8c_aca86bb77d6cecfae9251743f4171bafb}{lspg\_query\_queue\_off}
      ) \{
    fprintf( stderr, \textcolor{stringliteral}{"lspg\_query\_push: queue is full.  Ignoring query \(\backslash\)"%s\(\backslash\)"\(\backslash\)n"}
      , fmt);
    \textcolor{keywordflow}{return};
  \}

  idx = \hyperlink{kvredis_8c_a3cbe7f3161b3c1838ebc56a3bbcfd8a6}{lspg\_query\_queue\_on} % \hyperlink{kvredis_8c_a08fe83fe8226002ee8b80ce0a914fd11}{LS\_PG\_QUERY\_QUEUE\_LENGTH}
      ;

  va\_start( arg\_ptr, fmt);
  vsnprintf( \hyperlink{kvredis_8c_a357d9d98f0b8c9625ccebcebfcdce955}{lspg\_query\_queue}[idx].qs, \hyperlink{kvredis_8c_a3a8ef1b4b5994d6dd12bf74454ea891b}{
      LS\_PG\_QUERY\_STRING\_LENGTH}-1, fmt, arg\_ptr);
  va\_end( arg\_ptr);

  \hyperlink{kvredis_8c_a357d9d98f0b8c9625ccebcebfcdce955}{lspg\_query\_queue}[idx].\hyperlink{structlspgQueryQueueStruct_a1389b3ec4ddf9ed5cc0344d229a7ff9e}{qs}[\hyperlink{kvredis_8c_a3a8ef1b4b5994d6dd12bf74454ea891b}{LS\_PG\_QUERY\_STRING\_LENGTH}
       - 1] = 0;
  \hyperlink{kvredis_8c_a357d9d98f0b8c9625ccebcebfcdce955}{lspg\_query\_queue}[idx].\hyperlink{structlspgQueryQueueStruct_a53bac5ae4cab775423940bff5092a831}{onResponse} = cb;
  \hyperlink{kvredis_8c_a3cbe7f3161b3c1838ebc56a3bbcfd8a6}{lspg\_query\_queue\_on}++;

\};
\end{DoxyCode}
\hypertarget{kvredis_8c_a3847589e641f7e16a0cd68ef30e37cca}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-query\-\_\-reply\-\_\-next@{lspg\-\_\-query\-\_\-reply\-\_\-next}}
\index{lspg\-\_\-query\-\_\-reply\-\_\-next@{lspg\-\_\-query\-\_\-reply\-\_\-next}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-query\-\_\-reply\-\_\-next}]{\setlength{\rightskip}{0pt plus 5cm}void lspg\-\_\-query\-\_\-reply\-\_\-next (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_a3847589e641f7e16a0cd68ef30e37cca}


Remove the oldest item in the queue. 

this is called only when there is nothing else to service the reply\-: this pop does not return anything. We use the ...reply\-\_\-peek function to return the next item in the reply queue 

Definition at line 209 of file kvredis.\-c.


\begin{DoxyCode}
                             \{

  \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a2603b071afdbff7c0924b13de2454264}{lspg\_query\_queue\_reply} != \hyperlink{kvredis_8c_a3cbe7f3161b3c1838ebc56a3bbcfd8a6}{lspg\_query\_queue\_on}
      )
    \hyperlink{kvredis_8c_a2603b071afdbff7c0924b13de2454264}{lspg\_query\_queue\_reply}++;

\}
\end{DoxyCode}
\hypertarget{kvredis_8c_ae6bf4f54117bedf903360883bb32699f}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-query\-\_\-reply\-\_\-peek@{lspg\-\_\-query\-\_\-reply\-\_\-peek}}
\index{lspg\-\_\-query\-\_\-reply\-\_\-peek@{lspg\-\_\-query\-\_\-reply\-\_\-peek}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-query\-\_\-reply\-\_\-peek}]{\setlength{\rightskip}{0pt plus 5cm}{\bf lspg\-\_\-query\-\_\-queue\-\_\-t}$\ast$ lspg\-\_\-query\-\_\-reply\-\_\-peek (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_ae6bf4f54117bedf903360883bb32699f}


Return the next item in the reply queue but don't pop it since we may need it more than once. 

Call \hyperlink{kvredis_8c_a3847589e641f7e16a0cd68ef30e37cca}{lspg\-\_\-query\-\_\-reply\-\_\-next()} when done. 

Definition at line 219 of file kvredis.\-c.


\begin{DoxyCode}
                                            \{
  \hyperlink{structlspgQueryQueueStruct}{lspg\_query\_queue\_t} *rtn;

  \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a2603b071afdbff7c0924b13de2454264}{lspg\_query\_queue\_reply} == \hyperlink{kvredis_8c_a3cbe7f3161b3c1838ebc56a3bbcfd8a6}{lspg\_query\_queue\_on}
      )
    rtn = NULL;
  \textcolor{keywordflow}{else}
    rtn = &(\hyperlink{kvredis_8c_a357d9d98f0b8c9625ccebcebfcdce955}{lspg\_query\_queue}[(\hyperlink{kvredis_8c_a2603b071afdbff7c0924b13de2454264}{lspg\_query\_queue\_reply}
      ) % \hyperlink{kvredis_8c_a08fe83fe8226002ee8b80ce0a914fd11}{LS\_PG\_QUERY\_QUEUE\_LENGTH}]);

  \textcolor{keywordflow}{return} rtn;
\}
\end{DoxyCode}
\hypertarget{kvredis_8c_a038c5af23469b789fc1c55d21cb43029}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-receive@{lspg\-\_\-receive}}
\index{lspg\-\_\-receive@{lspg\-\_\-receive}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-receive}]{\setlength{\rightskip}{0pt plus 5cm}void lspg\-\_\-receive (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_a038c5af23469b789fc1c55d21cb43029}


Receive a result of a query. 



Definition at line 264 of file kvredis.\-c.


\begin{DoxyCode}
                    \{
  PGresult *pgr;
  \hyperlink{structlspgQueryQueueStruct}{lspg\_query\_queue\_t} *qqp;
  \textcolor{keywordtype}{int} err;

  err = PQconsumeInput( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q});
  \textcolor{keywordflow}{if}( err != 1) \{
    fprintf( stderr, \textcolor{stringliteral}{"consume input failed: %s"}, PQerrorMessage( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q}));
    \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} == \hyperlink{kvredis_8c_accda8c3a598dc7f5b107b04986d8ab50}{LS\_PG\_STATE\_RESET};
    \textcolor{keywordflow}{return};
  \}

  \textcolor{comment}{//}
  \textcolor{comment}{// We must call PQgetResult until it returns NULL before sending the next
       query}
  \textcolor{comment}{// This implies that only one query can ever be active at a time and our
       queue}
  \textcolor{comment}{// management should be simple}
  \textcolor{comment}{//}
  \textcolor{comment}{// We should be in the LS\_PG\_STATE\_RECV here}
  \textcolor{comment}{//}

  \textcolor{keywordflow}{while}( !PQisBusy( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q})) \{
    pgr = PQgetResult( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q});
    \textcolor{keywordflow}{if}( pgr == NULL) \{
      \hyperlink{kvredis_8c_a3847589e641f7e16a0cd68ef30e37cca}{lspg\_query\_reply\_next}();
      \textcolor{comment}{//}
      \textcolor{comment}{// we are now done reading the response from the database}
      \textcolor{comment}{//}
      \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_aaf1dd8ba4dafb91c296554c4cbf312e3}{LS\_PG\_STATE\_IDLE};
      \textcolor{keywordflow}{break};
    \} \textcolor{keywordflow}{else} \{
      ExecStatusType es;

      qqp = \hyperlink{kvredis_8c_ae6bf4f54117bedf903360883bb32699f}{lspg\_query\_reply\_peek}();
      es = PQresultStatus( pgr);

      \textcolor{keywordflow}{if}( es != PGRES\_COMMAND\_OK && es != PGRES\_TUPLES\_OK) \{
        \textcolor{keywordtype}{char} *emess;
        emess = PQresultErrorMessage( pgr);
        \textcolor{keywordflow}{if}( emess != NULL && emess[0] != 0) \{
          fprintf( stderr, \textcolor{stringliteral}{"Error from query '%s':\(\backslash\)n%s"}, qqp->\hyperlink{structlspgQueryQueueStruct_a1389b3ec4ddf9ed5cc0344d229a7ff9e}{qs}, emess);
        \}
      \} \textcolor{keywordflow}{else} \{
        \textcolor{comment}{//}
        \textcolor{comment}{// Deal with the response}
        \textcolor{comment}{//}
        \textcolor{comment}{// If the response is likely to take awhile we should probably}
        \textcolor{comment}{// add a new state and put something in the main look to run the
       onResponse}
        \textcolor{comment}{// routine in the main loop.  For now, though, we only expect very
       brief onResponse routines}
        \textcolor{comment}{//}
        \textcolor{keywordflow}{if}( qqp != NULL && qqp->\hyperlink{structlspgQueryQueueStruct_a53bac5ae4cab775423940bff5092a831}{onResponse} != NULL)
          qqp->\hyperlink{structlspgQueryQueueStruct_a53bac5ae4cab775423940bff5092a831}{onResponse}( qqp, pgr);
      \}
      PQclear( pgr);
    \}
  \}
\}
\end{DoxyCode}
\hypertarget{kvredis_8c_a714b15e117ffe7bfce4f2f2ce4725b0a}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-send\-\_\-next\-\_\-query@{lspg\-\_\-send\-\_\-next\-\_\-query}}
\index{lspg\-\_\-send\-\_\-next\-\_\-query@{lspg\-\_\-send\-\_\-next\-\_\-query}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-send\-\_\-next\-\_\-query}]{\setlength{\rightskip}{0pt plus 5cm}void lspg\-\_\-send\-\_\-next\-\_\-query (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_a714b15e117ffe7bfce4f2f2ce4725b0a}


send the next queued query to the D\-B server 



Definition at line 494 of file kvredis.\-c.


\begin{DoxyCode}
                            \{
  \textcolor{comment}{//}
  \textcolor{comment}{// Normally we should be in the "send" state}
  \textcolor{comment}{// but we can also send if we are servicing}
  \textcolor{comment}{// a reply}
  \textcolor{comment}{//}

  \hyperlink{structlspgQueryQueueStruct}{lspg\_query\_queue\_t} *qqp;
  \textcolor{keywordtype}{int} err;

  qqp = \hyperlink{kvredis_8c_ad5f3ec8f197cc330c83dba70f310533c}{lspg\_query\_next}();
  \textcolor{keywordflow}{if}( qqp == NULL) \{
    \textcolor{comment}{//}
    \textcolor{comment}{// A send without a query?  Should never happen.}
    \textcolor{comment}{// But at least we shouldn't segfault if it does.}
    \textcolor{comment}{//}
    \textcolor{keywordflow}{return};
  \}

  \textcolor{keywordflow}{if}( qqp->\hyperlink{structlspgQueryQueueStruct_a1389b3ec4ddf9ed5cc0344d229a7ff9e}{qs}[0] == 0) \{
    \textcolor{comment}{//}
    \textcolor{comment}{// Do we really have to check this case?}
    \textcolor{comment}{// It would only come up if we stupidly pushed an empty query string}
    \textcolor{comment}{// or ran off the end of the queue}
    \textcolor{comment}{//}
    fprintf( stderr, \textcolor{stringliteral}{"Popped empty query string.  Probably bad things are going
       on.\(\backslash\)n"});

    \hyperlink{kvredis_8c_a3847589e641f7e16a0cd68ef30e37cca}{lspg\_query\_reply\_next}();
    \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_aaf1dd8ba4dafb91c296554c4cbf312e3}{LS\_PG\_STATE\_IDLE};
  \} \textcolor{keywordflow}{else} \{
    err = PQsendQuery( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q}, qqp->\hyperlink{structlspgQueryQueueStruct_a1389b3ec4ddf9ed5cc0344d229a7ff9e}{qs});
    \textcolor{keywordflow}{if}( err == 0) \{
      fprintf( stderr, \textcolor{stringliteral}{"query failed: %s\(\backslash\)n"}, PQerrorMessage( \hyperlink{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{q}));

      \textcolor{comment}{//}
      \textcolor{comment}{// Don't wait for a reply, just reset the connection}
      \textcolor{comment}{//}
      \hyperlink{kvredis_8c_a3847589e641f7e16a0cd68ef30e37cca}{lspg\_query\_reply\_next}();
      \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} == \hyperlink{kvredis_8c_accda8c3a598dc7f5b107b04986d8ab50}{LS\_PG\_STATE\_RESET};
    \} \textcolor{keywordflow}{else} \{
      \hyperlink{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{ls\_pg\_state} = \hyperlink{kvredis_8c_a88a7e80c12fb0449c4b0857a0c7deb21}{LS\_PG\_STATE\_SEND\_FLUSH};
    \}
  \}
\}
\end{DoxyCode}
\hypertarget{kvredis_8c_a51af30a60f9f02777c6396b8247e356f}{\index{kvredis.\-c@{kvredis.\-c}!main@{main}}
\index{main@{main}!kvredis.c@{kvredis.\-c}}
\subsubsection[{main}]{\setlength{\rightskip}{0pt plus 5cm}main (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_a51af30a60f9f02777c6396b8247e356f}


Definition at line 653 of file kvredis.\-c.


\begin{DoxyCode}
       \{
  \textcolor{keyword}{static} \textcolor{keyword}{struct }pollfd fda[3];
  \textcolor{keyword}{static} \textcolor{keywordtype}{int} nfda = 0;
  \textcolor{keywordtype}{int} pollrtn;
  \textcolor{keywordtype}{int} poll\_timeout\_ms;
  \textcolor{keywordtype}{int} i;

  \hyperlink{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}{subac} = redisAsyncConnect(\textcolor{stringliteral}{"127.0.0.1"}, 6379);
  \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}{subac}->err) \{
    fprintf( stderr, \textcolor{stringliteral}{"Error: %s\(\backslash\)n"}, \hyperlink{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}{subac}->errstr);
    exit( -1);
  \}

  \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac} = redisAsyncConnect(\textcolor{stringliteral}{"127.0.0.1"}, 6379);
  \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}->err) \{
    fprintf( stderr, \textcolor{stringliteral}{"Error: %s\(\backslash\)n"}, \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}->errstr);
    exit( -1);
  \}

  \textcolor{keywordflow}{if}( redisAsyncSetDisconnectCallback( \hyperlink{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}{subac}, \hyperlink{kvredis_8c_aa1941e6515a254f76cfd1f18d3c8fac3}{redisDisconnectCB}
      ) == REDIS\_ERR) \{
    fprintf( stderr, \textcolor{stringliteral}{"Error: could not set disconnect callback\(\backslash\)n"});
    exit( -1);
  \}

  \textcolor{keywordflow}{if}( redisAsyncSetDisconnectCallback( \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}, \hyperlink{kvredis_8c_aa1941e6515a254f76cfd1f18d3c8fac3}{redisDisconnectCB}
      ) == REDIS\_ERR) \{
    fprintf( stderr, \textcolor{stringliteral}{"Error: could not set disconnect callback\(\backslash\)n"});
    exit( -1);
  \}

  \textcolor{comment}{// Set up redis events}
  \textcolor{comment}{//}
  \hyperlink{kvredis_8c_a0cd3bdc79d035eb1595371c845d14367}{subfd}.fd           = \hyperlink{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}{subac}->c.fd;
  \hyperlink{kvredis_8c_a0cd3bdc79d035eb1595371c845d14367}{subfd}.events       = 0;
  \hyperlink{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}{subac}->ev.data     = &\hyperlink{kvredis_8c_a0cd3bdc79d035eb1595371c845d14367}{subfd};
  \hyperlink{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}{subac}->ev.addRead  = \hyperlink{kvredis_8c_a95668f6d7a4b8882c6a502af3b0a4705}{addRead};
  \hyperlink{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}{subac}->ev.delRead  = \hyperlink{kvredis_8c_ad3f87d428857a2d8e526e2443fadd410}{delRead};
  \hyperlink{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}{subac}->ev.addWrite = \hyperlink{kvredis_8c_aacb58922ba249c3e15491826e682023c}{addWrite};
  \hyperlink{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}{subac}->ev.delWrite = \hyperlink{kvredis_8c_a5d4f324dd0beeea83848e05550b5cf39}{delWrite};
  \hyperlink{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}{subac}->ev.cleanup  = \hyperlink{kvredis_8c_a93a6e6dd9f422d01eeaa03d6ba4738a0}{cleanup};

  \hyperlink{kvredis_8c_a9b0e607f794ed78360d09a52bb4feaef}{cmdfd}.fd           = \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}->c.fd;
  \hyperlink{kvredis_8c_a9b0e607f794ed78360d09a52bb4feaef}{cmdfd}.events       = 0;
  \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}->ev.data     = &\hyperlink{kvredis_8c_a9b0e607f794ed78360d09a52bb4feaef}{cmdfd};
  \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}->ev.addRead  = \hyperlink{kvredis_8c_a95668f6d7a4b8882c6a502af3b0a4705}{addRead};
  \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}->ev.delRead  = \hyperlink{kvredis_8c_ad3f87d428857a2d8e526e2443fadd410}{delRead};
  \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}->ev.addWrite = \hyperlink{kvredis_8c_aacb58922ba249c3e15491826e682023c}{addWrite};
  \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}->ev.delWrite = \hyperlink{kvredis_8c_a5d4f324dd0beeea83848e05550b5cf39}{delWrite};
  \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}->ev.cleanup  = \hyperlink{kvredis_8c_a93a6e6dd9f422d01eeaa03d6ba4738a0}{cleanup};


  \hyperlink{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}{lspgfd}.fd = -1;

  \textcolor{keywordflow}{if}( redisAsyncCommand( \hyperlink{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{cmdac}, \hyperlink{kvredis_8c_a5dbdf77c680c97996882abbb6a142321}{debugCB}, NULL, \textcolor{stringliteral}{"KEYS *"}) == 
      REDIS\_ERR) \{
    fprintf( stderr, \textcolor{stringliteral}{"Error sending KEYS command\(\backslash\)n"});
    exit( -1);
  \}

  \textcolor{keywordflow}{if}( redisAsyncCommand( \hyperlink{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}{subac}, \hyperlink{kvredis_8c_a5dbdf77c680c97996882abbb6a142321}{debugCB}, NULL, \textcolor{stringliteral}{"PSUBSCRIBE MD2*
       UI**"}) == REDIS\_ERR) \{
    fprintf( stderr, \textcolor{stringliteral}{"Error sending PSUBSCRIBE command\(\backslash\)n"});
    exit( -1);
  \}


  \hyperlink{kvredis_8c_a0bb9ef42da8fa21c4df48ec384ab69f4}{lspg\_query\_push}( \hyperlink{kvredis_8c_afb8d1ff1e0f4fcdc85ad9c684271cb3d}{lspg\_allkvs\_cb}, \textcolor{stringliteral}{"SELECT * FROM
       px.redis\_kv\_init()"});
  \hyperlink{kvredis_8c_a0bb9ef42da8fa21c4df48ec384ab69f4}{lspg\_query\_push}( NULL, \textcolor{stringliteral}{"LISTEN REDIS\_KV\_CONNECTOR"});

  \textcolor{keywordflow}{while}( 1) \{
    nfda = 0;
    \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a0cd3bdc79d035eb1595371c845d14367}{subfd}.fd != -1) \{
      fda[nfda].fd      = \hyperlink{kvredis_8c_a0cd3bdc79d035eb1595371c845d14367}{subfd}.fd;
      fda[nfda].events  = \hyperlink{kvredis_8c_a0cd3bdc79d035eb1595371c845d14367}{subfd}.events;
      fda[nfda].revents = 0;

      nfda++;
    \}
    \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_a9b0e607f794ed78360d09a52bb4feaef}{cmdfd}.fd != -1) \{
      fda[nfda].fd      = \hyperlink{kvredis_8c_a9b0e607f794ed78360d09a52bb4feaef}{cmdfd}.fd;
      fda[nfda].events  = \hyperlink{kvredis_8c_a9b0e607f794ed78360d09a52bb4feaef}{cmdfd}.events;
      fda[nfda].revents = 0;
      
      nfda++;
    \}
    poll\_timeout\_ms = -1;

    \hyperlink{kvredis_8c_ab52a8c8245bf6561f40c0f224fc07ff4}{lspg\_next\_state}();

    \textcolor{keywordflow}{if}( \hyperlink{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}{lspgfd}.fd == -1) \{
      \textcolor{comment}{//}
      \textcolor{comment}{// Here a connection to the database is not established.}
      \textcolor{comment}{// Periodicaly try again.  Should possibly arrange to reconnect}
      \textcolor{comment}{// to signalfd but that's unlikely to be nessesary.}
      \textcolor{comment}{//}
      poll\_timeout\_ms = 10000;
    \} \textcolor{keywordflow}{else} \{
      \textcolor{comment}{//}
      \textcolor{comment}{// Arrange to peacfully do nothing until either the pg server sends us
       something}
      \textcolor{comment}{// or someone pushs something onto our queue}
      \textcolor{comment}{//}
      fda[nfda].fd      = \hyperlink{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}{lspgfd}.fd;
      fda[nfda].events  = \hyperlink{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}{lspgfd}.events;
      fda[nfda].revents = 0;
      nfda++;
      poll\_timeout\_ms = -1;
    \}


    fprintf( stderr, \textcolor{stringliteral}{"nfda: %d\(\backslash\)n"}, nfda);

    pollrtn = poll( fda, nfda, poll\_timeout\_ms);

    \textcolor{keywordflow}{for}( i=0; i<nfda; i++) \{
      \textcolor{keywordflow}{if}( fda[i].revents) \{
        \hyperlink{kvredis_8c_a79856d1a06c278688563be6e5219cee5}{fd\_service}( &(fda[i]));
      \}
    \}
  \}
\}
\end{DoxyCode}
\hypertarget{kvredis_8c_aa1941e6515a254f76cfd1f18d3c8fac3}{\index{kvredis.\-c@{kvredis.\-c}!redis\-Disconnect\-C\-B@{redis\-Disconnect\-C\-B}}
\index{redis\-Disconnect\-C\-B@{redis\-Disconnect\-C\-B}!kvredis.c@{kvredis.\-c}}
\subsubsection[{redis\-Disconnect\-C\-B}]{\setlength{\rightskip}{0pt plus 5cm}void redis\-Disconnect\-C\-B (
\begin{DoxyParamCaption}
\item[{const redis\-Async\-Context $\ast$}]{ac, }
\item[{int}]{status}
\end{DoxyParamCaption}
)}}\label{kvredis_8c_aa1941e6515a254f76cfd1f18d3c8fac3}


Definition at line 54 of file kvredis.\-c.


\begin{DoxyCode}
                                                                \{
  \textcolor{keywordflow}{if}( status == REDIS\_OK) \{
    printf( \textcolor{stringliteral}{"OK, that was fun.\(\backslash\)n"});
    exit( 0);
  \}
  fprintf( stderr, \textcolor{stringliteral}{"Opps, Disconnected with status %d\(\backslash\)n"}, status);
  exit( -1);
\}
\end{DoxyCode}


\subsection{Variable Documentation}
\hypertarget{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}{\index{kvredis.\-c@{kvredis.\-c}!cmdac@{cmdac}}
\index{cmdac@{cmdac}!kvredis.c@{kvredis.\-c}}
\subsubsection[{cmdac}]{\setlength{\rightskip}{0pt plus 5cm}redis\-Async\-Context $\ast$ cmdac\hspace{0.3cm}{\ttfamily [static]}}}\label{kvredis_8c_a498efb0426f0d925e6cab0e7104812ae}


Definition at line 9 of file kvredis.\-c.

\hypertarget{kvredis_8c_a9b0e607f794ed78360d09a52bb4feaef}{\index{kvredis.\-c@{kvredis.\-c}!cmdfd@{cmdfd}}
\index{cmdfd@{cmdfd}!kvredis.c@{kvredis.\-c}}
\subsubsection[{cmdfd}]{\setlength{\rightskip}{0pt plus 5cm}struct pollfd cmdfd\hspace{0.3cm}{\ttfamily [static]}}}\label{kvredis_8c_a9b0e607f794ed78360d09a52bb4feaef}


poll info for redis command channel 



Definition at line 50 of file kvredis.\-c.

\hypertarget{kvredis_8c_a6b15f24b2416f362a9e0039efc586fbb}{\index{kvredis.\-c@{kvredis.\-c}!kvseq@{kvseq}}
\index{kvseq@{kvseq}!kvredis.c@{kvredis.\-c}}
\subsubsection[{kvseq}]{\setlength{\rightskip}{0pt plus 5cm}int kvseq = 0\hspace{0.3cm}{\ttfamily [static]}}}\label{kvredis_8c_a6b15f24b2416f362a9e0039efc586fbb}


used to synchronize pg.\-kvs and redis 



Definition at line 26 of file kvredis.\-c.

\hypertarget{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}{\index{kvredis.\-c@{kvredis.\-c}!ls\-\_\-pg\-\_\-state@{ls\-\_\-pg\-\_\-state}}
\index{ls\-\_\-pg\-\_\-state@{ls\-\_\-pg\-\_\-state}!kvredis.c@{kvredis.\-c}}
\subsubsection[{ls\-\_\-pg\-\_\-state}]{\setlength{\rightskip}{0pt plus 5cm}int ls\-\_\-pg\-\_\-state = {\bf L\-S\-\_\-\-P\-G\-\_\-\-S\-T\-A\-T\-E\-\_\-\-I\-N\-I\-T}\hspace{0.3cm}{\ttfamily [static]}}}\label{kvredis_8c_a4937baac0cc78ea306d58b5f027867f1}


State of the lspg state machine. 



Definition at line 24 of file kvredis.\-c.

\hypertarget{kvredis_8c_a69ae04978986e6413ca7cefcb692b645}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-connect\-Poll\-\_\-response@{lspg\-\_\-connect\-Poll\-\_\-response}}
\index{lspg\-\_\-connect\-Poll\-\_\-response@{lspg\-\_\-connect\-Poll\-\_\-response}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-connect\-Poll\-\_\-response}]{\setlength{\rightskip}{0pt plus 5cm}Postgres\-Polling\-Status\-Type lspg\-\_\-connect\-Poll\-\_\-response\hspace{0.3cm}{\ttfamily [static]}}}\label{kvredis_8c_a69ae04978986e6413ca7cefcb692b645}


Used to determine state while connecting. 



Definition at line 46 of file kvredis.\-c.

\hypertarget{kvredis_8c_a357d9d98f0b8c9625ccebcebfcdce955}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-query\-\_\-queue@{lspg\-\_\-query\-\_\-queue}}
\index{lspg\-\_\-query\-\_\-queue@{lspg\-\_\-query\-\_\-queue}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-query\-\_\-queue}]{\setlength{\rightskip}{0pt plus 5cm}{\bf lspg\-\_\-query\-\_\-queue\-\_\-t} lspg\-\_\-query\-\_\-queue\mbox{[}{\bf L\-S\-\_\-\-P\-G\-\_\-\-Q\-U\-E\-R\-Y\-\_\-\-Q\-U\-E\-U\-E\-\_\-\-L\-E\-N\-G\-T\-H}\mbox{]}\hspace{0.3cm}{\ttfamily [static]}}}\label{kvredis_8c_a357d9d98f0b8c9625ccebcebfcdce955}


Our query queue. 



Definition at line 37 of file kvredis.\-c.

\hypertarget{kvredis_8c_aca86bb77d6cecfae9251743f4171bafb}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-query\-\_\-queue\-\_\-off@{lspg\-\_\-query\-\_\-queue\-\_\-off}}
\index{lspg\-\_\-query\-\_\-queue\-\_\-off@{lspg\-\_\-query\-\_\-queue\-\_\-off}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-query\-\_\-queue\-\_\-off}]{\setlength{\rightskip}{0pt plus 5cm}unsigned int lspg\-\_\-query\-\_\-queue\-\_\-off = 0\hspace{0.3cm}{\ttfamily [static]}}}\label{kvredis_8c_aca86bb77d6cecfae9251743f4171bafb}


The last item still being used (on == off means nothing in queue) 



Definition at line 39 of file kvredis.\-c.

\hypertarget{kvredis_8c_a3cbe7f3161b3c1838ebc56a3bbcfd8a6}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-query\-\_\-queue\-\_\-on@{lspg\-\_\-query\-\_\-queue\-\_\-on}}
\index{lspg\-\_\-query\-\_\-queue\-\_\-on@{lspg\-\_\-query\-\_\-queue\-\_\-on}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-query\-\_\-queue\-\_\-on}]{\setlength{\rightskip}{0pt plus 5cm}unsigned int lspg\-\_\-query\-\_\-queue\-\_\-on = 0\hspace{0.3cm}{\ttfamily [static]}}}\label{kvredis_8c_a3cbe7f3161b3c1838ebc56a3bbcfd8a6}


Next position to add something to the queue. 



Definition at line 38 of file kvredis.\-c.

\hypertarget{kvredis_8c_a2603b071afdbff7c0924b13de2454264}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-query\-\_\-queue\-\_\-reply@{lspg\-\_\-query\-\_\-queue\-\_\-reply}}
\index{lspg\-\_\-query\-\_\-queue\-\_\-reply@{lspg\-\_\-query\-\_\-queue\-\_\-reply}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-query\-\_\-queue\-\_\-reply}]{\setlength{\rightskip}{0pt plus 5cm}unsigned int lspg\-\_\-query\-\_\-queue\-\_\-reply = 0\hspace{0.3cm}{\ttfamily [static]}}}\label{kvredis_8c_a2603b071afdbff7c0924b13de2454264}


The current item being digested. 

Normally off $<$= reply $<$= on. Corner case of queue wrap arround works because we only increment and compare for equality. 

Definition at line 40 of file kvredis.\-c.

\hypertarget{kvredis_8c_a06c5a937e41a6c706a247777642ec1fb}{\index{kvredis.\-c@{kvredis.\-c}!lspg\-\_\-reset\-Poll\-\_\-response@{lspg\-\_\-reset\-Poll\-\_\-response}}
\index{lspg\-\_\-reset\-Poll\-\_\-response@{lspg\-\_\-reset\-Poll\-\_\-response}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspg\-\_\-reset\-Poll\-\_\-response}]{\setlength{\rightskip}{0pt plus 5cm}Postgres\-Polling\-Status\-Type lspg\-\_\-reset\-Poll\-\_\-response\hspace{0.3cm}{\ttfamily [static]}}}\label{kvredis_8c_a06c5a937e41a6c706a247777642ec1fb}


Used to determine state while reconnecting. 



Definition at line 47 of file kvredis.\-c.

\hypertarget{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}{\index{kvredis.\-c@{kvredis.\-c}!lspgfd@{lspgfd}}
\index{lspgfd@{lspgfd}!kvredis.c@{kvredis.\-c}}
\subsubsection[{lspgfd}]{\setlength{\rightskip}{0pt plus 5cm}struct pollfd lspgfd\hspace{0.3cm}{\ttfamily [static]}}}\label{kvredis_8c_af3f897b8ffa020ca54289bc5b28cb64d}


our poll info 



Definition at line 48 of file kvredis.\-c.

\hypertarget{kvredis_8c_ad40ac52086f6b774928af45b09d54c6e}{\index{kvredis.\-c@{kvredis.\-c}!now@{now}}
\index{now@{now}!kvredis.c@{kvredis.\-c}}
\subsubsection[{now}]{\setlength{\rightskip}{0pt plus 5cm}struct timeval lspg\-\_\-time\-\_\-sent now\hspace{0.3cm}{\ttfamily [static]}}}\label{kvredis_8c_ad40ac52086f6b774928af45b09d54c6e}


used to ensure we do not inundate the db server with connection requests 



Definition at line 25 of file kvredis.\-c.

\hypertarget{kvredis_8c_a9012783dbbadf652a81649a289697cf3}{\index{kvredis.\-c@{kvredis.\-c}!q@{q}}
\index{q@{q}!kvredis.c@{kvredis.\-c}}
\subsubsection[{q}]{\setlength{\rightskip}{0pt plus 5cm}P\-Gconn$\ast$ q = N\-U\-L\-L\hspace{0.3cm}{\ttfamily [static]}}}\label{kvredis_8c_a9012783dbbadf652a81649a289697cf3}


Database connector. 



Definition at line 45 of file kvredis.\-c.

\hypertarget{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}{\index{kvredis.\-c@{kvredis.\-c}!subac@{subac}}
\index{subac@{subac}!kvredis.c@{kvredis.\-c}}
\subsubsection[{subac}]{\setlength{\rightskip}{0pt plus 5cm}redis\-Async\-Context$\ast$ subac\hspace{0.3cm}{\ttfamily [static]}}}\label{kvredis_8c_a4d65536cb1094fb5deda0a852b181232}


Definition at line 9 of file kvredis.\-c.

\hypertarget{kvredis_8c_a0cd3bdc79d035eb1595371c845d14367}{\index{kvredis.\-c@{kvredis.\-c}!subfd@{subfd}}
\index{subfd@{subfd}!kvredis.c@{kvredis.\-c}}
\subsubsection[{subfd}]{\setlength{\rightskip}{0pt plus 5cm}struct pollfd subfd\hspace{0.3cm}{\ttfamily [static]}}}\label{kvredis_8c_a0cd3bdc79d035eb1595371c845d14367}


poll info for redis subscribe channel 



Definition at line 49 of file kvredis.\-c.

