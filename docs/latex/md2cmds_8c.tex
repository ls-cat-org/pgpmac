\hypertarget{md2cmds_8c}{\section{md2cmds.\-c File Reference}
\label{md2cmds_8c}\index{md2cmds.\-c@{md2cmds.\-c}}
}


Implements commands to run the md2 diffractometer attached to a P\-M\-A\-C controled by postgresql.  


{\ttfamily \#include \char`\"{}pgpmac.\-h\char`\"{}}\\*
\subsection*{Data Structures}
\begin{DoxyCompactItemize}
\item 
struct \hyperlink{structmd2cmds__cmd__kv__struct}{md2cmds\-\_\-cmd\-\_\-kv\-\_\-struct}
\end{DoxyCompactItemize}
\subsection*{Typedefs}
\begin{DoxyCompactItemize}
\item 
typedef struct \\*
\hyperlink{structmd2cmds__cmd__kv__struct}{md2cmds\-\_\-cmd\-\_\-kv\-\_\-struct} \hyperlink{md2cmds_8c_a5d5f3ca11eadb9719ccffec6753e1385}{md2cmds\-\_\-cmd\-\_\-kv\-\_\-t}
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \hyperlink{md2cmds_8c_ac196e3bcdae79c1ba70cf0bf40a9e299}{md2cmds\-\_\-abort} (const char $\ast$dummy)
\begin{DoxyCompactList}\small\item\em abort the current motion and put the system into a known state /param dummy Unused here \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_aa85ebd51f9c8268f4044be52201d3f1c}{md2cmds\-\_\-center} (const char $\ast$dummy)
\begin{DoxyCompactList}\small\item\em Move centering and alignment tables as requested T\-O\-D\-O\-: Implement. \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_ad8f399e3ea3c2c77c23989c0fa0ccd86}{md2cmds\-\_\-collect} (const char $\ast$dummy)
\begin{DoxyCompactList}\small\item\em Collect some data. \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_ae1122d11f5198c7e8ee22125da65407c}{md2cmds\-\_\-move\-Abs} (const char $\ast$ccmd)
\begin{DoxyCompactList}\small\item\em Move a motor to the position requested Returns non zero on error. \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_a8e8eba6f3c5855910ba3cde22dd3a4b2}{md2cmds\-\_\-move\-Rel} (const char $\ast$ccmd)
\begin{DoxyCompactList}\small\item\em Move a motor to the position requested Returns non zero on error. \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_a4569e8e2b269463b2a60b8407d9ce4d9}{md2cmds\-\_\-phase\-\_\-change} (const char $\ast$ccmd)
\begin{DoxyCompactList}\small\item\em Move md2 devices to a preconfigured state. \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_a577b62b66ed5589a171550e26478633f}{md2cmds\-\_\-run\-\_\-cmd} (const char $\ast$)
\item 
int \hyperlink{md2cmds_8c_ab562f807493aaaaf5a6a377ac6d5a45e}{md2cmds\-\_\-rotate} (const char $\ast$dummy)
\begin{DoxyCompactList}\small\item\em Spin 360 and make a video (recenter first, maybe) \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_aee4a35d084bc0fdd4598576469deeed0}{md2cmds\-\_\-set} (const char $\ast$)
\item 
int \hyperlink{md2cmds_8c_a3403a357a4b3ffd715a2f3d1dac3da5b}{md2cmds\-\_\-settransferpoint} (const char $\ast$)
\item 
int \hyperlink{md2cmds_8c_a4a321d5e1621948eecb33a51a58041f6}{md2cmds\-\_\-test} (const char $\ast$dummy)
\begin{DoxyCompactList}\small\item\em Run the test routine(s) \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_a87efed33b7a49cdfeaf5d64df4ca09aa}{md2cmds\-\_\-transfer} (const char $\ast$dummy)
\begin{DoxyCompactList}\small\item\em Transfer a sample. \end{DoxyCompactList}\item 
void \hyperlink{md2cmds_8c_a408a01640e74152304b10ae05f5d09e1}{md2cmds\-\_\-home\-\_\-prep} ()
\item 
int \hyperlink{md2cmds_8c_aaf5225dbdfe8b04318070c1167ff6a22}{md2cmds\-\_\-home\-\_\-wait} (double timeout\-\_\-secs)
\item 
void \hyperlink{md2cmds_8c_aa64b87b8aaf962a33e89f5086aeeabaa}{md2cmds\-\_\-move\-\_\-prep} ()
\begin{DoxyCompactList}\small\item\em prepare for new movements \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_a7cd262eaeafc85a6111cf06de4f29601}{md2cmds\-\_\-move\-\_\-wait} (double timeout\-\_\-secs)
\begin{DoxyCompactList}\small\item\em Wait for all the motions requested to complete. \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_ac7a133655e9bb91bbbd6cd316e4191fb}{md2cmds\-\_\-is\-\_\-moving} ()
\begin{DoxyCompactList}\small\item\em returns non-\/zero if we think a motor is moving, 0 otherwise \end{DoxyCompactList}\item 
double \hyperlink{md2cmds_8c_ab1cc77bc7476714a419c7db69c7c4be4}{md2cmds\-\_\-prep\-\_\-axis} (\hyperlink{pgpmac_8h_aa5067fcbaabc5bbfdc52492495518c96}{lspmac\-\_\-motor\-\_\-t} $\ast$mp, double pos)
\item 
void \hyperlink{md2cmds_8c_a09a28007e7d8df7b8f97207474e5e516}{md2cmds\-\_\-organs\-\_\-move\-\_\-presets} (char $\ast$pay, char $\ast$paz, char $\ast$pcy, char $\ast$pcz, char $\ast$psz)
\item 
int \hyperlink{md2cmds_8c_a7ecd73ece729c96219eb83f51a3c0b60}{md2cmds\-\_\-phase\-\_\-manual\-Mount} ()
\begin{DoxyCompactList}\small\item\em Go to the manual mount phase. \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_aac780d49120cea87b4bb7690c544e665}{md2cmds\-\_\-phase\-\_\-robot\-Mount} ()
\begin{DoxyCompactList}\small\item\em Go to robot mount phase. \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_a459291b5e2a267e8344431421805d81c}{md2cmds\-\_\-phase\-\_\-center} ()
\begin{DoxyCompactList}\small\item\em Go to center phase. \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_a1d54ec68fd8f1c1743ab5bf0e7905266}{md2cmds\-\_\-phase\-\_\-data\-Collection} ()
\begin{DoxyCompactList}\small\item\em Go to data collection phase. \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_a7801a711b56fb1c337890cb69010aa21}{md2cmds\-\_\-phase\-\_\-beam\-Location} ()
\begin{DoxyCompactList}\small\item\em Go to beam location phase. \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_a38e97b92a6ed2e81b74f2ee9411271d0}{md2cmds\-\_\-phase\-\_\-safe} ()
\begin{DoxyCompactList}\small\item\em Go to safe phase. \end{DoxyCompactList}\item 
void \hyperlink{md2cmds_8c_afdc46152b46ae4d37c73407b83016b78}{md2cmds\-\_\-mvcenter\-\_\-move} (double cx, double cy, double ax, double ay, double az)
\begin{DoxyCompactList}\small\item\em Move the centering and alignment tables. \end{DoxyCompactList}\item 
void \hyperlink{md2cmds_8c_a3970ef1a233dabcc5c1408e9d3865f13}{md2cmds\-\_\-maybe\-\_\-done\-\_\-moving\-\_\-cb} (char $\ast$event)
\begin{DoxyCompactList}\small\item\em Track how many motors are moving. \end{DoxyCompactList}\item 
void \hyperlink{md2cmds_8c_ad0618ee44e2e800c445d7d8726ec8ec2}{md2cmds\-\_\-maybe\-\_\-done\-\_\-homing\-\_\-cb} (char $\ast$event)
\begin{DoxyCompactList}\small\item\em Track motors homing. \end{DoxyCompactList}\item 
void \hyperlink{md2cmds_8c_ab0ee93046bd7bc476c9f8ec50342e89e}{md2cmds\-\_\-kappaphi\-\_\-move} (double kappa\-\_\-deg, double phi\-\_\-deg)
\item 
void \hyperlink{md2cmds_8c_aa43887b7c9799bc88d51df13745d0e5c}{md2cmds\-\_\-rotate\-\_\-cb} (char $\ast$event)
\begin{DoxyCompactList}\small\item\em Tell the database about the time we went through omega=zero. \end{DoxyCompactList}\item 
void \hyperlink{md2cmds_8c_a136f278c9f5a2742b2e9b4987b063faa}{md2cmds\-\_\-maybe\-\_\-rotate\-\_\-done\-\_\-cb} (char $\ast$event)
\begin{DoxyCompactList}\small\item\em Now that we are done with the 360 rotation lets rehome right quick. \end{DoxyCompactList}\item 
void \hyperlink{md2cmds_8c_a4eb608d012f8a471671e10fb19b366d6}{md2cmds\-\_\-set\-\_\-scale\-\_\-cb} (char $\ast$event)
\begin{DoxyCompactList}\small\item\em Fix up xscale and yscale when zoom changes xscale and yscale have units of microns per pixel. \end{DoxyCompactList}\item 
void \hyperlink{md2cmds_8c_aab9e2aa02903648acc342068f0664a96}{md2cmds\-\_\-time\-\_\-capz\-\_\-cb} (char $\ast$event)
\begin{DoxyCompactList}\small\item\em Time the capillary motion for the transfer routine. \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_aea8abad4c01250c1c88d6eff766bb83e}{md2cmds\-\_\-action\-\_\-queue} (double timeout, char $\ast$action)
\item 
void \hyperlink{md2cmds_8c_a33d55ab25f9dfdd6c019a78f4d91dc4d}{md2cmds\-\_\-action\-\_\-wait} ()
\begin{DoxyCompactList}\small\item\em pause until md2cmds\-\_\-worker has finished running the command \end{DoxyCompactList}\item 
void $\ast$ \hyperlink{md2cmds_8c_ae967e769d23555a631f615e630f25b00}{md2cmds\-\_\-worker} (void $\ast$dummy)
\begin{DoxyCompactList}\small\item\em Our worker thread. \end{DoxyCompactList}\item 
void \hyperlink{md2cmds_8c_a4cf5215fdb88407144f582d829c03c7b}{md2cmds\-\_\-coordsys\-\_\-1\-\_\-stopped\-\_\-cb} (char $\ast$event)
\item 
void \hyperlink{md2cmds_8c_a1ab8f6d08c82ee2130202d65d44ef3fe}{md2cmds\-\_\-coordsys\-\_\-2\-\_\-stopped\-\_\-cb} (char $\ast$event)
\item 
void \hyperlink{md2cmds_8c_a3640785c2fc9cd2f27ce0bafd7959179}{md2cmds\-\_\-coordsys\-\_\-3\-\_\-stopped\-\_\-cb} (char $\ast$event)
\item 
void \hyperlink{md2cmds_8c_a6069cb2f6e9f662edd54e1aeb6e78370}{md2cmds\-\_\-coordsys\-\_\-4\-\_\-stopped\-\_\-cb} (char $\ast$event)
\item 
void \hyperlink{md2cmds_8c_a846ed10de4e5ad48cfa429a93c853308}{md2cmds\-\_\-coordsys\-\_\-5\-\_\-stopped\-\_\-cb} (char $\ast$event)
\item 
void \hyperlink{md2cmds_8c_ab172a83eaf3e74799159e6720e4f5268}{md2cmds\-\_\-coordsys\-\_\-7\-\_\-stopped\-\_\-cb} (char $\ast$event)
\item 
void \hyperlink{md2cmds_8c_a0851b1baecda6a67993efde41d77b1c1}{md2cmds\-\_\-init} ()
\begin{DoxyCompactList}\small\item\em Initialize the md2cmds module. \end{DoxyCompactList}\item 
void \hyperlink{md2cmds_8c_aa62da7d423952334d41c7d282f45233d}{md2cmds\-\_\-run} ()
\begin{DoxyCompactList}\small\item\em Start up the thread. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
pthread\-\_\-cond\-\_\-t \hyperlink{md2cmds_8c_a08d5b18ec9478d753c46a3e28d1f2126}{md2cmds\-\_\-cond}
\begin{DoxyCompactList}\small\item\em condition to signal when it's time to run an md2 command \end{DoxyCompactList}\item 
pthread\-\_\-mutex\-\_\-t \hyperlink{md2cmds_8c_ad67304bb851dc6268b0cda2f40fc5aa8}{md2cmds\-\_\-mutex}
\begin{DoxyCompactList}\small\item\em mutex for the condition \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_af14178edd0398535a0c3c87066d6f00c}{md2cmds\-\_\-moving\-\_\-queue\-\_\-wait} = 0
\item 
pthread\-\_\-cond\-\_\-t \hyperlink{md2cmds_8c_adeebdb8f552bff14bd666c187505ee9e}{md2cmds\-\_\-moving\-\_\-cond}
\begin{DoxyCompactList}\small\item\em wait for command to have been dequeued and run \end{DoxyCompactList}\item 
pthread\-\_\-mutex\-\_\-t \hyperlink{md2cmds_8c_a4ea6e6bf63aefcd49f87c3921029451d}{md2cmds\-\_\-moving\-\_\-mutex}
\begin{DoxyCompactList}\small\item\em message passing between md2cmds and pg \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_ac6382968c1bd1ea03a06bde854cc4071}{md2cmds\-\_\-homing\-\_\-count} = 0
\begin{DoxyCompactList}\small\item\em We've asked a motor to home. \end{DoxyCompactList}\item 
pthread\-\_\-cond\-\_\-t \hyperlink{md2cmds_8c_ac8e45a64495062e32b7887651627f46d}{md2cmds\-\_\-homing\-\_\-cond}
\begin{DoxyCompactList}\small\item\em coordinate homing and homed \end{DoxyCompactList}\item 
pthread\-\_\-mutex\-\_\-t \hyperlink{md2cmds_8c_acb54710bbbc6ea638326e93071900d1b}{md2cmds\-\_\-homing\-\_\-mutex}
\begin{DoxyCompactList}\small\item\em our mutex; \end{DoxyCompactList}\item 
int \hyperlink{md2cmds_8c_a5ce190461376c4f9c7d74842d8ebc5d5}{md2cmds\-\_\-moving\-\_\-count} = 0
\item 
char \hyperlink{md2cmds_8c_a5f0fe1e2dfa92cf345b8c29134ab1ede}{md2cmds\-\_\-cmd} \mbox{[}\hyperlink{pgpmac_8h_a30f0f377b0f0695284145d420ea51846}{M\-D2\-C\-M\-D\-S\-\_\-\-C\-M\-D\-\_\-\-L\-E\-N\-G\-T\-H}\mbox{]}
\begin{DoxyCompactList}\small\item\em our command; \end{DoxyCompactList}\item 
\hyperlink{pgpmac_8h_ad449de06d02791adf2498d2a1e1f909c}{lsredis\-\_\-obj\-\_\-t} $\ast$ \hyperlink{md2cmds_8c_a6a34fb6876abbd580629d3708c805e7f}{md2cmds\-\_\-md\-\_\-status\-\_\-code}
\item 
static pthread\-\_\-t \hyperlink{md2cmds_8c_aa230921945149692de98fff15c01962f}{md2cmds\-\_\-thread}
\item 
static int \hyperlink{md2cmds_8c_aaa6eb2d46be8d5e17a511591dd5a1271}{rotating} = 0
\begin{DoxyCompactList}\small\item\em flag\-: when omega is in position after a rotate we want to re-\/home omega \end{DoxyCompactList}\item 
static double \hyperlink{md2cmds_8c_a478ca2fc7299fac5a13f6bce991198b7}{md2cmds\-\_\-capz\-\_\-moving\-\_\-time} = N\-A\-N
\item 
static struct hsearch\-\_\-data \hyperlink{md2cmds_8c_a625a7f2c3447a5ed7b6a1f9b0827d0c1}{md2cmds\-\_\-hmap}
\item 
static regex\-\_\-t \hyperlink{md2cmds_8c_ad07af354194cb9a8eac1f200257dcacd}{md2cmds\-\_\-cmd\-\_\-regex}
\item 
static \hyperlink{md2cmds_8c_a5d5f3ca11eadb9719ccffec6753e1385}{md2cmds\-\_\-cmd\-\_\-kv\-\_\-t} \hyperlink{md2cmds_8c_a2bb0a14593ac87833ec2151282098d64}{md2cmds\-\_\-cmd\-\_\-kvs} \mbox{[}$\,$\mbox{]}
\end{DoxyCompactItemize}


\subsection{Detailed Description}
Implements commands to run the md2 diffractometer attached to a P\-M\-A\-C controled by postgresql. \begin{DoxyDate}{Date}
2012 
\end{DoxyDate}
\begin{DoxyAuthor}{Author}
Keith Brister 
\end{DoxyAuthor}
\begin{DoxyCopyright}{Copyright}
All Rights Reserved 
\end{DoxyCopyright}


Definition in file \hyperlink{md2cmds_8c_source}{md2cmds.\-c}.



\subsection{Typedef Documentation}
\hypertarget{md2cmds_8c_a5d5f3ca11eadb9719ccffec6753e1385}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-cmd\-\_\-kv\-\_\-t@{md2cmds\-\_\-cmd\-\_\-kv\-\_\-t}}
\index{md2cmds\-\_\-cmd\-\_\-kv\-\_\-t@{md2cmds\-\_\-cmd\-\_\-kv\-\_\-t}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-cmd\-\_\-kv\-\_\-t}]{\setlength{\rightskip}{0pt plus 5cm}typedef struct {\bf md2cmds\-\_\-cmd\-\_\-kv\-\_\-struct}  {\bf md2cmds\-\_\-cmd\-\_\-kv\-\_\-t}}}\label{md2cmds_8c_a5d5f3ca11eadb9719ccffec6753e1385}


\subsection{Function Documentation}
\hypertarget{md2cmds_8c_ac196e3bcdae79c1ba70cf0bf40a9e299}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-abort@{md2cmds\-\_\-abort}}
\index{md2cmds\-\_\-abort@{md2cmds\-\_\-abort}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-abort}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-abort (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{dummy}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_ac196e3bcdae79c1ba70cf0bf40a9e299}


abort the current motion and put the system into a known state /param dummy Unused here 



Definition at line 1576 of file md2cmds.\-c.


\begin{DoxyCode}
                                      \{
  \textcolor{comment}{//}
  \textcolor{comment}{// First priority is to close the shutter}
  \textcolor{comment}{//}
  \textcolor{keywordflow}{if}( \hyperlink{lspmac_8c_a26dec4623af9beed912b8e7e6f99822c}{fshut}->\hyperlink{structlspmac__motor__struct_a38b6eee046c3ceff84f908af3335ebcf}{moveAbs}( \hyperlink{lspmac_8c_a26dec4623af9beed912b8e7e6f99822c}{fshut}, 0))
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_abort: for some reason
       the shutter close requested failed.  Proceeding anyway."});

  \textcolor{comment}{//}
  \textcolor{comment}{// Now stop all the motors}
  \textcolor{comment}{//}
  \hyperlink{lspmac_8c_a85f7a5e4d853b7a86ddde1006dd4dc1f}{lspmac\_abort}();
  \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_a7cd262eaeafc85a6111cf06de4f29601}{md2cmds\_move\_wait}( 10.0))
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_abort: Some motors did
       not appear to stop.  Proceding with reset anyway"});

  \textcolor{comment}{//}
  \textcolor{comment}{// Now try to close the shutter (again)}
  \textcolor{comment}{//}
  \textcolor{keywordflow}{if}( \hyperlink{lspmac_8c_a26dec4623af9beed912b8e7e6f99822c}{fshut}->\hyperlink{structlspmac__motor__struct_a38b6eee046c3ceff84f908af3335ebcf}{moveAbs}( \hyperlink{lspmac_8c_a26dec4623af9beed912b8e7e6f99822c}{fshut}, 0))
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_abort: for some reason
       the shutter close requested failed (2).  Proceeding anyway."});
  
  \textcolor{comment}{//}
  \textcolor{comment}{// Force the motion flags down}
  \textcolor{comment}{//}
  \hyperlink{lspmac_8c_afab9e8f0502a92ee5cf93209af710f81}{lspmac\_SockSendDPline}( NULL, \textcolor{stringliteral}{"m5075=0"});
  
  \textcolor{keywordflow}{return} 0;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_aea8abad4c01250c1c88d6eff766bb83e}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-action\-\_\-queue@{md2cmds\-\_\-action\-\_\-queue}}
\index{md2cmds\-\_\-action\-\_\-queue@{md2cmds\-\_\-action\-\_\-queue}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-action\-\_\-queue}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-action\-\_\-queue (
\begin{DoxyParamCaption}
\item[{double}]{timeout, }
\item[{char $\ast$}]{action}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_aea8abad4c01250c1c88d6eff766bb83e}


Definition at line 1538 of file md2cmds.\-c.


\begin{DoxyCode}
                                                        \{
  \textcolor{keywordtype}{int} rtn;
  \textcolor{keyword}{struct }timespec waitforit;


  \textcolor{keywordflow}{if}( timeout < 0.0) \{
    rtn = pthread\_mutex\_lock( &\hyperlink{md2cmds_8c_ad67304bb851dc6268b0cda2f40fc5aa8}{md2cmds\_mutex});
  \} \textcolor{keywordflow}{else} \{
    clock\_gettime( CLOCK\_REALTIME, &waitforit);

    waitforit.tv\_sec  += floor(timeout);
  
    waitforit.tv\_nsec += (timeout - waitforit.tv\_sec)*1.e9;
    \textcolor{keywordflow}{while}( waitforit.tv\_nsec >= 1000000000) \{
      waitforit.tv\_sec++;
      waitforit.tv\_nsec -= 1000000000;
    \}

    rtn = pthread\_mutex\_timedlock( &\hyperlink{md2cmds_8c_ad67304bb851dc6268b0cda2f40fc5aa8}{md2cmds\_mutex}, &waitforit);
  \}

  \textcolor{keywordflow}{if}( rtn == 0) \{
    strncpy( \hyperlink{md2cmds_8c_a5f0fe1e2dfa92cf345b8c29134ab1ede}{md2cmds\_cmd}, action, \hyperlink{pgpmac_8h_a30f0f377b0f0695284145d420ea51846}{MD2CMDS\_CMD\_LENGTH}
      -1);
    \hyperlink{md2cmds_8c_a5f0fe1e2dfa92cf345b8c29134ab1ede}{md2cmds\_cmd}[\hyperlink{pgpmac_8h_a30f0f377b0f0695284145d420ea51846}{MD2CMDS\_CMD\_LENGTH}-1] = 0;
    pthread\_cond\_signal( &\hyperlink{md2cmds_8c_a08d5b18ec9478d753c46a3e28d1f2126}{md2cmds\_cond});
    pthread\_mutex\_unlock( &\hyperlink{md2cmds_8c_ad67304bb851dc6268b0cda2f40fc5aa8}{md2cmds\_mutex});
  \} \textcolor{keywordflow}{else} \{
    \textcolor{keywordflow}{if}( rtn == ETIMEDOUT)
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_action\_queue: %s not
       queued, operation timed out"}, action);
    \textcolor{keywordflow}{else}
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_action\_queue: %s not
       queued with error code %d"}, action, rtn);
  \}
  \textcolor{keywordflow}{return} rtn;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a33d55ab25f9dfdd6c019a78f4d91dc4d}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-action\-\_\-wait@{md2cmds\-\_\-action\-\_\-wait}}
\index{md2cmds\-\_\-action\-\_\-wait@{md2cmds\-\_\-action\-\_\-wait}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-action\-\_\-wait}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-action\-\_\-wait (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a33d55ab25f9dfdd6c019a78f4d91dc4d}


pause until md2cmds\-\_\-worker has finished running the command 



Definition at line 1606 of file md2cmds.\-c.


\begin{DoxyCode}
                           \{
  pthread\_mutex\_lock( &\hyperlink{md2cmds_8c_ad67304bb851dc6268b0cda2f40fc5aa8}{md2cmds\_mutex});
  pthread\_mutex\_unlock( &\hyperlink{md2cmds_8c_ad67304bb851dc6268b0cda2f40fc5aa8}{md2cmds\_mutex});
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_aa85ebd51f9c8268f4044be52201d3f1c}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-center@{md2cmds\-\_\-center}}
\index{md2cmds\-\_\-center@{md2cmds\-\_\-center}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-center}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-center (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{dummy}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_aa85ebd51f9c8268f4044be52201d3f1c}


Move centering and alignment tables as requested T\-O\-D\-O\-: Implement. 



Definition at line 1501 of file md2cmds.\-c.


\begin{DoxyCode}
                                       \{
  \textcolor{keywordflow}{return} 0;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_ad8f399e3ea3c2c77c23989c0fa0ccd86}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-collect@{md2cmds\-\_\-collect}}
\index{md2cmds\-\_\-collect@{md2cmds\-\_\-collect}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-collect}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-collect (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{dummy}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_ad8f399e3ea3c2c77c23989c0fa0ccd86}


Collect some data. 


\begin{DoxyParams}{Parameters}
{\em dummy} & Unused returns non-\/zero on error \\
\hline
\end{DoxyParams}
$<$ index of shot to be taken

$<$ Exposure time (saved to compute shutter timeout)

$<$ start cnts

$<$ delta cnts

$<$ omega velocity cnts/msec

$<$ acceleration time (msec)

$<$ exposure time (msec)

$<$ unit to counts conversion

$<$ nominal zero offset

$<$ maximum acceleration allowed for omega

$<$ current kappa position in case we need to move phi only

$<$ current phi position in case we need to move kappa only

$<$ setup timeouts for shutter 

Definition at line 1021 of file md2cmds.\-c.


\begin{DoxyCode}
                                        \{
  \textcolor{keywordtype}{long} \textcolor{keywordtype}{long} skey;       
  \textcolor{keywordtype}{double} exp\_time;      
  \textcolor{keywordtype}{double} p170;          
  \textcolor{keywordtype}{double} p171;          
  \textcolor{keywordtype}{double} p173;          
  \textcolor{keywordtype}{double} p175;          
  \textcolor{keywordtype}{double} p180;          
  \textcolor{keywordtype}{double} u2c;           
  \textcolor{keywordtype}{double} neutral\_pos;   
  \textcolor{keywordtype}{double} max\_accel;     
  \textcolor{keywordtype}{double} kappa\_pos;     
  \textcolor{keywordtype}{double} phi\_pos;       
  \textcolor{keyword}{struct }timespec \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}, timeout;      
  \textcolor{keywordtype}{int} err;
  \textcolor{keywordtype}{double} move\_time;
  \textcolor{keywordtype}{int} mmask;

  u2c         = \hyperlink{lsredis_8c_aa8daf63b794b6b6341018feec205cb7d}{lsredis\_getd}( \hyperlink{lspmac_8c_a8237e646ce032a840637a4ef7bff49b9}{omega}->\hyperlink{structlspmac__motor__struct_a8838915ebb6f9989944117c8197d5e86}{u2c});
  neutral\_pos = \hyperlink{lsredis_8c_aa8daf63b794b6b6341018feec205cb7d}{lsredis\_getd}( \hyperlink{lspmac_8c_a8237e646ce032a840637a4ef7bff49b9}{omega}->\hyperlink{structlspmac__motor__struct_ae931e9bc9fc2fa82ca649334fc052fbe}{neutral\_pos});
  max\_accel   = \hyperlink{lsredis_8c_aa8daf63b794b6b6341018feec205cb7d}{lsredis\_getd}( \hyperlink{lspmac_8c_a8237e646ce032a840637a4ef7bff49b9}{omega}->\hyperlink{structlspmac__motor__struct_a50cf4c0711cea164e332bc34705a1a68}{max\_accel});

  mmask = 0;
  err = \hyperlink{lspmac_8c_a984a1d6e49ad53d6a1184666881bf117}{lspmac\_est\_move\_time}( &move\_time, &mmask,
                              \hyperlink{lspmac_8c_a139200ddaa9856a7ffcec0e6cbaa8f1b}{apery},     1, \textcolor{stringliteral}{"In"},    0.0,  \textcolor{comment}{// Aperture to
       the In position}
                              \hyperlink{lspmac_8c_ab93bd6ee850b285ca3a95e64d15e9477}{aperz},     1, \textcolor{stringliteral}{"In"},    0.0,
                              \hyperlink{lspmac_8c_a51358daaea8b5236f08414877d8af6c2}{capy},      1, \textcolor{stringliteral}{"In"},    0.0,   \textcolor{comment}{// Capillary /
       Beamstop to the In position}
                              \hyperlink{lspmac_8c_aa45f268d0af9f3d465acfab128919718}{capz},      1, \textcolor{stringliteral}{"In"},    0.0,
                              \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint},     1, \textcolor{stringliteral}{"Cover"}, 0.0,  \textcolor{comment}{// Hide the
       scintillator}
                              \hyperlink{lspmac_8c_af813a2eff0b7efa4c70633559054e84c}{blight\_ud}, 1, NULL,    0.0,      \textcolor{comment}{// put
       the backlight down}
                              NULL);

  err = \hyperlink{lspmac_8c_a570b4a359adc4da4ab80d53506d06963}{lspmac\_est\_move\_time\_wait}( move\_time + 2.0, 
      mmask, NULL);
  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Data Collection Aborted"});
    \textcolor{keywordflow}{return} 1;
  \}


  \textcolor{comment}{//}
  \textcolor{comment}{// reset shutter has opened flag}
  \textcolor{comment}{//}
  \hyperlink{lspmac_8c_afab9e8f0502a92ee5cf93209af710f81}{lspmac\_SockSendDPline}( NULL, \textcolor{stringliteral}{"P3001=0 P3002=0"});

  \textcolor{keywordflow}{while}( 1) \{
    \hyperlink{lspg_8c_af17ef79544ca5d78fd477010fe90d538}{lspg\_nextshot\_call}();
    \hyperlink{lspg_8c_a784a6de32a86fec9efb3ef3ae4b6e3ac}{lspg\_nextshot\_wait}();

    exp\_time = \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a063e4c99201a763c2eb048acfc855efa}{dsexp};

    \textcolor{keywordflow}{if}( \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_abc9242805729f70b83df79706c394c71}{no\_rows\_returned}) \{
      \hyperlink{lspg_8c_a50458a014041a4118452802dfb303960}{lspg\_nextshot\_done}();
      \textcolor{keywordflow}{break};
    \}

    skey = \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_af64a4e3f17752b5f1f05fb15d6f48382}{skey};
    \hyperlink{lspg_8c_a0bb9ef42da8fa21c4df48ec384ab69f4}{lspg\_query\_push}( NULL, \textcolor{stringliteral}{"SELECT px.shots\_set\_state(%lld,
       'Preparing')"}, skey);

    \textcolor{keywordflow}{if}( \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a1a94eefbad713976a3d9213695a6ca28}{active}) \{
      \textcolor{keywordflow}{if}(
         \textcolor{comment}{//}
         \textcolor{comment}{// Don't move if we are within 0.1 microns of our destination}
         \textcolor{comment}{//}
         (fabs( \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_ad9eb2013fa6f295f72f0891fe98c863f}{cx} - \hyperlink{lspmac_8c_ac940d950d9efeaf3f0ae67e9bf331188}{cenx}->\hyperlink{structlspmac__motor__struct_af8ffb3aed907d8664b65b37601954411}{position}) >
       0.1) ||
         (fabs( \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_ab7a7b37a17f06c4e9ebdcdf056946098}{cy} - \hyperlink{lspmac_8c_aaed18e738ba7bfb6c771a44f5d7ea827}{ceny}->\hyperlink{structlspmac__motor__struct_af8ffb3aed907d8664b65b37601954411}{position}) >
       0.1) ||
         (fabs( \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a7f57874223897ab7d9c7531a9522904d}{ax} - \hyperlink{lspmac_8c_a6cb218bdccfe5a93471c161f15a15cab}{alignx}->\hyperlink{structlspmac__motor__struct_af8ffb3aed907d8664b65b37601954411}{position}
      ) > 0.1) ||
         (fabs( \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a9e20b9a0aeb41f7f7d653a1c60335bf1}{ay} - \hyperlink{lspmac_8c_a737c246c3948e644a18d191a931e1acd}{aligny}->\hyperlink{structlspmac__motor__struct_af8ffb3aed907d8664b65b37601954411}{position}
      ) > 0.1) ||
         (fabs( \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a66e678866ce79f6398b66d033ae45a17}{az} - \hyperlink{lspmac_8c_ae7642b1da0f7c7f8448104c691d40a12}{alignz}->\hyperlink{structlspmac__motor__struct_af8ffb3aed907d8664b65b37601954411}{position}
      ) > 0.1)) \{


        \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_collect: moving
       center to cx=%f, cy=%f, ax=%f, ay=%f, az=%f"},\hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_ad9eb2013fa6f295f72f0891fe98c863f}{cx}, 
      \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_ab7a7b37a17f06c4e9ebdcdf056946098}{cy}, \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a7f57874223897ab7d9c7531a9522904d}{ax}, \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}
      .\hyperlink{structlspg__nextshot__struct_a9e20b9a0aeb41f7f7d653a1c60335bf1}{ay}, \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a66e678866ce79f6398b66d033ae45a17}{az});

        err = \hyperlink{lspmac_8c_a984a1d6e49ad53d6a1184666881bf117}{lspmac\_est\_move\_time}( &move\_time, &mmask,
                                    \hyperlink{lspmac_8c_ac940d950d9efeaf3f0ae67e9bf331188}{cenx},   0, NULL, \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}
      .\hyperlink{structlspg__nextshot__struct_ad9eb2013fa6f295f72f0891fe98c863f}{cx},
                                    \hyperlink{lspmac_8c_aaed18e738ba7bfb6c771a44f5d7ea827}{ceny},   0, NULL, \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}
      .\hyperlink{structlspg__nextshot__struct_ab7a7b37a17f06c4e9ebdcdf056946098}{cy},
                                    \hyperlink{lspmac_8c_a6cb218bdccfe5a93471c161f15a15cab}{alignx}, 0, NULL, \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}
      .\hyperlink{structlspg__nextshot__struct_a7f57874223897ab7d9c7531a9522904d}{ax},
                                    \hyperlink{lspmac_8c_a737c246c3948e644a18d191a931e1acd}{aligny}, 0, NULL, \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}
      .\hyperlink{structlspg__nextshot__struct_a9e20b9a0aeb41f7f7d653a1c60335bf1}{ay},
                                    \hyperlink{lspmac_8c_ae7642b1da0f7c7f8448104c691d40a12}{alignz}, 0, NULL, \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}
      .\hyperlink{structlspg__nextshot__struct_a66e678866ce79f6398b66d033ae45a17}{az},
                                    NULL);
        \textcolor{keywordflow}{if}( err) \{
          \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Data Colection Aborted"});
          \textcolor{keywordflow}{return} 1;
        \}

        err = \hyperlink{lspmac_8c_a570b4a359adc4da4ab80d53506d06963}{lspmac\_est\_move\_time\_wait}( move\_time, 
      mmask, NULL);
        \textcolor{keywordflow}{if}( err) \{
          \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Data Colection Aborted"});
          \textcolor{keywordflow}{return} 1;
        \}
      \}
    \}

    \textcolor{comment}{// Maybe move kappa and/or phi}
    \textcolor{comment}{//}
    \textcolor{keywordflow}{if}( !\hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a2d1f51cb1bb575a214344773136be878}{dsphi\_isnull} || !\hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}
      .\hyperlink{structlspg__nextshot__struct_a1686a72509cc1c3383ee95a790ddff14}{dskappa\_isnull}) \{

      kappa\_pos = \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a1686a72509cc1c3383ee95a790ddff14}{dskappa\_isnull} ? 
      \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}( \hyperlink{lspmac_8c_a0be79ccb7ebf3a665248fd856112b9fd}{kappa}) : \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.
      dskappa;
      phi\_pos   = \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a2d1f51cb1bb575a214344773136be878}{dsphi\_isnull}   ? 
      \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}( \hyperlink{lspmac_8c_ac8070dc568ad974a3db42b51eca828cc}{phi})   : \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.
      dsphi;

      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_collect: move
       phy/kappa: kappa=%f  phi=%f"}, kappa\_pos, phi\_pos);

      err = \hyperlink{lspmac_8c_a984a1d6e49ad53d6a1184666881bf117}{lspmac\_est\_move\_time}( &move\_time, &mmask,
                                  \hyperlink{lspmac_8c_a0be79ccb7ebf3a665248fd856112b9fd}{kappa}, 0, NULL, kappa\_pos,
                                  \hyperlink{lspmac_8c_ac8070dc568ad974a3db42b51eca828cc}{phi},   0, NULL, phi\_pos,
                                  NULL);
      \textcolor{keywordflow}{if}( err) \{
          \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Data Colection Aborted"});
          \textcolor{keywordflow}{return} 1;
      \} 

      err = \hyperlink{lspmac_8c_a570b4a359adc4da4ab80d53506d06963}{lspmac\_est\_move\_time\_wait}( move\_time + 2, 
      mmask, NULL);
      \textcolor{keywordflow}{if}( err) \{
          \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Data Colection Aborted"});
          \textcolor{keywordflow}{return} 1;
      \} 
    \}

  
    \textcolor{comment}{//}
    \textcolor{comment}{// Calculate the parameters we'll need to run the scan}
    \textcolor{comment}{//}
    p180 = \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a063e4c99201a763c2eb048acfc855efa}{dsexp} * 1000.0;
    p170 = u2c * (\hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a8dc11eaa094d59f61642c4abc226918f}{sstart} + neutral\_pos);
    p171 = u2c * \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_ad5a8f568a04aa6a13767933062b28f19}{dsowidth};
    p173 = fabs(p180) < 1.e-4 ? 0.0 : u2c * \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_ad5a8f568a04aa6a13767933062b28f19}{dsowidth}
       / p180;
    p175 = p173/max\_accel;


    \textcolor{comment}{//}
    \textcolor{comment}{// free up access to nextshot}
    \textcolor{comment}{//}
    \hyperlink{lspg_8c_a50458a014041a4118452802dfb303960}{lspg\_nextshot\_done}();

    \textcolor{comment}{//}
    \textcolor{comment}{// prepare the database and detector to expose}
    \textcolor{comment}{// On exit we own the diffractometer lock and}
    \textcolor{comment}{// have checked that all is OK with the detector}
    \textcolor{comment}{//}
    \hyperlink{lspg_8c_a4253474d4dd305aec0afdd5552b3ddd5}{lspg\_seq\_run\_prep\_all}( skey,
                           \hyperlink{lspmac_8c_a0be79ccb7ebf3a665248fd856112b9fd}{kappa}->\hyperlink{structlspmac__motor__struct_af8ffb3aed907d8664b65b37601954411}{position},
                           \hyperlink{lspmac_8c_ac8070dc568ad974a3db42b51eca828cc}{phi}->\hyperlink{structlspmac__motor__struct_af8ffb3aed907d8664b65b37601954411}{position},
                           \hyperlink{lspmac_8c_ac940d950d9efeaf3f0ae67e9bf331188}{cenx}->\hyperlink{structlspmac__motor__struct_af8ffb3aed907d8664b65b37601954411}{position},
                           \hyperlink{lspmac_8c_aaed18e738ba7bfb6c771a44f5d7ea827}{ceny}->\hyperlink{structlspmac__motor__struct_af8ffb3aed907d8664b65b37601954411}{position},
                           \hyperlink{lspmac_8c_a6cb218bdccfe5a93471c161f15a15cab}{alignx}->\hyperlink{structlspmac__motor__struct_af8ffb3aed907d8664b65b37601954411}{position},
                           \hyperlink{lspmac_8c_a737c246c3948e644a18d191a931e1acd}{aligny}->\hyperlink{structlspmac__motor__struct_af8ffb3aed907d8664b65b37601954411}{position},
                           \hyperlink{lspmac_8c_ae7642b1da0f7c7f8448104c691d40a12}{alignz}->\hyperlink{structlspmac__motor__struct_af8ffb3aed907d8664b65b37601954411}{position}
                           );

    
    \textcolor{comment}{//}
    \textcolor{comment}{// make sure our opened flag is down}
    \textcolor{comment}{// wait for the p3001=0 command to be noticed}
    \textcolor{comment}{//}
    clock\_gettime( CLOCK\_REALTIME, &\hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now});
    timeout.tv\_sec  = \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_sec + 10;
    timeout.tv\_nsec = \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_nsec;

    err = 0;
    pthread\_mutex\_lock( &\hyperlink{lspmac_8c_a1b78a13c654409333569815e1c109d38}{lspmac\_shutter\_mutex});
    \textcolor{keywordflow}{while}( err == 0 && \hyperlink{lspmac_8c_a396fbf06208de3ecbe1b0df549f1cd46}{lspmac\_shutter\_has\_opened} == 1)
      err = pthread\_cond\_timedwait( &\hyperlink{lspmac_8c_afbd51c2cefcee87afe994c9e9f372241}{lspmac\_shutter\_cond}, &
      \hyperlink{lspmac_8c_a1b78a13c654409333569815e1c109d38}{lspmac\_shutter\_mutex}, &timeout);
    pthread\_mutex\_unlock( &\hyperlink{lspmac_8c_a1b78a13c654409333569815e1c109d38}{lspmac\_shutter\_mutex});

    \textcolor{keywordflow}{if}( err == ETIMEDOUT) \{
      pthread\_mutex\_unlock( &\hyperlink{lspmac_8c_a1b78a13c654409333569815e1c109d38}{lspmac\_shutter\_mutex});
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_collect: Timed out
       waiting for shutter to open.  Data collection aborted."});
      \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Data Collection Aborted"});
      \textcolor{keywordflow}{return} 1;
    \}

    \textcolor{comment}{//}
    \textcolor{comment}{// Start the exposure}
    \textcolor{comment}{//}
    \hyperlink{lspmac_8c_ad7cd6c8e4ea1132ac4a4b90e6468e2d6}{lspmac\_set\_motion\_flags}( &mmask, \hyperlink{lspmac_8c_a8237e646ce032a840637a4ef7bff49b9}{omega});
    \hyperlink{lspmac_8c_afab9e8f0502a92ee5cf93209af710f81}{lspmac\_SockSendDPline}( \textcolor{stringliteral}{"Exposure"},
                           \textcolor{stringliteral}{"&1 P170=%.1f P171=%.1f P173=%.1f P174=0 P175=%.1f
       P176=0 P177=1 P178=0 P180=%.1f M431=1 &1B131R"},
                           p170,         p171,     p173,            p175,      
                          p180);

    \textcolor{comment}{//}
    \textcolor{comment}{// We could look for the "Exposure command accepted" event at this point.}
    \textcolor{comment}{//}
    \textcolor{comment}{//}
    \textcolor{comment}{// wait for the shutter to open}
    \textcolor{comment}{//}
    clock\_gettime( CLOCK\_REALTIME, &\hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now});
    timeout.tv\_sec  = \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_sec + 10;
    timeout.tv\_nsec = \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_nsec;

    err = 0;
    pthread\_mutex\_lock( &\hyperlink{lspmac_8c_a1b78a13c654409333569815e1c109d38}{lspmac\_shutter\_mutex});
    \textcolor{keywordflow}{while}( err == 0 && \hyperlink{lspmac_8c_a396fbf06208de3ecbe1b0df549f1cd46}{lspmac\_shutter\_has\_opened} == 0)
      err = pthread\_cond\_timedwait( &\hyperlink{lspmac_8c_afbd51c2cefcee87afe994c9e9f372241}{lspmac\_shutter\_cond}, &
      \hyperlink{lspmac_8c_a1b78a13c654409333569815e1c109d38}{lspmac\_shutter\_mutex}, &timeout);

    \textcolor{keywordflow}{if}( err == ETIMEDOUT) \{
      pthread\_mutex\_unlock( &\hyperlink{lspmac_8c_a1b78a13c654409333569815e1c109d38}{lspmac\_shutter\_mutex});
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_collect: Timed out
       waiting for shutter to open.  Data collection aborted."});
      \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Data Collection Aborted"});
      \textcolor{keywordflow}{return} 1;
    \}


    \textcolor{comment}{//}
    \textcolor{comment}{// wait for the shutter to close}
    \textcolor{comment}{//}
    clock\_gettime( CLOCK\_REALTIME, &\hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now});
    timeout.tv\_sec  = \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_sec + 4 + exp\_time;     \textcolor{comment}{// hopefully 4 seconds
       is long enough to never catch a legitimate shutter close and short enough to
       bail when something is really wrong}
    timeout.tv\_nsec = \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_nsec;

    err = 0;
    \textcolor{keywordflow}{while}( err == 0 && \hyperlink{lspmac_8c_a112158e0cd50449a440ac55c7af7bea2}{lspmac\_shutter\_state} == 1)
      err = pthread\_cond\_timedwait( &\hyperlink{lspmac_8c_afbd51c2cefcee87afe994c9e9f372241}{lspmac\_shutter\_cond}, &
      \hyperlink{lspmac_8c_a1b78a13c654409333569815e1c109d38}{lspmac\_shutter\_mutex}, &timeout);
    pthread\_mutex\_unlock( &\hyperlink{lspmac_8c_a1b78a13c654409333569815e1c109d38}{lspmac\_shutter\_mutex});


    \textcolor{keywordflow}{if}( err == ETIMEDOUT) \{
      pthread\_mutex\_unlock( &\hyperlink{lspmac_8c_a1b78a13c654409333569815e1c109d38}{lspmac\_shutter\_mutex});
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_collect: Timed out
       waiting for shutter to close.  Data collection aborted."});
      \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Data Collection Aborted"});
      \textcolor{keywordflow}{return} 1;
    \}


    \textcolor{comment}{//}
    \textcolor{comment}{// Signal the detector to start reading out}
    \textcolor{comment}{//}
    \hyperlink{lspg_8c_a0bb9ef42da8fa21c4df48ec384ab69f4}{lspg\_query\_push}( NULL, \textcolor{stringliteral}{"SELECT px.unlock\_diffractometer()"});

    \textcolor{comment}{//}
    \textcolor{comment}{// Update the shot status}
    \textcolor{comment}{//}
    \hyperlink{lspg_8c_a0bb9ef42da8fa21c4df48ec384ab69f4}{lspg\_query\_push}( NULL, \textcolor{stringliteral}{"SELECT px.shots\_set\_state(%lld,
       'Writing')"}, skey);

    \textcolor{comment}{//}
    \textcolor{comment}{// reset shutter has opened flag}
    \textcolor{comment}{//}
    \hyperlink{lspmac_8c_afab9e8f0502a92ee5cf93209af710f81}{lspmac\_SockSendDPline}( NULL, \textcolor{stringliteral}{"P3001=0"});

    \textcolor{comment}{//}
    \textcolor{comment}{// Wait for omega to stop moving}
    \textcolor{comment}{//}
    \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_a7cd262eaeafc85a6111cf06de4f29601}{md2cmds\_move\_wait}( 10.0)) \{
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_collect: Giving up
       waiting for omega to stop moving. Data collection aborted."});
      \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Data Colection Aborted"});
      \textcolor{keywordflow}{return} 1;
    \}

    \textcolor{comment}{//}
    \textcolor{comment}{// Move the center/alignment stages to the next position}
    \textcolor{comment}{//}
    \textcolor{comment}{// TODO: position omega for the next shot.  During data collection the
       motion program}
    \textcolor{comment}{// makes a good guess but for ortho snaps it is wrong.  We should add an
       argument to the motion program}
    \textcolor{comment}{//}

      
    \textcolor{keywordflow}{if}( !\hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a1aa11ff4a4c8d69695786b4349e84e6b}{active2\_isnull} && 
      \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a2875aa18df587806a3d8c05220fd62b5}{active2}) \{
      \textcolor{keywordflow}{if}(
         (fabs( \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a10d45763100bc59f9a5f68f1b48db6d3}{cx2} - \hyperlink{lspmac_8c_ac940d950d9efeaf3f0ae67e9bf331188}{cenx}->\hyperlink{structlspmac__motor__struct_af8ffb3aed907d8664b65b37601954411}{position})
       > 0.1) ||
         (fabs( \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a3644e5c3f12af18a3b426d4d4d7e16a5}{cy2} - \hyperlink{lspmac_8c_aaed18e738ba7bfb6c771a44f5d7ea827}{ceny}->\hyperlink{structlspmac__motor__struct_af8ffb3aed907d8664b65b37601954411}{position})
       > 0.1) ||
         (fabs( \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_ab76bd38d2a098bc7eda82aff5dcb9c66}{ax2} - \hyperlink{lspmac_8c_a6cb218bdccfe5a93471c161f15a15cab}{alignx}->\hyperlink{structlspmac__motor__struct_af8ffb3aed907d8664b65b37601954411}{position}
      ) > 0.1) ||
         (fabs( \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_ad13759740204b42e379161f98815f3d0}{ay2} - \hyperlink{lspmac_8c_a737c246c3948e644a18d191a931e1acd}{aligny}->\hyperlink{structlspmac__motor__struct_af8ffb3aed907d8664b65b37601954411}{position}
      ) > 0.1) ||
         (fabs( \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a94698a030fd5b2abf1f10a2ad33476a4}{az2} - \hyperlink{lspmac_8c_ae7642b1da0f7c7f8448104c691d40a12}{alignz}->\hyperlink{structlspmac__motor__struct_af8ffb3aed907d8664b65b37601954411}{position}
      ) > 0.1)) \{

        \hyperlink{md2cmds_8c_aa64b87b8aaf962a33e89f5086aeeabaa}{md2cmds\_move\_prep}();
        \hyperlink{md2cmds_8c_afdc46152b46ae4d37c73407b83016b78}{md2cmds\_mvcenter\_move}( \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.
      \hyperlink{structlspg__nextshot__struct_ad9eb2013fa6f295f72f0891fe98c863f}{cx}, \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_ab7a7b37a17f06c4e9ebdcdf056946098}{cy}, \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a7f57874223897ab7d9c7531a9522904d}{ax}, 
      \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a9e20b9a0aeb41f7f7d653a1c60335bf1}{ay}, \hyperlink{lspg_8c_ad8d8e2f578ca79189a80c1fd5b60cefd}{lspg\_nextshot}.\hyperlink{structlspg__nextshot__struct_a66e678866ce79f6398b66d033ae45a17}{az});
      \}
    \}
  \}
  \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Data Collection Done"});
  \textcolor{keywordflow}{return} 0;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a4cf5215fdb88407144f582d829c03c7b}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-coordsys\-\_\-1\-\_\-stopped\-\_\-cb@{md2cmds\-\_\-coordsys\-\_\-1\-\_\-stopped\-\_\-cb}}
\index{md2cmds\-\_\-coordsys\-\_\-1\-\_\-stopped\-\_\-cb@{md2cmds\-\_\-coordsys\-\_\-1\-\_\-stopped\-\_\-cb}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-coordsys\-\_\-1\-\_\-stopped\-\_\-cb}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-coordsys\-\_\-1\-\_\-stopped\-\_\-cb (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{event}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a4cf5215fdb88407144f582d829c03c7b}


Definition at line 1843 of file md2cmds.\-c.


\begin{DoxyCode}
                                                 \{
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a1ab8f6d08c82ee2130202d65d44ef3fe}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-coordsys\-\_\-2\-\_\-stopped\-\_\-cb@{md2cmds\-\_\-coordsys\-\_\-2\-\_\-stopped\-\_\-cb}}
\index{md2cmds\-\_\-coordsys\-\_\-2\-\_\-stopped\-\_\-cb@{md2cmds\-\_\-coordsys\-\_\-2\-\_\-stopped\-\_\-cb}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-coordsys\-\_\-2\-\_\-stopped\-\_\-cb}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-coordsys\-\_\-2\-\_\-stopped\-\_\-cb (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{event}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a1ab8f6d08c82ee2130202d65d44ef3fe}


Definition at line 1845 of file md2cmds.\-c.


\begin{DoxyCode}
                                                 \{
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a3640785c2fc9cd2f27ce0bafd7959179}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-coordsys\-\_\-3\-\_\-stopped\-\_\-cb@{md2cmds\-\_\-coordsys\-\_\-3\-\_\-stopped\-\_\-cb}}
\index{md2cmds\-\_\-coordsys\-\_\-3\-\_\-stopped\-\_\-cb@{md2cmds\-\_\-coordsys\-\_\-3\-\_\-stopped\-\_\-cb}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-coordsys\-\_\-3\-\_\-stopped\-\_\-cb}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-coordsys\-\_\-3\-\_\-stopped\-\_\-cb (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{event}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a3640785c2fc9cd2f27ce0bafd7959179}


Definition at line 1847 of file md2cmds.\-c.


\begin{DoxyCode}
                                                 \{
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a6069cb2f6e9f662edd54e1aeb6e78370}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-coordsys\-\_\-4\-\_\-stopped\-\_\-cb@{md2cmds\-\_\-coordsys\-\_\-4\-\_\-stopped\-\_\-cb}}
\index{md2cmds\-\_\-coordsys\-\_\-4\-\_\-stopped\-\_\-cb@{md2cmds\-\_\-coordsys\-\_\-4\-\_\-stopped\-\_\-cb}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-coordsys\-\_\-4\-\_\-stopped\-\_\-cb}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-coordsys\-\_\-4\-\_\-stopped\-\_\-cb (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{event}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a6069cb2f6e9f662edd54e1aeb6e78370}


Definition at line 1849 of file md2cmds.\-c.


\begin{DoxyCode}
                                                 \{
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a846ed10de4e5ad48cfa429a93c853308}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-coordsys\-\_\-5\-\_\-stopped\-\_\-cb@{md2cmds\-\_\-coordsys\-\_\-5\-\_\-stopped\-\_\-cb}}
\index{md2cmds\-\_\-coordsys\-\_\-5\-\_\-stopped\-\_\-cb@{md2cmds\-\_\-coordsys\-\_\-5\-\_\-stopped\-\_\-cb}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-coordsys\-\_\-5\-\_\-stopped\-\_\-cb}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-coordsys\-\_\-5\-\_\-stopped\-\_\-cb (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{event}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a846ed10de4e5ad48cfa429a93c853308}


Definition at line 1851 of file md2cmds.\-c.


\begin{DoxyCode}
                                                 \{
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_ab172a83eaf3e74799159e6720e4f5268}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-coordsys\-\_\-7\-\_\-stopped\-\_\-cb@{md2cmds\-\_\-coordsys\-\_\-7\-\_\-stopped\-\_\-cb}}
\index{md2cmds\-\_\-coordsys\-\_\-7\-\_\-stopped\-\_\-cb@{md2cmds\-\_\-coordsys\-\_\-7\-\_\-stopped\-\_\-cb}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-coordsys\-\_\-7\-\_\-stopped\-\_\-cb}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-coordsys\-\_\-7\-\_\-stopped\-\_\-cb (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{event}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_ab172a83eaf3e74799159e6720e4f5268}


Definition at line 1853 of file md2cmds.\-c.


\begin{DoxyCode}
                                                 \{
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a408a01640e74152304b10ae05f5d09e1}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-home\-\_\-prep@{md2cmds\-\_\-home\-\_\-prep}}
\index{md2cmds\-\_\-home\-\_\-prep@{md2cmds\-\_\-home\-\_\-prep}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-home\-\_\-prep}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-home\-\_\-prep (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a408a01640e74152304b10ae05f5d09e1}


Definition at line 72 of file md2cmds.\-c.


\begin{DoxyCode}
                         \{
  pthread\_mutex\_lock( &\hyperlink{md2cmds_8c_acb54710bbbc6ea638326e93071900d1b}{md2cmds\_homing\_mutex});
  \hyperlink{md2cmds_8c_ac6382968c1bd1ea03a06bde854cc4071}{md2cmds\_homing\_count} = -1;
  pthread\_mutex\_unlock( &\hyperlink{md2cmds_8c_acb54710bbbc6ea638326e93071900d1b}{md2cmds\_homing\_mutex});
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_aaf5225dbdfe8b04318070c1167ff6a22}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-home\-\_\-wait@{md2cmds\-\_\-home\-\_\-wait}}
\index{md2cmds\-\_\-home\-\_\-wait@{md2cmds\-\_\-home\-\_\-wait}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-home\-\_\-wait}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-home\-\_\-wait (
\begin{DoxyParamCaption}
\item[{double}]{timeout\-\_\-secs}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_aaf5225dbdfe8b04318070c1167ff6a22}


Definition at line 79 of file md2cmds.\-c.


\begin{DoxyCode}
                                            \{
  \textcolor{keyword}{struct }timespec timeout, \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now};
  \textcolor{keywordtype}{double} isecs, fsecs;
  \textcolor{keywordtype}{int} err;

  clock\_gettime( CLOCK\_REALTIME, &\hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now});

  fsecs = modf( timeout\_secs, &isecs);

  timeout.tv\_sec  = \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_sec  + (long)floor( isecs);
  timeout.tv\_nsec = \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_nsec + (long)floor( fsecs * 1.0e9);
  
  timeout.tv\_sec  += timeout.tv\_nsec / 1000000000;
  timeout.tv\_nsec %= 1000000000;

  err = 0;
  pthread\_mutex\_lock( &\hyperlink{md2cmds_8c_acb54710bbbc6ea638326e93071900d1b}{md2cmds\_homing\_mutex});
  \textcolor{keywordflow}{while}( err == 0 && \hyperlink{md2cmds_8c_ac6382968c1bd1ea03a06bde854cc4071}{md2cmds\_homing\_count} == -1)
    err = pthread\_cond\_timedwait( &\hyperlink{md2cmds_8c_ac8e45a64495062e32b7887651627f46d}{md2cmds\_homing\_cond}, &
      \hyperlink{md2cmds_8c_acb54710bbbc6ea638326e93071900d1b}{md2cmds\_homing\_mutex}, &timeout);

  \textcolor{keywordflow}{if}( err != 0) \{
    \textcolor{keywordflow}{if}( err != ETIMEDOUT) \{
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_home\_wait:
       unexpected error from timedwait: %d  tv\_sec %ld   tv\_nsec %ld"}, err, timeout.tv\_sec, 
      timeout.tv\_nsec);
    \}
    pthread\_mutex\_unlock( &\hyperlink{md2cmds_8c_acb54710bbbc6ea638326e93071900d1b}{md2cmds\_homing\_mutex});
    \textcolor{keywordflow}{return} 1;
  \}

  err = 0;
  \textcolor{keywordflow}{while}( err == 0 && \hyperlink{md2cmds_8c_ac6382968c1bd1ea03a06bde854cc4071}{md2cmds\_homing\_count} > 0)
    err = pthread\_cond\_timedwait( &\hyperlink{md2cmds_8c_ac8e45a64495062e32b7887651627f46d}{md2cmds\_homing\_cond}, &
      \hyperlink{md2cmds_8c_acb54710bbbc6ea638326e93071900d1b}{md2cmds\_homing\_mutex}, &timeout);
  pthread\_mutex\_unlock( &\hyperlink{md2cmds_8c_acb54710bbbc6ea638326e93071900d1b}{md2cmds\_homing\_mutex});

  \textcolor{keywordflow}{if}( err != 0) \{
    \textcolor{keywordflow}{if}( err != ETIMEDOUT)
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_home\_wait:
       unexpected error from timedwait: %d"}, err);
    
    \textcolor{keywordflow}{return} 1;
  \} 
  \textcolor{keywordflow}{return} 0;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a0851b1baecda6a67993efde41d77b1c1}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-init@{md2cmds\-\_\-init}}
\index{md2cmds\-\_\-init@{md2cmds\-\_\-init}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-init (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a0851b1baecda6a67993efde41d77b1c1}


Initialize the md2cmds module. 



Definition at line 1859 of file md2cmds.\-c.


\begin{DoxyCode}
                    \{
  ENTRY hloader, *hrtnval;
  \textcolor{keywordtype}{int} \hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}, err;

  pthread\_mutexattr\_t mutex\_initializer;

  pthread\_mutexattr\_init( &mutex\_initializer);
  pthread\_mutexattr\_settype( &mutex\_initializer, PTHREAD\_MUTEX\_RECURSIVE);

  pthread\_mutex\_init( &\hyperlink{md2cmds_8c_ad67304bb851dc6268b0cda2f40fc5aa8}{md2cmds\_mutex}, &mutex\_initializer);
  pthread\_cond\_init( &\hyperlink{md2cmds_8c_a08d5b18ec9478d753c46a3e28d1f2126}{md2cmds\_cond}, NULL);


  pthread\_mutex\_init( &\hyperlink{md2cmds_8c_a4ea6e6bf63aefcd49f87c3921029451d}{md2cmds\_moving\_mutex}, &
      mutex\_initializer);
  pthread\_cond\_init(  &\hyperlink{md2cmds_8c_adeebdb8f552bff14bd666c187505ee9e}{md2cmds\_moving\_cond}, NULL);

  pthread\_mutex\_init( &\hyperlink{md2cmds_8c_acb54710bbbc6ea638326e93071900d1b}{md2cmds\_homing\_mutex}, &
      mutex\_initializer);
  pthread\_cond\_init(  &\hyperlink{md2cmds_8c_ac8e45a64495062e32b7887651627f46d}{md2cmds\_homing\_cond}, NULL);

  err = regcomp( &\hyperlink{md2cmds_8c_ad07af354194cb9a8eac1f200257dcacd}{md2cmds\_cmd\_regex}, \textcolor{stringliteral}{" *([^ ]+) (([^ ]+)\(\backslash\)\(\backslash\)
      .presets\(\backslash\)\(\backslash\)..)*([^ ]*) *([^ ]*)"}, REG\_EXTENDED);
  \textcolor{keywordflow}{if}( err != 0) \{
    \textcolor{keywordtype}{int} nerrmsg;
    \textcolor{keywordtype}{char} *errmsg;

    nerrmsg = regerror( err, &\hyperlink{md2cmds_8c_ad07af354194cb9a8eac1f200257dcacd}{md2cmds\_cmd\_regex}, NULL, 0);
    \textcolor{keywordflow}{if}( nerrmsg > 0) \{
      errmsg = calloc( nerrmsg, \textcolor{keyword}{sizeof}( \textcolor{keywordtype}{char}));
      nerrmsg = regerror( err, &\hyperlink{md2cmds_8c_ad07af354194cb9a8eac1f200257dcacd}{md2cmds\_cmd\_regex}, errmsg, 
      nerrmsg);
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_init: %s"}, errmsg);
      free( errmsg);
    \}
  \}

  \hyperlink{md2cmds_8c_a6a34fb6876abbd580629d3708c805e7f}{md2cmds\_md\_status\_code} = \hyperlink{lsredis_8c_ad3bb3ebbae1ffbd03e062ecdd663cc6a}{lsredis\_get\_obj}
      ( \textcolor{stringliteral}{"md2\_status\_code"});
  \hyperlink{lsredis_8c_a9b9c64f883c7ded60badfe89cb15fa78}{lsredis\_setstr}( \hyperlink{md2cmds_8c_a6a34fb6876abbd580629d3708c805e7f}{md2cmds\_md\_status\_code}, \textcolor{stringliteral}{"
      7"});

  hcreate\_r( 2 * \textcolor{keyword}{sizeof}(\hyperlink{md2cmds_8c_a2bb0a14593ac87833ec2151282098d64}{md2cmds\_cmd\_kvs})/\textcolor{keyword}{sizeof}(\hyperlink{md2cmds_8c_a2bb0a14593ac87833ec2151282098d64}{md2cmds\_cmd\_kvs}
      [0]), &\hyperlink{md2cmds_8c_a625a7f2c3447a5ed7b6a1f9b0827d0c1}{md2cmds\_hmap});
  \textcolor{keywordflow}{for}( i=0; i<\textcolor{keyword}{sizeof}(\hyperlink{md2cmds_8c_a2bb0a14593ac87833ec2151282098d64}{md2cmds\_cmd\_kvs})/\textcolor{keyword}{sizeof}(\hyperlink{md2cmds_8c_a2bb0a14593ac87833ec2151282098d64}{md2cmds\_cmd\_kvs}
      [0]); i++) \{
    hloader.key  = \hyperlink{md2cmds_8c_a2bb0a14593ac87833ec2151282098d64}{md2cmds\_cmd\_kvs}[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}].\hyperlink{structmd2cmds__cmd__kv__struct_a4cd5cce8339ed8cc9f0a5835a9bc5c69}{k};
    hloader.data = \hyperlink{md2cmds_8c_a2bb0a14593ac87833ec2151282098d64}{md2cmds\_cmd\_kvs}[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}].\hyperlink{structmd2cmds__cmd__kv__struct_ab12171e8ea4148dedcb13673e05ca92c}{v};
    err = hsearch\_r( hloader, ENTER, &hrtnval, &\hyperlink{md2cmds_8c_a625a7f2c3447a5ed7b6a1f9b0827d0c1}{md2cmds\_hmap});
    \textcolor{keywordflow}{if}( err == 0) \{
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_init: hsearch\_r
       returned an error for item %d: %s"}, i, strerror( errno));
    \}
  \}

\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_ac7a133655e9bb91bbbd6cd316e4191fb}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-is\-\_\-moving@{md2cmds\-\_\-is\-\_\-moving}}
\index{md2cmds\-\_\-is\-\_\-moving@{md2cmds\-\_\-is\-\_\-moving}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-is\-\_\-moving}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-is\-\_\-moving (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_ac7a133655e9bb91bbbd6cd316e4191fb}


returns non-\/zero if we think a motor is moving, 0 otherwise 



Definition at line 178 of file md2cmds.\-c.


\begin{DoxyCode}
                        \{
  \textcolor{keywordtype}{int} rtn;

  pthread\_mutex\_lock( &\hyperlink{md2cmds_8c_a4ea6e6bf63aefcd49f87c3921029451d}{md2cmds\_moving\_mutex});
  rtn = \hyperlink{md2cmds_8c_a5ce190461376c4f9c7d74842d8ebc5d5}{md2cmds\_moving\_count} != 0;
  pthread\_mutex\_unlock( &\hyperlink{md2cmds_8c_a4ea6e6bf63aefcd49f87c3921029451d}{md2cmds\_moving\_mutex});

  \textcolor{keywordflow}{return} rtn;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_ab0ee93046bd7bc476c9f8ec50342e89e}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-kappaphi\-\_\-move@{md2cmds\-\_\-kappaphi\-\_\-move}}
\index{md2cmds\-\_\-kappaphi\-\_\-move@{md2cmds\-\_\-kappaphi\-\_\-move}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-kappaphi\-\_\-move}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-kappaphi\-\_\-move (
\begin{DoxyParamCaption}
\item[{double}]{kappa\-\_\-deg, }
\item[{double}]{phi\-\_\-deg}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_ab0ee93046bd7bc476c9f8ec50342e89e}


Definition at line 999 of file md2cmds.\-c.


\begin{DoxyCode}
                                                              \{
  \textcolor{keywordtype}{int} kc, pc;

  \textcolor{comment}{// coordinate system 7}
  \textcolor{comment}{// 1 << (coord sys no - 1) = 64}

  kc = \hyperlink{md2cmds_8c_ab1cc77bc7476714a419c7db69c7c4be4}{md2cmds\_prep\_axis}( \hyperlink{lspmac_8c_a0be79ccb7ebf3a665248fd856112b9fd}{kappa}, kappa\_deg);
  pc = \hyperlink{md2cmds_8c_ab1cc77bc7476714a419c7db69c7c4be4}{md2cmds\_prep\_axis}( \hyperlink{lspmac_8c_a0be79ccb7ebf3a665248fd856112b9fd}{kappa}, phi\_deg);

  \textcolor{comment}{//  ;150              LS-CAT Move X, Y Absolute}
  \textcolor{comment}{//  ;                 Q20    = X Value}
  \textcolor{comment}{//  ;                 Q21    = Y Value}
  \textcolor{comment}{//  ;                 Q100   = 1 << (coord sys no  - 1)}

  \hyperlink{lspmac_8c_afab9e8f0502a92ee5cf93209af710f81}{lspmac\_SockSendDPline}( \textcolor{stringliteral}{"kappaphi\_move"}, \textcolor{stringliteral}{"&7 Q20=%d
       Q21=%d Q100=64"}, kc, pc);
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_ad0618ee44e2e800c445d7d8726ec8ec2}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-maybe\-\_\-done\-\_\-homing\-\_\-cb@{md2cmds\-\_\-maybe\-\_\-done\-\_\-homing\-\_\-cb}}
\index{md2cmds\-\_\-maybe\-\_\-done\-\_\-homing\-\_\-cb@{md2cmds\-\_\-maybe\-\_\-done\-\_\-homing\-\_\-cb}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-maybe\-\_\-done\-\_\-homing\-\_\-cb}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-maybe\-\_\-done\-\_\-homing\-\_\-cb (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{event}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_ad0618ee44e2e800c445d7d8726ec8ec2}


Track motors homing. 



Definition at line 975 of file md2cmds.\-c.


\begin{DoxyCode}
                                                \{
  pthread\_mutex\_lock( &\hyperlink{md2cmds_8c_acb54710bbbc6ea638326e93071900d1b}{md2cmds\_homing\_mutex});
  
  \textcolor{keywordflow}{if}( strstr( event, \textcolor{stringliteral}{"Homing"}) != NULL) \{
    \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_ac6382968c1bd1ea03a06bde854cc4071}{md2cmds\_homing\_count} == -1)
      \hyperlink{md2cmds_8c_ac6382968c1bd1ea03a06bde854cc4071}{md2cmds\_homing\_count} = 1;
    \textcolor{keywordflow}{else}
      \hyperlink{md2cmds_8c_ac6382968c1bd1ea03a06bde854cc4071}{md2cmds\_homing\_count}++;
  \} \textcolor{keywordflow}{else} \{
    \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_ac6382968c1bd1ea03a06bde854cc4071}{md2cmds\_homing\_count} > 0)
      \hyperlink{md2cmds_8c_ac6382968c1bd1ea03a06bde854cc4071}{md2cmds\_homing\_count}--;
  \}

  \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_ac6382968c1bd1ea03a06bde854cc4071}{md2cmds\_homing\_count} != 0)
    \hyperlink{lsredis_8c_a9b9c64f883c7ded60badfe89cb15fa78}{lsredis\_setstr}( \hyperlink{md2cmds_8c_a6a34fb6876abbd580629d3708c805e7f}{md2cmds\_md\_status\_code},
       \textcolor{stringliteral}{"%s"}, \textcolor{stringliteral}{"4"});

  \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_ac6382968c1bd1ea03a06bde854cc4071}{md2cmds\_homing\_count} == 0)
    pthread\_cond\_signal( &\hyperlink{md2cmds_8c_ac8e45a64495062e32b7887651627f46d}{md2cmds\_homing\_cond});
  
  pthread\_mutex\_unlock( &\hyperlink{md2cmds_8c_acb54710bbbc6ea638326e93071900d1b}{md2cmds\_homing\_mutex});
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a3970ef1a233dabcc5c1408e9d3865f13}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-maybe\-\_\-done\-\_\-moving\-\_\-cb@{md2cmds\-\_\-maybe\-\_\-done\-\_\-moving\-\_\-cb}}
\index{md2cmds\-\_\-maybe\-\_\-done\-\_\-moving\-\_\-cb@{md2cmds\-\_\-maybe\-\_\-done\-\_\-moving\-\_\-cb}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-maybe\-\_\-done\-\_\-moving\-\_\-cb}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-maybe\-\_\-done\-\_\-moving\-\_\-cb (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{event}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a3970ef1a233dabcc5c1408e9d3865f13}


Track how many motors are moving. 



Definition at line 946 of file md2cmds.\-c.


\begin{DoxyCode}
                                                \{

  pthread\_mutex\_lock(   &\hyperlink{md2cmds_8c_a4ea6e6bf63aefcd49f87c3921029451d}{md2cmds\_moving\_mutex});
  \textcolor{keywordflow}{if}( strstr( event, \textcolor{stringliteral}{"Moving"}) != NULL) \{
    \textcolor{comment}{//}
    \textcolor{comment}{// -1 is a flag indicating we're expecting some action}
    \textcolor{comment}{//}
    \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_a5ce190461376c4f9c7d74842d8ebc5d5}{md2cmds\_moving\_count} == -1)
      \hyperlink{md2cmds_8c_a5ce190461376c4f9c7d74842d8ebc5d5}{md2cmds\_moving\_count} = 1;
    \textcolor{keywordflow}{else}
      \hyperlink{md2cmds_8c_a5ce190461376c4f9c7d74842d8ebc5d5}{md2cmds\_moving\_count}++;
  \} \textcolor{keywordflow}{else} \{
    \textcolor{comment}{//}
    \textcolor{comment}{//}
    \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_a5ce190461376c4f9c7d74842d8ebc5d5}{md2cmds\_moving\_count} > 0)
      \hyperlink{md2cmds_8c_a5ce190461376c4f9c7d74842d8ebc5d5}{md2cmds\_moving\_count}--;
  \}

  \hyperlink{lsredis_8c_a9b9c64f883c7ded60badfe89cb15fa78}{lsredis\_setstr}( \hyperlink{md2cmds_8c_a6a34fb6876abbd580629d3708c805e7f}{md2cmds\_md\_status\_code}, \textcolor{stringliteral}{"
      %s"}, \hyperlink{md2cmds_8c_a5ce190461376c4f9c7d74842d8ebc5d5}{md2cmds\_moving\_count} ? \textcolor{stringliteral}{"4"} : \textcolor{stringliteral}{"3"});
  
  \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_a5ce190461376c4f9c7d74842d8ebc5d5}{md2cmds\_moving\_count} == 0)
    pthread\_cond\_signal( &\hyperlink{md2cmds_8c_adeebdb8f552bff14bd666c187505ee9e}{md2cmds\_moving\_cond});
  pthread\_mutex\_unlock( &\hyperlink{md2cmds_8c_a4ea6e6bf63aefcd49f87c3921029451d}{md2cmds\_moving\_mutex});
  
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a136f278c9f5a2742b2e9b4987b063faa}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-maybe\-\_\-rotate\-\_\-done\-\_\-cb@{md2cmds\-\_\-maybe\-\_\-rotate\-\_\-done\-\_\-cb}}
\index{md2cmds\-\_\-maybe\-\_\-rotate\-\_\-done\-\_\-cb@{md2cmds\-\_\-maybe\-\_\-rotate\-\_\-done\-\_\-cb}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-maybe\-\_\-rotate\-\_\-done\-\_\-cb}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-maybe\-\_\-rotate\-\_\-done\-\_\-cb (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{event}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a136f278c9f5a2742b2e9b4987b063faa}


Now that we are done with the 360 rotation lets rehome right quick. 



Definition at line 1462 of file md2cmds.\-c.


\begin{DoxyCode}
                                                \{
  \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_aaa6eb2d46be8d5e17a511591dd5a1271}{rotating}) \{
    \hyperlink{md2cmds_8c_aaa6eb2d46be8d5e17a511591dd5a1271}{rotating} = 0;
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Rotate Done"});
  \}
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_aa64b87b8aaf962a33e89f5086aeeabaa}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-move\-\_\-prep@{md2cmds\-\_\-move\-\_\-prep}}
\index{md2cmds\-\_\-move\-\_\-prep@{md2cmds\-\_\-move\-\_\-prep}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-move\-\_\-prep}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-move\-\_\-prep (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_aa64b87b8aaf962a33e89f5086aeeabaa}


prepare for new movements 



Definition at line 124 of file md2cmds.\-c.


\begin{DoxyCode}
                         \{
  pthread\_mutex\_lock( &\hyperlink{md2cmds_8c_a4ea6e6bf63aefcd49f87c3921029451d}{md2cmds\_moving\_mutex});
  \hyperlink{md2cmds_8c_a5ce190461376c4f9c7d74842d8ebc5d5}{md2cmds\_moving\_count} = -1;
  pthread\_mutex\_unlock( &\hyperlink{md2cmds_8c_a4ea6e6bf63aefcd49f87c3921029451d}{md2cmds\_moving\_mutex});
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a7cd262eaeafc85a6111cf06de4f29601}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-move\-\_\-wait@{md2cmds\-\_\-move\-\_\-wait}}
\index{md2cmds\-\_\-move\-\_\-wait@{md2cmds\-\_\-move\-\_\-wait}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-move\-\_\-wait}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-move\-\_\-wait (
\begin{DoxyParamCaption}
\item[{double}]{timeout\-\_\-secs}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a7cd262eaeafc85a6111cf06de4f29601}


Wait for all the motions requested to complete. 


\begin{DoxyParams}{Parameters}
{\em timeout\-\_\-secs} & Double value of seconds to wait\\
\hline
\end{DoxyParams}
There are two waits involved\-: First to wait for the first \char`\"{}\-Moving\char`\"{} to be seen and second to wait for the last \char`\"{}\-In Position\char`\"{}. The timeout specified here is the sum of the two.

returns 0 on success and 1 if we timedout. 

Definition at line 141 of file md2cmds.\-c.


\begin{DoxyCode}
                                            \{
  \textcolor{keywordtype}{double} isecs, fsecs;
  \textcolor{keyword}{struct }timespec timeout, \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now};
  \textcolor{keywordtype}{int} err;

  clock\_gettime( CLOCK\_REALTIME, &\hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now});

  fsecs = modf( timeout\_secs, &isecs);

  timeout.tv\_sec  = \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_sec  + (long)floor( isecs);
  timeout.tv\_nsec = \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_nsec + (long)floor( fsecs * 1.0e9);
  
  timeout.tv\_sec  += timeout.tv\_nsec / 1000000000;
  timeout.tv\_nsec %= 1000000000;

  err = 0;
  pthread\_mutex\_lock( &\hyperlink{md2cmds_8c_a4ea6e6bf63aefcd49f87c3921029451d}{md2cmds\_moving\_mutex});
  \textcolor{keywordflow}{while}( err == 0 && \hyperlink{md2cmds_8c_a5ce190461376c4f9c7d74842d8ebc5d5}{md2cmds\_moving\_count} == -1)
    err = pthread\_cond\_timedwait( &\hyperlink{md2cmds_8c_adeebdb8f552bff14bd666c187505ee9e}{md2cmds\_moving\_cond}, &
      \hyperlink{md2cmds_8c_a4ea6e6bf63aefcd49f87c3921029451d}{md2cmds\_moving\_mutex}, &timeout);

  \textcolor{keywordflow}{if}( err == ETIMEDOUT) \{
    pthread\_mutex\_unlock( &\hyperlink{md2cmds_8c_a4ea6e6bf63aefcd49f87c3921029451d}{md2cmds\_moving\_mutex});
    \textcolor{keywordflow}{return} 1;
  \}

  err = 0;
  \textcolor{keywordflow}{while}( err == 0 && \hyperlink{md2cmds_8c_a5ce190461376c4f9c7d74842d8ebc5d5}{md2cmds\_moving\_count} > 0)
    err = pthread\_cond\_timedwait( &\hyperlink{md2cmds_8c_adeebdb8f552bff14bd666c187505ee9e}{md2cmds\_moving\_cond}, &
      \hyperlink{md2cmds_8c_a4ea6e6bf63aefcd49f87c3921029451d}{md2cmds\_moving\_mutex}, &timeout);
  pthread\_mutex\_unlock( &\hyperlink{md2cmds_8c_a4ea6e6bf63aefcd49f87c3921029451d}{md2cmds\_moving\_mutex});

  \textcolor{keywordflow}{if}( err == ETIMEDOUT)
    \textcolor{keywordflow}{return} 1;
  \textcolor{keywordflow}{return} 0;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_ae1122d11f5198c7e8ee22125da65407c}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-move\-Abs@{md2cmds\-\_\-move\-Abs}}
\index{md2cmds\-\_\-move\-Abs@{md2cmds\-\_\-move\-Abs}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-move\-Abs}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-move\-Abs (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{ccmd}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_ae1122d11f5198c7e8ee22125da65407c}


Move a motor to the position requested Returns non zero on error. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em ccmd} & The full command string to parse, ie, \char`\"{}move\-Abs omega 180\char`\"{} \\
\hline
\end{DoxyParams}


Definition at line 445 of file md2cmds.\-c.


\begin{DoxyCode}
                       \{
  \textcolor{keywordtype}{char} *cmd;
  \textcolor{keywordtype}{char} *ignore;
  \textcolor{keywordtype}{char} *ptr;
  \textcolor{keywordtype}{char} *mtr;
  \textcolor{keywordtype}{char} *pos;
  \textcolor{keywordtype}{double} fpos;
  \textcolor{keywordtype}{char} *endptr;
  \hyperlink{structlspmac__motor__struct}{lspmac\_motor\_t} *mp;
  \textcolor{keywordtype}{int} err;

  \textcolor{comment}{// ignore nothing}
  \textcolor{keywordflow}{if}( ccmd == NULL || *ccmd == 0) \{
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{comment}{// operate on a copy of the string since strtok\_r will modify its argument}
  \textcolor{comment}{//}
  cmd = strdup( ccmd);

  \textcolor{comment}{// Parse the command string}
  \textcolor{comment}{//}
  ignore = strtok\_r( cmd, \textcolor{stringliteral}{" "}, &ptr);
  \textcolor{keywordflow}{if}( ignore == NULL) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_moveAbs: ignoring
       blank command '%s'"}, cmd);
    free( cmd);
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{comment}{// The first string should be "moveAbs" cause that's how we got here.}
  \textcolor{comment}{// Toss it.}
  
  mtr = strtok\_r( NULL, \textcolor{stringliteral}{" "}, &ptr);
  \textcolor{keywordflow}{if}( mtr == NULL) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_moveAbs: missing motor
       name"});
    free( cmd);
    \textcolor{keywordflow}{return} 1;
  \}

  mp = \hyperlink{lspmac_8c_a22ef36819bdee963712691e660cfc101}{lspmac\_find\_motor\_by\_name}( mtr);
  \textcolor{keywordflow}{if}( mp == NULL) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_moveAbs: cannot find
       motor %s"}, mtr);
    free( cmd);
    \textcolor{keywordflow}{return} 1;
  \}

  pos = strtok\_r( NULL, \textcolor{stringliteral}{" "}, &ptr);
  \textcolor{keywordflow}{if}( pos == NULL) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_moveAbs: missing
       position"});
    free( cmd);
    \textcolor{keywordflow}{return} 1;
  \}

  fpos = strtod( pos, &endptr);
  \textcolor{keywordflow}{if}( pos == endptr) \{
    \textcolor{comment}{//}
    \textcolor{comment}{// Maybe we have a preset.  Give it a whirl}
    \textcolor{comment}{// In any case we are done here.}
    \textcolor{comment}{//}
    err = \hyperlink{lspmac_8c_acd26454acc150847b01717f60f956674}{lspmac\_move\_preset\_queue}( mp, pos);
    free( cmd);
    \textcolor{keywordflow}{return} err;
  \}

  \textcolor{keywordflow}{if}( mp != NULL && mp->\hyperlink{structlspmac__motor__struct_a38b6eee046c3ceff84f908af3335ebcf}{moveAbs} != NULL) \{
    wprintw( \hyperlink{pgpmac_8c_a65daf0f4a5bc6def23a9df98ff5ca57e}{term\_output}, \textcolor{stringliteral}{"Moving %s to %f\(\backslash\)n"}, mtr, fpos);
    wnoutrefresh( \hyperlink{pgpmac_8c_a65daf0f4a5bc6def23a9df98ff5ca57e}{term\_output});
    err = mp->\hyperlink{structlspmac__motor__struct_a38b6eee046c3ceff84f908af3335ebcf}{moveAbs}( mp, fpos);
  \}

  free( cmd);
  \textcolor{keywordflow}{return} err;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a8e8eba6f3c5855910ba3cde22dd3a4b2}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-move\-Rel@{md2cmds\-\_\-move\-Rel}}
\index{md2cmds\-\_\-move\-Rel@{md2cmds\-\_\-move\-Rel}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-move\-Rel}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-move\-Rel (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{ccmd}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a8e8eba6f3c5855910ba3cde22dd3a4b2}


Move a motor to the position requested Returns non zero on error. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em ccmd} & The full command string to parse, ie, \char`\"{}move\-Abs omega 180\char`\"{} \\
\hline
\end{DoxyParams}


Definition at line 524 of file md2cmds.\-c.


\begin{DoxyCode}
                       \{
  \textcolor{keywordtype}{char} *cmd;
  \textcolor{keywordtype}{char} *ignore;
  \textcolor{keywordtype}{char} *ptr;
  \textcolor{keywordtype}{char} *mtr;
  \textcolor{keywordtype}{char} *pos;
  \textcolor{keywordtype}{double} fpos;
  \textcolor{keywordtype}{char} *endptr;
  \hyperlink{structlspmac__motor__struct}{lspmac\_motor\_t} *mp;
  \textcolor{keywordtype}{int} err;

  \textcolor{comment}{// ignore nothing}
  \textcolor{keywordflow}{if}( ccmd == NULL || *ccmd == 0) \{
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{comment}{// operate on a copy of the string since strtok\_r will modify its argument}
  \textcolor{comment}{//}
  cmd = strdup( ccmd);

  \textcolor{comment}{// Parse the command string}
  \textcolor{comment}{//}
  ignore = strtok\_r( cmd, \textcolor{stringliteral}{" "}, &ptr);
  \textcolor{keywordflow}{if}( ignore == NULL) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_moveAbs: ignoring
       blank command '%s'"}, cmd);
    free( cmd);
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{comment}{// The first string should be "moveAbs" cause that's how we got here.}
  \textcolor{comment}{// Toss it.}
  
  mtr = strtok\_r( NULL, \textcolor{stringliteral}{" "}, &ptr);
  \textcolor{keywordflow}{if}( mtr == NULL) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_moveRel: missing motor
       name"});
    free( cmd);
    \textcolor{keywordflow}{return} 1;
  \}

  mp = \hyperlink{lspmac_8c_a22ef36819bdee963712691e660cfc101}{lspmac\_find\_motor\_by\_name}( mtr);

  \textcolor{keywordflow}{if}( mp == NULL) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_moveRel: cannot find
       motor %s"}, mtr);
    free( cmd);
    \textcolor{keywordflow}{return} 1;
  \}

  pos = strtok\_r( NULL, \textcolor{stringliteral}{" "}, &ptr);
  \textcolor{keywordflow}{if}( pos == NULL) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_moveRel: missing
       position"});
    free( cmd);
    \textcolor{keywordflow}{return} 1;
  \}

  fpos = strtod( pos, &endptr);
  \textcolor{keywordflow}{if}( pos == endptr) \{
    \textcolor{comment}{//}
    \textcolor{comment}{// No incrememtnal position found}
    \textcolor{comment}{//}
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_moveRel: no new
       position requested"});
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{keywordflow}{if}( mp != NULL && mp->\hyperlink{structlspmac__motor__struct_a38b6eee046c3ceff84f908af3335ebcf}{moveAbs} != NULL) \{
    wprintw( \hyperlink{pgpmac_8c_a65daf0f4a5bc6def23a9df98ff5ca57e}{term\_output}, \textcolor{stringliteral}{"Moving %s by %f\(\backslash\)n"}, mtr, fpos);
    wnoutrefresh( \hyperlink{pgpmac_8c_a65daf0f4a5bc6def23a9df98ff5ca57e}{term\_output});
    err = mp->\hyperlink{structlspmac__motor__struct_a38b6eee046c3ceff84f908af3335ebcf}{moveAbs}( mp, \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}(mp) + 
      fpos);
  \}

  free( cmd);
  \textcolor{keywordflow}{return} err;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_afdc46152b46ae4d37c73407b83016b78}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-mvcenter\-\_\-move@{md2cmds\-\_\-mvcenter\-\_\-move}}
\index{md2cmds\-\_\-mvcenter\-\_\-move@{md2cmds\-\_\-mvcenter\-\_\-move}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-mvcenter\-\_\-move}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-mvcenter\-\_\-move (
\begin{DoxyParamCaption}
\item[{double}]{cx, }
\item[{double}]{cy, }
\item[{double}]{ax, }
\item[{double}]{ay, }
\item[{double}]{az}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_afdc46152b46ae4d37c73407b83016b78}


Move the centering and alignment tables. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em cx} & Requested Centering Table X \\
\hline
\mbox{\tt in}  & {\em cy} & Requested Centering Table Y \\
\hline
\mbox{\tt in}  & {\em ax} & Requested Alignment Table X \\
\hline
\mbox{\tt in}  & {\em ay} & Requested Alignment Table Y \\
\hline
\mbox{\tt in}  & {\em az} & Requested Alignment Table Z \\
\hline
\end{DoxyParams}


Definition at line 919 of file md2cmds.\-c.


\begin{DoxyCode}
                             \{
  
  \textcolor{comment}{//}
  \textcolor{comment}{// centering stage is coordinate system 2}
  \textcolor{comment}{// alignment stage is coordinate system 3}
  \textcolor{comment}{//}
  
  \textcolor{keywordtype}{double} cx\_cts, cy\_cts, ax\_cts, ay\_cts, az\_cts;

  cx\_cts = \hyperlink{md2cmds_8c_ab1cc77bc7476714a419c7db69c7c4be4}{md2cmds\_prep\_axis}( \hyperlink{lspmac_8c_ac940d950d9efeaf3f0ae67e9bf331188}{cenx},   cx);
  cy\_cts = \hyperlink{md2cmds_8c_ab1cc77bc7476714a419c7db69c7c4be4}{md2cmds\_prep\_axis}( \hyperlink{lspmac_8c_aaed18e738ba7bfb6c771a44f5d7ea827}{ceny},   cy);
  ax\_cts = \hyperlink{md2cmds_8c_ab1cc77bc7476714a419c7db69c7c4be4}{md2cmds\_prep\_axis}( \hyperlink{lspmac_8c_a6cb218bdccfe5a93471c161f15a15cab}{alignx}, ax);
  ay\_cts = \hyperlink{md2cmds_8c_ab1cc77bc7476714a419c7db69c7c4be4}{md2cmds\_prep\_axis}( \hyperlink{lspmac_8c_a737c246c3948e644a18d191a931e1acd}{aligny}, ay);
  az\_cts = \hyperlink{md2cmds_8c_ab1cc77bc7476714a419c7db69c7c4be4}{md2cmds\_prep\_axis}( \hyperlink{lspmac_8c_ae7642b1da0f7c7f8448104c691d40a12}{alignz}, az);

  \hyperlink{lspmac_8c_afab9e8f0502a92ee5cf93209af710f81}{lspmac\_SockSendDPline}( NULL, \textcolor{stringliteral}{"&2 Q100=2 Q20=%.1f
       Q21=%.1f B150R"}, cx\_cts, cy\_cts);
  \hyperlink{lspmac_8c_afab9e8f0502a92ee5cf93209af710f81}{lspmac\_SockSendDPline}( \textcolor{stringliteral}{"mvcenter\_move"}, \textcolor{stringliteral}{"&3 Q100=4
       Q30=%.1f Q31=%.1f Q32=%.1f B160R"}, ax\_cts, ay\_cts, az\_cts);
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a09a28007e7d8df7b8f97207474e5e516}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-organs\-\_\-move\-\_\-presets@{md2cmds\-\_\-organs\-\_\-move\-\_\-presets}}
\index{md2cmds\-\_\-organs\-\_\-move\-\_\-presets@{md2cmds\-\_\-organs\-\_\-move\-\_\-presets}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-organs\-\_\-move\-\_\-presets}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-organs\-\_\-move\-\_\-presets (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{pay, }
\item[{char $\ast$}]{paz, }
\item[{char $\ast$}]{pcy, }
\item[{char $\ast$}]{pcz, }
\item[{char $\ast$}]{psz}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a09a28007e7d8df7b8f97207474e5e516}


Definition at line 211 of file md2cmds.\-c.


\begin{DoxyCode}
                                                                               
                \{
  \textcolor{keywordtype}{double} ay,   az,  cy,  cz,  sz;
  \textcolor{keywordtype}{int}    cay, caz, ccy, ccz, csz;
  \textcolor{keywordtype}{int} err;

  err = \hyperlink{lsredis_8c_a87d7bb0ade6f247edfbb7803aac9e694}{lsredis\_find\_preset}( \hyperlink{lspmac_8c_a139200ddaa9856a7ffcec0e6cbaa8f1b}{apery}->\hyperlink{structlspmac__motor__struct_aa90af2f6f1489f1befe1d0891e51575a}{name}, pay, &ay)
      ;
  \textcolor{keywordflow}{if}( err == 0) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_move\_organs\_presets:
       no preset '%s' for motor '%s'"}, pay, \hyperlink{lspmac_8c_a139200ddaa9856a7ffcec0e6cbaa8f1b}{apery}->\hyperlink{structlspmac__motor__struct_aa90af2f6f1489f1befe1d0891e51575a}{name});
    \textcolor{keywordflow}{return};
  \}
  
  err = \hyperlink{lsredis_8c_a87d7bb0ade6f247edfbb7803aac9e694}{lsredis\_find\_preset}( \hyperlink{lspmac_8c_ab93bd6ee850b285ca3a95e64d15e9477}{aperz}->\hyperlink{structlspmac__motor__struct_aa90af2f6f1489f1befe1d0891e51575a}{name}, paz, &az)
      ;
  \textcolor{keywordflow}{if}( err == 0) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_move\_organs\_presets:
       no preset '%s' for motor '%s'"}, paz, \hyperlink{lspmac_8c_ab93bd6ee850b285ca3a95e64d15e9477}{aperz}->\hyperlink{structlspmac__motor__struct_aa90af2f6f1489f1befe1d0891e51575a}{name});
    \textcolor{keywordflow}{return};
  \}
  
  err = \hyperlink{lsredis_8c_a87d7bb0ade6f247edfbb7803aac9e694}{lsredis\_find\_preset}( \hyperlink{lspmac_8c_a51358daaea8b5236f08414877d8af6c2}{capy}->\hyperlink{structlspmac__motor__struct_aa90af2f6f1489f1befe1d0891e51575a}{name}, pcy, &cy);
  \textcolor{keywordflow}{if}( err == 0) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_organs\_move\_presets:
       no preset '%s' for motor '%s'"}, pcy, \hyperlink{lspmac_8c_a51358daaea8b5236f08414877d8af6c2}{capy}->\hyperlink{structlspmac__motor__struct_aa90af2f6f1489f1befe1d0891e51575a}{name});
    \textcolor{keywordflow}{return};
  \}

  err = \hyperlink{lsredis_8c_a87d7bb0ade6f247edfbb7803aac9e694}{lsredis\_find\_preset}( \hyperlink{lspmac_8c_aa45f268d0af9f3d465acfab128919718}{capz}->\hyperlink{structlspmac__motor__struct_aa90af2f6f1489f1befe1d0891e51575a}{name}, pcz, &cz);
  \textcolor{keywordflow}{if}( err == 0) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_organs\_move\_presets:
       no preset '%s' for motor '%s'"}, pcz, \hyperlink{lspmac_8c_aa45f268d0af9f3d465acfab128919718}{capz}->\hyperlink{structlspmac__motor__struct_aa90af2f6f1489f1befe1d0891e51575a}{name});
    \textcolor{keywordflow}{return};
  \}

  err = \hyperlink{lsredis_8c_a87d7bb0ade6f247edfbb7803aac9e694}{lsredis\_find\_preset}( \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint}->\hyperlink{structlspmac__motor__struct_aa90af2f6f1489f1befe1d0891e51575a}{name}, psz, &sz)
      ;
  \textcolor{keywordflow}{if}( err == 0) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_organs\_move\_presets:
       no preset '%s' for motor '%s'"}, psz, \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint}->\hyperlink{structlspmac__motor__struct_aa90af2f6f1489f1befe1d0891e51575a}{name});
    \textcolor{keywordflow}{return};
  \}

  cay = \hyperlink{md2cmds_8c_ab1cc77bc7476714a419c7db69c7c4be4}{md2cmds\_prep\_axis}( \hyperlink{lspmac_8c_a139200ddaa9856a7ffcec0e6cbaa8f1b}{apery}, ay);
  caz = \hyperlink{md2cmds_8c_ab1cc77bc7476714a419c7db69c7c4be4}{md2cmds\_prep\_axis}( \hyperlink{lspmac_8c_ab93bd6ee850b285ca3a95e64d15e9477}{aperz}, az);
  ccy = \hyperlink{md2cmds_8c_ab1cc77bc7476714a419c7db69c7c4be4}{md2cmds\_prep\_axis}( \hyperlink{lspmac_8c_a51358daaea8b5236f08414877d8af6c2}{capy},  cy);
  ccz = \hyperlink{md2cmds_8c_ab1cc77bc7476714a419c7db69c7c4be4}{md2cmds\_prep\_axis}( \hyperlink{lspmac_8c_aa45f268d0af9f3d465acfab128919718}{capz},  cz);
  csz = \hyperlink{md2cmds_8c_ab1cc77bc7476714a419c7db69c7c4be4}{md2cmds\_prep\_axis}( \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint}, sz);
  
  \textcolor{comment}{//}
  \textcolor{comment}{// 170          LS-CAT Move U, V, W, X, Y, Z Absolute}
  \textcolor{comment}{//                  Q40     = X Value}
  \textcolor{comment}{//                  Q41     = Y Value}
  \textcolor{comment}{//                  Q42     = Z Value}
  \textcolor{comment}{//                  Q43     = U Value}
  \textcolor{comment}{//                  Q44     = V Value}
  \textcolor{comment}{//                  Q45     = W Value}
  \textcolor{comment}{//}
  
  \hyperlink{lspmac_8c_afab9e8f0502a92ee5cf93209af710f81}{lspmac\_SockSendDPline}( \textcolor{stringliteral}{"organs"}, \textcolor{stringliteral}{"&5 Q40=0 Q41=%d Q42=%d
       Q43=%d Q44=%d Q45=%d Q100=16 B170R"}, cay, caz, ccy, ccz, csz);
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a7801a711b56fb1c337890cb69010aa21}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-phase\-\_\-beam\-Location@{md2cmds\-\_\-phase\-\_\-beam\-Location}}
\index{md2cmds\-\_\-phase\-\_\-beam\-Location@{md2cmds\-\_\-phase\-\_\-beam\-Location}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-phase\-\_\-beam\-Location}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-phase\-\_\-beam\-Location (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a7801a711b56fb1c337890cb69010aa21}


Go to beam location phase. 



Definition at line 778 of file md2cmds.\-c.


\begin{DoxyCode}
                                 \{
  \textcolor{keywordtype}{double} move\_time;
  \textcolor{keywordtype}{int} mmask, err;

  \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode beamLocation Starting"});

  mmask = 0;
  err = \hyperlink{lspmac_8c_a984a1d6e49ad53d6a1184666881bf117}{lspmac\_est\_move\_time}( &move\_time, &mmask,
                              \textcolor{comment}{//motor   jog, preset,      position if no preset
                                                                                      
                                                                                      
                                                                    kappa,      0,
       NULL,           0.0,}
                              \hyperlink{lspmac_8c_a8237e646ce032a840637a4ef7bff49b9}{omega},      0, NULL,           0.0,
                              \hyperlink{lspmac_8c_a139200ddaa9856a7ffcec0e6cbaa8f1b}{apery},      0, \textcolor{stringliteral}{"In"},           0.0,
                              \hyperlink{lspmac_8c_ab93bd6ee850b285ca3a95e64d15e9477}{aperz},      0, \textcolor{stringliteral}{"In"},           0.0,
                              \hyperlink{lspmac_8c_a51358daaea8b5236f08414877d8af6c2}{capy},       0, \textcolor{stringliteral}{"In"},           0.0,
                              \hyperlink{lspmac_8c_aa45f268d0af9f3d465acfab128919718}{capz},       0, \textcolor{stringliteral}{"In"},           0.0,
                              \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint},      0, \textcolor{stringliteral}{"Scintillator"}, 0.0,
                              \hyperlink{lspmac_8c_a85d6eaa4b4a82bb3112574f458d1dc50}{blight},     1, NULL,           0.0,
                              \hyperlink{lspmac_8c_af813a2eff0b7efa4c70633559054e84c}{blight\_ud},  1, NULL,           0.0,
                              \hyperlink{lspmac_8c_ad53a42cfaa04eff0336a44c8c9986333}{zoom},       0, NULL,           1.0,
                              \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo},       1, NULL,           0.0,
                              \hyperlink{lspmac_8c_addb26c80065506faa1de3c1b468fe03f}{fluo},       1, NULL,           0.0,
                              NULL);
  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode beamLocation Aborted"});
    \textcolor{keywordflow}{return} err;
  \}

  err = \hyperlink{lspmac_8c_a570b4a359adc4da4ab80d53506d06963}{lspmac\_est\_move\_time\_wait}( move\_time + 2.0, 
      mmask, \hyperlink{lspmac_8c_af813a2eff0b7efa4c70633559054e84c}{blight\_ud}, \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo}, \hyperlink{lspmac_8c_addb26c80065506faa1de3c1b468fe03f}{fluo}, NULL);
  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode beamLocation Aborted"});
    \textcolor{keywordflow}{return} err;
  \}

  \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode beamLocation Done"});
  \textcolor{keywordflow}{return} 0;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a459291b5e2a267e8344431421805d81c}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-phase\-\_\-center@{md2cmds\-\_\-phase\-\_\-center}}
\index{md2cmds\-\_\-phase\-\_\-center@{md2cmds\-\_\-phase\-\_\-center}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-phase\-\_\-center}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-phase\-\_\-center (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a459291b5e2a267e8344431421805d81c}


Go to center phase. 



Definition at line 703 of file md2cmds.\-c.


\begin{DoxyCode}
                           \{
  \textcolor{keywordtype}{double} move\_time;
  \textcolor{keywordtype}{int} mmask, err;

  \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode center Starting"});
  \textcolor{comment}{//                                                                           
                                                                                      
                                                                                      
                                        // Move 'em                                   
                                                                                      
                                                                                      
                                                                       //             
                                                                                      
                                                                                      
                                                                                      
                     }
  mmask = 0;
  err = \hyperlink{lspmac_8c_a984a1d6e49ad53d6a1184666881bf117}{lspmac\_est\_move\_time}( &move\_time, &mmask,
                              \hyperlink{lspmac_8c_a8237e646ce032a840637a4ef7bff49b9}{omega},     0, NULL,    0.0,
                              \hyperlink{lspmac_8c_a0be79ccb7ebf3a665248fd856112b9fd}{kappa},     0, NULL,    0.0,
                              \hyperlink{lspmac_8c_ac8070dc568ad974a3db42b51eca828cc}{phi},       0, NULL,    0.0,
                              \hyperlink{lspmac_8c_a139200ddaa9856a7ffcec0e6cbaa8f1b}{apery},     0, \textcolor{stringliteral}{"In"},    0.0,
                              \hyperlink{lspmac_8c_ab93bd6ee850b285ca3a95e64d15e9477}{aperz},     0, \textcolor{stringliteral}{"In"},    0.0,
                              \hyperlink{lspmac_8c_a51358daaea8b5236f08414877d8af6c2}{capy},      0, \textcolor{stringliteral}{"In"},    0.0,
                              \hyperlink{lspmac_8c_aa45f268d0af9f3d465acfab128919718}{capz},      0, \textcolor{stringliteral}{"In"},    0.0,
                              \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint},     0, \textcolor{stringliteral}{"Cover"}, 0.0,
                              \hyperlink{lspmac_8c_af813a2eff0b7efa4c70633559054e84c}{blight\_ud}, 1, NULL,    1.0,
                              \hyperlink{lspmac_8c_ad53a42cfaa04eff0336a44c8c9986333}{zoom},      0, NULL,    1.0,
                              \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo},      1, NULL,    0.0,
                              \hyperlink{lspmac_8c_addb26c80065506faa1de3c1b468fe03f}{fluo},      1, NULL,    0.0,
                              NULL);
  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode center Aborted"});
    \textcolor{keywordflow}{return} err;
  \}

  err = \hyperlink{lspmac_8c_a570b4a359adc4da4ab80d53506d06963}{lspmac\_est\_move\_time\_wait}( move\_time + 2.0, 
      mmask, \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo}, \hyperlink{lspmac_8c_addb26c80065506faa1de3c1b468fe03f}{fluo}, NULL);
  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode center Aborted"});
    \textcolor{keywordflow}{return} err;
  \}

  \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode center Done"});
  \textcolor{keywordflow}{return} 0;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a4569e8e2b269463b2a60b8407d9ce4d9}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-phase\-\_\-change@{md2cmds\-\_\-phase\-\_\-change}}
\index{md2cmds\-\_\-phase\-\_\-change@{md2cmds\-\_\-phase\-\_\-change}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-phase\-\_\-change}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-phase\-\_\-change (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{ccmd}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a4569e8e2b269463b2a60b8407d9ce4d9}


Move md2 devices to a preconfigured state. 


\begin{DoxyItemize}
\item E\-M\-B\-L calls these states \char`\"{}phases\char`\"{} and this language is partially retained here $\ast$ $\ast$ 
\begin{DoxyParams}{Parameters}
{\em ccmd} & The full text of the command that sent us here \\
\hline
\end{DoxyParams}

\end{DoxyItemize}

Definition at line 859 of file md2cmds.\-c.


\begin{DoxyCode}
                                            \{
  \textcolor{keywordtype}{char} *cmd;
  \textcolor{keywordtype}{char} *ignore;
  \textcolor{keywordtype}{char} *ptr;
  \textcolor{keywordtype}{char} *mode;
  \textcolor{keywordtype}{int} err;

  \textcolor{keywordflow}{if}( ccmd == NULL || *ccmd == 0)
    \textcolor{keywordflow}{return} 1;

  \textcolor{comment}{// use a copy as strtok\_r modifies the string it is parsing                  
                                                                                      
                                                                                      
                                        //                                            
                                                                                      
                                                                                      
                                                                      }
  cmd = strdup( ccmd);

  ignore = strtok\_r( cmd, \textcolor{stringliteral}{" "}, &ptr);
  \textcolor{keywordflow}{if}( ignore == NULL) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_phase\_change: ignoring
       empty command string (how did we let things get this far?"});
    free( cmd);
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{comment}{//                                                                           
                                                                                      
                                                                                      
                                        // ignore should point to "mode" cause that's
       how we got here.  Ignore it                                                     
                                                                                      
                                                                       //             
                                                                                      
                                                                                      
                                                                                      
                     }
  mode = strtok\_r( NULL, \textcolor{stringliteral}{" "}, &ptr);
  \textcolor{keywordflow}{if}( mode == NULL) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_phase\_change: no mode
       specified"});
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_ac7a133655e9bb91bbbd6cd316e4191fb}{md2cmds\_is\_moving}()) \{
    \textcolor{keywordtype}{int} err;
    \hyperlink{lspmac_8c_a0575fc751cecf35ffe8b290ab483ac21}{lspmac\_SockSendDPControlChar}( \textcolor{stringliteral}{"Aborting Motions
      "}, \textcolor{stringliteral}{'\(\backslash\)x01'});
    err = \hyperlink{md2cmds_8c_a7cd262eaeafc85a6111cf06de4f29601}{md2cmds\_move\_wait}( 2.0);
    \textcolor{keywordflow}{if}( err) \{
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_phase\_change: Timed
       out waiting for previous moves to finish"});
      \textcolor{keywordflow}{return} 1;
    \}
  \}

  \textcolor{comment}{//                                                                           
                                                                                      
                                                                                      
                                        // Tangled web.  Probably not worth fixing. 
       O(N) but N is 6.                                                                 
                                                                                      
                                                                       //             
                                                                                      
                                                                                      
                                                                                      
                     }
  \textcolor{keywordflow}{if}( strcmp( mode, \textcolor{stringliteral}{"manualMount"}) == 0) \{
    err = \hyperlink{md2cmds_8c_a7ecd73ece729c96219eb83f51a3c0b60}{md2cmds\_phase\_manualMount}();
  \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}( strcmp( mode, \textcolor{stringliteral}{"robotMount"}) == 0) \{
    err = \hyperlink{md2cmds_8c_aac780d49120cea87b4bb7690c544e665}{md2cmds\_phase\_robotMount}();
  \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}( strcmp( mode, \textcolor{stringliteral}{"center"}) == 0) \{
    err = \hyperlink{md2cmds_8c_a459291b5e2a267e8344431421805d81c}{md2cmds\_phase\_center}();
  \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}( strcmp( mode, \textcolor{stringliteral}{"dataCollection"}) == 0) \{
    err = \hyperlink{md2cmds_8c_a1d54ec68fd8f1c1743ab5bf0e7905266}{md2cmds\_phase\_dataCollection}();
  \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}( strcmp( mode, \textcolor{stringliteral}{"beamLocation"}) == 0) \{
    err = \hyperlink{md2cmds_8c_a7801a711b56fb1c337890cb69010aa21}{md2cmds\_phase\_beamLocation}();
  \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}( strcmp( mode, \textcolor{stringliteral}{"safe"}) == 0) \{
    err = \hyperlink{md2cmds_8c_a38e97b92a6ed2e81b74f2ee9411271d0}{md2cmds\_phase\_safe}();
  \}

  free( cmd);
  \textcolor{keywordflow}{return} err;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a1d54ec68fd8f1c1743ab5bf0e7905266}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-phase\-\_\-data\-Collection@{md2cmds\-\_\-phase\-\_\-data\-Collection}}
\index{md2cmds\-\_\-phase\-\_\-data\-Collection@{md2cmds\-\_\-phase\-\_\-data\-Collection}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-phase\-\_\-data\-Collection}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-phase\-\_\-data\-Collection (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a1d54ec68fd8f1c1743ab5bf0e7905266}


Go to data collection phase. 



Definition at line 742 of file md2cmds.\-c.


\begin{DoxyCode}
                                   \{
  \textcolor{keywordtype}{double} move\_time;
  \textcolor{keywordtype}{int} mmask, err;

  \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode dataCollection Starting"});

  mmask = 0;
  err = \hyperlink{lspmac_8c_a984a1d6e49ad53d6a1184666881bf117}{lspmac\_est\_move\_time}( &move\_time, &mmask,
                              \hyperlink{lspmac_8c_a139200ddaa9856a7ffcec0e6cbaa8f1b}{apery},     1, \textcolor{stringliteral}{"In"},     0.0,
                              \hyperlink{lspmac_8c_ab93bd6ee850b285ca3a95e64d15e9477}{aperz},     1, \textcolor{stringliteral}{"In"},     0.0,
                              \hyperlink{lspmac_8c_a51358daaea8b5236f08414877d8af6c2}{capy},      1, \textcolor{stringliteral}{"In"},     0.0,
                              \hyperlink{lspmac_8c_aa45f268d0af9f3d465acfab128919718}{capz},      1, \textcolor{stringliteral}{"In"},     0.0,
                              \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint},     1, \textcolor{stringliteral}{"Cover"},  0.0,
                              \hyperlink{lspmac_8c_a85d6eaa4b4a82bb3112574f458d1dc50}{blight},    1, NULL,     0.0,
                              \hyperlink{lspmac_8c_af813a2eff0b7efa4c70633559054e84c}{blight\_ud}, 1, NULL,     0.0,
                              \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo},      1, NULL,     0.0,
                              \hyperlink{lspmac_8c_addb26c80065506faa1de3c1b468fe03f}{fluo},      1, NULL,     0.0,
                              NULL);
  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode dataCollection Aborted"});
    \textcolor{keywordflow}{return} err;
  \}

  err = \hyperlink{lspmac_8c_a570b4a359adc4da4ab80d53506d06963}{lspmac\_est\_move\_time\_wait}( move\_time + 2.0, 
      mmask, \hyperlink{lspmac_8c_a139200ddaa9856a7ffcec0e6cbaa8f1b}{apery}, \hyperlink{lspmac_8c_ab93bd6ee850b285ca3a95e64d15e9477}{aperz}, \hyperlink{lspmac_8c_a51358daaea8b5236f08414877d8af6c2}{capy}, \hyperlink{lspmac_8c_aa45f268d0af9f3d465acfab128919718}{capz}, \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint}, \hyperlink{lspmac_8c_af813a2eff0b7efa4c70633559054e84c}{blight\_ud},
       \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo}, \hyperlink{lspmac_8c_addb26c80065506faa1de3c1b468fe03f}{fluo}, NULL);
  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode dataCollection Aborted"});
    \textcolor{keywordflow}{return} err;
  \}

  \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode dataCollection Done"});
  \textcolor{keywordflow}{return} 0;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a7ecd73ece729c96219eb83f51a3c0b60}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-phase\-\_\-manual\-Mount@{md2cmds\-\_\-phase\-\_\-manual\-Mount}}
\index{md2cmds\-\_\-phase\-\_\-manual\-Mount@{md2cmds\-\_\-phase\-\_\-manual\-Mount}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-phase\-\_\-manual\-Mount}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-phase\-\_\-manual\-Mount (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a7ecd73ece729c96219eb83f51a3c0b60}


Go to the manual mount phase. 



Definition at line 605 of file md2cmds.\-c.


\begin{DoxyCode}
                                \{
  \textcolor{keywordtype}{double} move\_time;
  \textcolor{keywordtype}{int} mmask, err;

  \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode manualMount Starting"});
  \textcolor{comment}{//}
  \textcolor{comment}{// Move stuff}
  \textcolor{comment}{//}
  mmask = 0;
  err = \hyperlink{lspmac_8c_a984a1d6e49ad53d6a1184666881bf117}{lspmac\_est\_move\_time}( &move\_time, &mmask,
                              \hyperlink{lspmac_8c_a0be79ccb7ebf3a665248fd856112b9fd}{kappa},     0, \textcolor{stringliteral}{"manualMount"}, 0.0,
                              \hyperlink{lspmac_8c_a8237e646ce032a840637a4ef7bff49b9}{omega},     0, \textcolor{stringliteral}{"manualMount"}, 0.0,
                              \hyperlink{lspmac_8c_ac8070dc568ad974a3db42b51eca828cc}{phi},       0, NULL,          0.0,
                              \hyperlink{lspmac_8c_ab93bd6ee850b285ca3a95e64d15e9477}{aperz},     1, \textcolor{stringliteral}{"Cover"},       0.0,
                              \hyperlink{lspmac_8c_aa45f268d0af9f3d465acfab128919718}{capz},      1, \textcolor{stringliteral}{"Cover"},       0.0,
                              \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint},     1, \textcolor{stringliteral}{"Cover"},       0.0,
                              \hyperlink{lspmac_8c_a85d6eaa4b4a82bb3112574f458d1dc50}{blight},    1, NULL,          0.0,
                              \hyperlink{lspmac_8c_af813a2eff0b7efa4c70633559054e84c}{blight\_ud}, 1, NULL,          0.0,
                              \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo},      1, NULL,          0.0,
                              \hyperlink{lspmac_8c_addb26c80065506faa1de3c1b468fe03f}{fluo},      1, NULL,          0.0,
                              \hyperlink{lspmac_8c_ad53a42cfaa04eff0336a44c8c9986333}{zoom},      0, NULL,          1.0,
                              NULL);


  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode manualMount Aborted"});
    \textcolor{keywordflow}{return} err;
  \}

  \textcolor{comment}{//                                                                           
                                                                                      
                                                                                      
                                       }
  \textcolor{comment}{// Wait for motion programs                                                  
                                                                                      
                                                                                      
                                       }
  \textcolor{comment}{//                                                                           
                                                                                      
                                                                                      
                                       }
  err = \hyperlink{lspmac_8c_a570b4a359adc4da4ab80d53506d06963}{lspmac\_est\_move\_time\_wait}( move\_time+2.0, 
      mmask, \hyperlink{lspmac_8c_ab93bd6ee850b285ca3a95e64d15e9477}{aperz}, \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint}, \hyperlink{lspmac_8c_af813a2eff0b7efa4c70633559054e84c}{blight\_ud}, \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo}, \hyperlink{lspmac_8c_addb26c80065506faa1de3c1b468fe03f}{fluo}, NULL);
  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode manualMount Aborted"});
    \textcolor{keywordflow}{return} err;
  \}

  \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode manualMount Done"});
  \textcolor{keywordflow}{return} 0;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_aac780d49120cea87b4bb7690c544e665}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-phase\-\_\-robot\-Mount@{md2cmds\-\_\-phase\-\_\-robot\-Mount}}
\index{md2cmds\-\_\-phase\-\_\-robot\-Mount@{md2cmds\-\_\-phase\-\_\-robot\-Mount}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-phase\-\_\-robot\-Mount}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-phase\-\_\-robot\-Mount (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_aac780d49120cea87b4bb7690c544e665}


Go to robot mount phase. 



Definition at line 649 of file md2cmds.\-c.


\begin{DoxyCode}
                               \{
  \textcolor{keywordtype}{double} move\_time;
  \textcolor{keywordtype}{int} mmask, err;

  \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode robotMount Starting"});

  \hyperlink{md2cmds_8c_a408a01640e74152304b10ae05f5d09e1}{md2cmds\_home\_prep}();

  \textcolor{comment}{//                                                                           
                                                                                      
                                                                                      
                                        // Move 'em                                   
                                                                                      
                                                                                      
                                                                       //             
                                                                                      
                                                                                      
                                                                                      
                      lspmac\_home1\_queue( kappa);}
  \hyperlink{lspmac_8c_a9fbadf816a842c8f131cf8ee47b54e29}{lspmac\_home1\_queue}( \hyperlink{lspmac_8c_a8237e646ce032a840637a4ef7bff49b9}{omega});
  \hyperlink{lspmac_8c_a9fbadf816a842c8f131cf8ee47b54e29}{lspmac\_home1\_queue}( \hyperlink{lspmac_8c_a0be79ccb7ebf3a665248fd856112b9fd}{kappa});

  mmask = 0;
  err = \hyperlink{lspmac_8c_a984a1d6e49ad53d6a1184666881bf117}{lspmac\_est\_move\_time}( &move\_time, &mmask,
                              \hyperlink{lspmac_8c_a139200ddaa9856a7ffcec0e6cbaa8f1b}{apery},     1, \textcolor{stringliteral}{"In"},    0.0,
                              \hyperlink{lspmac_8c_ab93bd6ee850b285ca3a95e64d15e9477}{aperz},     1, \textcolor{stringliteral}{"In"},    0.0,
                              \hyperlink{lspmac_8c_aa45f268d0af9f3d465acfab128919718}{capz},      1, \textcolor{stringliteral}{"Cover"}, 0.0,
                              \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint},     1, \textcolor{stringliteral}{"Cover"}, 0.0,
                              \hyperlink{lspmac_8c_a85d6eaa4b4a82bb3112574f458d1dc50}{blight},    1, NULL,    0.0,
                              \hyperlink{lspmac_8c_af813a2eff0b7efa4c70633559054e84c}{blight\_ud}, 1, NULL,    0.0,
                              \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo},      1, NULL,    0.0,
                              \hyperlink{lspmac_8c_addb26c80065506faa1de3c1b468fe03f}{fluo},      1, NULL,    0.0,
                              \hyperlink{lspmac_8c_ad53a42cfaa04eff0336a44c8c9986333}{zoom},      0, NULL,    1.0,
                              NULL);

  err = \hyperlink{lspmac_8c_a570b4a359adc4da4ab80d53506d06963}{lspmac\_est\_move\_time\_wait}( move\_time + 2.0, 
      mmask, \hyperlink{lspmac_8c_a139200ddaa9856a7ffcec0e6cbaa8f1b}{apery}, \hyperlink{lspmac_8c_ab93bd6ee850b285ca3a95e64d15e9477}{aperz}, \hyperlink{lspmac_8c_aa45f268d0af9f3d465acfab128919718}{capz}, \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint}, \hyperlink{lspmac_8c_af813a2eff0b7efa4c70633559054e84c}{blight\_ud}, \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo},
       \hyperlink{lspmac_8c_addb26c80065506faa1de3c1b468fe03f}{fluo}, NULL);
  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode robotMount Aborted"});
    \textcolor{keywordflow}{return} err;
  \}

  err = \hyperlink{md2cmds_8c_aaf5225dbdfe8b04318070c1167ff6a22}{md2cmds\_home\_wait}( 60.0);
  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_phase\_robotMount:
       timed out homing omega or kappa"});
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode robotMount Aborted"});
    \textcolor{keywordflow}{return} err;
  \}

  \hyperlink{md2cmds_8c_a408a01640e74152304b10ae05f5d09e1}{md2cmds\_home\_prep}();
  \hyperlink{lspmac_8c_a9fbadf816a842c8f131cf8ee47b54e29}{lspmac\_home1\_queue}( \hyperlink{lspmac_8c_ac8070dc568ad974a3db42b51eca828cc}{phi});
  err = \hyperlink{md2cmds_8c_aaf5225dbdfe8b04318070c1167ff6a22}{md2cmds\_home\_wait}( 60.0);
  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_phase\_robotMount:
       timed out homing phi"});
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode robotMount Aborted"});
    \textcolor{keywordflow}{return} err;
  \}


  \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode robotMount Done"});
  \textcolor{keywordflow}{return} 0;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a38e97b92a6ed2e81b74f2ee9411271d0}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-phase\-\_\-safe@{md2cmds\-\_\-phase\-\_\-safe}}
\index{md2cmds\-\_\-phase\-\_\-safe@{md2cmds\-\_\-phase\-\_\-safe}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-phase\-\_\-safe}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-phase\-\_\-safe (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a38e97b92a6ed2e81b74f2ee9411271d0}


Go to safe phase. 



Definition at line 817 of file md2cmds.\-c.


\begin{DoxyCode}
                         \{
  \textcolor{keywordtype}{double} move\_time;
  \textcolor{keywordtype}{int} mmask, err;

  \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode safe Starting"});

  mmask = 0;
  err = \hyperlink{lspmac_8c_a984a1d6e49ad53d6a1184666881bf117}{lspmac\_est\_move\_time}( &move\_time, &mmask,
                              \textcolor{comment}{//motor   jog, preset,      position if no preset
                                                                                      
                                                                                      
                                       }
                              \hyperlink{lspmac_8c_a0be79ccb7ebf3a665248fd856112b9fd}{kappa},      0, NULL,           0.0,
                              \hyperlink{lspmac_8c_a8237e646ce032a840637a4ef7bff49b9}{omega},      0, NULL,           0.0,
                              \hyperlink{lspmac_8c_a139200ddaa9856a7ffcec0e6cbaa8f1b}{apery},      1, \textcolor{stringliteral}{"In"},           0.0,
                              \hyperlink{lspmac_8c_ab93bd6ee850b285ca3a95e64d15e9477}{aperz},      1, \textcolor{stringliteral}{"Cover"},        0.0,
                              \hyperlink{lspmac_8c_a51358daaea8b5236f08414877d8af6c2}{capy},       1, \textcolor{stringliteral}{"In"},           0.0,
                              \hyperlink{lspmac_8c_aa45f268d0af9f3d465acfab128919718}{capz},       1, \textcolor{stringliteral}{"Cover"},        0.0,
                              \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint},      1, \textcolor{stringliteral}{"Cover"},        0.0,
                              \hyperlink{lspmac_8c_a85d6eaa4b4a82bb3112574f458d1dc50}{blight},     1, NULL,           0.0,
                              \hyperlink{lspmac_8c_af813a2eff0b7efa4c70633559054e84c}{blight\_ud},  1, NULL,           0.0,
                              \hyperlink{lspmac_8c_ad53a42cfaa04eff0336a44c8c9986333}{zoom},       0, NULL,           1.0,
                              \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo},       1, NULL,           0.0,
                              \hyperlink{lspmac_8c_addb26c80065506faa1de3c1b468fe03f}{fluo},       1, NULL,           0.0,
                              NULL);


  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode safe Aborted"});
    \textcolor{keywordflow}{return} err;
  \}

  err = \hyperlink{lspmac_8c_a570b4a359adc4da4ab80d53506d06963}{lspmac\_est\_move\_time\_wait}( move\_time + 2.0, 
      mmask, \hyperlink{lspmac_8c_a139200ddaa9856a7ffcec0e6cbaa8f1b}{apery}, \hyperlink{lspmac_8c_ab93bd6ee850b285ca3a95e64d15e9477}{aperz}, \hyperlink{lspmac_8c_a51358daaea8b5236f08414877d8af6c2}{capy}, \hyperlink{lspmac_8c_aa45f268d0af9f3d465acfab128919718}{capz}, \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint}, \hyperlink{lspmac_8c_af813a2eff0b7efa4c70633559054e84c}{blight\_ud},
       \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo}, \hyperlink{lspmac_8c_addb26c80065506faa1de3c1b468fe03f}{fluo}, NULL);
  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode safe Aborted"});
    \textcolor{keywordflow}{return} err;
  \}

  \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Mode safe Done"});
  \textcolor{keywordflow}{return} 0;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_ab1cc77bc7476714a419c7db69c7c4be4}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-prep\-\_\-axis@{md2cmds\-\_\-prep\-\_\-axis}}
\index{md2cmds\-\_\-prep\-\_\-axis@{md2cmds\-\_\-prep\-\_\-axis}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-prep\-\_\-axis}]{\setlength{\rightskip}{0pt plus 5cm}double md2cmds\-\_\-prep\-\_\-axis (
\begin{DoxyParamCaption}
\item[{{\bf lspmac\-\_\-motor\-\_\-t} $\ast$}]{mp, }
\item[{double}]{pos}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_ab1cc77bc7476714a419c7db69c7c4be4}


Definition at line 189 of file md2cmds.\-c.


\begin{DoxyCode}
                                                          \{
  \textcolor{keywordtype}{double} rtn;
  \textcolor{keywordtype}{double} u2c;
  \textcolor{keywordtype}{double} neutral\_pos;

  pthread\_mutex\_lock( &(mp->\hyperlink{structlspmac__motor__struct_a188c5b1e991750ce2ffd53e0192e0907}{mutex}));

  u2c         = \hyperlink{lsredis_8c_aa8daf63b794b6b6341018feec205cb7d}{lsredis\_getd}( mp->\hyperlink{structlspmac__motor__struct_a8838915ebb6f9989944117c8197d5e86}{u2c});
  neutral\_pos = \hyperlink{lsredis_8c_aa8daf63b794b6b6341018feec205cb7d}{lsredis\_getd}( mp->\hyperlink{structlspmac__motor__struct_ae931e9bc9fc2fa82ca649334fc052fbe}{neutral\_pos});

  mp->\hyperlink{structlspmac__motor__struct_a68c471836f52707fa8582f7860cf500f}{motion\_seen} = 0;
  mp->\hyperlink{structlspmac__motor__struct_ab7bd8bff48953ce05c758598d75877ac}{not\_done}    = 1;

  rtn = u2c   * (pos + neutral\_pos);

  pthread\_mutex\_unlock( &(mp->\hyperlink{structlspmac__motor__struct_a188c5b1e991750ce2ffd53e0192e0907}{mutex}));

  \textcolor{keywordflow}{return} rtn;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_ab562f807493aaaaf5a6a377ac6d5a45e}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-rotate@{md2cmds\-\_\-rotate}}
\index{md2cmds\-\_\-rotate@{md2cmds\-\_\-rotate}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-rotate}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-rotate (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{dummy}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_ab562f807493aaaaf5a6a377ac6d5a45e}


Spin 360 and make a video (recenter first, maybe) 


\begin{DoxyParams}{Parameters}
{\em dummy} & Unused returns non-\/zero on error \\
\hline
\end{DoxyParams}


Definition at line 1297 of file md2cmds.\-c.


\begin{DoxyCode}
                                       \{
  \textcolor{keywordtype}{double} cx, cy, ax, ay, az,   zm;
  \textcolor{keywordtype}{double}        bax, bay, baz;
  \textcolor{keywordtype}{int} mmask;
  \textcolor{keywordtype}{int} err;
  \textcolor{keywordtype}{double} move\_time;

  mmask = 0;
  \textcolor{comment}{//}
  \textcolor{comment}{// BLUMax disables scintilator here.}
  \textcolor{comment}{//}

  \textcolor{comment}{//}
  \textcolor{comment}{// get the new center information}
  \textcolor{comment}{//}
  \hyperlink{lspg_8c_a6f7cd0a06f6a266ef65b3604cf33d6c4}{lspg\_getcenter\_call}();
  \hyperlink{lspg_8c_a3e0e4b3cb9fa03961ee0c104e0b06754}{lspg\_getcenter\_wait}();


  \textcolor{comment}{// put up the back light}
  \hyperlink{lspmac_8c_af813a2eff0b7efa4c70633559054e84c}{blight\_ud}->\hyperlink{structlspmac__motor__struct_a38b6eee046c3ceff84f908af3335ebcf}{moveAbs}( \hyperlink{lspmac_8c_af813a2eff0b7efa4c70633559054e84c}{blight\_ud}, 1);

  \textcolor{comment}{//}
  \textcolor{comment}{// Get ready to move our motors}
  \hyperlink{md2cmds_8c_a408a01640e74152304b10ae05f5d09e1}{md2cmds\_home\_prep}();

  \textcolor{comment}{//}
  \textcolor{comment}{// make sure omega is homed}
  \textcolor{comment}{//}
  \hyperlink{lspmac_8c_a9fbadf816a842c8f131cf8ee47b54e29}{lspmac\_home1\_queue}( \hyperlink{lspmac_8c_a8237e646ce032a840637a4ef7bff49b9}{omega});
  \textcolor{comment}{//}
  \textcolor{comment}{// Grab the current positions}
  \textcolor{comment}{//}
  cx = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}( \hyperlink{lspmac_8c_ac940d950d9efeaf3f0ae67e9bf331188}{cenx});
  cy = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}( \hyperlink{lspmac_8c_aaed18e738ba7bfb6c771a44f5d7ea827}{ceny});
  ax = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}( \hyperlink{lspmac_8c_a6cb218bdccfe5a93471c161f15a15cab}{alignx});
  ay = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}( \hyperlink{lspmac_8c_a737c246c3948e644a18d191a931e1acd}{aligny});
  az = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}( \hyperlink{lspmac_8c_ae7642b1da0f7c7f8448104c691d40a12}{alignz});

  \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_rotate: actual positions
       cx %f, cy %f, ax %f, ay %f, az %f"}, cx, cy, ax, ay, az);

  \textcolor{keywordflow}{if}( \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_aaeb0ccf4289b4fb306c2bc04ae85b237}{no\_rows\_returned}) \{
    \textcolor{comment}{//}
    \textcolor{comment}{// Always specify zoom even if no other center information is found}
    \textcolor{comment}{//}
    zm = 1;
  \} \textcolor{keywordflow}{else} \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_rotate: getcenter
       returned dcx %f, dcy %f, dax %f, day %f, daz %f, zoom %d"},
                           \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_ade0534056296e9ed568404c538be9227}{dcx}, \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}
      .\hyperlink{structlspg__getcenter__struct_a55b1a488b714e6a40d8e06a6e182bd0a}{dcy}, \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_a17db52848c28852a470222ec93ae8886}{dax}, \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_a9ce0f29540f2ff47be9788565d19f1b8}{day}
      , \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_a1170bab2161f03ab29c39f79519ed9ae}{daz},\hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_a63e640a925611d2404a1529aea30a853}{zoom});

    \textcolor{keywordflow}{if}( \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_a6ca85a8de29039188357b2814acd7803}{zoom\_isnull} == 0) \{
      zm = \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_a63e640a925611d2404a1529aea30a853}{zoom};
    \} \textcolor{keywordflow}{else} \{
      zm = 1.0;
    \}

    \textcolor{keywordflow}{if}( \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_aa404da85af654998f039c81a77626748}{dcx\_isnull} == 0)
      cx += \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_ade0534056296e9ed568404c538be9227}{dcx};

    \textcolor{keywordflow}{if}( \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_a352c48c8d443c52f18ebd13019d01684}{dcy\_isnull} == 0)
      cy  += \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_a55b1a488b714e6a40d8e06a6e182bd0a}{dcy};

    \textcolor{comment}{//}
    \textcolor{comment}{// Slightly complicated procedure for alignment stage since we might want
       to update}
    \textcolor{comment}{// the presets.  Use the preset Back\_Vector to calculate the new Back
       preset from our}
    \textcolor{comment}{// current position.}
    \textcolor{comment}{//}
    \textcolor{keywordflow}{if}( \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_a621b489777d61e9db8b33b784b8d70f9}{dax\_isnull} == 0) \{
      err = \hyperlink{lsredis_8c_a87d7bb0ade6f247edfbb7803aac9e694}{lsredis\_find\_preset}( \textcolor{stringliteral}{"align.x"}, \textcolor{stringliteral}{"Back\_Vector"}, &
      bax);
      \textcolor{keywordflow}{if}( err == 0)
        bax = 0.0;
      bax += \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_a17db52848c28852a470222ec93ae8886}{dax};
      \hyperlink{lsredis_8c_a2b48f29f489bcbdaf4fb29e7fbf1d4d2}{lsredis\_set\_preset}( \textcolor{stringliteral}{"align.x"}, \textcolor{stringliteral}{"Back"}, bax);

      ax  += \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_a17db52848c28852a470222ec93ae8886}{dax};
      \hyperlink{lsredis_8c_a2b48f29f489bcbdaf4fb29e7fbf1d4d2}{lsredis\_set\_preset}( \textcolor{stringliteral}{"align.x"}, \textcolor{stringliteral}{"Beam"}, ax);
    \}      


    \textcolor{keywordflow}{if}( \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_a36f57a319288810caf365cca7827ff96}{day\_isnull} == 0) \{
      err = \hyperlink{lsredis_8c_a87d7bb0ade6f247edfbb7803aac9e694}{lsredis\_find\_preset}( \textcolor{stringliteral}{"align.y"}, \textcolor{stringliteral}{"Back\_Vector"}, &
      bay);
      \textcolor{keywordflow}{if}( err == 0)
        bay = 0.0;
      bay += \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_a9ce0f29540f2ff47be9788565d19f1b8}{day};
      \hyperlink{lsredis_8c_a2b48f29f489bcbdaf4fb29e7fbf1d4d2}{lsredis\_set\_preset}( \textcolor{stringliteral}{"align.y"}, \textcolor{stringliteral}{"Back"}, bay);

      ay  += \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_a9ce0f29540f2ff47be9788565d19f1b8}{day};
      \hyperlink{lsredis_8c_a2b48f29f489bcbdaf4fb29e7fbf1d4d2}{lsredis\_set\_preset}( \textcolor{stringliteral}{"align.y"}, \textcolor{stringliteral}{"Beam"}, ay);
    \}
                          
    \textcolor{keywordflow}{if}( \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_a36742b6bd0f4bf9356414930ba893617}{daz\_isnull} == 0) \{
      err = \hyperlink{lsredis_8c_a87d7bb0ade6f247edfbb7803aac9e694}{lsredis\_find\_preset}( \textcolor{stringliteral}{"align.z"}, \textcolor{stringliteral}{"Back\_Vector"}, &
      baz);
      \textcolor{keywordflow}{if}( err == 0)
        baz = 0.0;
      baz += \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_a1170bab2161f03ab29c39f79519ed9ae}{daz};
      \hyperlink{lsredis_8c_a2b48f29f489bcbdaf4fb29e7fbf1d4d2}{lsredis\_set\_preset}( \textcolor{stringliteral}{"align.z"}, \textcolor{stringliteral}{"Back"}, baz);

      az  += \hyperlink{lspg_8c_a7ef8a09203117578c9b2ce4719519f36}{lspg\_getcenter}.\hyperlink{structlspg__getcenter__struct_a1170bab2161f03ab29c39f79519ed9ae}{daz};
      \hyperlink{lsredis_8c_a2b48f29f489bcbdaf4fb29e7fbf1d4d2}{lsredis\_set\_preset}( \textcolor{stringliteral}{"align.z"}, \textcolor{stringliteral}{"Beam"}, az);
    \}
  \}
  \hyperlink{lspg_8c_a7c678553b44c874d08ec9966ed7bb1c0}{lspg\_getcenter\_done}();


  \textcolor{keywordflow}{if}( \hyperlink{lspmac_8c_a984a1d6e49ad53d6a1184666881bf117}{lspmac\_est\_move\_time}( &move\_time, &mmask,
                            \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint},  1,  \textcolor{stringliteral}{"Cover"}, 0.0,
                            \hyperlink{lspmac_8c_aa45f268d0af9f3d465acfab128919718}{capz},   1,  \textcolor{stringliteral}{"Cover"}, 0.0,
                            \hyperlink{lspmac_8c_ac940d950d9efeaf3f0ae67e9bf331188}{cenx},   0,  NULL,    cx,
                            \hyperlink{lspmac_8c_aaed18e738ba7bfb6c771a44f5d7ea827}{ceny},   0,  NULL,    cy,
                            \hyperlink{lspmac_8c_a6cb218bdccfe5a93471c161f15a15cab}{alignx}, 0,  NULL,    ax,
                            \hyperlink{lspmac_8c_a737c246c3948e644a18d191a931e1acd}{aligny}, 0,  NULL,    ay,
                            \hyperlink{lspmac_8c_ae7642b1da0f7c7f8448104c691d40a12}{alignz}, 0,  NULL,    az,
                            \hyperlink{lspmac_8c_ad53a42cfaa04eff0336a44c8c9986333}{zoom},   1,  NULL,    zm,
                            NULL)) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_rotate: organ motion
       request failed"});
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Rotate Aborted"});
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{keywordflow}{if}( \hyperlink{lspmac_8c_a570b4a359adc4da4ab80d53506d06963}{lspmac\_est\_move\_time\_wait}( move\_time + 2.0, 
      mmask, \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint}, \hyperlink{lspmac_8c_aa45f268d0af9f3d465acfab128919718}{capz}, \hyperlink{lspmac_8c_ad53a42cfaa04eff0336a44c8c9986333}{zoom}, NULL)) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_rotate: organ motion
       timed out %f seconds"}, move\_time + 2.0);
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Rotate Aborted"});
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_aaf5225dbdfe8b04318070c1167ff6a22}{md2cmds\_home\_wait}( 20.0)) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_rotate: homing motors
       timed out.  Rotate aborted"});
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Rotate Aborted"});
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{comment}{// Report new center positions}
  cx = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}( \hyperlink{lspmac_8c_ac940d950d9efeaf3f0ae67e9bf331188}{cenx});
  cy = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}( \hyperlink{lspmac_8c_aaed18e738ba7bfb6c771a44f5d7ea827}{ceny});
  ax = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}( \hyperlink{lspmac_8c_a6cb218bdccfe5a93471c161f15a15cab}{alignx});
  ay = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}( \hyperlink{lspmac_8c_a737c246c3948e644a18d191a931e1acd}{aligny});
  az = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}( \hyperlink{lspmac_8c_ae7642b1da0f7c7f8448104c691d40a12}{alignz});
  \hyperlink{lspg_8c_a0bb9ef42da8fa21c4df48ec384ab69f4}{lspg\_query\_push}( NULL, \textcolor{stringliteral}{"SELECT px.applycenter( %.3f, %.3f,
       %.3f, %.3f, %.3f, %.3f, %.3f)"}, cx, cy, ax, ay, az, \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}
      (\hyperlink{lspmac_8c_a0be79ccb7ebf3a665248fd856112b9fd}{kappa}), \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}( \hyperlink{lspmac_8c_ac8070dc568ad974a3db42b51eca828cc}{phi}));

  \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_rotate: done with
       applycenter"});
  \hyperlink{lspmac_8c_aa8bf745a9ec388783009e2275a8b56f8}{lspmac\_video\_rotate}( 4.0);
  \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_rotate: starting
       rotation"});
  \hyperlink{md2cmds_8c_aaa6eb2d46be8d5e17a511591dd5a1271}{rotating} = 1;

  \textcolor{keywordflow}{return} 0;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_aa43887b7c9799bc88d51df13745d0e5c}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-rotate\-\_\-cb@{md2cmds\-\_\-rotate\-\_\-cb}}
\index{md2cmds\-\_\-rotate\-\_\-cb@{md2cmds\-\_\-rotate\-\_\-cb}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-rotate\-\_\-cb}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-rotate\-\_\-cb (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{event}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_aa43887b7c9799bc88d51df13745d0e5c}


Tell the database about the time we went through omega=zero. 

This should trigger the video feed server to starting making a movie. 

Definition at line 1447 of file md2cmds.\-c.


\begin{DoxyCode}
                                     \{
  \textcolor{keyword}{struct }tm t;
  \textcolor{keywordtype}{int} usecs;

  localtime\_r( &(\hyperlink{lspmac_8c_ae6631a094accc469661805bdf80fc6d8}{omega\_zero\_time}.tv\_sec), &t);
  
  usecs = \hyperlink{lspmac_8c_ae6631a094accc469661805bdf80fc6d8}{omega\_zero\_time}.tv\_nsec / 1000;
  \hyperlink{lspg_8c_a0bb9ef42da8fa21c4df48ec384ab69f4}{lspg\_query\_push}( NULL, \textcolor{stringliteral}{"SELECT px.trigcam('%d-%d-%d
       %d:%d:%d.%06d', %d, 0.0, 90.0)"},
                   t.tm\_year+1900, t.tm\_mon+1, t.tm\_mday, t.tm\_hour, t.tm\_min, 
      t.tm\_sec, usecs,
                   (\textcolor{keywordtype}{int})(\hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}( \hyperlink{lspmac_8c_ad53a42cfaa04eff0336a44c8c9986333}{zoom})));

\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_aa62da7d423952334d41c7d282f45233d}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-run@{md2cmds\-\_\-run}}
\index{md2cmds\-\_\-run@{md2cmds\-\_\-run}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-run}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-run (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_aa62da7d423952334d41c7d282f45233d}


Start up the thread. 



Definition at line 1909 of file md2cmds.\-c.


\begin{DoxyCode}
                   \{
  pthread\_create( &\hyperlink{md2cmds_8c_aa230921945149692de98fff15c01962f}{md2cmds\_thread}, NULL,                
      \hyperlink{md2cmds_8c_ae967e769d23555a631f615e630f25b00}{md2cmds\_worker}, NULL);
  \hyperlink{lsevents_8c_a1efedb183d9558ae0f3573712e7918b2}{lsevents\_add\_listener}( \textcolor{stringliteral}{"^omega crossed zero$"},        
      \hyperlink{md2cmds_8c_aa43887b7c9799bc88d51df13745d0e5c}{md2cmds\_rotate\_cb});
  \hyperlink{lsevents_8c_a1efedb183d9558ae0f3573712e7918b2}{lsevents\_add\_listener}( \textcolor{stringliteral}{"^omega In Position$"},         
      \hyperlink{md2cmds_8c_a136f278c9f5a2742b2e9b4987b063faa}{md2cmds\_maybe\_rotate\_done\_cb});
  \hyperlink{lsevents_8c_a1efedb183d9558ae0f3573712e7918b2}{lsevents\_add\_listener}( \textcolor{stringliteral}{".+ (Moving|In Position)$"},    
      \hyperlink{md2cmds_8c_a3970ef1a233dabcc5c1408e9d3865f13}{md2cmds\_maybe\_done\_moving\_cb});
  \hyperlink{lsevents_8c_a1efedb183d9558ae0f3573712e7918b2}{lsevents\_add\_listener}( \textcolor{stringliteral}{"(.+) (Homing|Homed)$"},        
      \hyperlink{md2cmds_8c_ad0618ee44e2e800c445d7d8726ec8ec2}{md2cmds\_maybe\_done\_homing\_cb});
  \hyperlink{lsevents_8c_a1efedb183d9558ae0f3573712e7918b2}{lsevents\_add\_listener}( \textcolor{stringliteral}{"^capz (Moving|In Position)$"}, 
      \hyperlink{md2cmds_8c_aab9e2aa02903648acc342068f0664a96}{md2cmds\_time\_capz\_cb});
  \hyperlink{lsevents_8c_a1efedb183d9558ae0f3573712e7918b2}{lsevents\_add\_listener}( \textcolor{stringliteral}{"^Coordsys 1 Stopped$"},        
      \hyperlink{md2cmds_8c_a4cf5215fdb88407144f582d829c03c7b}{md2cmds\_coordsys\_1\_stopped\_cb});
  \hyperlink{lsevents_8c_a1efedb183d9558ae0f3573712e7918b2}{lsevents\_add\_listener}( \textcolor{stringliteral}{"^Coordsys 2 Stopped$"},        
      \hyperlink{md2cmds_8c_a1ab8f6d08c82ee2130202d65d44ef3fe}{md2cmds\_coordsys\_2\_stopped\_cb});
  \hyperlink{lsevents_8c_a1efedb183d9558ae0f3573712e7918b2}{lsevents\_add\_listener}( \textcolor{stringliteral}{"^Coordsys 3 Stopped$"},        
      \hyperlink{md2cmds_8c_a3640785c2fc9cd2f27ce0bafd7959179}{md2cmds\_coordsys\_3\_stopped\_cb});
  \hyperlink{lsevents_8c_a1efedb183d9558ae0f3573712e7918b2}{lsevents\_add\_listener}( \textcolor{stringliteral}{"^Coordsys 4 Stopped$"},        
      \hyperlink{md2cmds_8c_a6069cb2f6e9f662edd54e1aeb6e78370}{md2cmds\_coordsys\_4\_stopped\_cb});
  \hyperlink{lsevents_8c_a1efedb183d9558ae0f3573712e7918b2}{lsevents\_add\_listener}( \textcolor{stringliteral}{"^Coordsys 5 Stopped$"},        
      \hyperlink{md2cmds_8c_a846ed10de4e5ad48cfa429a93c853308}{md2cmds\_coordsys\_5\_stopped\_cb});
  \hyperlink{lsevents_8c_a1efedb183d9558ae0f3573712e7918b2}{lsevents\_add\_listener}( \textcolor{stringliteral}{"^Coordsys 7 Stopped$"},        
      \hyperlink{md2cmds_8c_ab172a83eaf3e74799159e6720e4f5268}{md2cmds\_coordsys\_7\_stopped\_cb});
  \hyperlink{lsevents_8c_a1efedb183d9558ae0f3573712e7918b2}{lsevents\_add\_listener}( \textcolor{stringliteral}{"^cam.zoom Moving$"},             
       \hyperlink{md2cmds_8c_a4eb608d012f8a471671e10fb19b366d6}{md2cmds\_set\_scale\_cb});
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a577b62b66ed5589a171550e26478633f}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-run\-\_\-cmd@{md2cmds\-\_\-run\-\_\-cmd}}
\index{md2cmds\-\_\-run\-\_\-cmd@{md2cmds\-\_\-run\-\_\-cmd}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-run\-\_\-cmd}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-run\-\_\-cmd (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{cmd}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a577b62b66ed5589a171550e26478633f}


Definition at line 1620 of file md2cmds.\-c.


\begin{DoxyCode}
                                      \{
  \textcolor{keywordtype}{int} err, \hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i};
  \hyperlink{structlspmac__motor__struct}{lspmac\_motor\_t} *mp;
  regmatch\_t pmatch[16];
  \textcolor{keywordtype}{char} cp[64];
  
  \textcolor{keywordflow}{if}( strlen(cmd) > \textcolor{keyword}{sizeof}( cp)-1) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_run\_cmd: command too
       long '%s'"}, cmd);
    \textcolor{keywordflow}{return} 1;
  \}
  
  err = regexec( &\hyperlink{md2cmds_8c_ad07af354194cb9a8eac1f200257dcacd}{md2cmds\_cmd\_regex}, cmd, 16, pmatch, 0);
  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_run\_cmd: no match
       found from '%s'"}, cmd);
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{keywordflow}{for}( i=0; i<16; i++) \{
    \textcolor{keywordflow}{if}( pmatch[i].rm\_so == -1)
      \textcolor{keywordflow}{continue};
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_run\_cmd: %d '%.*s'"}, i
      , pmatch[i].rm\_eo - pmatch[i].rm\_so, cmd+pmatch[i].rm\_so);
  \}

  \textcolor{comment}{//}
  \textcolor{comment}{// get motor name}
  \textcolor{comment}{//}
  snprintf( cp, \textcolor{keyword}{sizeof}( cp)-1, \textcolor{stringliteral}{"%.*s"}, pmatch[4].rm\_eo - pmatch[4].rm\_so, cmd+
      pmatch[4].rm\_so);
  cp[\textcolor{keyword}{sizeof}( cp)-1] = 0;

  mp = \hyperlink{lspmac_8c_a22ef36819bdee963712691e660cfc101}{lspmac\_find\_motor\_by\_name}( cp);
  \textcolor{keywordflow}{if}( mp == NULL) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_run\_cmd: could not
       find motor '%s'"}, cp);
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{keywordflow}{if}( pmatch[5].rm\_so != -1) \{
    \textcolor{keywordflow}{if}( strncmp( cmd+pmatch[5].rm\_so, \textcolor{stringliteral}{"home"}, pmatch[5].rm\_eo-pmatch[5].rm\_so)
      ==0) \{
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_run\_cmd: homing
       motor '%s'"}, cp);
      \hyperlink{lspmac_8c_a9fbadf816a842c8f131cf8ee47b54e29}{lspmac\_home1\_queue}( mp);
    \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}( strncmp( cmd+pmatch[5].rm\_so, \textcolor{stringliteral}{"stop"}, pmatch[5].rm\_eo-pmatch[5].
      rm\_so)==0) \{
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_run\_cmd: stoping
       motor '%s'"}, cp);
      \hyperlink{lspmac_8c_a85f7a5e4d853b7a86ddde1006dd4dc1f}{lspmac\_abort}();
    \}
  \}


  \textcolor{keywordflow}{return} 0;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_aee4a35d084bc0fdd4598576469deeed0}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-set@{md2cmds\-\_\-set}}
\index{md2cmds\-\_\-set@{md2cmds\-\_\-set}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-set}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-set (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{cmd}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_aee4a35d084bc0fdd4598576469deeed0}


Definition at line 1721 of file md2cmds.\-c.


\begin{DoxyCode}
                                  \{
  \textcolor{keywordtype}{int} err;
  \hyperlink{structlsredis__obj__struct}{lsredis\_obj\_t} *\hyperlink{namespacemk__pgpmac__redis_a11daf2847f2dc94562b5b61b3f412574}{p};
  \hyperlink{structlspmac__motor__struct}{lspmac\_motor\_t} *mp;
  regmatch\_t pmatch[16];
  \textcolor{keywordtype}{char} cp[64];
  \textcolor{keywordtype}{char} *rp;
  
  \textcolor{keywordflow}{if}( strlen(cmd) > \textcolor{keyword}{sizeof}( cp)-1) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_set: command too long
       '%s'"}, cmd);
    \textcolor{keywordflow}{return} 1;
  \}

  \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_set: recieved '%s'"}, cmd
      );
  

  err = regexec( &\hyperlink{md2cmds_8c_ad07af354194cb9a8eac1f200257dcacd}{md2cmds\_cmd\_regex}, cmd, 16, pmatch, 0);
  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_set: no match found
       from '%s'"}, cmd);
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{keywordflow}{if}( pmatch[2].rm\_so == -1) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_set: could not parse
       preset name from '%s'"}, cmd);
    \textcolor{keywordflow}{return} 1;
  \}

  
  \textcolor{comment}{//}
  \textcolor{comment}{// get motor name}
  \textcolor{comment}{//}
  snprintf( cp, \textcolor{keyword}{sizeof}( cp)-1, \textcolor{stringliteral}{"%.*s"}, pmatch[3].rm\_eo - pmatch[3].rm\_so, cmd+
      pmatch[3].rm\_so);
  cp[\textcolor{keyword}{sizeof}( cp)-1] = 0;

  mp = \hyperlink{lspmac_8c_a22ef36819bdee963712691e660cfc101}{lspmac\_find\_motor\_by\_name}( cp);
  \textcolor{keywordflow}{if}( mp == NULL) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_set: could not find
       motor '%s'"}, cp);
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{comment}{//}
  \textcolor{comment}{// get redis preset position name}
  \textcolor{comment}{//}

  p = \hyperlink{lsredis_8c_ad3bb3ebbae1ffbd03e062ecdd663cc6a}{lsredis\_get\_obj}( \textcolor{stringliteral}{"%.*s.position"}, pmatch[2].rm\_eo - pmatch
      [2].rm\_so, cmd+pmatch[2].rm\_so);
  \textcolor{keywordflow}{if}( p == NULL) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_set: could not find
       preset name in '%s'"}, cmd);
    \textcolor{keywordflow}{return} 1;
  \}
    
  rp = \hyperlink{lsredis_8c_ac1994e56114b2315294527d76311f829}{lsredis\_getstr}( mp->redis\_position);

  \textcolor{comment}{//}
  \textcolor{comment}{// set the preset to the current position}
  \textcolor{comment}{//}
  \hyperlink{lsredis_8c_a9b9c64f883c7ded60badfe89cb15fa78}{lsredis\_setstr}( p, \textcolor{stringliteral}{"%s"}, rp);
  \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Preset Changed %s"}, p->\hyperlink{structlsredis__obj__struct_ad0a987a011b580eab739cda831f78fbb}{events\_name}
      );

  free( rp);
  \textcolor{keywordflow}{return} 0;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a4eb608d012f8a471671e10fb19b366d6}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-set\-\_\-scale\-\_\-cb@{md2cmds\-\_\-set\-\_\-scale\-\_\-cb}}
\index{md2cmds\-\_\-set\-\_\-scale\-\_\-cb@{md2cmds\-\_\-set\-\_\-scale\-\_\-cb}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-set\-\_\-scale\-\_\-cb}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-set\-\_\-scale\-\_\-cb (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{event}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a4eb608d012f8a471671e10fb19b366d6}


Fix up xscale and yscale when zoom changes xscale and yscale have units of microns per pixel. 



Definition at line 1474 of file md2cmds.\-c.


\begin{DoxyCode}
                                        \{
  \textcolor{keywordtype}{int} mag;
  \hyperlink{structlsredis__obj__struct}{lsredis\_obj\_t} *p1, *p2;
  \textcolor{keywordtype}{char} *vp;

  pthread\_mutex\_lock( &\hyperlink{lspmac_8c_ad53a42cfaa04eff0336a44c8c9986333}{zoom}->\hyperlink{structlspmac__motor__struct_a188c5b1e991750ce2ffd53e0192e0907}{mutex});
  mag = \hyperlink{lspmac_8c_ad53a42cfaa04eff0336a44c8c9986333}{zoom}->\hyperlink{structlspmac__motor__struct_af8cdc94c6e2478b12ce942d4cf1d7499}{requested\_position};
  pthread\_mutex\_unlock( &\hyperlink{lspmac_8c_ad53a42cfaa04eff0336a44c8c9986333}{zoom}->\hyperlink{structlspmac__motor__struct_a188c5b1e991750ce2ffd53e0192e0907}{mutex});
  
  p1  = \hyperlink{lsredis_8c_ad3bb3ebbae1ffbd03e062ecdd663cc6a}{lsredis\_get\_obj}( \textcolor{stringliteral}{"cam.xScale"});
  p2  = \hyperlink{lsredis_8c_ad3bb3ebbae1ffbd03e062ecdd663cc6a}{lsredis\_get\_obj}( \textcolor{stringliteral}{"cam.zoom.%d.ScaleX"}, mag);

  vp = \hyperlink{lsredis_8c_ac1994e56114b2315294527d76311f829}{lsredis\_getstr}( p2);
  \hyperlink{lsredis_8c_a9b9c64f883c7ded60badfe89cb15fa78}{lsredis\_setstr}( p1, vp);
  free( vp);

  p1  = \hyperlink{lsredis_8c_ad3bb3ebbae1ffbd03e062ecdd663cc6a}{lsredis\_get\_obj}( \textcolor{stringliteral}{"cam.yScale"});
  p2  = \hyperlink{lsredis_8c_ad3bb3ebbae1ffbd03e062ecdd663cc6a}{lsredis\_get\_obj}( \textcolor{stringliteral}{"cam.zoom.%d.ScaleY"}, mag);

  vp = \hyperlink{lsredis_8c_ac1994e56114b2315294527d76311f829}{lsredis\_getstr}( p2);
  \hyperlink{lsredis_8c_a9b9c64f883c7ded60badfe89cb15fa78}{lsredis\_setstr}( p1, vp);
  free( vp);
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a3403a357a4b3ffd715a2f3d1dac3da5b}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-settransferpoint@{md2cmds\-\_\-settransferpoint}}
\index{md2cmds\-\_\-settransferpoint@{md2cmds\-\_\-settransferpoint}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-settransferpoint}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-settransferpoint (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{cmd}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a3403a357a4b3ffd715a2f3d1dac3da5b}


Definition at line 1669 of file md2cmds.\-c.


\begin{DoxyCode}
                                               \{
  \textcolor{keywordtype}{double} ax, ay, az, cx, cy;

  \hyperlink{md2cmds_8c_a408a01640e74152304b10ae05f5d09e1}{md2cmds\_home\_prep}();

  \textcolor{comment}{//}
  \textcolor{comment}{// Home Kappa}
  \textcolor{comment}{//}
  \hyperlink{lspmac_8c_a9fbadf816a842c8f131cf8ee47b54e29}{lspmac\_home1\_queue}( \hyperlink{lspmac_8c_a0be79ccb7ebf3a665248fd856112b9fd}{kappa});

  \textcolor{comment}{//}
  \textcolor{comment}{// Home omega}
  \textcolor{comment}{//}
  \hyperlink{lspmac_8c_a9fbadf816a842c8f131cf8ee47b54e29}{lspmac\_home1\_queue}( \hyperlink{lspmac_8c_a8237e646ce032a840637a4ef7bff49b9}{omega});

  \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_aaf5225dbdfe8b04318070c1167ff6a22}{md2cmds\_home\_wait}( 30.0)) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_settransferpoint:
       homing routines taking too long.  Aborting transfer."});
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Settransferpoint Aborted"});
    \textcolor{keywordflow}{return} 1;
  \}

  \hyperlink{md2cmds_8c_a408a01640e74152304b10ae05f5d09e1}{md2cmds\_home\_prep}();
  \textcolor{comment}{//}
  \textcolor{comment}{// Home phi (whatever that means)}
  \textcolor{comment}{//}
  \hyperlink{lspmac_8c_a9fbadf816a842c8f131cf8ee47b54e29}{lspmac\_home1\_queue}( \hyperlink{lspmac_8c_ac8070dc568ad974a3db42b51eca828cc}{phi});

  \textcolor{comment}{//}
  \textcolor{comment}{// Wait for the homing routines to finish}
  \textcolor{comment}{//}
  \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_aaf5225dbdfe8b04318070c1167ff6a22}{md2cmds\_home\_wait}( 30.0)) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_settransferpoint:
       homing routines taking too long.  Aborting transfer."});
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Settransferpoint Aborted"});
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{comment}{//}
  \textcolor{comment}{// get positions we'll be needed to report to postgres}
  \textcolor{comment}{//}
  ax = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}(\hyperlink{lspmac_8c_a6cb218bdccfe5a93471c161f15a15cab}{alignx});
  ay = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}(\hyperlink{lspmac_8c_a737c246c3948e644a18d191a931e1acd}{aligny});
  az = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}(\hyperlink{lspmac_8c_ae7642b1da0f7c7f8448104c691d40a12}{alignz});
  cx = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}(\hyperlink{lspmac_8c_ac940d950d9efeaf3f0ae67e9bf331188}{cenx});
  cy = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}(\hyperlink{lspmac_8c_aaed18e738ba7bfb6c771a44f5d7ea827}{ceny});

  \hyperlink{lspg_8c_a0bb9ef42da8fa21c4df48ec384ab69f4}{lspg\_query\_push}( NULL, \textcolor{stringliteral}{"SELECT px.settransferpoint( %0.3f,
       %0.3f, %0.3f, %0.3f, %0.3f)"}, ax, ay, az, cx, cy);

  \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Settransferpoint Done"});
  \textcolor{keywordflow}{return} 0;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a4a321d5e1621948eecb33a51a58041f6}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-test@{md2cmds\-\_\-test}}
\index{md2cmds\-\_\-test@{md2cmds\-\_\-test}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-test}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-test (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{dummy}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a4a321d5e1621948eecb33a51a58041f6}


Run the test routine(s) 


\begin{DoxyParams}{Parameters}
{\em dummy} & Unused \\
\hline
\end{DoxyParams}


Definition at line 1614 of file md2cmds.\-c.


\begin{DoxyCode}
                                     \{
  \hyperlink{lstest_8c_a7b84b6a923167d84c1aefbd2241864c3}{lstest\_main}();
  \textcolor{keywordflow}{return} 0;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_aab9e2aa02903648acc342068f0664a96}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-time\-\_\-capz\-\_\-cb@{md2cmds\-\_\-time\-\_\-capz\-\_\-cb}}
\index{md2cmds\-\_\-time\-\_\-capz\-\_\-cb@{md2cmds\-\_\-time\-\_\-capz\-\_\-cb}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-time\-\_\-capz\-\_\-cb}]{\setlength{\rightskip}{0pt plus 5cm}void md2cmds\-\_\-time\-\_\-capz\-\_\-cb (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{event}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_aab9e2aa02903648acc342068f0664a96}


Time the capillary motion for the transfer routine. 

$<$ track the time spent moving capz 

Definition at line 1508 of file md2cmds.\-c.


\begin{DoxyCode}
                                        \{
  \textcolor{keyword}{static} \textcolor{keyword}{struct }timespec capz\_timestarted;      
  \textcolor{keyword}{struct }timespec \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now};
  \textcolor{keywordtype}{int} nsec, sec;

  \textcolor{keywordflow}{if}( strstr( event, \textcolor{stringliteral}{"Moving"}) != NULL) \{
    clock\_gettime( CLOCK\_REALTIME, &capz\_timestarted);
  \} \textcolor{keywordflow}{else} \{
    clock\_gettime( CLOCK\_REALTIME, &\hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now});

    sec  = \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_sec - capz\_timestarted.tv\_sec;
    nsec = 0;
    \textcolor{keywordflow}{if}( \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_nsec > capz\_timestarted.tv\_nsec) \{
      sec--;
      nsec += 1000000000;
    \}
    nsec += \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_nsec - capz\_timestarted.tv\_nsec;
    \hyperlink{md2cmds_8c_a478ca2fc7299fac5a13f6bce991198b7}{md2cmds\_capz\_moving\_time} = sec + nsec / 1000000000.
      ;
  \}
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_a87efed33b7a49cdfeaf5d64df4ca09aa}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-transfer@{md2cmds\-\_\-transfer}}
\index{md2cmds\-\_\-transfer@{md2cmds\-\_\-transfer}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-transfer}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-transfer (
\begin{DoxyParamCaption}
\item[{const char $\ast$}]{dummy}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_a87efed33b7a49cdfeaf5d64df4ca09aa}


Transfer a sample. 


\begin{DoxyParams}{Parameters}
{\em dummy} & Unused \\
\hline
\end{DoxyParams}


Definition at line 269 of file md2cmds.\-c.


\begin{DoxyCode}
                                         \{
  \textcolor{keywordtype}{int} nextsample, abort\_now;
  \textcolor{keywordtype}{double} ax, ay, az, cx, cy, horz, vert, oref;
  \textcolor{keywordtype}{int} err;
  \textcolor{keywordtype}{int} mmask;
  \textcolor{keywordtype}{double} move\_time;

  nextsample = \hyperlink{lspg_8c_a4cc866393eda0cf20276d035f6fbe206}{lspg\_nextsample\_all}( &err);
  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_transfer: no sample
       requested to be transfered, false alarm"});
    \textcolor{keywordflow}{return} 1;
  \}
  
  \textcolor{comment}{//}
  \textcolor{comment}{// BLUMax sets up an abort dialogbox here.  Probably we should figure out how
       we are going to handle that.}
  \textcolor{comment}{//}

  \textcolor{comment}{//}
  \textcolor{comment}{// Wait for motors to stop}
  \textcolor{comment}{//}
  \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_ac7a133655e9bb91bbbd6cd316e4191fb}{md2cmds\_is\_moving}()) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_transfer: Waiting for
       previous motion to finish"});
    \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_a7cd262eaeafc85a6111cf06de4f29601}{md2cmds\_move\_wait}( 30.0)) \{
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_transfer: Timed out
       waiting for previous motion to finish.  Aborting transfer"});
    \}
  \}

  \textcolor{comment}{//}
  \textcolor{comment}{// get positions we'll be needed to report to postgres}
  \textcolor{comment}{//}
  ax = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}(\hyperlink{lspmac_8c_a6cb218bdccfe5a93471c161f15a15cab}{alignx});
  ay = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}(\hyperlink{lspmac_8c_a737c246c3948e644a18d191a931e1acd}{aligny});
  az = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}(\hyperlink{lspmac_8c_ae7642b1da0f7c7f8448104c691d40a12}{alignz});
  cx = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}(\hyperlink{lspmac_8c_ac940d950d9efeaf3f0ae67e9bf331188}{cenx});
  cy = \hyperlink{lspmac_8c_acc46bdddee59bd8c5ad662b3fd445e9f}{lspmac\_getPosition}(\hyperlink{lspmac_8c_aaed18e738ba7bfb6c771a44f5d7ea827}{ceny});
  oref = \hyperlink{lsredis_8c_aa8daf63b794b6b6341018feec205cb7d}{lsredis\_getd}(\hyperlink{lsredis_8c_ad3bb3ebbae1ffbd03e062ecdd663cc6a}{lsredis\_get\_obj}( \textcolor{stringliteral}{"
      omega.reference"})) * M\_PI/180.;

  horz = cx * cos(oref) + cy * sin(oref);
  vert = cx * sin(oref) - cy * cos(oref);


  mmask = 0;
  err = \hyperlink{lspmac_8c_a984a1d6e49ad53d6a1184666881bf117}{lspmac\_est\_move\_time}( &move\_time, &mmask,
                              \hyperlink{lspmac_8c_a139200ddaa9856a7ffcec0e6cbaa8f1b}{apery},     1, \textcolor{stringliteral}{"In"},    0.0,
                              \hyperlink{lspmac_8c_ab93bd6ee850b285ca3a95e64d15e9477}{aperz},     1, \textcolor{stringliteral}{"Cover"}, 0.0,
                              \hyperlink{lspmac_8c_a51358daaea8b5236f08414877d8af6c2}{capy},      1, \textcolor{stringliteral}{"In"},    0.0,
                              \hyperlink{lspmac_8c_aa45f268d0af9f3d465acfab128919718}{capz},      1, \textcolor{stringliteral}{"Cover"}, 0.0,
                              \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint},     1, \textcolor{stringliteral}{"Cover"}, 0.0,
                              \hyperlink{lspmac_8c_af813a2eff0b7efa4c70633559054e84c}{blight\_ud}, 1, NULL,    0.0,
                              \hyperlink{lspmac_8c_addb26c80065506faa1de3c1b468fe03f}{fluo},      1, NULL,    0.0,
                              NULL);

  \hyperlink{lspg_8c_af72c4b037347737df09348ab703f6802}{lspg\_starttransfer\_call}( nextsample, 
      \hyperlink{lspmac_8c_af57fb3f335edcfd2adff8186e1efd458}{lspmac\_getBIPosition}( \hyperlink{lspmac_8c_ac59ab990e48033a811aeb0281fb588fc}{sample\_detected}), ax, 
      ay, az, horz, vert, move\_time);

  \hyperlink{md2cmds_8c_a408a01640e74152304b10ae05f5d09e1}{md2cmds\_home\_prep}();

  \textcolor{comment}{//}
  \textcolor{comment}{// Home Kappa}
  \textcolor{comment}{//}
  \hyperlink{lspmac_8c_a9fbadf816a842c8f131cf8ee47b54e29}{lspmac\_home1\_queue}( \hyperlink{lspmac_8c_a0be79ccb7ebf3a665248fd856112b9fd}{kappa});

  \textcolor{comment}{//}
  \textcolor{comment}{// Home omega}
  \textcolor{comment}{//}
  \hyperlink{lspmac_8c_a9fbadf816a842c8f131cf8ee47b54e29}{lspmac\_home1\_queue}( \hyperlink{lspmac_8c_a8237e646ce032a840637a4ef7bff49b9}{omega});

  \textcolor{comment}{//}
  \textcolor{comment}{// Wait for the kappa/omega homing routines to finish}
  \textcolor{comment}{//}
  \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_aaf5225dbdfe8b04318070c1167ff6a22}{md2cmds\_home\_wait}( 30.0)) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_transfer: kappa/omega
       homing routines taking too long.  Aborting transfer."});
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Transfer Aborted"});
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{comment}{//}
  \textcolor{comment}{// Home phi (whatever that means)}
  \textcolor{comment}{//}
  \hyperlink{md2cmds_8c_a408a01640e74152304b10ae05f5d09e1}{md2cmds\_home\_prep}();
  \hyperlink{lspmac_8c_a9fbadf816a842c8f131cf8ee47b54e29}{lspmac\_home1\_queue}( \hyperlink{lspmac_8c_ac8070dc568ad974a3db42b51eca828cc}{phi});

  \textcolor{comment}{// Now let's get back to postresql (remember our query so long ago?)}
  \textcolor{comment}{//}
  \hyperlink{lspg_8c_a189e9fd5cbc06dd09e5549f6e229fa5e}{lspg\_starttransfer\_wait}();

  \textcolor{comment}{//}
  \textcolor{comment}{// It's possible that the sample that's mounted is unknown to the robot.}
  \textcolor{comment}{// If so then we need to abort after we're done moving stuff}
  \textcolor{comment}{//}
  \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_transfer:
       no\_rows\_returned %d, starttransfer %d"},
                         \hyperlink{lspg_8c_af18499d17171eff473cfc49d4a0a5562}{lspg\_starttransfer}.\hyperlink{structlspg__starttransfer__struct_aa384ccd326d9247317f77072b93f94ca}{no\_rows\_returned}
      , \hyperlink{lspg_8c_af18499d17171eff473cfc49d4a0a5562}{lspg\_starttransfer}.\hyperlink{structlspg__starttransfer__struct_af01b6bac6db9830719aef63e552312eb}{starttransfer});
  \textcolor{keywordflow}{if}( \hyperlink{lspg_8c_af18499d17171eff473cfc49d4a0a5562}{lspg\_starttransfer}.\hyperlink{structlspg__starttransfer__struct_aa384ccd326d9247317f77072b93f94ca}{no\_rows\_returned} || 
      \hyperlink{lspg_8c_af18499d17171eff473cfc49d4a0a5562}{lspg\_starttransfer}.\hyperlink{structlspg__starttransfer__struct_af01b6bac6db9830719aef63e552312eb}{starttransfer} != 1)
    abort\_now = 1;
  \textcolor{keywordflow}{else}
    abort\_now = 0;

  \hyperlink{lspg_8c_ad989179281d8b65b940250a4580007d0}{lspg\_starttransfer\_done}();

 
  \textcolor{comment}{//}
  \textcolor{comment}{// Wait for the homing routines to finish}
  \textcolor{comment}{//}
  \textcolor{keywordflow}{if}( \hyperlink{md2cmds_8c_aaf5225dbdfe8b04318070c1167ff6a22}{md2cmds\_home\_wait}( 30.0)) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_transfer: phi homing
       routine taking too long.  Aborting transfer."});
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Transfer Aborted"});
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{comment}{//}
  \textcolor{comment}{// Wait for all those other motors to stop moving}
  \textcolor{comment}{//}
  err = \hyperlink{lspmac_8c_a570b4a359adc4da4ab80d53506d06963}{lspmac\_est\_move\_time\_wait}( move\_time + 2.0, 
      mmask, \hyperlink{lspmac_8c_a139200ddaa9856a7ffcec0e6cbaa8f1b}{apery}, \hyperlink{lspmac_8c_ab93bd6ee850b285ca3a95e64d15e9477}{aperz}, \hyperlink{lspmac_8c_a51358daaea8b5236f08414877d8af6c2}{capy}, \hyperlink{lspmac_8c_aa45f268d0af9f3d465acfab128919718}{capz}, \hyperlink{lspmac_8c_a589431b3a79c21c251fcb97cc9126991}{scint}, \hyperlink{lspmac_8c_af813a2eff0b7efa4c70633559054e84c}{blight\_ud},
       \hyperlink{lspmac_8c_addb26c80065506faa1de3c1b468fe03f}{fluo}, NULL);
  \textcolor{keywordflow}{if}( err) \{
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Transfer Aborted"});
    \textcolor{keywordflow}{return} 1;
  \}


  \textcolor{comment}{// TODO: check that all the motors are where we told them to go  }
  \textcolor{comment}{//}

  \textcolor{comment}{//}
  \textcolor{comment}{// see if we have a sample mounted problem (is abort\_now misnamed?)}
  \textcolor{comment}{//}
  \textcolor{keywordflow}{if}( abort\_now) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_transfer: Apparently
       there is a sample mounted already but we don't know where it is supposed to go"});
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Transfer Aborted"});
    \textcolor{keywordflow}{return} 1;
  \}
  
  \textcolor{comment}{// refuse to go on if we do not have positive confirmation that the backlight
       is down and the}
  \textcolor{comment}{// fluorescence detector is back  (TODO: how about all those organs?)}
  \textcolor{comment}{//}
  \textcolor{keywordflow}{if}( \hyperlink{lspmac_8c_af57fb3f335edcfd2adff8186e1efd458}{lspmac\_getBIPosition}( \hyperlink{lspmac_8c_ac0d0bc95bcbcbd154b30c72a9645c8b2}{blight\_down}) != 1 ||
      \hyperlink{lspmac_8c_af57fb3f335edcfd2adff8186e1efd458}{lspmac\_getBIPosition}( \hyperlink{lspmac_8c_a67092de6f3fcc0b245e4970437eaff6b}{fluor\_back}) != 1) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_transfer: It looks
       like either the back light is not down or the fluoescence dectector is not back"});
    \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Transfer Aborted"});
    \textcolor{keywordflow}{return} 1;
  \}

  \textcolor{comment}{//}
  \textcolor{comment}{// Wait for the robot to unlock the cryo which signals us that we need to}
  \textcolor{comment}{// move the cryo back and drop air rights}
  \textcolor{comment}{//}
  \hyperlink{lspg_8c_a67a44f70405c8b6a01cec6ac3d166efb}{lspg\_waitcryo\_all}();

  \textcolor{comment}{// Move the cryo back}
  \textcolor{comment}{//}
  \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo}->\hyperlink{structlspmac__motor__struct_a38b6eee046c3ceff84f908af3335ebcf}{moveAbs}( \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo}, 1);
  \hyperlink{lspmac_8c_a55ffe2b135854f75079ecd39d507d3b4}{lspmac\_moveabs\_wait}( \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo}, 10.0);

  \textcolor{comment}{// simplest query yet!}
  \hyperlink{lspg_8c_a0bb9ef42da8fa21c4df48ec384ab69f4}{lspg\_query\_push}( NULL, \textcolor{stringliteral}{"SELECT px.dropairrights()"});

  \textcolor{comment}{// wait for the result}
  \textcolor{comment}{// TODO: find an easy way out of this in case of error}
  \textcolor{comment}{//}
  \hyperlink{lspg_8c_a2d624b228ddd560ace0cef4286a30b07}{lspg\_getcurrentsampleid\_wait\_for\_id}( 
      nextsample);

  \textcolor{comment}{// grab the airrights again}
  \textcolor{comment}{//}
  \hyperlink{lspg_8c_aaf0ad72847ccb93694b3bdc649e6d1fc}{lspg\_demandairrights\_all}();

  \textcolor{comment}{// Return the cryo}
  \textcolor{comment}{//}
  \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo}->\hyperlink{structlspmac__motor__struct_a38b6eee046c3ceff84f908af3335ebcf}{moveAbs}( \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo}, 0);
  \hyperlink{lspmac_8c_a55ffe2b135854f75079ecd39d507d3b4}{lspmac\_moveabs\_wait}( \hyperlink{lspmac_8c_ae78d9a757d4c85419fff9c94b15e25d7}{cryo}, 10.0);

  \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( \textcolor{stringliteral}{"Transfer Done"});

  \textcolor{keywordflow}{return} 0;
\}
\end{DoxyCode}
\hypertarget{md2cmds_8c_ae967e769d23555a631f615e630f25b00}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-worker@{md2cmds\-\_\-worker}}
\index{md2cmds\-\_\-worker@{md2cmds\-\_\-worker}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-worker}]{\setlength{\rightskip}{0pt plus 5cm}void$\ast$ md2cmds\-\_\-worker (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{dummy}
\end{DoxyParamCaption}
)}}\label{md2cmds_8c_ae967e769d23555a631f615e630f25b00}


Our worker thread. 


\begin{DoxyParams}{Parameters}
{\em dummy} & \begin{quotation}
\mbox{[}in\mbox{]} Unused but required by protocol \end{quotation}
\\
\hline
\end{DoxyParams}


Definition at line 1786 of file md2cmds.\-c.


\begin{DoxyCode}
                       \{

  ENTRY hsearcher, *hrtnval;
  \textcolor{keywordtype}{char} theCmd[32], *sp;
  \textcolor{keywordtype}{int} \hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}, err;
  \hyperlink{structmd2cmds__cmd__kv__struct}{md2cmds\_cmd\_kv\_t} *cmdp;

  pthread\_mutex\_lock( &\hyperlink{md2cmds_8c_ad67304bb851dc6268b0cda2f40fc5aa8}{md2cmds\_mutex});

  \textcolor{keywordflow}{while}( 1) \{
    \textcolor{comment}{//}
    \textcolor{comment}{// wait for someone to give us a command (and tell us they did so)}
    \textcolor{comment}{//}
    \textcolor{keywordflow}{while}( \hyperlink{md2cmds_8c_a5f0fe1e2dfa92cf345b8c29134ab1ede}{md2cmds\_cmd}[0] == 0)
      pthread\_cond\_wait( &\hyperlink{md2cmds_8c_a08d5b18ec9478d753c46a3e28d1f2126}{md2cmds\_cond}, &\hyperlink{md2cmds_8c_ad67304bb851dc6268b0cda2f40fc5aa8}{md2cmds\_mutex}
      );


    \textcolor{comment}{//}
    \textcolor{comment}{// pull out the command name itself from the string we were given}
    \textcolor{comment}{//}
    \textcolor{keywordflow}{for}( i=0, sp=\hyperlink{md2cmds_8c_a5f0fe1e2dfa92cf345b8c29134ab1ede}{md2cmds\_cmd}; i<\textcolor{keyword}{sizeof}( theCmd)-1; i++, sp++) \{
      \textcolor{keywordflow}{if}( *sp == 0 || *sp == \textcolor{charliteral}{' '}) \{
        theCmd[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}] = 0;
        \textcolor{keywordflow}{break};
      \}
      theCmd[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}] = *sp;
    \}
    theCmd[\textcolor{keyword}{sizeof}(theCmd)-1]=0;

    hsearcher.key  = theCmd;
    hsearcher.data = NULL;

    errno = 0;
    err = hsearch\_r( hsearcher, FIND, &hrtnval, &\hyperlink{md2cmds_8c_a625a7f2c3447a5ed7b6a1f9b0827d0c1}{md2cmds\_hmap});
    \textcolor{keywordflow}{if}( err == 0) \{
      \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_worker: hsearch\_r
       failed.  theCmd = '%s' from string '%s'"}, theCmd, \hyperlink{md2cmds_8c_a5f0fe1e2dfa92cf345b8c29134ab1ede}{md2cmds\_cmd});
      \hyperlink{md2cmds_8c_a5f0fe1e2dfa92cf345b8c29134ab1ede}{md2cmds\_cmd}[0] = 0;
      \textcolor{keywordflow}{continue};
    \}
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_worker: Found command
       '%s'"}, theCmd);
    \textcolor{keywordflow}{if}( hrtnval != NULL) \{
      cmdp = (\hyperlink{structmd2cmds__cmd__kv__struct}{md2cmds\_cmd\_kv\_t} *)hrtnval;
      err = cmdp->\hyperlink{structmd2cmds__cmd__kv__struct_ab12171e8ea4148dedcb13673e05ca92c}{v}( \hyperlink{md2cmds_8c_a5f0fe1e2dfa92cf345b8c29134ab1ede}{md2cmds\_cmd});
      \textcolor{keywordflow}{if}( err) \{
        \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"md2cmds\_worker: Command
       failed: '%s'"}, \hyperlink{md2cmds_8c_a5f0fe1e2dfa92cf345b8c29134ab1ede}{md2cmds\_cmd});
        \textcolor{comment}{//}
        \textcolor{comment}{// At this point we'd clear the queue but the queue is currently too
       short to bother doing that}
        \textcolor{comment}{//}
      \}
    \}

    \hyperlink{md2cmds_8c_a5f0fe1e2dfa92cf345b8c29134ab1ede}{md2cmds\_cmd}[0] = 0;
  \}
\}
\end{DoxyCode}


\subsection{Variable Documentation}
\hypertarget{md2cmds_8c_a478ca2fc7299fac5a13f6bce991198b7}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-capz\-\_\-moving\-\_\-time@{md2cmds\-\_\-capz\-\_\-moving\-\_\-time}}
\index{md2cmds\-\_\-capz\-\_\-moving\-\_\-time@{md2cmds\-\_\-capz\-\_\-moving\-\_\-time}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-capz\-\_\-moving\-\_\-time}]{\setlength{\rightskip}{0pt plus 5cm}double md2cmds\-\_\-capz\-\_\-moving\-\_\-time = N\-A\-N\hspace{0.3cm}{\ttfamily [static]}}}\label{md2cmds_8c_a478ca2fc7299fac5a13f6bce991198b7}


Definition at line 32 of file md2cmds.\-c.

\hypertarget{md2cmds_8c_a5f0fe1e2dfa92cf345b8c29134ab1ede}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-cmd@{md2cmds\-\_\-cmd}}
\index{md2cmds\-\_\-cmd@{md2cmds\-\_\-cmd}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-cmd}]{\setlength{\rightskip}{0pt plus 5cm}char md2cmds\-\_\-cmd\mbox{[}{\bf M\-D2\-C\-M\-D\-S\-\_\-\-C\-M\-D\-\_\-\-L\-E\-N\-G\-T\-H}\mbox{]}}}\label{md2cmds_8c_a5f0fe1e2dfa92cf345b8c29134ab1ede}


our command; 



Definition at line 24 of file md2cmds.\-c.

\hypertarget{md2cmds_8c_a2bb0a14593ac87833ec2151282098d64}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-cmd\-\_\-kvs@{md2cmds\-\_\-cmd\-\_\-kvs}}
\index{md2cmds\-\_\-cmd\-\_\-kvs@{md2cmds\-\_\-cmd\-\_\-kvs}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-cmd\-\_\-kvs}]{\setlength{\rightskip}{0pt plus 5cm}{\bf md2cmds\-\_\-cmd\-\_\-kv\-\_\-t} md2cmds\-\_\-cmd\-\_\-kvs\mbox{[}$\,$\mbox{]}\hspace{0.3cm}{\ttfamily [static]}}}\label{md2cmds_8c_a2bb0a14593ac87833ec2151282098d64}
{\bfseries Initial value\-:}
\begin{DoxyCode}
= \{
  \{ \textcolor{stringliteral}{"abort"},            \hyperlink{md2cmds_8c_ac196e3bcdae79c1ba70cf0bf40a9e299}{md2cmds\_abort}\},
  \{ \textcolor{stringliteral}{"center"},           \hyperlink{md2cmds_8c_aa85ebd51f9c8268f4044be52201d3f1c}{md2cmds\_center}\},
  \{ \textcolor{stringliteral}{"changeMode"},       \hyperlink{md2cmds_8c_a4569e8e2b269463b2a60b8407d9ce4d9}{md2cmds\_phase\_change}\},
  \{ \textcolor{stringliteral}{"collect"},          \hyperlink{md2cmds_8c_ad8f399e3ea3c2c77c23989c0fa0ccd86}{md2cmds\_collect}\},
  \{ \textcolor{stringliteral}{"moveAbs"},          \hyperlink{md2cmds_8c_ae1122d11f5198c7e8ee22125da65407c}{md2cmds\_moveAbs}\},
  \{ \textcolor{stringliteral}{"moveRel"},          \hyperlink{md2cmds_8c_a8e8eba6f3c5855910ba3cde22dd3a4b2}{md2cmds\_moveRel}\},
  \{ \textcolor{stringliteral}{"rotate"},           \hyperlink{md2cmds_8c_ab562f807493aaaaf5a6a377ac6d5a45e}{md2cmds\_rotate}\},
  \{ \textcolor{stringliteral}{"run"},              \hyperlink{md2cmds_8c_a577b62b66ed5589a171550e26478633f}{md2cmds\_run\_cmd}\},
  \{ \textcolor{stringliteral}{"test"},             \hyperlink{md2cmds_8c_a4a321d5e1621948eecb33a51a58041f6}{md2cmds\_test}\},
  \{ \textcolor{stringliteral}{"set"},              \hyperlink{md2cmds_8c_aee4a35d084bc0fdd4598576469deeed0}{md2cmds\_set}\},
  \{ \textcolor{stringliteral}{"settransferpoint"}, \hyperlink{md2cmds_8c_a3403a357a4b3ffd715a2f3d1dac3da5b}{md2cmds\_settransferpoint}\},
  \{ \textcolor{stringliteral}{"transfer"},         \hyperlink{md2cmds_8c_a87efed33b7a49cdfeaf5d64df4ca09aa}{md2cmds\_transfer}\}
\}
\end{DoxyCode}


Definition at line 57 of file md2cmds.\-c.

\hypertarget{md2cmds_8c_ad07af354194cb9a8eac1f200257dcacd}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-cmd\-\_\-regex@{md2cmds\-\_\-cmd\-\_\-regex}}
\index{md2cmds\-\_\-cmd\-\_\-regex@{md2cmds\-\_\-cmd\-\_\-regex}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-cmd\-\_\-regex}]{\setlength{\rightskip}{0pt plus 5cm}regex\-\_\-t md2cmds\-\_\-cmd\-\_\-regex\hspace{0.3cm}{\ttfamily [static]}}}\label{md2cmds_8c_ad07af354194cb9a8eac1f200257dcacd}


Definition at line 36 of file md2cmds.\-c.

\hypertarget{md2cmds_8c_a08d5b18ec9478d753c46a3e28d1f2126}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-cond@{md2cmds\-\_\-cond}}
\index{md2cmds\-\_\-cond@{md2cmds\-\_\-cond}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-cond}]{\setlength{\rightskip}{0pt plus 5cm}pthread\-\_\-cond\-\_\-t md2cmds\-\_\-cond}}\label{md2cmds_8c_a08d5b18ec9478d753c46a3e28d1f2126}


condition to signal when it's time to run an md2 command 



Definition at line 10 of file md2cmds.\-c.

\hypertarget{md2cmds_8c_a625a7f2c3447a5ed7b6a1f9b0827d0c1}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-hmap@{md2cmds\-\_\-hmap}}
\index{md2cmds\-\_\-hmap@{md2cmds\-\_\-hmap}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-hmap}]{\setlength{\rightskip}{0pt plus 5cm}struct hsearch\-\_\-data md2cmds\-\_\-hmap\hspace{0.3cm}{\ttfamily [static]}}}\label{md2cmds_8c_a625a7f2c3447a5ed7b6a1f9b0827d0c1}


Definition at line 34 of file md2cmds.\-c.

\hypertarget{md2cmds_8c_ac8e45a64495062e32b7887651627f46d}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-homing\-\_\-cond@{md2cmds\-\_\-homing\-\_\-cond}}
\index{md2cmds\-\_\-homing\-\_\-cond@{md2cmds\-\_\-homing\-\_\-cond}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-homing\-\_\-cond}]{\setlength{\rightskip}{0pt plus 5cm}pthread\-\_\-cond\-\_\-t md2cmds\-\_\-homing\-\_\-cond}}\label{md2cmds_8c_ac8e45a64495062e32b7887651627f46d}


coordinate homing and homed 



Definition at line 18 of file md2cmds.\-c.

\hypertarget{md2cmds_8c_ac6382968c1bd1ea03a06bde854cc4071}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-homing\-\_\-count@{md2cmds\-\_\-homing\-\_\-count}}
\index{md2cmds\-\_\-homing\-\_\-count@{md2cmds\-\_\-homing\-\_\-count}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-homing\-\_\-count}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-homing\-\_\-count = 0}}\label{md2cmds_8c_ac6382968c1bd1ea03a06bde854cc4071}


We've asked a motor to home. 



Definition at line 17 of file md2cmds.\-c.

\hypertarget{md2cmds_8c_acb54710bbbc6ea638326e93071900d1b}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-homing\-\_\-mutex@{md2cmds\-\_\-homing\-\_\-mutex}}
\index{md2cmds\-\_\-homing\-\_\-mutex@{md2cmds\-\_\-homing\-\_\-mutex}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-homing\-\_\-mutex}]{\setlength{\rightskip}{0pt plus 5cm}pthread\-\_\-mutex\-\_\-t md2cmds\-\_\-homing\-\_\-mutex}}\label{md2cmds_8c_acb54710bbbc6ea638326e93071900d1b}


our mutex; 



Definition at line 19 of file md2cmds.\-c.

\hypertarget{md2cmds_8c_a6a34fb6876abbd580629d3708c805e7f}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-md\-\_\-status\-\_\-code@{md2cmds\-\_\-md\-\_\-status\-\_\-code}}
\index{md2cmds\-\_\-md\-\_\-status\-\_\-code@{md2cmds\-\_\-md\-\_\-status\-\_\-code}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-md\-\_\-status\-\_\-code}]{\setlength{\rightskip}{0pt plus 5cm}{\bf lsredis\-\_\-obj\-\_\-t}$\ast$ md2cmds\-\_\-md\-\_\-status\-\_\-code}}\label{md2cmds_8c_a6a34fb6876abbd580629d3708c805e7f}


Definition at line 26 of file md2cmds.\-c.

\hypertarget{md2cmds_8c_adeebdb8f552bff14bd666c187505ee9e}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-moving\-\_\-cond@{md2cmds\-\_\-moving\-\_\-cond}}
\index{md2cmds\-\_\-moving\-\_\-cond@{md2cmds\-\_\-moving\-\_\-cond}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-moving\-\_\-cond}]{\setlength{\rightskip}{0pt plus 5cm}pthread\-\_\-cond\-\_\-t md2cmds\-\_\-moving\-\_\-cond}}\label{md2cmds_8c_adeebdb8f552bff14bd666c187505ee9e}


wait for command to have been dequeued and run 

coordinate call and response 

Definition at line 14 of file md2cmds.\-c.

\hypertarget{md2cmds_8c_a5ce190461376c4f9c7d74842d8ebc5d5}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-moving\-\_\-count@{md2cmds\-\_\-moving\-\_\-count}}
\index{md2cmds\-\_\-moving\-\_\-count@{md2cmds\-\_\-moving\-\_\-count}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-moving\-\_\-count}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-moving\-\_\-count = 0}}\label{md2cmds_8c_a5ce190461376c4f9c7d74842d8ebc5d5}


Definition at line 22 of file md2cmds.\-c.

\hypertarget{md2cmds_8c_a4ea6e6bf63aefcd49f87c3921029451d}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-moving\-\_\-mutex@{md2cmds\-\_\-moving\-\_\-mutex}}
\index{md2cmds\-\_\-moving\-\_\-mutex@{md2cmds\-\_\-moving\-\_\-mutex}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-moving\-\_\-mutex}]{\setlength{\rightskip}{0pt plus 5cm}pthread\-\_\-mutex\-\_\-t md2cmds\-\_\-moving\-\_\-mutex}}\label{md2cmds_8c_a4ea6e6bf63aefcd49f87c3921029451d}


message passing between md2cmds and pg 



Definition at line 15 of file md2cmds.\-c.

\hypertarget{md2cmds_8c_af14178edd0398535a0c3c87066d6f00c}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-moving\-\_\-queue\-\_\-wait@{md2cmds\-\_\-moving\-\_\-queue\-\_\-wait}}
\index{md2cmds\-\_\-moving\-\_\-queue\-\_\-wait@{md2cmds\-\_\-moving\-\_\-queue\-\_\-wait}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-moving\-\_\-queue\-\_\-wait}]{\setlength{\rightskip}{0pt plus 5cm}int md2cmds\-\_\-moving\-\_\-queue\-\_\-wait = 0}}\label{md2cmds_8c_af14178edd0398535a0c3c87066d6f00c}


Definition at line 13 of file md2cmds.\-c.

\hypertarget{md2cmds_8c_ad67304bb851dc6268b0cda2f40fc5aa8}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-mutex@{md2cmds\-\_\-mutex}}
\index{md2cmds\-\_\-mutex@{md2cmds\-\_\-mutex}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-mutex}]{\setlength{\rightskip}{0pt plus 5cm}pthread\-\_\-mutex\-\_\-t md2cmds\-\_\-mutex}}\label{md2cmds_8c_ad67304bb851dc6268b0cda2f40fc5aa8}


mutex for the condition 



Definition at line 11 of file md2cmds.\-c.

\hypertarget{md2cmds_8c_aa230921945149692de98fff15c01962f}{\index{md2cmds.\-c@{md2cmds.\-c}!md2cmds\-\_\-thread@{md2cmds\-\_\-thread}}
\index{md2cmds\-\_\-thread@{md2cmds\-\_\-thread}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{md2cmds\-\_\-thread}]{\setlength{\rightskip}{0pt plus 5cm}pthread\-\_\-t md2cmds\-\_\-thread\hspace{0.3cm}{\ttfamily [static]}}}\label{md2cmds_8c_aa230921945149692de98fff15c01962f}


Definition at line 28 of file md2cmds.\-c.

\hypertarget{md2cmds_8c_aaa6eb2d46be8d5e17a511591dd5a1271}{\index{md2cmds.\-c@{md2cmds.\-c}!rotating@{rotating}}
\index{rotating@{rotating}!md2cmds.c@{md2cmds.\-c}}
\subsubsection[{rotating}]{\setlength{\rightskip}{0pt plus 5cm}int rotating = 0\hspace{0.3cm}{\ttfamily [static]}}}\label{md2cmds_8c_aaa6eb2d46be8d5e17a511591dd5a1271}


flag\-: when omega is in position after a rotate we want to re-\/home omega 



Definition at line 30 of file md2cmds.\-c.

