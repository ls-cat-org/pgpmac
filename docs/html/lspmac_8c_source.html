<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>LS-CAT PGPMAC: lspmac.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>lspmac.c</h1><a href="lspmac_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &quot;<a class="code" href="pgpmac_8h.html" title="Headers for the entire pgpmac project.">pgpmac.h</a>&quot;</span>
<a name="l00037"></a><a class="code" href="lspmac_8c.html#a7e1c68021b3dbb53ba1bac2afbd8fc20">00037</a> <span class="preprocessor">#define LS_PMAC_STATE_RESET     -1</span>
<a name="l00038"></a><a class="code" href="lspmac_8c.html#a7eb86ecf0789ab9555de1e03a4c73567">00038</a> <span class="preprocessor"></span><span class="preprocessor">#define LS_PMAC_STATE_DETACHED  0</span>
<a name="l00039"></a><a class="code" href="lspmac_8c.html#a37741af675425d61c876cc30ae6c99d0">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define LS_PMAC_STATE_IDLE      1</span>
<a name="l00040"></a><a class="code" href="lspmac_8c.html#a7d8f34fc599cc08c1a9d2cd62ccbb20a">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define LS_PMAC_STATE_SC        2</span>
<a name="l00041"></a><a class="code" href="lspmac_8c.html#a63356b0c18fcb186f456c12c6e927d84">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define LS_PMAC_STATE_WACK_NFR  3</span>
<a name="l00042"></a><a class="code" href="lspmac_8c.html#adef540911028fda73e8bbf0aa6ad39e9">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define LS_PMAC_STATE_WACK_CC   4</span>
<a name="l00043"></a><a class="code" href="lspmac_8c.html#a5eba9ef09d4316e803b9d75bd3104f43">00043</a> <span class="preprocessor"></span><span class="preprocessor">#define LS_PMAC_STATE_WACK      5</span>
<a name="l00044"></a><a class="code" href="lspmac_8c.html#a220b39710719cfe8b500d51819e8efeb">00044</a> <span class="preprocessor"></span><span class="preprocessor">#define LS_PMAC_STATE_GMR       6</span>
<a name="l00045"></a><a class="code" href="lspmac_8c.html#abbd709b56a71eb1fc6adc9063605d243">00045</a> <span class="preprocessor"></span><span class="preprocessor">#define LS_PMAC_STATE_CR        7</span>
<a name="l00046"></a><a class="code" href="lspmac_8c.html#add5325f4a84e4fe05f558880349485ea">00046</a> <span class="preprocessor"></span><span class="preprocessor">#define LS_PMAC_STATE_RR        8</span>
<a name="l00047"></a><a class="code" href="lspmac_8c.html#a3e0a62cd9a1212419ad3615c34bdc65a">00047</a> <span class="preprocessor"></span><span class="preprocessor">#define LS_PMAC_STATE_WACK_RR   9</span>
<a name="l00048"></a><a class="code" href="lspmac_8c.html#a5f4ff8874677aac48a4c675f2c1ca4e9">00048</a> <span class="preprocessor"></span><span class="preprocessor">#define LS_PMAC_STATE_GB       10</span>
<a name="l00049"></a><a class="code" href="lspmac_8c.html#a27ee6c39d58604c8aa9bd6c249c4833f">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define LS_PMAC_STATE_WCR      11</span>
<a name="l00050"></a><a class="code" href="lspmac_8c.html#a591822cc92f76a39b293c2e90b322db2">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define LS_PMAC_STATE_WGB      12</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>
<a name="l00052"></a><a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390">00052</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#a7eb86ecf0789ab9555de1e03a4c73567">LS_PMAC_STATE_DETACHED</a>;      
<a name="l00053"></a>00053 
<a name="l00054"></a><a class="code" href="pgpmac_8h.html#a112158e0cd50449a440ac55c7af7bea2">00054</a> <span class="keywordtype">int</span> <a class="code" href="lspmac_8c.html#a112158e0cd50449a440ac55c7af7bea2" title="State of the shutter, used to detect changes.">lspmac_shutter_state</a>;                       
<a name="l00055"></a><a class="code" href="pgpmac_8h.html#a396fbf06208de3ecbe1b0df549f1cd46">00055</a> <span class="keywordtype">int</span> <a class="code" href="lspmac_8c.html#a396fbf06208de3ecbe1b0df549f1cd46" title="Indicates that the shutter had opened, perhaps briefly even if the state did not...">lspmac_shutter_has_opened</a>;                  
<a name="l00056"></a><a class="code" href="pgpmac_8h.html#a1b78a13c654409333569815e1c109d38">00056</a> pthread_mutex_t <a class="code" href="lspmac_8c.html#a1b78a13c654409333569815e1c109d38" title="Coordinates threads reading shutter status.">lspmac_shutter_mutex</a>;           
<a name="l00057"></a><a class="code" href="pgpmac_8h.html#afbd51c2cefcee87afe994c9e9f372241">00057</a> pthread_cond_t  <a class="code" href="lspmac_8c.html#afbd51c2cefcee87afe994c9e9f372241" title="Allows waiting for the shutter status to change.">lspmac_shutter_cond</a>;            
<a name="l00058"></a><a class="code" href="pgpmac_8h.html#a85679cac947e199c88794f8e5a12bf5f">00058</a> pthread_mutex_t <a class="code" href="lspmac_8c.html#a85679cac947e199c88794f8e5a12bf5f" title="Coordinate moving motors between threads.">lspmac_moving_mutex</a>;            
<a name="l00059"></a><a class="code" href="pgpmac_8h.html#a57547d211906c981ef20257eba99f8df">00059</a> pthread_cond_t  <a class="code" href="lspmac_8c.html#a57547d211906c981ef20257eba99f8df" title="Wait for motor(s) to finish moving condition.">lspmac_moving_cond</a>;             
<a name="l00060"></a><a class="code" href="pgpmac_8h.html#a7a32c617c183166308241e270959df56">00060</a> <span class="keywordtype">int</span> <a class="code" href="lspmac_8c.html#a7a32c617c183166308241e270959df56" title="Flag used to implement motor moving condition.">lspmac_moving_flags</a>;                        
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="lspmac_8c.html#a6b7011dd7d2c2d3afadff8d3e50e7677">00063</a> <span class="keyword">static</span> pthread_t <a class="code" href="lspmac_8c.html#a6b7011dd7d2c2d3afadff8d3e50e7677" title="our thread to manage access and communication to the pmac">pmac_thread</a>;                   
<a name="l00064"></a><a class="code" href="lspmac_8c.html#acc1bb77b9bcbc4d970f841a41fd274b3">00064</a> <span class="keyword">static</span> pthread_mutex_t <a class="code" href="lspmac_8c.html#acc1bb77b9bcbc4d970f841a41fd274b3" title="manage access to the pmac command queue">pmac_queue_mutex</a>;        
<a name="l00065"></a><a class="code" href="lspmac_8c.html#a8a25bd9c593c6985107f90f999ce0b08">00065</a> <span class="keyword">static</span> pthread_cond_t  <a class="code" href="lspmac_8c.html#a8a25bd9c593c6985107f90f999ce0b08" title="wait for a command to be sent to PMAC before continuing">pmac_queue_cond</a>;         
<a name="l00066"></a><a class="code" href="lspmac_8c.html#adba7f5f4bbeabc4dac859221d4c684ba">00066</a> <span class="keyword">static</span> <span class="keyword">struct </span>pollfd <a class="code" href="lspmac_8c.html#adba7f5f4bbeabc4dac859221d4c684ba" title="our poll structure">pmacfd</a>;                    
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="lspmac_8c.html#a07b7b8254772075e6a4ced500b589c36">00068</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lspmac_8c.html#a07b7b8254772075e6a4ced500b589c36" title="flag set at initialization to send i vars to db">getivars</a> = 0;                        
<a name="l00069"></a><a class="code" href="lspmac_8c.html#a50e9c0a06654fd81b3446a6e54ff12c3">00069</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lspmac_8c.html#a50e9c0a06654fd81b3446a6e54ff12c3" title="flag set at initialization to send m vars to db">getmvars</a> = 0;                        
<a name="l00070"></a>00070 
<a name="l00071"></a><a class="code" href="pgpmac_8h.html#aebfce5f9cbc8ba7bd4e2ee4880f303e8">00071</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> <a class="code" href="lspmac_8c.html#a9bffbf72495499b505543cd942f665da" title="All our motors.">lspmac_motors</a>[32];               
<a name="l00072"></a><a class="code" href="pgpmac_8h.html#a56260f012c50a591ee7f97e500f16994">00072</a> <span class="keywordtype">int</span> <a class="code" href="lspmac_8c.html#a56260f012c50a591ee7f97e500f16994" title="The number of motors we manage.">lspmac_nmotors</a> = 0;                         
<a name="l00073"></a><a class="code" href="pgpmac_8h.html#a8237e646ce032a840637a4ef7bff49b9">00073</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#a8237e646ce032a840637a4ef7bff49b9" title="MD2 omega axis (the air bearing).">omega</a>;                          
<a name="l00074"></a><a class="code" href="pgpmac_8h.html#a6cb218bdccfe5a93471c161f15a15cab">00074</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#a6cb218bdccfe5a93471c161f15a15cab" title="Alignment stage X.">alignx</a>;                         
<a name="l00075"></a><a class="code" href="pgpmac_8h.html#a737c246c3948e644a18d191a931e1acd">00075</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#a737c246c3948e644a18d191a931e1acd" title="Alignment stage Y.">aligny</a>;                         
<a name="l00076"></a><a class="code" href="pgpmac_8h.html#ae7642b1da0f7c7f8448104c691d40a12">00076</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#ae7642b1da0f7c7f8448104c691d40a12" title="Alignment stage X.">alignz</a>;                         
<a name="l00077"></a><a class="code" href="pgpmac_8h.html#aa90d2363b744acbd4d45133b7a716d8f">00077</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#aa90d2363b744acbd4d45133b7a716d8f" title="Polaroid analyzer motor.">anal</a>;                           
<a name="l00078"></a><a class="code" href="pgpmac_8h.html#ad53a42cfaa04eff0336a44c8c9986333">00078</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#ad53a42cfaa04eff0336a44c8c9986333" title="Optical zoom.">zoom</a>;                           
<a name="l00079"></a><a class="code" href="pgpmac_8h.html#a139200ddaa9856a7ffcec0e6cbaa8f1b">00079</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#a139200ddaa9856a7ffcec0e6cbaa8f1b" title="Aperture Y.">apery</a>;                          
<a name="l00080"></a><a class="code" href="pgpmac_8h.html#ab93bd6ee850b285ca3a95e64d15e9477">00080</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#ab93bd6ee850b285ca3a95e64d15e9477" title="Aperture Z.">aperz</a>;                          
<a name="l00081"></a><a class="code" href="pgpmac_8h.html#a51358daaea8b5236f08414877d8af6c2">00081</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#a51358daaea8b5236f08414877d8af6c2" title="Capillary Y.">capy</a>;                           
<a name="l00082"></a><a class="code" href="pgpmac_8h.html#aa45f268d0af9f3d465acfab128919718">00082</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#aa45f268d0af9f3d465acfab128919718" title="Capillary Z.">capz</a>;                           
<a name="l00083"></a><a class="code" href="pgpmac_8h.html#ac0eeaffa0996271d8a38344a470d13d7">00083</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#ac0eeaffa0996271d8a38344a470d13d7" title="Scintillator Z.">scinz</a>;                          
<a name="l00084"></a><a class="code" href="pgpmac_8h.html#ac940d950d9efeaf3f0ae67e9bf331188">00084</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#ac940d950d9efeaf3f0ae67e9bf331188" title="Centering Table X.">cenx</a>;                           
<a name="l00085"></a><a class="code" href="pgpmac_8h.html#aaed18e738ba7bfb6c771a44f5d7ea827">00085</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#aaed18e738ba7bfb6c771a44f5d7ea827" title="Centering Table Y.">ceny</a>;                           
<a name="l00086"></a><a class="code" href="pgpmac_8h.html#a0be79ccb7ebf3a665248fd856112b9fd">00086</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#a0be79ccb7ebf3a665248fd856112b9fd" title="Kappa.">kappa</a>;                          
<a name="l00087"></a><a class="code" href="pgpmac_8h.html#ac8070dc568ad974a3db42b51eca828cc">00087</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#ac8070dc568ad974a3db42b51eca828cc" title="Phi (not data collection axis).">phi</a>;                            
<a name="l00088"></a>00088 
<a name="l00089"></a><a class="code" href="pgpmac_8h.html#a26dec4623af9beed912b8e7e6f99822c">00089</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#a26dec4623af9beed912b8e7e6f99822c" title="Fast shutter.">fshut</a>;                          
<a name="l00090"></a><a class="code" href="pgpmac_8h.html#aeb09895663eff333b7a75acb319a9fc1">00090</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#aeb09895663eff333b7a75acb319a9fc1" title="Front Light DAC.">flight</a>;                         
<a name="l00091"></a><a class="code" href="pgpmac_8h.html#a85d6eaa4b4a82bb3112574f458d1dc50">00091</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#a85d6eaa4b4a82bb3112574f458d1dc50" title="Back Light DAC.">blight</a>;                         
<a name="l00092"></a><a class="code" href="pgpmac_8h.html#a8a3ca6fcf5e24dcc26170736843e53b2">00092</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#a8a3ca6fcf5e24dcc26170736843e53b2" title="Scintillator Piezo DAC.">fscint</a>;                         
<a name="l00093"></a>00093 
<a name="l00094"></a><a class="code" href="pgpmac_8h.html#af813a2eff0b7efa4c70633559054e84c">00094</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#af813a2eff0b7efa4c70633559054e84c" title="Back Light Up/Down actuator.">blight_ud</a>;                      
<a name="l00095"></a><a class="code" href="pgpmac_8h.html#ae78d9a757d4c85419fff9c94b15e25d7">00095</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#ae78d9a757d4c85419fff9c94b15e25d7" title="Move the cryostream towards or away from the crystal.">cryo</a>;                           
<a name="l00096"></a><a class="code" href="pgpmac_8h.html#a9d9c5030d817483ca9518027c91adac4">00096</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#a9d9c5030d817483ca9518027c91adac4" title="blow air on the scintilator to dry it off">dryer</a>;                          
<a name="l00097"></a>00097 
<a name="l00099"></a><a class="code" href="lspmac_8c.html#ac95886e84843b6b0bb6cc270e42043c4">00099</a> <span class="preprocessor">#define PMACPORT 1025</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span>
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 <span class="comment">// This size does not include the data, and hence, is fixed.</span>
<a name="l00104"></a>00104 <span class="comment">//</span>
<a name="l00105"></a><a class="code" href="lspmac_8c.html#abdc45e3f7106f84f688419e2da9b3627">00105</a> <span class="preprocessor">#define pmac_cmd_size 8</span>
<a name="l00106"></a>00106 <span class="preprocessor"></span>
<a name="l00107"></a><a class="code" href="lspmac_8c.html#a5485d08fdc80533b5cebadff63696ed2">00107</a> <span class="preprocessor">#define VR_UPLOAD               0xc0</span>
<a name="l00108"></a><a class="code" href="lspmac_8c.html#af24ecdc10723dc8fd6320fef416ae514">00108</a> <span class="preprocessor"></span><span class="preprocessor">#define VR_DOWNLOAD             0x40</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>
<a name="l00110"></a><a class="code" href="lspmac_8c.html#a772b2ea2ad93989ae4275c79a93525ee">00110</a> <span class="preprocessor">#define VR_PMAC_SENDLINE        0xb0</span>
<a name="l00111"></a><a class="code" href="lspmac_8c.html#af3c7372a48fccf0458f266f4bc758a2c">00111</a> <span class="preprocessor"></span><span class="preprocessor">#define VR_PMAC_GETLINE         0xb1</span>
<a name="l00112"></a><a class="code" href="lspmac_8c.html#ac0e5588681366b52589cd321eabf12ff">00112</a> <span class="preprocessor"></span><span class="preprocessor">#define VR_PMAC_FLUSH           0xb3</span>
<a name="l00113"></a><a class="code" href="lspmac_8c.html#af9c53e7c5b2681a5ca1c5410a914a2dc">00113</a> <span class="preprocessor"></span><span class="preprocessor">#define VR_PMAC_GETMEM          0xb4</span>
<a name="l00114"></a><a class="code" href="lspmac_8c.html#ab79207cc3145740f8c070a24c91b11e0">00114</a> <span class="preprocessor"></span><span class="preprocessor">#define VR_PMAC_SETMEM          0xb5</span>
<a name="l00115"></a><a class="code" href="lspmac_8c.html#a76c1c401354826ac2ba8906578be930f">00115</a> <span class="preprocessor"></span><span class="preprocessor">#define VR_PMAC_SENDCTRLCHAR    0xb6</span>
<a name="l00116"></a><a class="code" href="lspmac_8c.html#aaed77195148c3d9fe10c6e82fc6b2ea7">00116</a> <span class="preprocessor"></span><span class="preprocessor">#define VR_PMAC_SETBIT          0xba</span>
<a name="l00117"></a><a class="code" href="lspmac_8c.html#a91a625425f6df7610f440231868a5cf1">00117</a> <span class="preprocessor"></span><span class="preprocessor">#define VR_PMAC_SETBITS         0xbb</span>
<a name="l00118"></a><a class="code" href="lspmac_8c.html#a4cd95cb80b8da3962ebe9ec8afe844c8">00118</a> <span class="preprocessor"></span><span class="preprocessor">#define VR_PMAC_PORT            0xbe</span>
<a name="l00119"></a><a class="code" href="lspmac_8c.html#aee7c46f33b9b6945c6b2b260810dc7f5">00119</a> <span class="preprocessor"></span><span class="preprocessor">#define VR_PMAC_GETRESPONSE     0xbf</span>
<a name="l00120"></a><a class="code" href="lspmac_8c.html#aad3c7b4a9403e56c09eceadcf21252c0">00120</a> <span class="preprocessor"></span><span class="preprocessor">#define VR_PMAC_READREADY       0xc2</span>
<a name="l00121"></a><a class="code" href="lspmac_8c.html#a8f4ce4666a23a3fb153d680bd1cb6556">00121</a> <span class="preprocessor"></span><span class="preprocessor">#define VR_CTRL_RESPONSE        0xc4</span>
<a name="l00122"></a><a class="code" href="lspmac_8c.html#a50e444b5ceb6d62a1be43c88c55c549c">00122</a> <span class="preprocessor"></span><span class="preprocessor">#define VR_PMAC_GETBUFFER       0xc5</span>
<a name="l00123"></a><a class="code" href="lspmac_8c.html#af5e53c37c17cd06e42f7b0df211f96d8">00123</a> <span class="preprocessor"></span><span class="preprocessor">#define VR_PMAC_WRITEBUFFER     0xc6</span>
<a name="l00124"></a><a class="code" href="lspmac_8c.html#ab8367c4c9247a96c6828418d87b8623b">00124</a> <span class="preprocessor"></span><span class="preprocessor">#define VR_PMAC_WRITEERROR      0xc7</span>
<a name="l00125"></a><a class="code" href="lspmac_8c.html#a15e4dbce5615c285ec1755f01057b5fe">00125</a> <span class="preprocessor"></span><span class="preprocessor">#define VR_FWDOWNLOAD           0xcb</span>
<a name="l00126"></a><a class="code" href="lspmac_8c.html#a34a2e0d5c1f48ba463ae5d98431d05f7">00126</a> <span class="preprocessor"></span><span class="preprocessor">#define VR_IPADDRESS            0xe0</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span>
<a name="l00128"></a>00128 
<a name="l00129"></a><a class="code" href="lspmac_8c.html#a1de136a293a8e4bd306e692218a81587">00129</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lspmac_8c.html#a1de136a293a8e4bd306e692218a81587" title="current number of lines received">linesReceived</a>=0;                     
<a name="l00130"></a><a class="code" href="lspmac_8c.html#a9da2795d11ccbc3a060c4811770ad04c">00130</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="lspmac_8c.html#a9da2795d11ccbc3a060c4811770ad04c" title="double buffered memory">dbmem</a>[64*1024];            
<a name="l00131"></a><a class="code" href="lspmac_8c.html#aa0be2f26364c4d12c9c81c10913f0b26">00131</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lspmac_8c.html#aa0be2f26364c4d12c9c81c10913f0b26" title="next location">dbmemIn</a> = 0;                         
<a name="l00132"></a>00132 
<a name="l00134"></a>00134 <span class="comment">//</span>
<a name="l00135"></a><a class="code" href="lspmac_8c.html#a59f5f5218e25332dbf64f216aec116e5">00135</a> <span class="preprocessor">#define PMAC_MIN_CMD_TIME 20000.0</span>
<a name="l00136"></a><a class="code" href="lspmac_8c.html#a4bed9053319d1d2cad5cc03d0549e17f">00136</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span>timeval pmac_time_sent, <a class="code" href="lspmac_8c.html#a4bed9053319d1d2cad5cc03d0549e17f" title="used to ensure we do not send commands to the pmac too often. Only needed for non-DB...">now</a>;      
<a name="l00137"></a>00137 
<a name="l00139"></a><a class="code" href="lspmac_8c.html#a3fae557baafab24b7518dc84f5ef5a9b">00139</a> <span class="preprocessor">#define PMAC_CMD_QUEUE_LENGTH 2048</span>
<a name="l00140"></a><a class="code" href="lspmac_8c.html#a6fcbbe47fe9912533962601f5befdb29">00140</a> <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="structtagEthernetCmd.html" title="PMAC ethernet packet definition.">pmac_cmd_t</a> <a class="code" href="lspmac_8c.html#a6fcbbe47fe9912533962601f5befdb29">rr_cmd</a>, <a class="code" href="lspmac_8c.html#ae7b21213b9c78b6745213409f1ef7320">gb_cmd</a>, <a class="code" href="lspmac_8c.html#a8908812f4ff25c196679e00d330edd81" title="commands to send out &amp;quot;readready&amp;quot;, &amp;quot;getbuffer&amp;quot;, controlresponse...">cr_cmd</a>;               
<a name="l00141"></a><a class="code" href="lspmac_8c.html#a69e569a833fe7f202b92e860d1548f2b">00141</a> <span class="keyword">static</span> <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> <a class="code" href="lspmac_8c.html#a69e569a833fe7f202b92e860d1548f2b" title="PMAC command queue.">ethCmdQueue</a>[<a class="code" href="lspmac_8c.html#a3fae557baafab24b7518dc84f5ef5a9b" title="Size of the PMAC command queue.">PMAC_CMD_QUEUE_LENGTH</a>];     
<a name="l00142"></a><a class="code" href="lspmac_8c.html#ad62b1f9e907acc3de9f3d6a05d55829e">00142</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="lspmac_8c.html#ad62b1f9e907acc3de9f3d6a05d55829e" title="points to next empty PMAC command queue position">ethCmdOn</a>    = 0;                            
<a name="l00143"></a><a class="code" href="lspmac_8c.html#ae85caec6f4ddb2fc52ca14a26549ab08">00143</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="lspmac_8c.html#ae85caec6f4ddb2fc52ca14a26549ab08" title="points to current command (or none if == ethCmdOn)">ethCmdOff</a>   = 0;                            
<a name="l00144"></a><a class="code" href="lspmac_8c.html#a7a78524ada402bb74759a3dfc5f8a571">00144</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="lspmac_8c.html#a7a78524ada402bb74759a3dfc5f8a571" title="Used like ethCmdOff only to deal with the pmac reply to a command.">ethCmdReply</a> = 0;                            
<a name="l00145"></a>00145 
<a name="l00147"></a><a class="code" href="lspmac_8c.html#aab5a76f1ac64049314f9836e5c01fb7e">00147</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="lspmac_8c.html#aab5a76f1ac64049314f9836e5c01fb7e" title="Decode the errors perhaps returned by the PMAC.">pmac_error_strs</a>[] = {
<a name="l00148"></a>00148   <span class="stringliteral">&quot;ERR000: Unknown error&quot;</span>,
<a name="l00149"></a>00149   <span class="stringliteral">&quot;ERR001: Command not allowed during program execution&quot;</span>,
<a name="l00150"></a>00150   <span class="stringliteral">&quot;ERR002: Password error&quot;</span>,
<a name="l00151"></a>00151   <span class="stringliteral">&quot;ERR003: Data error or unrecognized command&quot;</span>,
<a name="l00152"></a>00152   <span class="stringliteral">&quot;ERR004: Illegal character&quot;</span>,
<a name="l00153"></a>00153   <span class="stringliteral">&quot;ERR005: Command not allowed unless buffer is open&quot;</span>,
<a name="l00154"></a>00154   <span class="stringliteral">&quot;ERR006: No room in buffer for command&quot;</span>,
<a name="l00155"></a>00155   <span class="stringliteral">&quot;ERR007: Buffer already in use&quot;</span>,
<a name="l00156"></a>00156   <span class="stringliteral">&quot;ERR008: MACRO auziliary communication error&quot;</span>,
<a name="l00157"></a>00157   <span class="stringliteral">&quot;ERR009: Program structure error (e.g. ENDIF without IF)&quot;</span>,
<a name="l00158"></a>00158   <span class="stringliteral">&quot;ERR010: Both overtravel limits set for a motor in the C.S.&quot;</span>,
<a name="l00159"></a>00159   <span class="stringliteral">&quot;ERR011: Previous move not completed&quot;</span>,
<a name="l00160"></a>00160   <span class="stringliteral">&quot;ERR012: A motor in the coordinate system is open-loop&quot;</span>,
<a name="l00161"></a>00161   <span class="stringliteral">&quot;ERR013: A motor in the coordinate system is not activated&quot;</span>,
<a name="l00162"></a>00162   <span class="stringliteral">&quot;ERR014: No motors in the coordinate system&quot;</span>,
<a name="l00163"></a>00163   <span class="stringliteral">&quot;ERR015: Not pointer to valid program buffer&quot;</span>,
<a name="l00164"></a>00164   <span class="stringliteral">&quot;ERR016: Running improperly structure program (e.g. missing ENDWHILE)&quot;</span>,
<a name="l00165"></a>00165   <span class="stringliteral">&quot;ERR017: Trying to resume after H or Q with motors out of stopped position&quot;</span>,
<a name="l00166"></a>00166   <span class="stringliteral">&quot;ERR018: Attempt to perform phase reference during move, move during phase reference, or enabling with phase clock error&quot;</span>,
<a name="l00167"></a>00167   <span class="stringliteral">&quot;ERR019: Illegal position-chage command while moves stored in CCBUFFER&quot;</span>
<a name="l00168"></a>00168 };
<a name="l00169"></a>00169 
<a name="l00170"></a>00170 
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 <span class="comment">//</span>
<a name="l00174"></a>00174 <span class="comment">// DPRAM is from $60000 to ????</span>
<a name="l00175"></a>00175 <span class="comment">//</span>
<a name="l00176"></a>00176 <span class="comment">// We can quickly read 1400 bytes = 350 32-bit registers</span>
<a name="l00177"></a>00177 <span class="comment">// so reading $60000 to 60015D is not too expensive</span>
<a name="l00178"></a>00178 <span class="comment">//</span>
<a name="l00179"></a>00179 <span class="comment">// Gather data starts at $600450 (per turbo pmac user manual)</span>
<a name="l00180"></a>00180 <span class="comment">//</span>
<a name="l00181"></a>00181 <span class="comment">// MD2 seems to use $60060 to</span>
<a name="l00182"></a>00182 <span class="comment">//</span>
<a name="l00183"></a>00183 
<a name="l00184"></a><a class="code" href="structmd2StatusStruct.html">00184</a> <span class="keyword">typedef</span>  <span class="keyword">struct </span><a class="code" href="structmd2StatusStruct.html" title="The block of memory retrieved in a status request.">md2StatusStruct</a> {
<a name="l00185"></a>00185   <span class="comment">//</span>
<a name="l00186"></a>00186   <span class="comment">// Pmac stores data in 24 bit or 48 bit words</span>
<a name="l00187"></a>00187   <span class="comment">//</span>
<a name="l00188"></a>00188   <span class="comment">// The DP: addresses point to the low 16 bits of the 24 bit X and Y registers</span>
<a name="l00189"></a>00189   <span class="comment">//</span>
<a name="l00190"></a>00190   <span class="comment">//  PMAC       Our dp ram offset</span>
<a name="l00191"></a>00191   <span class="comment">//</span>
<a name="l00192"></a>00192   <span class="comment">// Y:$060000      0x0000</span>
<a name="l00193"></a>00193   <span class="comment">// X:$060000      0x0002</span>
<a name="l00194"></a>00194   <span class="comment">// Y:$060001      0x0004</span>
<a name="l00195"></a>00195   <span class="comment">// X:$060001      0x0006</span>
<a name="l00196"></a>00196   <span class="comment">// And so forth</span>
<a name="l00197"></a>00197   <span class="comment">//</span>
<a name="l00198"></a>00198   <span class="comment">//</span>
<a name="l00199"></a><a class="code" href="structmd2StatusStruct.html#a3a2dff3e6a1a346806a655e8404e0f53">00199</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a3a2dff3e6a1a346806a655e8404e0f53">dummy1</a>;                   <span class="comment">// 0x000                $60100 </span>
<a name="l00200"></a><a class="code" href="structmd2StatusStruct.html#af6cf3cd65b9ef205685a0d970f168907">00200</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#af6cf3cd65b9ef205685a0d970f168907">omega_status_1</a>;           <span class="comment">// 0x004                $60101 </span>
<a name="l00201"></a><a class="code" href="structmd2StatusStruct.html#a56accf8cb00c59bff87ed75df7dafbbe">00201</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a56accf8cb00c59bff87ed75df7dafbbe">alignx_status_1</a>;          <span class="comment">// 0x008                $60102</span>
<a name="l00202"></a><a class="code" href="structmd2StatusStruct.html#a2f2a11fe2fc7a446323def2be465185a">00202</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a2f2a11fe2fc7a446323def2be465185a">aligny_status_1</a>;          <span class="comment">// 0x00C                $60103</span>
<a name="l00203"></a><a class="code" href="structmd2StatusStruct.html#aadbfac5709de57e449a37e2937d6ade7">00203</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#aadbfac5709de57e449a37e2937d6ade7">alignz_status_1</a>;          <span class="comment">// 0x010                $60104</span>
<a name="l00204"></a><a class="code" href="structmd2StatusStruct.html#ab876b484f55bcce576fcd89dcc3f7267">00204</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#ab876b484f55bcce576fcd89dcc3f7267">analyzer_status_1</a>;        <span class="comment">// 0x014                $60105</span>
<a name="l00205"></a><a class="code" href="structmd2StatusStruct.html#af28e978b761dc07eefed3971547cfd4d">00205</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#af28e978b761dc07eefed3971547cfd4d">zoom_status_1</a>;            <span class="comment">// 0x018                $60106</span>
<a name="l00206"></a><a class="code" href="structmd2StatusStruct.html#a2ef953eaddf7058bf4276585e6ff066b">00206</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a2ef953eaddf7058bf4276585e6ff066b">aperturey_status_1</a>;       <span class="comment">// 0x01C                $60107</span>
<a name="l00207"></a><a class="code" href="structmd2StatusStruct.html#a27880dd795e1ba4fea4870c64ee3aa84">00207</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a27880dd795e1ba4fea4870c64ee3aa84">aperturez_status_1</a>;       <span class="comment">// 0x020                $60108</span>
<a name="l00208"></a><a class="code" href="structmd2StatusStruct.html#a7f4e945e80b1980b9e69366a69ad79cc">00208</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a7f4e945e80b1980b9e69366a69ad79cc">capy_status_1</a>;            <span class="comment">// 0x024                $60109</span>
<a name="l00209"></a><a class="code" href="structmd2StatusStruct.html#a719db4477f35331eaa8b7b44150e88a2">00209</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a719db4477f35331eaa8b7b44150e88a2">capz_status_1</a>;            <span class="comment">// 0x028                $6010A</span>
<a name="l00210"></a><a class="code" href="structmd2StatusStruct.html#a1723870357f428ac5c2758a2c9a475c7">00210</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a1723870357f428ac5c2758a2c9a475c7">scint_status_1</a>;           <span class="comment">// 0x02C                $6010B</span>
<a name="l00211"></a><a class="code" href="structmd2StatusStruct.html#aa619cdbd7a563408c6b825ddc4f74ebb">00211</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#aa619cdbd7a563408c6b825ddc4f74ebb">centerx_status_1</a>;         <span class="comment">// 0x030                $6010C</span>
<a name="l00212"></a><a class="code" href="structmd2StatusStruct.html#a57f65ebe28ef88f1c632d9f35d9167eb">00212</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a57f65ebe28ef88f1c632d9f35d9167eb">centery_status_1</a>;         <span class="comment">// 0x034                $6010D</span>
<a name="l00213"></a><a class="code" href="structmd2StatusStruct.html#ab152694bc32d37c1d180f55e8d282020">00213</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#ab152694bc32d37c1d180f55e8d282020">kappa_status_1</a>;           <span class="comment">// 0x038                $6010E</span>
<a name="l00214"></a><a class="code" href="structmd2StatusStruct.html#ad8b8fd90ffff43016e2adaab5ccbfa02">00214</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#ad8b8fd90ffff43016e2adaab5ccbfa02">phi_status_1</a>;             <span class="comment">// 0x03C                $6010F</span>
<a name="l00215"></a>00215 
<a name="l00216"></a><a class="code" href="structmd2StatusStruct.html#a4df936acc498498baba111edb82597a1">00216</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a4df936acc498498baba111edb82597a1">dummy2</a>;                   <span class="comment">// 0x040                $60110</span>
<a name="l00217"></a><a class="code" href="structmd2StatusStruct.html#a8577c9df7b663b548b2759ac3db721cd">00217</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a8577c9df7b663b548b2759ac3db721cd">omega_status_2</a>;           <span class="comment">// 0x044                $60111</span>
<a name="l00218"></a><a class="code" href="structmd2StatusStruct.html#a2feb35ceab8129fd2cc34d1104af8b8f">00218</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a2feb35ceab8129fd2cc34d1104af8b8f">alignx_status_2</a>;          <span class="comment">// 0x048                $60112</span>
<a name="l00219"></a><a class="code" href="structmd2StatusStruct.html#a1f98d8b9831e32d77129f9b0f1d7d255">00219</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a1f98d8b9831e32d77129f9b0f1d7d255">aligny_status_2</a>;          <span class="comment">// 0x04C                $60113</span>
<a name="l00220"></a><a class="code" href="structmd2StatusStruct.html#ac378da16eeaab2bc47f3f8f88f7411ed">00220</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#ac378da16eeaab2bc47f3f8f88f7411ed">alignz_status_2</a>;          <span class="comment">// 0x050                $60114</span>
<a name="l00221"></a><a class="code" href="structmd2StatusStruct.html#a4f88bb778e4e18f1fbf7672ac11e7433">00221</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a4f88bb778e4e18f1fbf7672ac11e7433">analyzer_status_2</a>;        <span class="comment">// 0x054                $60115</span>
<a name="l00222"></a><a class="code" href="structmd2StatusStruct.html#a34e4200315a083deb8a970e21bbbe277">00222</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a34e4200315a083deb8a970e21bbbe277">zoom_status_2</a>;            <span class="comment">// 0x058                $60116</span>
<a name="l00223"></a><a class="code" href="structmd2StatusStruct.html#a0a7738f13a0fa80626cafc2299b104b4">00223</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a0a7738f13a0fa80626cafc2299b104b4">aperturey_status_2</a>;       <span class="comment">// 0x05C                $60117</span>
<a name="l00224"></a><a class="code" href="structmd2StatusStruct.html#ae407a99e428d9f4a7444a02c8bc3414e">00224</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#ae407a99e428d9f4a7444a02c8bc3414e">aperturez_status_2</a>;       <span class="comment">// 0x060                $60118</span>
<a name="l00225"></a><a class="code" href="structmd2StatusStruct.html#a5d7c10d9a16ebcc53ac4a0770ab2ef62">00225</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a5d7c10d9a16ebcc53ac4a0770ab2ef62">capy_status_2</a>;            <span class="comment">// 0x064                $60119</span>
<a name="l00226"></a><a class="code" href="structmd2StatusStruct.html#a3abb998bb89433aed16121d0dae6275a">00226</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a3abb998bb89433aed16121d0dae6275a">capz_status_2</a>;            <span class="comment">// 0x068                $6011A</span>
<a name="l00227"></a><a class="code" href="structmd2StatusStruct.html#a4e5bc72e2f4007370f1c29ea272c952f">00227</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a4e5bc72e2f4007370f1c29ea272c952f">scint_status_2</a>;           <span class="comment">// 0x06C                $6011B</span>
<a name="l00228"></a><a class="code" href="structmd2StatusStruct.html#ae4fad6debe138ed7815d463e83f8d0f6">00228</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#ae4fad6debe138ed7815d463e83f8d0f6">centerx_status_2</a>;         <span class="comment">// 0x070                $6011C</span>
<a name="l00229"></a><a class="code" href="structmd2StatusStruct.html#aa242098c185cce8f852cd6e081ef0b1d">00229</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#aa242098c185cce8f852cd6e081ef0b1d">centery_status_2</a>;         <span class="comment">// 0x074                $6011D</span>
<a name="l00230"></a><a class="code" href="structmd2StatusStruct.html#af6891f5f8dcfc62668f64c583042c6bc">00230</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#af6891f5f8dcfc62668f64c583042c6bc">kappa_status_2</a>;           <span class="comment">// 0x078                $6011E</span>
<a name="l00231"></a><a class="code" href="structmd2StatusStruct.html#a0e6cea4c32cb34e602b9ac3d21259219">00231</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a0e6cea4c32cb34e602b9ac3d21259219">phi_status_2</a>;             <span class="comment">// 0x07C                $6011F</span>
<a name="l00232"></a>00232 
<a name="l00233"></a><a class="code" href="structmd2StatusStruct.html#adb2dc5bdbf99def51018558201508009">00233</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#adb2dc5bdbf99def51018558201508009">dummy3</a>;                   <span class="comment">// 0x080                $60120</span>
<a name="l00234"></a><a class="code" href="structmd2StatusStruct.html#a6ce303bec89082cae1e9b1fddf6b6c10">00234</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a6ce303bec89082cae1e9b1fddf6b6c10">omega_act_pos</a>;            <span class="comment">// 0x084                $60121</span>
<a name="l00235"></a><a class="code" href="structmd2StatusStruct.html#a9653a75bc0b66c5f86d8b0206dc39b4f">00235</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a9653a75bc0b66c5f86d8b0206dc39b4f">alignx_act_pos</a>;           <span class="comment">// 0x088                $60122</span>
<a name="l00236"></a><a class="code" href="structmd2StatusStruct.html#a0d40a01d2aa93c443526e826440f77fc">00236</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a0d40a01d2aa93c443526e826440f77fc">aligny_act_pos</a>;           <span class="comment">// 0x08C                $60123</span>
<a name="l00237"></a><a class="code" href="structmd2StatusStruct.html#a480f892fe91b05b2980fb00064807e2b">00237</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a480f892fe91b05b2980fb00064807e2b">alignz_act_pos</a>;           <span class="comment">// 0x090                $60124</span>
<a name="l00238"></a><a class="code" href="structmd2StatusStruct.html#a49d1151b0e819646587be0ca9c9d612a">00238</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a49d1151b0e819646587be0ca9c9d612a">analyzer_act_pos</a>;         <span class="comment">// 0x094                $60125</span>
<a name="l00239"></a><a class="code" href="structmd2StatusStruct.html#a920b80e9f5f08aedac3ad541d5ffc8ae">00239</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a920b80e9f5f08aedac3ad541d5ffc8ae">zoom_act_pos</a>;             <span class="comment">// 0x098                $60126</span>
<a name="l00240"></a><a class="code" href="structmd2StatusStruct.html#a2a434d2b57dbb669de0765486a1516ff">00240</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a2a434d2b57dbb669de0765486a1516ff">aperturey_act_pos</a>;        <span class="comment">// 0x09C                $60127</span>
<a name="l00241"></a><a class="code" href="structmd2StatusStruct.html#a62d584ce23cfd9aa626d3c03649b455c">00241</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a62d584ce23cfd9aa626d3c03649b455c">aperturez_act_pos</a>;        <span class="comment">// 0x0A0                $60128</span>
<a name="l00242"></a><a class="code" href="structmd2StatusStruct.html#ae25122a6db146501b51609b9cb59b044">00242</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#ae25122a6db146501b51609b9cb59b044">capy_act_pos</a>;             <span class="comment">// 0x0A4                $60129</span>
<a name="l00243"></a><a class="code" href="structmd2StatusStruct.html#a257c04efac3a33d5d34b21d64c6f1266">00243</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a257c04efac3a33d5d34b21d64c6f1266">capz_act_pos</a>;             <span class="comment">// 0x0A8                $6012A</span>
<a name="l00244"></a><a class="code" href="structmd2StatusStruct.html#a1c146fc792c4285eed5b2c446c214f98">00244</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a1c146fc792c4285eed5b2c446c214f98">scint_act_pos</a>;            <span class="comment">// 0x0AC                $6012B</span>
<a name="l00245"></a><a class="code" href="structmd2StatusStruct.html#ae7924b6e91e1de82f6f7910cb3a9c9bd">00245</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#ae7924b6e91e1de82f6f7910cb3a9c9bd">centerx_act_pos</a>;          <span class="comment">// 0x0B0                $6012C</span>
<a name="l00246"></a><a class="code" href="structmd2StatusStruct.html#a6be71a92a599d490ca808af8c7e7faa0">00246</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a6be71a92a599d490ca808af8c7e7faa0">centery_act_pos</a>;          <span class="comment">// 0x0B4                $6012D</span>
<a name="l00247"></a><a class="code" href="structmd2StatusStruct.html#ac384fb7073387dd5dcb2e85a00ec8a77">00247</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#ac384fb7073387dd5dcb2e85a00ec8a77">kappa_act_pos</a>;            <span class="comment">// 0x0B8                $6012E</span>
<a name="l00248"></a><a class="code" href="structmd2StatusStruct.html#a4de22995a72ff6e72a1a9ccab6d00620">00248</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a4de22995a72ff6e72a1a9ccab6d00620">phi_act_pos</a>;              <span class="comment">// 0x0BC                $6012F</span>
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 
<a name="l00251"></a><a class="code" href="structmd2StatusStruct.html#a69fc2e30a5de0a11c992d133e7a761cd">00251</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a69fc2e30a5de0a11c992d133e7a761cd">acc11c_1</a>;                 <span class="comment">// 0x0C0                $60130</span>
<a name="l00252"></a><a class="code" href="structmd2StatusStruct.html#ad186f06cb4670b00b8af8264d1da66a4">00252</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#ad186f06cb4670b00b8af8264d1da66a4">acc11c_2</a>;                 <span class="comment">// 0x0C4                $60131</span>
<a name="l00253"></a><a class="code" href="structmd2StatusStruct.html#a20a15620e12888f61c0aed1e47e97932">00253</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a20a15620e12888f61c0aed1e47e97932">acc11c_3</a>;                 <span class="comment">// 0x0C8                $60132</span>
<a name="l00254"></a><a class="code" href="structmd2StatusStruct.html#ab09c1342dc12052b8f5b35f78ef95000">00254</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#ab09c1342dc12052b8f5b35f78ef95000">acc11c_5</a>;                 <span class="comment">// 0x0CC                $60133</span>
<a name="l00255"></a><a class="code" href="structmd2StatusStruct.html#ac7029100738dcc3f09a8b0d1d3d1d353">00255</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#ac7029100738dcc3f09a8b0d1d3d1d353">acc11c_6</a>;                 <span class="comment">// 0x0D0                $60134</span>
<a name="l00256"></a><a class="code" href="structmd2StatusStruct.html#a3be73c48b09190241a2bcb801af5b97c">00256</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a3be73c48b09190241a2bcb801af5b97c">front_dac</a>;                <span class="comment">// 0x0D4                $60135</span>
<a name="l00257"></a><a class="code" href="structmd2StatusStruct.html#a33ce490348c8de255cf49b96469d3d4e">00257</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a33ce490348c8de255cf49b96469d3d4e">back_dac</a>;                 <span class="comment">// 0x0D8                $60136</span>
<a name="l00258"></a><a class="code" href="structmd2StatusStruct.html#a031be48adfa016c637d6eae49054c435">00258</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a031be48adfa016c637d6eae49054c435">scint_piezo</a>;              <span class="comment">// 0x0DC                $60137</span>
<a name="l00259"></a>00259 
<a name="l00260"></a><a class="code" href="structmd2StatusStruct.html#adaa01db9cf77d95756bc3156fb702600">00260</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#adaa01db9cf77d95756bc3156fb702600">dummy4</a>;                   <span class="comment">// 0x0E0                $60138</span>
<a name="l00261"></a><a class="code" href="structmd2StatusStruct.html#af4f8869f8954c6162cae80000c54694f">00261</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#af4f8869f8954c6162cae80000c54694f">dummy5</a>;                   <span class="comment">// 0x0E4                $60139</span>
<a name="l00262"></a><a class="code" href="structmd2StatusStruct.html#a864a2234ede061ec2380230ebf29ce70">00262</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a864a2234ede061ec2380230ebf29ce70">dummy6</a>;                   <span class="comment">// 0x0E8                $6013A</span>
<a name="l00263"></a><a class="code" href="structmd2StatusStruct.html#a91f38d814222edeffa67a6a3ab61f5d6">00263</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a91f38d814222edeffa67a6a3ab61f5d6">dummy7</a>;                   <span class="comment">// 0x0EC                $6013B</span>
<a name="l00264"></a><a class="code" href="structmd2StatusStruct.html#a17f44367cfa4c66ec3ee481863ef4960">00264</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a17f44367cfa4c66ec3ee481863ef4960">dummy8</a>;                   <span class="comment">// 0x0F0                $6013C</span>
<a name="l00265"></a><a class="code" href="structmd2StatusStruct.html#aa5aadda5a5cb98c6028f8b45e16cd084">00265</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#aa5aadda5a5cb98c6028f8b45e16cd084">dummy9</a>;                   <span class="comment">// 0x0F4                $6013D</span>
<a name="l00266"></a><a class="code" href="structmd2StatusStruct.html#a9fc7dc802d00c22463dd7ddd531e06d7">00266</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#a9fc7dc802d00c22463dd7ddd531e06d7">dummyA</a>;                   <span class="comment">// 0x0F8                $6013E</span>
<a name="l00267"></a><a class="code" href="structmd2StatusStruct.html#aab597be69a8dcc140778d9aeb8a50eee">00267</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#aab597be69a8dcc140778d9aeb8a50eee">dummyB</a>;                   <span class="comment">// 0x0FC                $6013F</span>
<a name="l00268"></a>00268 
<a name="l00269"></a><a class="code" href="structmd2StatusStruct.html#aca3722c109e6646bd41fb269a32261f2">00269</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#aca3722c109e6646bd41fb269a32261f2">fs_is_open</a>;               <span class="comment">// 0x100                $60140</span>
<a name="l00270"></a><a class="code" href="structmd2StatusStruct.html#abe3d4a61a15f54590b061e23b45e659c">00270</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#abe3d4a61a15f54590b061e23b45e659c">phiscan</a>;                  <span class="comment">// 0x104                $60141</span>
<a name="l00271"></a><a class="code" href="structmd2StatusStruct.html#ab961c2ba24a1a8c95a88dec25319e712">00271</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#ab961c2ba24a1a8c95a88dec25319e712">fs_has_opened</a>;            <span class="comment">// 0x108                $60142</span>
<a name="l00272"></a><a class="code" href="structmd2StatusStruct.html#ac95696b7ed35ccfdfb6aeeee879bdb65">00272</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#ac95696b7ed35ccfdfb6aeeee879bdb65">fs_has_opened_globally</a>;   <span class="comment">// 0x10C                $60143</span>
<a name="l00273"></a><a class="code" href="structmd2StatusStruct.html#ab3da523bad7b82c1d27780caa24a8b92">00273</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#ab3da523bad7b82c1d27780caa24a8b92">number_passes</a>;            <span class="comment">// 0x110                $60144</span>
<a name="l00274"></a>00274 
<a name="l00275"></a><a class="code" href="structmd2StatusStruct.html#aac82f8e97fa39ea9be7823dd1d308986">00275</a>   <span class="keywordtype">int</span> <a class="code" href="structmd2StatusStruct.html#aac82f8e97fa39ea9be7823dd1d308986">moving_flags</a>;             <span class="comment">// 0x11C                $60145</span>
<a name="l00276"></a>00276 } <a class="code" href="structmd2StatusStruct.html" title="The block of memory retrieved in a status request.">md2_status_t</a>;
<a name="l00277"></a>00277 
<a name="l00278"></a><a class="code" href="lspmac_8c.html#ad5bce7451d48127bace5af445d03b492">00278</a> <span class="keyword">static</span> <a class="code" href="structmd2StatusStruct.html" title="The block of memory retrieved in a status request.">md2_status_t</a> <a class="code" href="lspmac_8c.html#ad5bce7451d48127bace5af445d03b492" title="Buffer for MD2 Status.">md2_status</a>;         
<a name="l00279"></a><a class="code" href="pgpmac_8h.html#a7a3e763682bd7f987d07f149e94b3bf8">00279</a> pthread_mutex_t <a class="code" href="lspmac_8c.html#a7a3e763682bd7f987d07f149e94b3bf8" title="Synchronize reading/writting status buffer.">md2_status_mutex</a>;       
<a name="l00280"></a>00280 
<a name="l00281"></a>00281 
<a name="l00291"></a><a class="code" href="lspmac_8c.html#a55b882be15d56a2a777f2b1f92901b7d">00291</a> <span class="keywordtype">double</span> <a class="code" href="lspmac_8c.html#a55b882be15d56a2a777f2b1f92901b7d" title="Look up table support for motor positions (think x=zoom, y=light intensity) use a...">lspmac_lut</a>(
<a name="l00292"></a>00292                   <span class="keywordtype">int</span> nlut,             
<a name="l00293"></a>00293                   <span class="keywordtype">double</span> *lut,          
<a name="l00294"></a>00294                   <span class="keywordtype">double</span> x              
<a name="l00295"></a>00295                   ) {
<a name="l00296"></a>00296   <span class="keywordtype">int</span> i, foundone;
<a name="l00297"></a>00297   <span class="keywordtype">double</span> m;
<a name="l00298"></a>00298   <span class="keywordtype">double</span> y1, y2, x1, x2, y;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300   foundone = 0;
<a name="l00301"></a>00301   <span class="keywordflow">if</span>( lut != NULL &amp;&amp; nlut &gt; 1) {
<a name="l00302"></a>00302     <span class="keywordflow">for</span>( i=0; i &lt; 2*nlut; i += 2) {
<a name="l00303"></a>00303       x1 = lut[i];
<a name="l00304"></a>00304       y1 = lut[i+1];
<a name="l00305"></a>00305       <span class="keywordflow">if</span>( i &lt; 2*nlut - 2) {
<a name="l00306"></a>00306         x2 = lut[i+2];
<a name="l00307"></a>00307         y2 = lut[i+3];
<a name="l00308"></a>00308       }
<a name="l00309"></a>00309 
<a name="l00310"></a>00310       <span class="comment">//</span>
<a name="l00311"></a>00311       <span class="comment">// First one too big?  Use the y value of the first element</span>
<a name="l00312"></a>00312       <span class="comment">//</span>
<a name="l00313"></a>00313       <span class="keywordflow">if</span>( i == 0 &amp;&amp; x1 &gt; x) {
<a name="l00314"></a>00314         y = y1;
<a name="l00315"></a>00315         foundone = 1;
<a name="l00316"></a>00316         <span class="keywordflow">break</span>;
<a name="l00317"></a>00317       }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319       <span class="comment">//</span>
<a name="l00320"></a>00320       <span class="comment">// Look for equality</span>
<a name="l00321"></a>00321       <span class="comment">//</span>
<a name="l00322"></a>00322       <span class="keywordflow">if</span>( x1 == x) {
<a name="l00323"></a>00323         y = y1;
<a name="l00324"></a>00324         foundone = 1;
<a name="l00325"></a>00325         <span class="keywordflow">break</span>;
<a name="l00326"></a>00326       }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328       <span class="comment">//</span>
<a name="l00329"></a>00329       <span class="comment">// Maybe interpolate</span>
<a name="l00330"></a>00330       <span class="comment">//</span>
<a name="l00331"></a>00331       <span class="keywordflow">if</span>( (i &lt; 2*nlut-2) &amp;&amp; x &lt; x2) {
<a name="l00332"></a>00332         m = (y2 - y1) / (x2 - x1);
<a name="l00333"></a>00333         y = m*(x - x1) + y1;
<a name="l00334"></a>00334         foundone = 1;
<a name="l00335"></a>00335         <span class="keywordflow">break</span>;
<a name="l00336"></a>00336       }
<a name="l00337"></a>00337     }
<a name="l00338"></a>00338     <span class="keywordflow">if</span>( foundone == 0) {
<a name="l00339"></a>00339       <span class="comment">// must be bigger than the last entry</span>
<a name="l00340"></a>00340       <span class="comment">//</span>
<a name="l00341"></a>00341       <span class="comment">//</span>
<a name="l00342"></a>00342       y = lut[2*(nlut-1) + 1];
<a name="l00343"></a>00343     }
<a name="l00344"></a>00344     <span class="keywordflow">return</span> y;
<a name="l00345"></a>00345   }
<a name="l00346"></a>00346   <span class="keywordflow">return</span> 0.0;
<a name="l00347"></a>00347 }
<a name="l00348"></a>00348 
<a name="l00349"></a><a class="code" href="lspmac_8c.html#a5afe5cd407b44f9c05ad4f1c4e4d5f6a">00349</a> <span class="keywordtype">double</span> <a class="code" href="lspmac_8c.html#a5afe5cd407b44f9c05ad4f1c4e4d5f6a">lspmac_rlut</a>(
<a name="l00350"></a>00350                    <span class="keywordtype">int</span> nlut,            
<a name="l00351"></a>00351                    <span class="keywordtype">double</span> *lut,         
<a name="l00352"></a>00352                    <span class="keywordtype">double</span> y             
<a name="l00353"></a>00353                    ) {
<a name="l00354"></a>00354   <span class="keywordtype">int</span> i, foundone, up;
<a name="l00355"></a>00355   <span class="keywordtype">double</span> m;
<a name="l00356"></a>00356   <span class="keywordtype">double</span> y1, y2, x1, x2, x;
<a name="l00357"></a>00357 
<a name="l00358"></a>00358   foundone = 0;
<a name="l00359"></a>00359   <span class="keywordflow">if</span>( lut != NULL &amp;&amp; nlut &gt; 1) {
<a name="l00360"></a>00360 
<a name="l00361"></a>00361     <span class="keywordflow">if</span>( lut[1] &lt; lut[2*nlut-1])
<a name="l00362"></a>00362       up = 1;
<a name="l00363"></a>00363     <span class="keywordflow">else</span>
<a name="l00364"></a>00364       up = 0;
<a name="l00365"></a>00365 
<a name="l00366"></a>00366     <span class="keywordflow">for</span>( i=0; i &lt; 2*nlut; i += 2) {
<a name="l00367"></a>00367       x1 = lut[i];
<a name="l00368"></a>00368       y1 = lut[i+1];
<a name="l00369"></a>00369       <span class="keywordflow">if</span>( i &lt; 2*nlut - 2) {
<a name="l00370"></a>00370         x2 = lut[i+2];
<a name="l00371"></a>00371         y2 = lut[i+3];
<a name="l00372"></a>00372       }
<a name="l00373"></a>00373       <span class="keywordflow">if</span>( i==0 &amp;&amp; ( up ? y1 &gt; y : y1 &lt; y)) {
<a name="l00374"></a>00374         x = x1;
<a name="l00375"></a>00375         foundone = 1;
<a name="l00376"></a>00376         <span class="keywordflow">break</span>;
<a name="l00377"></a>00377       }
<a name="l00378"></a>00378       <span class="keywordflow">if</span>( y1 == y) {
<a name="l00379"></a>00379         x = x1;
<a name="l00380"></a>00380         foundone = 1;
<a name="l00381"></a>00381         <span class="keywordflow">break</span>;
<a name="l00382"></a>00382       }
<a name="l00383"></a>00383       <span class="keywordflow">if</span>( (i &lt; 2*nlut-2) &amp;&amp; (up ? y &lt; y2 : y &gt; y2)) {
<a name="l00384"></a>00384         m = (x2 - x1) / (y2 - y1);
<a name="l00385"></a>00385         x = m * (y - y1) + x1;
<a name="l00386"></a>00386         foundone = 1;
<a name="l00387"></a>00387         <span class="keywordflow">break</span>;
<a name="l00388"></a>00388       }
<a name="l00389"></a>00389     }
<a name="l00390"></a>00390     <span class="keywordflow">if</span>( foundone == 0 ) {
<a name="l00391"></a>00391       x = lut[2*(nlut-1)];
<a name="l00392"></a>00392     }
<a name="l00393"></a>00393     <span class="keywordflow">return</span> x;
<a name="l00394"></a>00394   }
<a name="l00395"></a>00395   <span class="keywordflow">return</span> 0.0;
<a name="l00396"></a>00396 }
<a name="l00397"></a>00397 
<a name="l00398"></a>00398 
<a name="l00399"></a>00399 
<a name="l00404"></a><a class="code" href="lspmac_8c.html#a1c3786f3a38724f497afc4fe6d82d8c4">00404</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#a1c3786f3a38724f497afc4fe6d82d8c4" title="Prints a hex dump of the given data.">hex_dump</a>(
<a name="l00405"></a>00405               <span class="keywordtype">int</span> n,            
<a name="l00406"></a>00406               <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *s  
<a name="l00407"></a>00407               ) {
<a name="l00408"></a>00408 
<a name="l00409"></a>00409   <span class="keywordtype">int</span> i;        <span class="comment">// row counter</span>
<a name="l00410"></a>00410   <span class="keywordtype">int</span> j;        <span class="comment">// column counter</span>
<a name="l00411"></a>00411 
<a name="l00412"></a>00412   pthread_mutex_lock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l00413"></a>00413 
<a name="l00414"></a>00414   <span class="keywordflow">for</span>( i=0; n &gt; 0; i++) {
<a name="l00415"></a>00415     <span class="keywordflow">for</span>( j=0; j&lt;16 &amp;&amp; n &gt; 0; j++) {
<a name="l00416"></a>00416       <span class="keywordflow">if</span>( j==8)
<a name="l00417"></a>00417         wprintw( <a class="code" href="pgpmac_8c.html#a65daf0f4a5bc6def23a9df98ff5ca57e" title="place to print stuff out">term_output</a>, <span class="stringliteral">&quot;  &quot;</span>);
<a name="l00418"></a>00418       wprintw( <a class="code" href="pgpmac_8c.html#a65daf0f4a5bc6def23a9df98ff5ca57e" title="place to print stuff out">term_output</a>, <span class="stringliteral">&quot; %02x&quot;</span>, *(s + 16*i + j));
<a name="l00419"></a>00419       n--;
<a name="l00420"></a>00420     }
<a name="l00421"></a>00421     wprintw( <a class="code" href="pgpmac_8c.html#a65daf0f4a5bc6def23a9df98ff5ca57e" title="place to print stuff out">term_output</a>, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00422"></a>00422   }
<a name="l00423"></a>00423   wprintw( <a class="code" href="pgpmac_8c.html#a65daf0f4a5bc6def23a9df98ff5ca57e" title="place to print stuff out">term_output</a>, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00424"></a>00424 
<a name="l00425"></a>00425   pthread_mutex_unlock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00432"></a><a class="code" href="lspmac_8c.html#a8f9f1ad624350095075aa6b51423b02d">00432</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#a8f9f1ad624350095075aa6b51423b02d" title="Replace  with   in null terminated string and print result to terminal.">cleanstr</a>(
<a name="l00433"></a>00433               <span class="keywordtype">char</span> *s   
<a name="l00434"></a>00434               ) {
<a name="l00435"></a>00435   <span class="keywordtype">int</span> i;
<a name="l00436"></a>00436 
<a name="l00437"></a>00437   pthread_mutex_lock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l00438"></a>00438 
<a name="l00439"></a>00439   <span class="keywordflow">for</span>( i=0; i&lt;strlen( s); i++) {
<a name="l00440"></a>00440     <span class="keywordflow">if</span>( s[i] == <span class="charliteral">&apos;\r&apos;</span>)
<a name="l00441"></a>00441       wprintw( <a class="code" href="pgpmac_8c.html#a65daf0f4a5bc6def23a9df98ff5ca57e" title="place to print stuff out">term_output</a>, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00442"></a>00442     <span class="keywordflow">else</span>
<a name="l00443"></a>00443       wprintw( <a class="code" href="pgpmac_8c.html#a65daf0f4a5bc6def23a9df98ff5ca57e" title="place to print stuff out">term_output</a>, <span class="stringliteral">&quot;%c&quot;</span>, s[i]);
<a name="l00444"></a>00444   }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446   pthread_mutex_unlock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l00447"></a>00447 }
<a name="l00448"></a>00448 
<a name="l00453"></a><a class="code" href="lspmac_8c.html#aae020ea2478b41702ce8b7d20b2560be">00453</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#aae020ea2478b41702ce8b7d20b2560be" title="Connect to the PMAC socket.">lsConnect</a>(
<a name="l00454"></a>00454                <span class="keywordtype">char</span> *ipaddr     
<a name="l00455"></a>00455                ) {
<a name="l00456"></a>00456   <span class="keywordtype">int</span> psock;                    <span class="comment">// our socket: value stored in pmacfda.fd</span>
<a name="l00457"></a>00457   <span class="keywordtype">int</span> err;                      <span class="comment">// error code from some system calls</span>
<a name="l00458"></a>00458   <span class="keyword">struct </span>sockaddr_in *addrP;    <span class="comment">// our address structure to connect to</span>
<a name="l00459"></a>00459   <span class="keyword">struct </span>addrinfo ai_hints;     <span class="comment">// required for getaddrinfo</span>
<a name="l00460"></a>00460   <span class="keyword">struct </span>addrinfo *ai_resultP;  <span class="comment">// linked list of address structures (we&apos;ll always pick the first)</span>
<a name="l00461"></a>00461 
<a name="l00462"></a>00462   <a class="code" href="lspmac_8c.html#adba7f5f4bbeabc4dac859221d4c684ba" title="our poll structure">pmacfd</a>.fd     = -1;
<a name="l00463"></a>00463   <a class="code" href="lspmac_8c.html#adba7f5f4bbeabc4dac859221d4c684ba" title="our poll structure">pmacfd</a>.events = 0;
<a name="l00464"></a>00464 
<a name="l00465"></a>00465   <span class="comment">// Initial buffer(s)</span>
<a name="l00466"></a>00466   memset( &amp;ai_hints,  0, <span class="keyword">sizeof</span>( ai_hints));
<a name="l00467"></a>00467 
<a name="l00468"></a>00468   ai_hints.ai_family   = AF_INET;
<a name="l00469"></a>00469   ai_hints.ai_socktype = SOCK_STREAM;
<a name="l00470"></a>00470 
<a name="l00471"></a>00471 
<a name="l00472"></a>00472   <span class="comment">//</span>
<a name="l00473"></a>00473   <span class="comment">// get address</span>
<a name="l00474"></a>00474   <span class="comment">//</span>
<a name="l00475"></a>00475   err = getaddrinfo( ipaddr, NULL, &amp;ai_hints, &amp;ai_resultP);
<a name="l00476"></a>00476   <span class="keywordflow">if</span>( err != 0) {
<a name="l00477"></a>00477 
<a name="l00478"></a>00478     <a class="code" href="lslogging_8c.html#a0e756b36671055ef02a8f04d2ba8a93b">lslogging_log_message</a>( <span class="stringliteral">&quot;Could not find address: %s&quot;</span>, gai_strerror( err));
<a name="l00479"></a>00479 
<a name="l00480"></a>00480     <span class="keywordflow">return</span>;
<a name="l00481"></a>00481   }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483 
<a name="l00484"></a>00484   addrP = (<span class="keyword">struct </span>sockaddr_in *)ai_resultP-&gt;ai_addr;
<a name="l00485"></a>00485   addrP-&gt;sin_port = htons( <a class="code" href="lspmac_8c.html#ac95886e84843b6b0bb6cc270e42043c4" title="The PMAC (only) listens on this port.">PMACPORT</a>);
<a name="l00486"></a>00486 
<a name="l00487"></a>00487 
<a name="l00488"></a>00488   psock = socket( PF_INET, SOCK_STREAM, 0);
<a name="l00489"></a>00489   <span class="keywordflow">if</span>( psock == -1) {
<a name="l00490"></a>00490     <a class="code" href="lslogging_8c.html#a0e756b36671055ef02a8f04d2ba8a93b">lslogging_log_message</a>( <span class="stringliteral">&quot;Could not create socket&quot;</span>);
<a name="l00491"></a>00491     <span class="keywordflow">return</span>;
<a name="l00492"></a>00492   }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494   err = connect( psock, (<span class="keyword">const</span> <span class="keyword">struct</span> sockaddr *)addrP, <span class="keyword">sizeof</span>( *addrP));
<a name="l00495"></a>00495   <span class="keywordflow">if</span>( err != 0) {
<a name="l00496"></a>00496     <a class="code" href="lslogging_8c.html#a0e756b36671055ef02a8f04d2ba8a93b">lslogging_log_message</a>( <span class="stringliteral">&quot;Could not connect socket: %s&quot;</span>, strerror( errno));
<a name="l00497"></a>00497     <span class="keywordflow">return</span>;
<a name="l00498"></a>00498   }
<a name="l00499"></a>00499 
<a name="l00500"></a>00500   <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#a37741af675425d61c876cc30ae6c99d0">LS_PMAC_STATE_IDLE</a>;
<a name="l00501"></a>00501   <a class="code" href="lspmac_8c.html#adba7f5f4bbeabc4dac859221d4c684ba" title="our poll structure">pmacfd</a>.fd     = psock;
<a name="l00502"></a>00502   <a class="code" href="lspmac_8c.html#adba7f5f4bbeabc4dac859221d4c684ba" title="our poll structure">pmacfd</a>.events = POLLIN;
<a name="l00503"></a>00503 
<a name="l00504"></a>00504 }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506 
<a name="l00507"></a>00507 
<a name="l00513"></a><a class="code" href="lspmac_8c.html#a84a6096d9bfff2bfb1506a216756ae28">00513</a> <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *<a class="code" href="lspmac_8c.html#a84a6096d9bfff2bfb1506a216756ae28" title="Put a new command on the queue.">lspmac_push_queue</a>(
<a name="l00514"></a>00514                                     <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *cmd       
<a name="l00515"></a>00515                                     ) {
<a name="l00516"></a>00516   <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *rtn;
<a name="l00517"></a>00517 
<a name="l00518"></a>00518   pthread_mutex_lock( &amp;<a class="code" href="lspmac_8c.html#acc1bb77b9bcbc4d970f841a41fd274b3" title="manage access to the pmac command queue">pmac_queue_mutex</a>);
<a name="l00519"></a>00519   rtn = &amp;(ethCmdQueue[(<a class="code" href="lspmac_8c.html#ad62b1f9e907acc3de9f3d6a05d55829e" title="points to next empty PMAC command queue position">ethCmdOn</a>++) % <a class="code" href="lspmac_8c.html#a3fae557baafab24b7518dc84f5ef5a9b" title="Size of the PMAC command queue.">PMAC_CMD_QUEUE_LENGTH</a>]);
<a name="l00520"></a>00520   memcpy( rtn, cmd, <span class="keyword">sizeof</span>( <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a>));
<a name="l00521"></a>00521   rtn-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a276ebc4b35c2554e4cb7377b60fd89b7" title="time this item was dequeued and sent to the pmac">time_sent</a>.tv_sec  = 0;
<a name="l00522"></a>00522   rtn-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a276ebc4b35c2554e4cb7377b60fd89b7" title="time this item was dequeued and sent to the pmac">time_sent</a>.tv_nsec = 0;
<a name="l00523"></a>00523   pthread_cond_signal( &amp;<a class="code" href="lspmac_8c.html#a8a25bd9c593c6985107f90f999ce0b08" title="wait for a command to be sent to PMAC before continuing">pmac_queue_cond</a>);
<a name="l00524"></a>00524   pthread_mutex_unlock( &amp;<a class="code" href="lspmac_8c.html#acc1bb77b9bcbc4d970f841a41fd274b3" title="manage access to the pmac command queue">pmac_queue_mutex</a>);
<a name="l00525"></a>00525 
<a name="l00526"></a>00526   <span class="keywordflow">return</span> rtn;
<a name="l00527"></a>00527 }
<a name="l00528"></a>00528 
<a name="l00537"></a><a class="code" href="lspmac_8c.html#a9627f30135aa7007bc4ab8dde905739a">00537</a> <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *<a class="code" href="lspmac_8c.html#a9627f30135aa7007bc4ab8dde905739a" title="Remove the oldest queue item.">lspmac_pop_queue</a>() {
<a name="l00538"></a>00538   <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *rtn;
<a name="l00539"></a>00539 
<a name="l00540"></a>00540   pthread_mutex_lock( &amp;<a class="code" href="lspmac_8c.html#acc1bb77b9bcbc4d970f841a41fd274b3" title="manage access to the pmac command queue">pmac_queue_mutex</a>);
<a name="l00541"></a>00541 
<a name="l00542"></a>00542   <span class="keywordflow">if</span>( <a class="code" href="lspmac_8c.html#ad62b1f9e907acc3de9f3d6a05d55829e" title="points to next empty PMAC command queue position">ethCmdOn</a> == <a class="code" href="lspmac_8c.html#ae85caec6f4ddb2fc52ca14a26549ab08" title="points to current command (or none if == ethCmdOn)">ethCmdOff</a>)
<a name="l00543"></a>00543     rtn = NULL;
<a name="l00544"></a>00544   <span class="keywordflow">else</span> {
<a name="l00545"></a>00545     rtn = &amp;(ethCmdQueue[(<a class="code" href="lspmac_8c.html#ae85caec6f4ddb2fc52ca14a26549ab08" title="points to current command (or none if == ethCmdOn)">ethCmdOff</a>++) % <a class="code" href="lspmac_8c.html#a3fae557baafab24b7518dc84f5ef5a9b" title="Size of the PMAC command queue.">PMAC_CMD_QUEUE_LENGTH</a>]);
<a name="l00546"></a>00546     clock_gettime( CLOCK_REALTIME, &amp;(rtn-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a276ebc4b35c2554e4cb7377b60fd89b7" title="time this item was dequeued and sent to the pmac">time_sent</a>));
<a name="l00547"></a>00547   }
<a name="l00548"></a>00548   pthread_mutex_unlock( &amp;<a class="code" href="lspmac_8c.html#acc1bb77b9bcbc4d970f841a41fd274b3" title="manage access to the pmac command queue">pmac_queue_mutex</a>);
<a name="l00549"></a>00549   <span class="keywordflow">return</span> rtn;
<a name="l00550"></a>00550 }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 
<a name="l00557"></a><a class="code" href="lspmac_8c.html#a0f60f18dfe11c1c0299909521596be8f">00557</a> <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *<a class="code" href="lspmac_8c.html#a0f60f18dfe11c1c0299909521596be8f" title="Remove the next command queue item that is waiting for a reply.">lspmac_pop_reply</a>() {
<a name="l00558"></a>00558   <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *rtn;
<a name="l00559"></a>00559 
<a name="l00560"></a>00560   pthread_mutex_lock( &amp;<a class="code" href="lspmac_8c.html#acc1bb77b9bcbc4d970f841a41fd274b3" title="manage access to the pmac command queue">pmac_queue_mutex</a>);
<a name="l00561"></a>00561 
<a name="l00562"></a>00562   <span class="keywordflow">if</span>( <a class="code" href="lspmac_8c.html#ad62b1f9e907acc3de9f3d6a05d55829e" title="points to next empty PMAC command queue position">ethCmdOn</a> == <a class="code" href="lspmac_8c.html#a7a78524ada402bb74759a3dfc5f8a571" title="Used like ethCmdOff only to deal with the pmac reply to a command.">ethCmdReply</a>)
<a name="l00563"></a>00563     rtn = NULL;
<a name="l00564"></a>00564   <span class="keywordflow">else</span>
<a name="l00565"></a>00565     rtn = &amp;(ethCmdQueue[(<a class="code" href="lspmac_8c.html#a7a78524ada402bb74759a3dfc5f8a571" title="Used like ethCmdOff only to deal with the pmac reply to a command.">ethCmdReply</a>++) % <a class="code" href="lspmac_8c.html#a3fae557baafab24b7518dc84f5ef5a9b" title="Size of the PMAC command queue.">PMAC_CMD_QUEUE_LENGTH</a>]);
<a name="l00566"></a>00566 
<a name="l00567"></a>00567   pthread_mutex_unlock( &amp;<a class="code" href="lspmac_8c.html#acc1bb77b9bcbc4d970f841a41fd274b3" title="manage access to the pmac command queue">pmac_queue_mutex</a>);
<a name="l00568"></a>00568   <span class="keywordflow">return</span> rtn;
<a name="l00569"></a>00569 }
<a name="l00570"></a>00570 
<a name="l00575"></a><a class="code" href="lspmac_8c.html#a1e472a11df3765763c2fe92dd358bf0c">00575</a> <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *<a class="code" href="lspmac_8c.html#a1e472a11df3765763c2fe92dd358bf0c" title="Compose a packet and send it to the PMAC.">lspmac_send_command</a>(
<a name="l00576"></a>00576                                       <span class="keywordtype">int</span> rqType,               
<a name="l00577"></a>00577                                       <span class="keywordtype">int</span> rq,                   
<a name="l00578"></a>00578                                       <span class="keywordtype">int</span> wValue,               
<a name="l00579"></a>00579                                       <span class="keywordtype">int</span> wIndex,               
<a name="l00580"></a>00580                                       <span class="keywordtype">int</span> wLength,              
<a name="l00581"></a>00581                                       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data,      
<a name="l00582"></a>00582                                       <span class="keywordtype">void</span> (*responseCB)(<a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *, <span class="keywordtype">int</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *),
<a name="l00584"></a>00584                                       <span class="keywordtype">int</span> no_reply              
<a name="l00585"></a>00585                                       ) {
<a name="l00586"></a>00586   <span class="keyword">static</span> <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> cmd;
<a name="l00587"></a>00587 
<a name="l00588"></a>00588   cmd.<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#a6a155eb3ae546dd29369c4a33ddb3310" title="VR_UPLOAD or VR_DOWNLOAD.">RequestType</a> = rqType;
<a name="l00589"></a>00589   cmd.<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#a0dc566e7edbb226f1a4ea443d93d56e2" title="The command to run (VR_PMAC_GETMEM, etc).">Request</a>     = rq;
<a name="l00590"></a>00590   cmd.<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#aec0ee9a5f6c7e3bc6e4bd98f1bd52783" title="Command parameter 1.">wValue</a>      = htons(wValue);
<a name="l00591"></a>00591   cmd.<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#a92f5a374e87d4f496b64b4888850d6e6" title="Command parameter 2.">wIndex</a>      = htons(wIndex);
<a name="l00592"></a>00592   cmd.<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#af5df25ff13ca30fa33719d0df1ab7e97" title="Number of bytes in bData.">wLength</a>     = htons(wLength);
<a name="l00593"></a>00593   cmd.<a class="code" href="structlspmac__cmd__queue__struct.html#afe92c0bab9f124314a6f3d8104c94364" title="function to call when response is received. args are (int fd, nreturned, buffer)">onResponse</a>       = responseCB;
<a name="l00594"></a>00594   cmd.<a class="code" href="structlspmac__cmd__queue__struct.html#a33f70b45f8b7c27935cd3efe28748479" title="1 = no reply is expected, 0 = expect a reply">no_reply</a>         = no_reply;
<a name="l00595"></a>00595 
<a name="l00596"></a>00596   <span class="comment">//</span>
<a name="l00597"></a>00597   <span class="comment">// Setting the message buff bData requires a bit more care to avoid over filling it</span>
<a name="l00598"></a>00598   <span class="comment">// or sending garbage in the unused bytes.</span>
<a name="l00599"></a>00599   <span class="comment">//</span>
<a name="l00600"></a>00600 
<a name="l00601"></a>00601   <span class="keywordflow">if</span>( wLength &gt; <span class="keyword">sizeof</span>( cmd.<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#a872dab798127d6f589974a79c5d0aef1" title="The data buffer, if required.">bData</a>)) {
<a name="l00602"></a>00602     <span class="comment">//</span>
<a name="l00603"></a>00603     <span class="comment">// Bad things happen if we do not catch this case.</span>
<a name="l00604"></a>00604     <span class="comment">//</span>
<a name="l00605"></a>00605     <a class="code" href="lslogging_8c.html#a0e756b36671055ef02a8f04d2ba8a93b">lslogging_log_message</a>( <span class="stringliteral">&quot;Message Length %d longer than maximum of %ld, aborting&quot;</span>, wLength, <span class="keyword">sizeof</span>( cmd.<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#a872dab798127d6f589974a79c5d0aef1" title="The data buffer, if required.">bData</a>));
<a name="l00606"></a>00606     exit( -1);
<a name="l00607"></a>00607   }
<a name="l00608"></a>00608   <span class="keywordflow">if</span>( data == NULL) {
<a name="l00609"></a>00609     memset( cmd.<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#a872dab798127d6f589974a79c5d0aef1" title="The data buffer, if required.">bData</a>, 0, <span class="keyword">sizeof</span>( cmd.<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#a872dab798127d6f589974a79c5d0aef1" title="The data buffer, if required.">bData</a>));
<a name="l00610"></a>00610   } <span class="keywordflow">else</span> {
<a name="l00611"></a>00611     <span class="comment">//</span>
<a name="l00612"></a>00612     <span class="comment">// This could leave bData non-null terminated.  I do not know if this is a problem.</span>
<a name="l00613"></a>00613     <span class="comment">//</span>
<a name="l00614"></a>00614     <span class="keywordflow">if</span>( wLength &gt; 0)
<a name="l00615"></a>00615       memcpy( cmd.<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#a872dab798127d6f589974a79c5d0aef1" title="The data buffer, if required.">bData</a>, data, wLength);
<a name="l00616"></a>00616     <span class="keywordflow">if</span>( wLength &lt; <span class="keyword">sizeof</span>( cmd.<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#a872dab798127d6f589974a79c5d0aef1" title="The data buffer, if required.">bData</a>))
<a name="l00617"></a>00617       memset( cmd.<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#a872dab798127d6f589974a79c5d0aef1" title="The data buffer, if required.">bData</a> + wLength, 0, <span class="keyword">sizeof</span>( cmd.<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#a872dab798127d6f589974a79c5d0aef1" title="The data buffer, if required.">bData</a>) - wLength);
<a name="l00618"></a>00618   }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620   <span class="keywordflow">return</span> <a class="code" href="lspmac_8c.html#a84a6096d9bfff2bfb1506a216756ae28" title="Put a new command on the queue.">lspmac_push_queue</a>( &amp;cmd);
<a name="l00621"></a>00621 }
<a name="l00622"></a>00622 
<a name="l00623"></a>00623 
<a name="l00627"></a><a class="code" href="lspmac_8c.html#ac5745f25f242edf02f7b9b7c77ed6126">00627</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#ac5745f25f242edf02f7b9b7c77ed6126" title="Reset the PMAC socket from the PMAC side.">lspmac_SockFlush</a>() {
<a name="l00628"></a>00628   <a class="code" href="lspmac_8c.html#a1e472a11df3765763c2fe92dd358bf0c" title="Compose a packet and send it to the PMAC.">lspmac_send_command</a>( <a class="code" href="lspmac_8c.html#af24ecdc10723dc8fd6320fef416ae514">VR_DOWNLOAD</a>, <a class="code" href="lspmac_8c.html#ac0e5588681366b52589cd321eabf12ff">VR_PMAC_FLUSH</a>, 0, 0, 0, NULL, NULL, 1);
<a name="l00629"></a>00629 }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631 
<a name="l00634"></a><a class="code" href="lspmac_8c.html#aaedae34bc18ac1742a232117c125d7b9">00634</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#aaedae34bc18ac1742a232117c125d7b9" title="Clear the queue and put the PMAC into a known state.">lspmac_Reset</a>() {
<a name="l00635"></a>00635   <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#a37741af675425d61c876cc30ae6c99d0">LS_PMAC_STATE_IDLE</a>;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637   <span class="comment">// clear queue</span>
<a name="l00638"></a>00638   <a class="code" href="lspmac_8c.html#a7a78524ada402bb74759a3dfc5f8a571" title="Used like ethCmdOff only to deal with the pmac reply to a command.">ethCmdReply</a> = <a class="code" href="lspmac_8c.html#ad62b1f9e907acc3de9f3d6a05d55829e" title="points to next empty PMAC command queue position">ethCmdOn</a>;
<a name="l00639"></a>00639   <a class="code" href="lspmac_8c.html#ae85caec6f4ddb2fc52ca14a26549ab08" title="points to current command (or none if == ethCmdOn)">ethCmdOff</a>   = <a class="code" href="lspmac_8c.html#ad62b1f9e907acc3de9f3d6a05d55829e" title="points to next empty PMAC command queue position">ethCmdOn</a>;
<a name="l00640"></a>00640 
<a name="l00641"></a>00641   <a class="code" href="lspmac_8c.html#ac5745f25f242edf02f7b9b7c77ed6126" title="Reset the PMAC socket from the PMAC side.">lspmac_SockFlush</a>();
<a name="l00642"></a>00642 }
<a name="l00643"></a>00643 
<a name="l00644"></a>00644 
<a name="l00645"></a>00645 
<a name="l00650"></a><a class="code" href="lspmac_8c.html#a2442c529b024e9c23c4acef8c1eb8689">00650</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#a2442c529b024e9c23c4acef8c1eb8689" title="The service routing detected an error condition.">lspmac_Error</a>(
<a name="l00651"></a>00651                   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buff   
<a name="l00652"></a>00652                   ) {
<a name="l00653"></a>00653   <span class="keywordtype">int</span> err;
<a name="l00654"></a>00654   <span class="comment">//</span>
<a name="l00655"></a>00655   <span class="comment">// assume buff points to a 1400 byte array of stuff read from the pmac</span>
<a name="l00656"></a>00656   <span class="comment">//</span>
<a name="l00657"></a>00657 
<a name="l00658"></a>00658   <span class="keywordflow">if</span>( buff[0] == 7 &amp;&amp; buff[1] == <span class="charliteral">&apos;E&apos;</span> &amp;&amp; buff[2] == <span class="charliteral">&apos;R&apos;</span> &amp;&amp; buff[3] == <span class="charliteral">&apos;R&apos;</span>) {
<a name="l00659"></a>00659     buff[7] = 0;  <span class="comment">// For null termination</span>
<a name="l00660"></a>00660     err = atoi( &amp;(buff[4]));
<a name="l00661"></a>00661     <span class="keywordflow">if</span>( err &gt; 0 &amp;&amp; err &lt; 20) {
<a name="l00662"></a>00662       <a class="code" href="lslogging_8c.html#a0e756b36671055ef02a8f04d2ba8a93b">lslogging_log_message</a>( <a class="code" href="lspmac_8c.html#aab5a76f1ac64049314f9836e5c01fb7e" title="Decode the errors perhaps returned by the PMAC.">pmac_error_strs</a>[err]);
<a name="l00663"></a>00663 
<a name="l00664"></a>00664       pthread_mutex_lock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l00665"></a>00665       wprintw( <a class="code" href="pgpmac_8c.html#a65daf0f4a5bc6def23a9df98ff5ca57e" title="place to print stuff out">term_output</a>, <span class="stringliteral">&quot;\n%s\n&quot;</span>, <a class="code" href="lspmac_8c.html#aab5a76f1ac64049314f9836e5c01fb7e" title="Decode the errors perhaps returned by the PMAC.">pmac_error_strs</a>[err]);
<a name="l00666"></a>00666       wnoutrefresh( <a class="code" href="pgpmac_8c.html#a65daf0f4a5bc6def23a9df98ff5ca57e" title="place to print stuff out">term_output</a>);
<a name="l00667"></a>00667       wnoutrefresh( <a class="code" href="pgpmac_8c.html#ab0487111dbe3c05d0bd835eb2fb9a3f7" title="place to put the cursor">term_input</a>);
<a name="l00668"></a>00668       doupdate();
<a name="l00669"></a>00669       pthread_mutex_unlock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l00670"></a>00670     }
<a name="l00671"></a>00671   }
<a name="l00672"></a>00672   <a class="code" href="lspmac_8c.html#aaedae34bc18ac1742a232117c125d7b9" title="Clear the queue and put the PMAC into a known state.">lspmac_Reset</a>();
<a name="l00673"></a>00673 }
<a name="l00674"></a>00674 
<a name="l00675"></a>00675 
<a name="l00681"></a><a class="code" href="lspmac_8c.html#af3fa79868ba88f7c37f7b8f7d53149ff">00681</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#af3fa79868ba88f7c37f7b8f7d53149ff" title="Service routine for packet coming from the PMAC.">lspmac_Service</a>(
<a name="l00682"></a>00682                     <span class="keyword">struct</span> pollfd *evt          
<a name="l00683"></a>00683                     ) {
<a name="l00684"></a>00684   <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *receiveBuffer = NULL;   <span class="comment">// the buffer inwhich to stick our incomming characters</span>
<a name="l00685"></a>00685   <span class="keyword">static</span> <span class="keywordtype">int</span> receiveBufferSize = 0;             <span class="comment">// size of receiveBuffer</span>
<a name="l00686"></a>00686   <span class="keyword">static</span> <span class="keywordtype">int</span> receiveBufferIn = 0;               <span class="comment">// next location to write to in receiveBuffer</span>
<a name="l00687"></a>00687   <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *cmd;                        <span class="comment">// maybe the command we are servicing</span>
<a name="l00688"></a>00688   ssize_t nsent, nread;                         <span class="comment">// nbytes dealt with</span>
<a name="l00689"></a>00689   <span class="keywordtype">int</span> i;                                        <span class="comment">// loop counter</span>
<a name="l00690"></a>00690   <span class="keywordtype">int</span> foundEOCR;                                <span class="comment">// end of command response flag</span>
<a name="l00691"></a>00691 
<a name="l00692"></a>00692   <span class="keywordflow">if</span>( evt-&gt;revents &amp; (POLLERR | POLLHUP | POLLNVAL)) {
<a name="l00693"></a>00693     <span class="keywordflow">if</span>( evt-&gt;fd != -1) {
<a name="l00694"></a>00694       close( evt-&gt;fd);
<a name="l00695"></a>00695       evt-&gt;fd = -1;
<a name="l00696"></a>00696     }
<a name="l00697"></a>00697     <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#a7eb86ecf0789ab9555de1e03a4c73567">LS_PMAC_STATE_DETACHED</a>;
<a name="l00698"></a>00698     <span class="keywordflow">return</span>;
<a name="l00699"></a>00699   }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701 
<a name="l00702"></a>00702   <span class="keywordflow">if</span>( evt-&gt;revents &amp; POLLOUT) {
<a name="l00703"></a>00703 
<a name="l00704"></a>00704     <span class="keywordflow">switch</span>( <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a>) {
<a name="l00705"></a>00705     <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a7eb86ecf0789ab9555de1e03a4c73567">LS_PMAC_STATE_DETACHED</a>:
<a name="l00706"></a>00706       <span class="keywordflow">break</span>;
<a name="l00707"></a>00707     <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a37741af675425d61c876cc30ae6c99d0">LS_PMAC_STATE_IDLE</a>:
<a name="l00708"></a>00708       <span class="keywordflow">break</span>;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a7d8f34fc599cc08c1a9d2cd62ccbb20a">LS_PMAC_STATE_SC</a>:
<a name="l00711"></a>00711       cmd = <a class="code" href="lspmac_8c.html#a9627f30135aa7007bc4ab8dde905739a" title="Remove the oldest queue item.">lspmac_pop_queue</a>();
<a name="l00712"></a>00712       <span class="keywordflow">if</span>( cmd != NULL) {
<a name="l00713"></a>00713         <span class="keywordflow">if</span>( cmd-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#a0dc566e7edbb226f1a4ea443d93d56e2" title="The command to run (VR_PMAC_GETMEM, etc).">Request</a> == <a class="code" href="lspmac_8c.html#af9c53e7c5b2681a5ca1c5410a914a2dc">VR_PMAC_GETMEM</a>) {
<a name="l00714"></a>00714           nsent = send( evt-&gt;fd, cmd, <a class="code" href="lspmac_8c.html#abdc45e3f7106f84f688419e2da9b3627" title="PMAC command size in bytes.">pmac_cmd_size</a>, 0);
<a name="l00715"></a>00715           <span class="keywordflow">if</span>( nsent != <a class="code" href="lspmac_8c.html#abdc45e3f7106f84f688419e2da9b3627" title="PMAC command size in bytes.">pmac_cmd_size</a>) {
<a name="l00716"></a>00716             <a class="code" href="lslogging_8c.html#a0e756b36671055ef02a8f04d2ba8a93b">lslogging_log_message</a>( <span class="stringliteral">&quot;Could only send %d of %d bytes....Not good.&quot;</span>, (<span class="keywordtype">int</span>)nsent, (<span class="keywordtype">int</span>)(<a class="code" href="lspmac_8c.html#abdc45e3f7106f84f688419e2da9b3627" title="PMAC command size in bytes.">pmac_cmd_size</a>));
<a name="l00717"></a>00717           }
<a name="l00718"></a>00718         } <span class="keywordflow">else</span> {
<a name="l00719"></a>00719           nsent = send( evt-&gt;fd, cmd, <a class="code" href="lspmac_8c.html#abdc45e3f7106f84f688419e2da9b3627" title="PMAC command size in bytes.">pmac_cmd_size</a> + ntohs(cmd-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#af5df25ff13ca30fa33719d0df1ab7e97" title="Number of bytes in bData.">wLength</a>), 0);
<a name="l00720"></a>00720           gettimeofday( &amp;pmac_time_sent, NULL);
<a name="l00721"></a>00721           <span class="keywordflow">if</span>( nsent != <a class="code" href="lspmac_8c.html#abdc45e3f7106f84f688419e2da9b3627" title="PMAC command size in bytes.">pmac_cmd_size</a> + ntohs(cmd-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#af5df25ff13ca30fa33719d0df1ab7e97" title="Number of bytes in bData.">wLength</a>)) {
<a name="l00722"></a>00722             <a class="code" href="lslogging_8c.html#a0e756b36671055ef02a8f04d2ba8a93b">lslogging_log_message</a>( <span class="stringliteral">&quot;Could only send %d of %d bytes....Not good.&quot;</span>, (<span class="keywordtype">int</span>)nsent, (<span class="keywordtype">int</span>)(<a class="code" href="lspmac_8c.html#abdc45e3f7106f84f688419e2da9b3627" title="PMAC command size in bytes.">pmac_cmd_size</a> + ntohs(cmd-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#af5df25ff13ca30fa33719d0df1ab7e97" title="Number of bytes in bData.">wLength</a>)));
<a name="l00723"></a>00723           }
<a name="l00724"></a>00724         }
<a name="l00725"></a>00725       }
<a name="l00726"></a>00726       <span class="keywordflow">if</span>( cmd-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#a0dc566e7edbb226f1a4ea443d93d56e2" title="The command to run (VR_PMAC_GETMEM, etc).">Request</a> == <a class="code" href="lspmac_8c.html#a76c1c401354826ac2ba8906578be930f">VR_PMAC_SENDCTRLCHAR</a>)
<a name="l00727"></a>00727         <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#adef540911028fda73e8bbf0aa6ad39e9">LS_PMAC_STATE_WACK_CC</a>;
<a name="l00728"></a>00728       <span class="keywordflow">else</span> <span class="keywordflow">if</span>( cmd-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#a0dc566e7edbb226f1a4ea443d93d56e2" title="The command to run (VR_PMAC_GETMEM, etc).">Request</a> == <a class="code" href="lspmac_8c.html#af9c53e7c5b2681a5ca1c5410a914a2dc">VR_PMAC_GETMEM</a>)
<a name="l00729"></a>00729         <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#a220b39710719cfe8b500d51819e8efeb">LS_PMAC_STATE_GMR</a>;
<a name="l00730"></a>00730       <span class="keywordflow">else</span> <span class="keywordflow">if</span>( cmd-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a33f70b45f8b7c27935cd3efe28748479" title="1 = no reply is expected, 0 = expect a reply">no_reply</a> == 0)
<a name="l00731"></a>00731         <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#a5eba9ef09d4316e803b9d75bd3104f43">LS_PMAC_STATE_WACK</a>;
<a name="l00732"></a>00732       <span class="keywordflow">else</span>
<a name="l00733"></a>00733         <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#a63356b0c18fcb186f456c12c6e927d84">LS_PMAC_STATE_WACK_NFR</a>;
<a name="l00734"></a>00734       <span class="keywordflow">break</span>;
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#abbd709b56a71eb1fc6adc9063605d243">LS_PMAC_STATE_CR</a>:
<a name="l00737"></a>00737       nsent = send( evt-&gt;fd, &amp;cr_cmd, <a class="code" href="lspmac_8c.html#abdc45e3f7106f84f688419e2da9b3627" title="PMAC command size in bytes.">pmac_cmd_size</a>, 0);
<a name="l00738"></a>00738       gettimeofday( &amp;pmac_time_sent, NULL);
<a name="l00739"></a>00739       <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#a27ee6c39d58604c8aa9bd6c249c4833f">LS_PMAC_STATE_WCR</a>;
<a name="l00740"></a>00740       <span class="keywordflow">break</span>;
<a name="l00741"></a>00741 
<a name="l00742"></a>00742     <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#add5325f4a84e4fe05f558880349485ea">LS_PMAC_STATE_RR</a>:
<a name="l00743"></a>00743       nsent = send( evt-&gt;fd, &amp;rr_cmd, <a class="code" href="lspmac_8c.html#abdc45e3f7106f84f688419e2da9b3627" title="PMAC command size in bytes.">pmac_cmd_size</a>, 0);
<a name="l00744"></a>00744       gettimeofday( &amp;pmac_time_sent, NULL);
<a name="l00745"></a>00745       <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#a3e0a62cd9a1212419ad3615c34bdc65a">LS_PMAC_STATE_WACK_RR</a>;
<a name="l00746"></a>00746       <span class="keywordflow">break</span>;
<a name="l00747"></a>00747 
<a name="l00748"></a>00748     <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a5f4ff8874677aac48a4c675f2c1ca4e9">LS_PMAC_STATE_GB</a>:
<a name="l00749"></a>00749       nsent = send( evt-&gt;fd, &amp;gb_cmd, <a class="code" href="lspmac_8c.html#abdc45e3f7106f84f688419e2da9b3627" title="PMAC command size in bytes.">pmac_cmd_size</a>, 0);
<a name="l00750"></a>00750       gettimeofday( &amp;pmac_time_sent, NULL);
<a name="l00751"></a>00751       <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#a591822cc92f76a39b293c2e90b322db2">LS_PMAC_STATE_WGB</a>;
<a name="l00752"></a>00752       <span class="keywordflow">break</span>;
<a name="l00753"></a>00753     }
<a name="l00754"></a>00754   }
<a name="l00755"></a>00755 
<a name="l00756"></a>00756   <span class="keywordflow">if</span>( evt-&gt;revents &amp; POLLIN) {
<a name="l00757"></a>00757 
<a name="l00758"></a>00758     <span class="keywordflow">if</span>( receiveBufferSize - receiveBufferIn &lt; 1400) {
<a name="l00759"></a>00759       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *newbuff;
<a name="l00760"></a>00760 
<a name="l00761"></a>00761       receiveBufferSize += 1400;
<a name="l00762"></a>00762       newbuff = calloc( receiveBufferSize, <span class="keyword">sizeof</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>));
<a name="l00763"></a>00763       <span class="keywordflow">if</span>( newbuff == NULL) {
<a name="l00764"></a>00764         <a class="code" href="lslogging_8c.html#a0e756b36671055ef02a8f04d2ba8a93b">lslogging_log_message</a>( <span class="stringliteral">&quot;Out of memory&quot;</span>);
<a name="l00765"></a>00765         exit( -1);
<a name="l00766"></a>00766       }
<a name="l00767"></a>00767       memcpy( newbuff, receiveBuffer, receiveBufferIn);
<a name="l00768"></a>00768       receiveBuffer = newbuff;
<a name="l00769"></a>00769     }
<a name="l00770"></a>00770 
<a name="l00771"></a>00771     nread = read( evt-&gt;fd, receiveBuffer + receiveBufferIn, 1400);
<a name="l00772"></a>00772 
<a name="l00773"></a>00773     foundEOCR = 0;
<a name="l00774"></a>00774     <span class="keywordflow">if</span>( <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> == <a class="code" href="lspmac_8c.html#a220b39710719cfe8b500d51819e8efeb">LS_PMAC_STATE_GMR</a>) {
<a name="l00775"></a>00775       <span class="comment">//</span>
<a name="l00776"></a>00776       <span class="comment">// get memory returns binary stuff, don&apos;t try to parse it</span>
<a name="l00777"></a>00777       <span class="comment">//</span>
<a name="l00778"></a>00778       receiveBufferIn += nread;
<a name="l00779"></a>00779     } <span class="keywordflow">else</span> {
<a name="l00780"></a>00780       <span class="comment">//</span>
<a name="l00781"></a>00781       <span class="comment">// other commands end in 6 if OK, 7 if not</span>
<a name="l00782"></a>00782       <span class="comment">//</span>
<a name="l00783"></a>00783       <span class="keywordflow">for</span>( i=receiveBufferIn; i&lt;receiveBufferIn+nread; i++) {
<a name="l00784"></a>00784         <span class="keywordflow">if</span>( receiveBuffer[i] == 7) {
<a name="l00785"></a>00785           <span class="comment">//</span>
<a name="l00786"></a>00786           <span class="comment">// Error condition</span>
<a name="l00787"></a>00787           <span class="comment">//</span>
<a name="l00788"></a>00788           <a class="code" href="lspmac_8c.html#a2442c529b024e9c23c4acef8c1eb8689" title="The service routing detected an error condition.">lspmac_Error</a>( &amp;(receiveBuffer[i]));
<a name="l00789"></a>00789           receiveBufferIn = 0;
<a name="l00790"></a>00790           <span class="keywordflow">return</span>;
<a name="l00791"></a>00791         }
<a name="l00792"></a>00792         <span class="keywordflow">if</span>( receiveBuffer[i] == 6) {
<a name="l00793"></a>00793           <span class="comment">//</span>
<a name="l00794"></a>00794           <span class="comment">// End of command response</span>
<a name="l00795"></a>00795           <span class="comment">//</span>
<a name="l00796"></a>00796           foundEOCR = 1;
<a name="l00797"></a>00797           receiveBuffer[i] = 0;
<a name="l00798"></a>00798           <span class="keywordflow">break</span>;
<a name="l00799"></a>00799         }
<a name="l00800"></a>00800       }
<a name="l00801"></a>00801       receiveBufferIn = i;
<a name="l00802"></a>00802     }
<a name="l00803"></a>00803 
<a name="l00804"></a>00804     cmd = NULL;
<a name="l00805"></a>00805 
<a name="l00806"></a>00806     <span class="keywordflow">switch</span>( <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a>) {
<a name="l00807"></a>00807     <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a63356b0c18fcb186f456c12c6e927d84">LS_PMAC_STATE_WACK_NFR</a>:
<a name="l00808"></a>00808       receiveBuffer[--receiveBufferIn] = 0;
<a name="l00809"></a>00809       cmd = <a class="code" href="lspmac_8c.html#a0f60f18dfe11c1c0299909521596be8f" title="Remove the next command queue item that is waiting for a reply.">lspmac_pop_reply</a>();
<a name="l00810"></a>00810       <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#a37741af675425d61c876cc30ae6c99d0">LS_PMAC_STATE_IDLE</a>;
<a name="l00811"></a>00811       <span class="keywordflow">break</span>;
<a name="l00812"></a>00812     <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a5eba9ef09d4316e803b9d75bd3104f43">LS_PMAC_STATE_WACK</a>:
<a name="l00813"></a>00813       receiveBuffer[--receiveBufferIn] = 0;
<a name="l00814"></a>00814       <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#add5325f4a84e4fe05f558880349485ea">LS_PMAC_STATE_RR</a>;
<a name="l00815"></a>00815       <span class="keywordflow">break</span>;
<a name="l00816"></a>00816     <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#adef540911028fda73e8bbf0aa6ad39e9">LS_PMAC_STATE_WACK_CC</a>:
<a name="l00817"></a>00817       receiveBuffer[--receiveBufferIn] = 0;
<a name="l00818"></a>00818       <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#abbd709b56a71eb1fc6adc9063605d243">LS_PMAC_STATE_CR</a>;
<a name="l00819"></a>00819       <span class="keywordflow">break</span>;
<a name="l00820"></a>00820     <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a3e0a62cd9a1212419ad3615c34bdc65a">LS_PMAC_STATE_WACK_RR</a>:
<a name="l00821"></a>00821       receiveBufferIn -= 2;
<a name="l00822"></a>00822       <span class="keywordflow">if</span>( receiveBuffer[receiveBufferIn])
<a name="l00823"></a>00823         <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#a5f4ff8874677aac48a4c675f2c1ca4e9">LS_PMAC_STATE_GB</a>;
<a name="l00824"></a>00824       <span class="keywordflow">else</span>
<a name="l00825"></a>00825         <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#add5325f4a84e4fe05f558880349485ea">LS_PMAC_STATE_RR</a>;
<a name="l00826"></a>00826       receiveBuffer[receiveBufferIn] = 0;
<a name="l00827"></a>00827       <span class="keywordflow">break</span>;
<a name="l00828"></a>00828     <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a220b39710719cfe8b500d51819e8efeb">LS_PMAC_STATE_GMR</a>:
<a name="l00829"></a>00829       cmd = <a class="code" href="lspmac_8c.html#a0f60f18dfe11c1c0299909521596be8f" title="Remove the next command queue item that is waiting for a reply.">lspmac_pop_reply</a>();
<a name="l00830"></a>00830       <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#a37741af675425d61c876cc30ae6c99d0">LS_PMAC_STATE_IDLE</a>;
<a name="l00831"></a>00831       <span class="keywordflow">break</span>;
<a name="l00832"></a>00832 
<a name="l00833"></a>00833     <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a27ee6c39d58604c8aa9bd6c249c4833f">LS_PMAC_STATE_WCR</a>:
<a name="l00834"></a>00834       cmd = <a class="code" href="lspmac_8c.html#a0f60f18dfe11c1c0299909521596be8f" title="Remove the next command queue item that is waiting for a reply.">lspmac_pop_reply</a>();
<a name="l00835"></a>00835       <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#a37741af675425d61c876cc30ae6c99d0">LS_PMAC_STATE_IDLE</a>;
<a name="l00836"></a>00836       <span class="keywordflow">break</span>;
<a name="l00837"></a>00837     <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a591822cc92f76a39b293c2e90b322db2">LS_PMAC_STATE_WGB</a>:
<a name="l00838"></a>00838       <span class="keywordflow">if</span>( foundEOCR) {
<a name="l00839"></a>00839         cmd = <a class="code" href="lspmac_8c.html#a0f60f18dfe11c1c0299909521596be8f" title="Remove the next command queue item that is waiting for a reply.">lspmac_pop_reply</a>();
<a name="l00840"></a>00840         <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#a37741af675425d61c876cc30ae6c99d0">LS_PMAC_STATE_IDLE</a>;
<a name="l00841"></a>00841       } <span class="keywordflow">else</span> {
<a name="l00842"></a>00842         <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#add5325f4a84e4fe05f558880349485ea">LS_PMAC_STATE_RR</a>;
<a name="l00843"></a>00843       }
<a name="l00844"></a>00844       <span class="keywordflow">break</span>;
<a name="l00845"></a>00845     }
<a name="l00846"></a>00846 
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     <span class="keywordflow">if</span>( cmd != NULL &amp;&amp; cmd-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#afe92c0bab9f124314a6f3d8104c94364" title="function to call when response is received. args are (int fd, nreturned, buffer)">onResponse</a> != NULL) {
<a name="l00849"></a>00849       cmd-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#afe92c0bab9f124314a6f3d8104c94364" title="function to call when response is received. args are (int fd, nreturned, buffer)">onResponse</a>( cmd, receiveBufferIn, receiveBuffer);
<a name="l00850"></a>00850       receiveBufferIn = 0;
<a name="l00851"></a>00851     }
<a name="l00852"></a>00852   }
<a name="l00853"></a>00853 }
<a name="l00854"></a>00854 
<a name="l00855"></a>00855 
<a name="l00856"></a>00856 
<a name="l00859"></a><a class="code" href="lspmac_8c.html#ac89b615b3ecb738c902c3c090d7c1dc3">00859</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#ac89b615b3ecb738c902c3c090d7c1dc3" title="Receive a reply that does not require multiple buffers.">lspmac_GetShortReplyCB</a>(
<a name="l00860"></a>00860                             <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *cmd,      
<a name="l00861"></a>00861                             <span class="keywordtype">int</span> nreceived,              
<a name="l00862"></a>00862                             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buff         
<a name="l00863"></a>00863                             ) {
<a name="l00864"></a>00864 
<a name="l00865"></a>00865   <span class="keywordtype">char</span> *sp;     <span class="comment">// pointer to the command this is a reply to</span>
<a name="l00866"></a>00866 
<a name="l00867"></a>00867   <span class="keywordflow">if</span>( nreceived &lt; 1400)
<a name="l00868"></a>00868     buff[nreceived]=0;
<a name="l00869"></a>00869 
<a name="l00870"></a>00870   sp = (<span class="keywordtype">char</span> *)(cmd-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#a872dab798127d6f589974a79c5d0aef1" title="The data buffer, if required.">bData</a>);
<a name="l00871"></a>00871 
<a name="l00872"></a>00872   <span class="keywordflow">if</span>( *buff == 0) {
<a name="l00873"></a>00873     pthread_mutex_lock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l00874"></a>00874     wprintw( <a class="code" href="pgpmac_8c.html#a65daf0f4a5bc6def23a9df98ff5ca57e" title="place to print stuff out">term_output</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, sp);
<a name="l00875"></a>00875     pthread_mutex_unlock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l00876"></a>00876   } <span class="keywordflow">else</span> {
<a name="l00877"></a>00877     pthread_mutex_lock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l00878"></a>00878     wprintw( <a class="code" href="pgpmac_8c.html#a65daf0f4a5bc6def23a9df98ff5ca57e" title="place to print stuff out">term_output</a>, <span class="stringliteral">&quot;%s: &quot;</span>, sp);
<a name="l00879"></a>00879     pthread_mutex_unlock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l00880"></a>00880     <a class="code" href="lspmac_8c.html#a8f9f1ad624350095075aa6b51423b02d" title="Replace  with   in null terminated string and print result to terminal.">cleanstr</a>( buff);
<a name="l00881"></a>00881   }
<a name="l00882"></a>00882   wnoutrefresh( <a class="code" href="pgpmac_8c.html#a65daf0f4a5bc6def23a9df98ff5ca57e" title="place to print stuff out">term_output</a>);
<a name="l00883"></a>00883   wnoutrefresh( <a class="code" href="pgpmac_8c.html#ab0487111dbe3c05d0bd835eb2fb9a3f7" title="place to put the cursor">term_input</a>);
<a name="l00884"></a>00884   doupdate();
<a name="l00885"></a>00885 
<a name="l00886"></a>00886   memset( cmd-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#a872dab798127d6f589974a79c5d0aef1" title="The data buffer, if required.">bData</a>, 0, <span class="keyword">sizeof</span>( cmd-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#a872dab798127d6f589974a79c5d0aef1" title="The data buffer, if required.">bData</a>));
<a name="l00887"></a>00887 }
<a name="l00888"></a>00888 
<a name="l00893"></a><a class="code" href="lspmac_8c.html#ac23af52b8d3a8f2722d4804d5340fa6c">00893</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#ac23af52b8d3a8f2722d4804d5340fa6c" title="Receive a reply to a control character Print a &amp;quot;printable&amp;quot; version of the...">lspmac_SendControlReplyPrintCB</a>(
<a name="l00894"></a>00894                                     <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *cmd,      
<a name="l00895"></a>00895                                     <span class="keywordtype">int</span> nreceived,              
<a name="l00896"></a>00896                                     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buff         
<a name="l00897"></a>00897                                     ) {
<a name="l00898"></a>00898     pthread_mutex_lock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l00899"></a>00899     wprintw( <a class="code" href="pgpmac_8c.html#a65daf0f4a5bc6def23a9df98ff5ca57e" title="place to print stuff out">term_output</a>, <span class="stringliteral">&quot;control-%c: &quot;</span>, <span class="charliteral">&apos;@&apos;</span>+ ntohs(cmd-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#aec0ee9a5f6c7e3bc6e4bd98f1bd52783" title="Command parameter 1.">wValue</a>));
<a name="l00900"></a>00900     pthread_mutex_unlock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l00901"></a>00901     <a class="code" href="lspmac_8c.html#a1c3786f3a38724f497afc4fe6d82d8c4" title="Prints a hex dump of the given data.">hex_dump</a>( nreceived, buff);
<a name="l00902"></a>00902     pthread_mutex_lock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l00903"></a>00903     wnoutrefresh( <a class="code" href="pgpmac_8c.html#a65daf0f4a5bc6def23a9df98ff5ca57e" title="place to print stuff out">term_output</a>);
<a name="l00904"></a>00904     wnoutrefresh( <a class="code" href="pgpmac_8c.html#ab0487111dbe3c05d0bd835eb2fb9a3f7" title="place to put the cursor">term_input</a>);
<a name="l00905"></a>00905     doupdate();
<a name="l00906"></a>00906     pthread_mutex_unlock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l00907"></a>00907 }
<a name="l00908"></a>00908 
<a name="l00909"></a>00909 
<a name="l00914"></a><a class="code" href="lspmac_8c.html#aaa3323f952efd66e63ff864932da5ced">00914</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#aaa3323f952efd66e63ff864932da5ced" title="Service a reply to the getmem command.">lspmac_GetmemReplyCB</a>(
<a name="l00915"></a>00915                           <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *cmd,                
<a name="l00916"></a>00916                           <span class="keywordtype">int</span> nreceived,                        
<a name="l00917"></a>00917                           <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buff) {                
<a name="l00919"></a>00919   memcpy( &amp;(<a class="code" href="lspmac_8c.html#a9da2795d11ccbc3a060c4811770ad04c" title="double buffered memory">dbmem</a>[ntohs(cmd-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a9ac7618bbe0faa3001e8efeb1d89010d" title="the pmac command to send">pcmd</a>.<a class="code" href="structtagEthernetCmd.html#aec0ee9a5f6c7e3bc6e4bd98f1bd52783" title="Command parameter 1.">wValue</a>)]), buff, nreceived);
<a name="l00920"></a>00920 
<a name="l00921"></a>00921   <a class="code" href="lspmac_8c.html#aa0be2f26364c4d12c9c81c10913f0b26" title="next location">dbmemIn</a> += nreceived;
<a name="l00922"></a>00922   <span class="keywordflow">if</span>( <a class="code" href="lspmac_8c.html#aa0be2f26364c4d12c9c81c10913f0b26" title="next location">dbmemIn</a> &gt;= <span class="keyword">sizeof</span>( <a class="code" href="lspmac_8c.html#a9da2795d11ccbc3a060c4811770ad04c" title="double buffered memory">dbmem</a>)) {
<a name="l00923"></a>00923     <a class="code" href="lspmac_8c.html#aa0be2f26364c4d12c9c81c10913f0b26" title="next location">dbmemIn</a> = 0;
<a name="l00924"></a>00924   }
<a name="l00925"></a>00925 }
<a name="l00926"></a>00926 
<a name="l00930"></a><a class="code" href="lspmac_8c.html#a0a56c777b1469ad8c3d29d825a71e300">00930</a> <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *<a class="code" href="lspmac_8c.html#a0a56c777b1469ad8c3d29d825a71e300" title="Request a chunk of memory to be returned.">lspmac_SockGetmem</a>(
<a name="l00931"></a>00931                                     <span class="keywordtype">int</span> offset,                 
<a name="l00932"></a>00932                                     <span class="keywordtype">int</span> nbytes                  
<a name="l00933"></a>00933                                     )  {
<a name="l00934"></a>00934   <span class="keywordflow">return</span> <a class="code" href="lspmac_8c.html#a1e472a11df3765763c2fe92dd358bf0c" title="Compose a packet and send it to the PMAC.">lspmac_send_command</a>( <a class="code" href="lspmac_8c.html#a5485d08fdc80533b5cebadff63696ed2">VR_UPLOAD</a>,   <a class="code" href="lspmac_8c.html#af9c53e7c5b2681a5ca1c5410a914a2dc">VR_PMAC_GETMEM</a>, offset, 0, nbytes, NULL, <a class="code" href="lspmac_8c.html#aaa3323f952efd66e63ff864932da5ced" title="Service a reply to the getmem command.">lspmac_GetmemReplyCB</a>, 0);
<a name="l00935"></a>00935 }
<a name="l00936"></a>00936 
<a name="l00940"></a><a class="code" href="lspmac_8c.html#aaa442d9bc7a3cdee39adea0724f0e18c">00940</a> <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *<a class="code" href="lspmac_8c.html#aaa442d9bc7a3cdee39adea0724f0e18c" title="Send a one line command.">lspmac_SockSendline</a>( 
<a name="l00941"></a>00941                                       <span class="keywordtype">char</span> *fmt,                
<a name="l00942"></a>00942                                       ...                       <span class="comment">/*        other arguments required by format string     */</span>
<a name="l00943"></a>00943                                        ) {
<a name="l00944"></a>00944   va_list arg_ptr;
<a name="l00945"></a>00945   <span class="keywordtype">char</span> payload[1400];
<a name="l00946"></a>00946 
<a name="l00947"></a>00947   va_start( arg_ptr, fmt);
<a name="l00948"></a>00948   vsnprintf( payload, <span class="keyword">sizeof</span>(payload)-1, fmt, arg_ptr);
<a name="l00949"></a>00949   payload[ <span class="keyword">sizeof</span>(payload)-1] = 0;
<a name="l00950"></a>00950   va_end( arg_ptr);
<a name="l00951"></a>00951 
<a name="l00952"></a>00952   <a class="code" href="lslogging_8c.html#a0e756b36671055ef02a8f04d2ba8a93b">lslogging_log_message</a>( payload);
<a name="l00953"></a>00953 
<a name="l00954"></a>00954   <span class="keywordflow">return</span> <a class="code" href="lspmac_8c.html#a1e472a11df3765763c2fe92dd358bf0c" title="Compose a packet and send it to the PMAC.">lspmac_send_command</a>( <a class="code" href="lspmac_8c.html#af24ecdc10723dc8fd6320fef416ae514">VR_DOWNLOAD</a>, <a class="code" href="lspmac_8c.html#a772b2ea2ad93989ae4275c79a93525ee">VR_PMAC_SENDLINE</a>, 0, 0, strlen( payload), payload, <a class="code" href="lspmac_8c.html#ac89b615b3ecb738c902c3c090d7c1dc3" title="Receive a reply that does not require multiple buffers.">lspmac_GetShortReplyCB</a>, 0);
<a name="l00955"></a>00955 }
<a name="l00956"></a>00956 
<a name="l00959"></a><a class="code" href="lspmac_8c.html#ac4cf3a79186859714d8a8293377526ba">00959</a> <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *<a class="code" href="lspmac_8c.html#ac4cf3a79186859714d8a8293377526ba" title="Send a command and ignore the response.">lspmac_SockSendline_nr</a>(
<a name="l00960"></a>00960                                          <span class="keywordtype">char</span> *fmt,             
<a name="l00961"></a>00961                                          ...                    <span class="comment">/*        Other arguments required by format string     */</span>
<a name="l00962"></a>00962                                          ) {
<a name="l00963"></a>00963   va_list arg_ptr;
<a name="l00964"></a>00964   <span class="keywordtype">char</span> s[512];
<a name="l00965"></a>00965 
<a name="l00966"></a>00966   va_start( arg_ptr, fmt);
<a name="l00967"></a>00967   vsnprintf( s, <span class="keyword">sizeof</span>(s)-1, fmt, arg_ptr);
<a name="l00968"></a>00968   s[<span class="keyword">sizeof</span>(s)-1] = 0;
<a name="l00969"></a>00969   va_end( arg_ptr);
<a name="l00970"></a>00970 
<a name="l00971"></a>00971   <a class="code" href="lslogging_8c.html#a0e756b36671055ef02a8f04d2ba8a93b">lslogging_log_message</a>( s);
<a name="l00972"></a>00972 
<a name="l00973"></a>00973   <span class="keywordflow">return</span> <a class="code" href="lspmac_8c.html#a1e472a11df3765763c2fe92dd358bf0c" title="Compose a packet and send it to the PMAC.">lspmac_send_command</a>( <a class="code" href="lspmac_8c.html#af24ecdc10723dc8fd6320fef416ae514">VR_DOWNLOAD</a>, <a class="code" href="lspmac_8c.html#a772b2ea2ad93989ae4275c79a93525ee">VR_PMAC_SENDLINE</a>, 0, 0, strlen( s), s, NULL, 1);
<a name="l00974"></a>00974 }
<a name="l00975"></a>00975 
<a name="l00978"></a><a class="code" href="lspmac_8c.html#a53ee9ff1a8ca316901babf8314b423de">00978</a> <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *<a class="code" href="lspmac_8c.html#a53ee9ff1a8ca316901babf8314b423de" title="Send a control character.">lspmac_SockSendControlCharPrint</a>(
<a name="l00979"></a>00979                                                   <span class="keywordtype">char</span> c        
<a name="l00980"></a>00980                                                   ) {
<a name="l00981"></a>00981   <span class="keywordflow">return</span> <a class="code" href="lspmac_8c.html#a1e472a11df3765763c2fe92dd358bf0c" title="Compose a packet and send it to the PMAC.">lspmac_send_command</a>( <a class="code" href="lspmac_8c.html#af24ecdc10723dc8fd6320fef416ae514">VR_DOWNLOAD</a>, <a class="code" href="lspmac_8c.html#a76c1c401354826ac2ba8906578be930f">VR_PMAC_SENDCTRLCHAR</a>, c, 0, 0, NULL, <a class="code" href="lspmac_8c.html#ac23af52b8d3a8f2722d4804d5340fa6c" title="Receive a reply to a control character Print a &amp;quot;printable&amp;quot; version of the...">lspmac_SendControlReplyPrintCB</a>, 0);
<a name="l00982"></a>00982 }
<a name="l00983"></a>00983 
<a name="l00986"></a><a class="code" href="lspmac_8c.html#a825ba2feb0108b977c34872e24a6c827">00986</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#a825ba2feb0108b977c34872e24a6c827" title="Request a block of double buffer memory.">lspmac_Getmem</a>() {
<a name="l00987"></a>00987   <span class="keywordtype">int</span> nbytes;
<a name="l00988"></a>00988   nbytes = (<a class="code" href="lspmac_8c.html#aa0be2f26364c4d12c9c81c10913f0b26" title="next location">dbmemIn</a> + 1400 &gt; <span class="keyword">sizeof</span>( <a class="code" href="lspmac_8c.html#a9da2795d11ccbc3a060c4811770ad04c" title="double buffered memory">dbmem</a>)) ? <span class="keyword">sizeof</span>( <a class="code" href="lspmac_8c.html#a9da2795d11ccbc3a060c4811770ad04c" title="double buffered memory">dbmem</a>) - <a class="code" href="lspmac_8c.html#aa0be2f26364c4d12c9c81c10913f0b26" title="next location">dbmemIn</a> : 1400;
<a name="l00989"></a>00989   <a class="code" href="lspmac_8c.html#a0a56c777b1469ad8c3d29d825a71e300" title="Request a chunk of memory to be returned.">lspmac_SockGetmem</a>( <a class="code" href="lspmac_8c.html#aa0be2f26364c4d12c9c81c10913f0b26" title="next location">dbmemIn</a>, nbytes);
<a name="l00990"></a>00990 }
<a name="l00991"></a>00991 
<a name="l00995"></a><a class="code" href="lspmac_8c.html#a5945488310a5a8f616e6605782c7f1c9">00995</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#a5945488310a5a8f616e6605782c7f1c9" title="Read the state of a binary i/o motor This is the read method for the binary i/o motor...">lspmac_bio_read</a>(
<a name="l00996"></a>00996                      <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *mp         
<a name="l00997"></a>00997                      ) {
<a name="l00998"></a>00998   <span class="keywordtype">char</span> s[512];
<a name="l00999"></a>00999   <span class="keywordtype">int</span> pos;
<a name="l01000"></a>01000 
<a name="l01001"></a>01001   pthread_mutex_lock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01002"></a>01002 
<a name="l01003"></a>01003   pos = (*(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a844b28ccabab5048ca216db074fb9704" title="With read_mask finds bit to read for binary i/o.">read_ptr</a>) &amp; mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a3c24ed30c5a3ad490c6139b2780b2af7" title="WIth read_ptr find bit to read for binary i/o.">read_mask</a>) == 0 ? 0 : 1;
<a name="l01004"></a>01004   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#af8ffb3aed907d8664b65b37601954411" title="scaled position">position</a> = pos;
<a name="l01005"></a>01005 
<a name="l01006"></a>01006   <span class="comment">// Not sure what kind of status makes sense to report</span>
<a name="l01007"></a>01007   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae4a6f54a98e7758d66228efebe8f3baa" title="short text summarizing status">statuss</a>[0] = 0;
<a name="l01008"></a>01008 
<a name="l01009"></a>01009 
<a name="l01010"></a>01010   <span class="comment">/*</span>
<a name="l01011"></a>01011 <span class="comment">  pthread_mutex_lock( &amp;ncurses_mutex);</span>
<a name="l01012"></a>01012 <span class="comment">  wprintw( term_output, &quot;    %d    %f\n&quot;, pos, mp-&gt;position);</span>
<a name="l01013"></a>01013 <span class="comment">  wnoutrefresh( term_output);</span>
<a name="l01014"></a>01014 <span class="comment">  wnoutrefresh( term_input);</span>
<a name="l01015"></a>01015 <span class="comment">  doupdate();</span>
<a name="l01016"></a>01016 <span class="comment">  pthread_mutex_unlock( &amp;ncurses_mutex);</span>
<a name="l01017"></a>01017 <span class="comment">  */</span>
<a name="l01018"></a>01018 
<a name="l01019"></a>01019   pthread_mutex_unlock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01020"></a>01020 }
<a name="l01021"></a>01021 
<a name="l01024"></a><a class="code" href="lspmac_8c.html#a200bc9306d54fca566eb5e29d8e82308">01024</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#a200bc9306d54fca566eb5e29d8e82308" title="Read a DAC motor position.">lspmac_dac_read</a>(
<a name="l01025"></a>01025                      <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *mp         
<a name="l01026"></a>01026                      ) {
<a name="l01027"></a>01027   <span class="keywordtype">int</span> pos;
<a name="l01028"></a>01028   pthread_mutex_lock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01029"></a>01029   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae5c7aea45b9637a1817be246688fd980" title="local copy of actual counts so only our mutex is needed to read">actual_pos_cnts</a> = *mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a312047bb71def5cd2443fecd875eaea5" title="pointer to the md2_status structure to the actual position">actual_pos_cnts_p</a>;
<a name="l01030"></a>01030 
<a name="l01031"></a>01031   <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a11cbc6f50c150ed446e9a901cf7cc12b" title="length of lut">nlut</a> &gt;0 &amp;&amp; mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a7b43671f7f3e06521f6cf91fb9ac707d" title="lookup table (instead of u2c)">lut</a> != NULL) {
<a name="l01032"></a>01032     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#af8ffb3aed907d8664b65b37601954411" title="scaled position">position</a> = <a class="code" href="lspmac_8c.html#a5afe5cd407b44f9c05ad4f1c4e4d5f6a">lspmac_rlut</a>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a11cbc6f50c150ed446e9a901cf7cc12b" title="length of lut">nlut</a>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a7b43671f7f3e06521f6cf91fb9ac707d" title="lookup table (instead of u2c)">lut</a>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae5c7aea45b9637a1817be246688fd980" title="local copy of actual counts so only our mutex is needed to read">actual_pos_cnts</a>);
<a name="l01033"></a>01033   } <span class="keywordflow">else</span> {
<a name="l01034"></a>01034     <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a61415627ab2dc0f438b190d117e532db" title="conversion from counts to units: 0.0 means not loaded yet">u2c</a> != 0.0) {
<a name="l01035"></a>01035       mp-&gt;<a class="code" href="structlspmac__motor__struct.html#af8ffb3aed907d8664b65b37601954411" title="scaled position">position</a> = mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae5c7aea45b9637a1817be246688fd980" title="local copy of actual counts so only our mutex is needed to read">actual_pos_cnts</a> / mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a61415627ab2dc0f438b190d117e532db" title="conversion from counts to units: 0.0 means not loaded yet">u2c</a>;
<a name="l01036"></a>01036     } <span class="keywordflow">else</span> {
<a name="l01037"></a>01037       mp-&gt;<a class="code" href="structlspmac__motor__struct.html#af8ffb3aed907d8664b65b37601954411" title="scaled position">position</a> = mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae5c7aea45b9637a1817be246688fd980" title="local copy of actual counts so only our mutex is needed to read">actual_pos_cnts</a>;
<a name="l01038"></a>01038     }
<a name="l01039"></a>01039   }
<a name="l01040"></a>01040 
<a name="l01041"></a>01041   <span class="comment">// Not sure what kind of status makes sense to report</span>
<a name="l01042"></a>01042   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae4a6f54a98e7758d66228efebe8f3baa" title="short text summarizing status">statuss</a>[0] = 0;
<a name="l01043"></a>01043 
<a name="l01044"></a>01044   pthread_mutex_unlock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01045"></a>01045 }
<a name="l01046"></a>01046 
<a name="l01053"></a><a class="code" href="lspmac_8c.html#ab81f07dea6bb0e88103a05a380de1034">01053</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#ab81f07dea6bb0e88103a05a380de1034" title="Fast shutter read routine The shutter is mildly complicated in that we need to take...">lspmac_shutter_read</a>(
<a name="l01054"></a>01054                          <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *mp     
<a name="l01055"></a>01055                          ) {
<a name="l01056"></a>01056   <span class="comment">//</span>
<a name="l01057"></a>01057   <span class="comment">// track the shutter state and signal if it has changed</span>
<a name="l01058"></a>01058   <span class="comment">//</span>
<a name="l01059"></a>01059   pthread_mutex_lock( &amp;<a class="code" href="lspmac_8c.html#a1b78a13c654409333569815e1c109d38" title="Coordinates threads reading shutter status.">lspmac_shutter_mutex</a>);
<a name="l01060"></a>01060   <span class="keywordflow">if</span>( md2_status.<a class="code" href="structmd2StatusStruct.html#ab961c2ba24a1a8c95a88dec25319e712">fs_has_opened</a> &amp;&amp; !<a class="code" href="lspmac_8c.html#a396fbf06208de3ecbe1b0df549f1cd46" title="Indicates that the shutter had opened, perhaps briefly even if the state did not...">lspmac_shutter_has_opened</a> &amp;&amp; !md2_status.<a class="code" href="structmd2StatusStruct.html#aca3722c109e6646bd41fb269a32261f2">fs_is_open</a>) {
<a name="l01061"></a>01061     <span class="comment">//</span>
<a name="l01062"></a>01062     <span class="comment">// Here the shutter opened and closed again before we got the memo</span>
<a name="l01063"></a>01063     <span class="comment">// Treat it as a shutter closed event</span>
<a name="l01064"></a>01064     <span class="comment">//</span>
<a name="l01065"></a>01065     pthread_cond_signal( &amp;<a class="code" href="lspmac_8c.html#afbd51c2cefcee87afe994c9e9f372241" title="Allows waiting for the shutter status to change.">lspmac_shutter_cond</a>);
<a name="l01066"></a>01066   }
<a name="l01067"></a>01067   <a class="code" href="lspmac_8c.html#a396fbf06208de3ecbe1b0df549f1cd46" title="Indicates that the shutter had opened, perhaps briefly even if the state did not...">lspmac_shutter_has_opened</a> = md2_status.<a class="code" href="structmd2StatusStruct.html#ab961c2ba24a1a8c95a88dec25319e712">fs_has_opened</a>;
<a name="l01068"></a>01068 
<a name="l01069"></a>01069   <span class="keywordflow">if</span>( <a class="code" href="lspmac_8c.html#a112158e0cd50449a440ac55c7af7bea2" title="State of the shutter, used to detect changes.">lspmac_shutter_state</a> !=  md2_status.<a class="code" href="structmd2StatusStruct.html#aca3722c109e6646bd41fb269a32261f2">fs_is_open</a>) {
<a name="l01070"></a>01070     <a class="code" href="lspmac_8c.html#a112158e0cd50449a440ac55c7af7bea2" title="State of the shutter, used to detect changes.">lspmac_shutter_state</a> = md2_status.<a class="code" href="structmd2StatusStruct.html#aca3722c109e6646bd41fb269a32261f2">fs_is_open</a>;
<a name="l01071"></a>01071     pthread_cond_signal( &amp;<a class="code" href="lspmac_8c.html#afbd51c2cefcee87afe994c9e9f372241" title="Allows waiting for the shutter status to change.">lspmac_shutter_cond</a>);
<a name="l01072"></a>01072   }
<a name="l01073"></a>01073 
<a name="l01074"></a>01074   <span class="keywordflow">if</span>( md2_status.<a class="code" href="structmd2StatusStruct.html#aca3722c109e6646bd41fb269a32261f2">fs_is_open</a>) {
<a name="l01075"></a>01075     mvwprintw( <a class="code" href="pgpmac_8c.html#ae2d7da3afeb756716e6e4ee9cab78f8a" title="shutter, lamp, air, etc status">term_status2</a>, 1, 1, <span class="stringliteral">&quot;Shutter Open  &quot;</span>);
<a name="l01076"></a>01076     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#af8ffb3aed907d8664b65b37601954411" title="scaled position">position</a> = 1;
<a name="l01077"></a>01077   } <span class="keywordflow">else</span> {
<a name="l01078"></a>01078     mvwprintw( <a class="code" href="pgpmac_8c.html#ae2d7da3afeb756716e6e4ee9cab78f8a" title="shutter, lamp, air, etc status">term_status2</a>, 1, 1, <span class="stringliteral">&quot;Shutter Closed&quot;</span>);
<a name="l01079"></a>01079     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#af8ffb3aed907d8664b65b37601954411" title="scaled position">position</a> = 0;
<a name="l01080"></a>01080   }
<a name="l01081"></a>01081 
<a name="l01082"></a>01082   <span class="comment">// Not sure what kind of status makes sense to report</span>
<a name="l01083"></a>01083   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae4a6f54a98e7758d66228efebe8f3baa" title="short text summarizing status">statuss</a>[0] = 0;
<a name="l01084"></a>01084 
<a name="l01085"></a>01085   pthread_mutex_unlock( &amp;<a class="code" href="lspmac_8c.html#a1b78a13c654409333569815e1c109d38" title="Coordinates threads reading shutter status.">lspmac_shutter_mutex</a>);
<a name="l01086"></a>01086 }
<a name="l01087"></a>01087 
<a name="l01090"></a><a class="code" href="lspmac_8c.html#a9fbadf816a842c8f131cf8ee47b54e29">01090</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#a9fbadf816a842c8f131cf8ee47b54e29" title="Homing method for steppers and servos.">lspmac_home1_queue</a>(
<a name="l01091"></a>01091                        <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *mp                       
<a name="l01092"></a>01092                        ) {
<a name="l01093"></a>01093   <span class="keywordtype">char</span> openloops[32];
<a name="l01094"></a>01094   <span class="keywordtype">char</span> *sp;
<a name="l01095"></a>01095   <span class="keywordtype">int</span> i;
<a name="l01096"></a>01096 
<a name="l01097"></a>01097   pthread_mutex_lock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01098"></a>01098 
<a name="l01099"></a>01099   
<a name="l01100"></a>01100   <span class="comment">// We got here before the initialization routine finished</span>
<a name="l01101"></a>01101   <span class="comment">// TODO: arrange to retry or at least indicated we haven&apos;t run</span>
<a name="l01102"></a>01102   <span class="comment">//</span>
<a name="l01103"></a>01103   <span class="keywordflow">if</span>( (mp-&gt;<a class="code" href="structlspmac__motor__struct.html#af11e5f75c1cf88ed6842d04154d27a31" title="bit flags: bit 0 = motor initialized by database, bit 1 = px.kvs value initialized...">lspg_initialized</a> &amp; 1) == 0) {
<a name="l01104"></a>01104     pthread_mutex_unlock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01105"></a>01105     <span class="keywordflow">return</span>;
<a name="l01106"></a>01106   }    
<a name="l01107"></a>01107 
<a name="l01108"></a>01108 
<a name="l01109"></a>01109   <span class="comment">// Each of the motors should have this defined</span>
<a name="l01110"></a>01110   <span class="comment">// but let&apos;s not seg fault if home is missing</span>
<a name="l01111"></a>01111   <span class="comment">//</span>
<a name="l01112"></a>01112   <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a073246b8878d75615b0536301b343f3d" title="pmac commands to home motor">home</a> == NULL || *(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a073246b8878d75615b0536301b343f3d" title="pmac commands to home motor">home</a>) == NULL) {
<a name="l01113"></a>01113     <span class="comment">//</span>
<a name="l01114"></a>01114     <span class="comment">// Note we are already initialized</span>
<a name="l01115"></a>01115     <span class="comment">// so if we are here there is something wrong.</span>
<a name="l01116"></a>01116     <span class="comment">// TODO: log this event</span>
<a name="l01117"></a>01117     pthread_mutex_unlock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01118"></a>01118     <span class="keywordflow">return</span>;
<a name="l01119"></a>01119   }
<a name="l01120"></a>01120 
<a name="l01121"></a>01121   <span class="comment">// We&apos;ve already been called.  Don&apos;t home again until</span>
<a name="l01122"></a>01122   <span class="comment">// we&apos;re finish with the last time.</span>
<a name="l01123"></a>01123   <span class="comment">//</span>
<a name="l01124"></a>01124   <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#aa74108855693f94fc2ff76333c9fb6ac" title="Homing routine started.">homing</a>) {
<a name="l01125"></a>01125     pthread_mutex_unlock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01126"></a>01126     <span class="keywordflow">return</span>;
<a name="l01127"></a>01127   }    
<a name="l01128"></a>01128 
<a name="l01129"></a>01129 
<a name="l01130"></a>01130   <span class="comment">//</span>
<a name="l01131"></a>01131   <span class="comment">// Don&apos;t go on if any other motors in this coordinate system are homing.</span>
<a name="l01132"></a>01132   <span class="comment">// It&apos;s possible to write the homing program to home all the motors in the coordinate</span>
<a name="l01133"></a>01133   <span class="comment">// system.</span>
<a name="l01134"></a>01134   <span class="comment">//</span>
<a name="l01135"></a>01135   <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a2093b0a3cd2f9500fd92e3c89bf46577" title="coordinate system this motor belongs to (0 if none)">coord_num</a> &gt; 0) {
<a name="l01136"></a>01136     <span class="keywordflow">for</span>( i=0; i&lt;<a class="code" href="lspmac_8c.html#a56260f012c50a591ee7f97e500f16994" title="The number of motors we manage.">lspmac_nmotors</a>; i++) {
<a name="l01137"></a>01137       <span class="keywordflow">if</span>( &amp;(lspmac_motors[i]) == mp)
<a name="l01138"></a>01138         <span class="keywordflow">continue</span>;
<a name="l01139"></a>01139       <span class="keywordflow">if</span>( lspmac_motors[i].coord_num == mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a2093b0a3cd2f9500fd92e3c89bf46577" title="coordinate system this motor belongs to (0 if none)">coord_num</a>) {
<a name="l01140"></a>01140         <span class="keywordflow">if</span>( lspmac_motors[i].homing) {
<a name="l01141"></a>01141           pthread_mutex_unlock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01142"></a>01142           <span class="keywordflow">return</span>;
<a name="l01143"></a>01143         }
<a name="l01144"></a>01144       }
<a name="l01145"></a>01145     }
<a name="l01146"></a>01146   }
<a name="l01147"></a>01147   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#aa74108855693f94fc2ff76333c9fb6ac" title="Homing routine started.">homing</a> = 1;
<a name="l01148"></a>01148        
<a name="l01149"></a>01149   <span class="comment">// This opens the control loop.</span>
<a name="l01150"></a>01150   <span class="comment">// The status routine should notice this and the fact that</span>
<a name="l01151"></a>01151   <span class="comment">// the homing flag is set and call on the home2 routine</span>
<a name="l01152"></a>01152   <span class="comment">//</span>
<a name="l01153"></a>01153   <span class="comment">// Only send the open loop command if we are not in</span>
<a name="l01154"></a>01154   <span class="comment">// open loop mode already.  This test might prevent a race condition</span>
<a name="l01155"></a>01155   <span class="comment">// where we&apos;ve already moved the home2 routine (and queue the homing program motion)</span>
<a name="l01156"></a>01156   <span class="comment">// before the open loop command is dequeued and acted on.</span>
<a name="l01157"></a>01157   <span class="comment">//</span>
<a name="l01158"></a>01158   <span class="keywordflow">if</span>( ~(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#acb52b612b9237e8eec0b97fb1e76a35d" title="local copy of status1">status1</a>) &amp; 0x040000) {
<a name="l01159"></a>01159     snprintf( openloops, <span class="keyword">sizeof</span>(openloops)-1, <span class="stringliteral">&quot;#%d$*&quot;</span>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a45fae17618f0c0827e97060dc04f79cb" title="pmac motor number">motor_num</a>);
<a name="l01160"></a>01160     openloops[<span class="keyword">sizeof</span>(openloops)-1] = 0;
<a name="l01161"></a>01161     <a class="code" href="lspmac_8c.html#aaa442d9bc7a3cdee39adea0724f0e18c" title="Send a one line command.">lspmac_SockSendline</a>( openloops);
<a name="l01162"></a>01162   }
<a name="l01163"></a>01163 
<a name="l01164"></a>01164   pthread_mutex_unlock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01165"></a>01165 }
<a name="l01166"></a>01166 
<a name="l01170"></a><a class="code" href="lspmac_8c.html#a43e54631dc8de372854ebbb63ff28f70">01170</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#a43e54631dc8de372854ebbb63ff28f70" title="Second stage of homing.">lspmac_home2_queue</a>(
<a name="l01171"></a>01171                        <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *mp                       
<a name="l01172"></a>01172                        ) {
<a name="l01173"></a>01173 
<a name="l01174"></a>01174   <span class="keywordtype">char</span> **spp;
<a name="l01175"></a>01175 
<a name="l01176"></a>01176   <span class="comment">//</span>
<a name="l01177"></a>01177   <span class="comment">// At this point we are in open loop.</span>
<a name="l01178"></a>01178   <span class="comment">// Run the motor specific commands</span>
<a name="l01179"></a>01179   <span class="comment">//</span>
<a name="l01180"></a>01180 
<a name="l01181"></a>01181   pthread_mutex_lock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01182"></a>01182   <span class="comment">//</span>
<a name="l01183"></a>01183   <span class="comment">// We don&apos;t have any motors that have a null home text array so </span>
<a name="l01184"></a>01184   <span class="comment">// there is currently no need to worry about this case other than</span>
<a name="l01185"></a>01185   <span class="comment">// not to seg fault</span>
<a name="l01186"></a>01186   <span class="comment">//</span>
<a name="l01187"></a>01187   <span class="comment">// Also, Only go on if the first homing phase has been started</span>
<a name="l01188"></a>01188   <span class="comment">//</span>
<a name="l01189"></a>01189   <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a073246b8878d75615b0536301b343f3d" title="pmac commands to home motor">home</a> == NULL || mp-&gt;<a class="code" href="structlspmac__motor__struct.html#aa74108855693f94fc2ff76333c9fb6ac" title="Homing routine started.">homing</a> != 1) {
<a name="l01190"></a>01190     pthread_mutex_unlock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01191"></a>01191     <span class="keywordflow">return</span>;
<a name="l01192"></a>01192   }
<a name="l01193"></a>01193 
<a name="l01194"></a>01194   <span class="keywordflow">for</span>( spp = mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a073246b8878d75615b0536301b343f3d" title="pmac commands to home motor">home</a>; *spp != NULL; spp++) {
<a name="l01195"></a>01195 
<a name="l01196"></a>01196     pthread_mutex_lock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l01197"></a>01197     wprintw( <a class="code" href="pgpmac_8c.html#a65daf0f4a5bc6def23a9df98ff5ca57e" title="place to print stuff out">term_output</a>, <span class="stringliteral">&quot;home2 is queuing &apos;%s&apos;\n&quot;</span>, *spp);
<a name="l01198"></a>01198     wnoutrefresh( <a class="code" href="pgpmac_8c.html#a65daf0f4a5bc6def23a9df98ff5ca57e" title="place to print stuff out">term_output</a>);
<a name="l01199"></a>01199     doupdate();
<a name="l01200"></a>01200     pthread_mutex_unlock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l01201"></a>01201 
<a name="l01202"></a>01202     <a class="code" href="lspmac_8c.html#aaa442d9bc7a3cdee39adea0724f0e18c" title="Send a one line command.">lspmac_SockSendline</a>( *spp);
<a name="l01203"></a>01203   }
<a name="l01204"></a>01204 
<a name="l01205"></a>01205   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#aa74108855693f94fc2ff76333c9fb6ac" title="Homing routine started.">homing</a> = 2;
<a name="l01206"></a>01206   pthread_mutex_unlock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01207"></a>01207   
<a name="l01208"></a>01208 }
<a name="l01209"></a>01209 
<a name="l01212"></a><a class="code" href="lspmac_8c.html#a637fc023d1255f3519b2eee01913d64d">01212</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#a637fc023d1255f3519b2eee01913d64d" title="Read the position and status of a normal PMAC motor.">lspmac_pmacmotor_read</a>(
<a name="l01213"></a>01213                            <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *mp           
<a name="l01214"></a>01214                            ) {
<a name="l01215"></a>01215   <span class="keywordtype">char</span> s[512], *sp;
<a name="l01216"></a>01216   <span class="keywordtype">int</span> homing1, homing2;
<a name="l01217"></a>01217 
<a name="l01218"></a>01218   pthread_mutex_lock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01219"></a>01219 
<a name="l01220"></a>01220   <span class="comment">//</span>
<a name="l01221"></a>01221   <span class="comment">// if this time and last time were both &quot;in position&quot;</span>
<a name="l01222"></a>01222   <span class="comment">// and the position changed significantly then log the event</span>
<a name="l01223"></a>01223   <span class="comment">//</span>
<a name="l01224"></a>01224   <span class="comment">// On E omega has been observed to change by 0x10000 on its own</span>
<a name="l01225"></a>01225   <span class="comment">// with no real motion.</span>
<a name="l01226"></a>01226   <span class="comment">//</span>
<a name="l01227"></a>01227   <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6a412224c09268c1dc92de9c2a1a2512" title="local copy of status2">status2</a> &amp; 1 &amp;&amp; mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6a412224c09268c1dc92de9c2a1a2512" title="local copy of status2">status2</a> == *mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a2b33ef6e12717459c1e9967cc6e659c6" title="Sectond 24 bit PMAC motor status word.">status2_p</a> &amp;&amp; abs( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae5c7aea45b9637a1817be246688fd980" title="local copy of actual counts so only our mutex is needed to read">actual_pos_cnts</a> - *mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a312047bb71def5cd2443fecd875eaea5" title="pointer to the md2_status structure to the actual position">actual_pos_cnts_p</a>) &gt; 256) {
<a name="l01228"></a>01228     <a class="code" href="lslogging_8c.html#a0e756b36671055ef02a8f04d2ba8a93b">lslogging_log_message</a>( <span class="stringliteral">&quot;Instantaneous change: %s old status1: %0x, new status1: %0x, old status2: %0x, new status2: %0x, old cnts: %0x, new cnts: %0x&quot;</span>,
<a name="l01229"></a>01229                            mp-&gt;<a class="code" href="structlspmac__motor__struct.html#aa90af2f6f1489f1befe1d0891e51575a" title="Name of motor as refered by ls database kvs table.">name</a>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#acb52b612b9237e8eec0b97fb1e76a35d" title="local copy of status1">status1</a>, *mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a56c41875faf19c643e97c10519e6eb8c" title="First 24 bit PMAC motor status word.">status1_p</a>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6a412224c09268c1dc92de9c2a1a2512" title="local copy of status2">status2</a>, *mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a2b33ef6e12717459c1e9967cc6e659c6" title="Sectond 24 bit PMAC motor status word.">status2_p</a>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae5c7aea45b9637a1817be246688fd980" title="local copy of actual counts so only our mutex is needed to read">actual_pos_cnts</a>, *mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a312047bb71def5cd2443fecd875eaea5" title="pointer to the md2_status structure to the actual position">actual_pos_cnts_p</a>);
<a name="l01230"></a>01230 
<a name="l01231"></a>01231     <span class="comment">//</span>
<a name="l01232"></a>01232     <span class="comment">// At this point we&apos;ll just log the event and return</span>
<a name="l01233"></a>01233     <span class="comment">// There is no reason to believe the change is real.</span>
<a name="l01234"></a>01234     <span class="comment">//</span>
<a name="l01235"></a>01235     <span class="comment">// There is a non-zero probability that the first value is the bad one and any value afterwards will be taken as</span>
<a name="l01236"></a>01236     <span class="comment">// wrong.  Homing (or moving) the motor should fix this.  There is a non-zero probably that it can happen</span>
<a name="l01237"></a>01237     <span class="comment">// two or more times in a row after moving.</span>
<a name="l01238"></a>01238     <span class="comment">//</span>
<a name="l01239"></a>01239     <span class="comment">// TODO: account for the case where mp-&gt;actual_pos_cnts is the bad value.</span>
<a name="l01240"></a>01240     <span class="comment">//</span>
<a name="l01241"></a>01241     <span class="comment">// TODO: Is this a problem when the motor is moving?  Can we detect it?</span>
<a name="l01242"></a>01242     <span class="comment">//</span>
<a name="l01243"></a>01243     <span class="comment">// TODO: Think of the correct change value here (currently 256) that works for all motors</span>
<a name="l01244"></a>01244     <span class="comment">// or have this value configurable</span>
<a name="l01245"></a>01245     <span class="comment">//</span>
<a name="l01246"></a>01246     pthread_mutex_unlock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01247"></a>01247     <span class="keywordflow">return</span>;
<a name="l01248"></a>01248   }
<a name="l01249"></a>01249 
<a name="l01250"></a>01250 
<a name="l01251"></a>01251   <span class="comment">// Send an event if inPosition has changed</span>
<a name="l01252"></a>01252   <span class="comment">//</span>
<a name="l01253"></a>01253   <span class="keywordflow">if</span>( (mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6a412224c09268c1dc92de9c2a1a2512" title="local copy of status2">status2</a> &amp; 0x000001) != (*mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a2b33ef6e12717459c1e9967cc6e659c6" title="Sectond 24 bit PMAC motor status word.">status2_p</a> &amp; 0x000001)) {
<a name="l01254"></a>01254     <a class="code" href="lsevents_8c.html#a5c6f122382dea3dcc231b772e5e75b46">lsevents_send_event</a>( <span class="stringliteral">&quot;%s %s&quot;</span>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#aa90af2f6f1489f1befe1d0891e51575a" title="Name of motor as refered by ls database kvs table.">name</a>, (*mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a2b33ef6e12717459c1e9967cc6e659c6" title="Sectond 24 bit PMAC motor status word.">status2_p</a> &amp; 0x000001) ? <span class="stringliteral">&quot;In Position&quot;</span> : <span class="stringliteral">&quot;Moving&quot;</span>);
<a name="l01255"></a>01255   }
<a name="l01256"></a>01256 
<a name="l01257"></a>01257   <span class="comment">// Make local copies so we can inspect them in other threads</span>
<a name="l01258"></a>01258   <span class="comment">// without having to grab the status mutex</span>
<a name="l01259"></a>01259   <span class="comment">//</span>
<a name="l01260"></a>01260 
<a name="l01261"></a>01261   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#acb52b612b9237e8eec0b97fb1e76a35d" title="local copy of status1">status1</a> = *mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a56c41875faf19c643e97c10519e6eb8c" title="First 24 bit PMAC motor status word.">status1_p</a>;
<a name="l01262"></a>01262   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6a412224c09268c1dc92de9c2a1a2512" title="local copy of status2">status2</a> = *mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a2b33ef6e12717459c1e9967cc6e659c6" title="Sectond 24 bit PMAC motor status word.">status2_p</a>;
<a name="l01263"></a>01263   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae5c7aea45b9637a1817be246688fd980" title="local copy of actual counts so only our mutex is needed to read">actual_pos_cnts</a> = *mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a312047bb71def5cd2443fecd875eaea5" title="pointer to the md2_status structure to the actual position">actual_pos_cnts_p</a>;
<a name="l01264"></a>01264 
<a name="l01265"></a>01265   <span class="comment">//</span>
<a name="l01266"></a>01266   <span class="comment">// See if we are done moving, ie, in position</span>
<a name="l01267"></a>01267   <span class="comment">//</span>
<a name="l01268"></a>01268   <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6a412224c09268c1dc92de9c2a1a2512" title="local copy of status2">status2</a> &amp; 0x000001) {
<a name="l01269"></a>01269     <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ab7bd8bff48953ce05c758598d75877ac" title="set to 1 when request is queued, zero after motion has toggled">not_done</a>) {
<a name="l01270"></a>01270       mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ab7bd8bff48953ce05c758598d75877ac" title="set to 1 when request is queued, zero after motion has toggled">not_done</a> = 0;
<a name="l01271"></a>01271       pthread_cond_signal( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#aa0ea4108b8fed5b41ff91ca7266f3d84">cond</a>));
<a name="l01272"></a>01272     }
<a name="l01273"></a>01273   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ab7bd8bff48953ce05c758598d75877ac" title="set to 1 when request is queued, zero after motion has toggled">not_done</a> == 0) {
<a name="l01274"></a>01274     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ab7bd8bff48953ce05c758598d75877ac" title="set to 1 when request is queued, zero after motion has toggled">not_done</a> = 1;
<a name="l01275"></a>01275   }
<a name="l01276"></a>01276 
<a name="l01277"></a>01277   <span class="comment">//</span>
<a name="l01278"></a>01278   <span class="comment">// See if homed or desired velocity zero</span>
<a name="l01279"></a>01279   <span class="comment">// TODO: What&apos;s going on here?  Does this logic do anything interesting?</span>
<a name="l01280"></a>01280   <span class="comment">//</span>
<a name="l01281"></a>01281   <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#acb52b612b9237e8eec0b97fb1e76a35d" title="local copy of status1">status1</a> &amp; 0x020000 || mp-&gt;<a class="code" href="structlspmac__motor__struct.html#acb52b612b9237e8eec0b97fb1e76a35d" title="local copy of status1">status1</a> &amp; 0x000400) {
<a name="l01282"></a>01282     <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a68c471836f52707fa8582f7860cf500f" title="set to 1 when motion has been verified to have started">motion_seen</a> == 0) {
<a name="l01283"></a>01283       mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a68c471836f52707fa8582f7860cf500f" title="set to 1 when motion has been verified to have started">motion_seen</a> = 1;
<a name="l01284"></a>01284       pthread_cond_signal( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#aa0ea4108b8fed5b41ff91ca7266f3d84">cond</a>));
<a name="l01285"></a>01285     }
<a name="l01286"></a>01286   }
<a name="l01287"></a>01287 
<a name="l01288"></a>01288   mvwprintw( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a133775154b0e008f3a2fde6f53bc0eff" title="our ncurses window">win</a>, 2, 1, <span class="stringliteral">&quot;%*s&quot;</span>, <a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>-2, <span class="stringliteral">&quot; &quot;</span>);
<a name="l01289"></a>01289   mvwprintw( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a133775154b0e008f3a2fde6f53bc0eff" title="our ncurses window">win</a>, 2, 1, <span class="stringliteral">&quot;%*d cts&quot;</span>, <a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>-6, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae5c7aea45b9637a1817be246688fd980" title="local copy of actual counts so only our mutex is needed to read">actual_pos_cnts</a>);
<a name="l01290"></a>01290   mvwprintw( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a133775154b0e008f3a2fde6f53bc0eff" title="our ncurses window">win</a>, 3, 1, <span class="stringliteral">&quot;%*s&quot;</span>, <a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>-2, <span class="stringliteral">&quot; &quot;</span>);
<a name="l01291"></a>01291 
<a name="l01292"></a>01292   <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a11cbc6f50c150ed446e9a901cf7cc12b" title="length of lut">nlut</a> &gt;0 &amp;&amp; mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a7b43671f7f3e06521f6cf91fb9ac707d" title="lookup table (instead of u2c)">lut</a> != NULL) {
<a name="l01293"></a>01293     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#af8ffb3aed907d8664b65b37601954411" title="scaled position">position</a> = <a class="code" href="lspmac_8c.html#a5afe5cd407b44f9c05ad4f1c4e4d5f6a">lspmac_rlut</a>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a11cbc6f50c150ed446e9a901cf7cc12b" title="length of lut">nlut</a>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a7b43671f7f3e06521f6cf91fb9ac707d" title="lookup table (instead of u2c)">lut</a>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae5c7aea45b9637a1817be246688fd980" title="local copy of actual counts so only our mutex is needed to read">actual_pos_cnts</a>);
<a name="l01294"></a>01294   } <span class="keywordflow">else</span> {
<a name="l01295"></a>01295     <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a61415627ab2dc0f438b190d117e532db" title="conversion from counts to units: 0.0 means not loaded yet">u2c</a> != 0.0) {
<a name="l01296"></a>01296       mp-&gt;<a class="code" href="structlspmac__motor__struct.html#af8ffb3aed907d8664b65b37601954411" title="scaled position">position</a> = mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae5c7aea45b9637a1817be246688fd980" title="local copy of actual counts so only our mutex is needed to read">actual_pos_cnts</a> / mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a61415627ab2dc0f438b190d117e532db" title="conversion from counts to units: 0.0 means not loaded yet">u2c</a>;
<a name="l01297"></a>01297     } <span class="keywordflow">else</span> {
<a name="l01298"></a>01298       mp-&gt;<a class="code" href="structlspmac__motor__struct.html#af8ffb3aed907d8664b65b37601954411" title="scaled position">position</a> = mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae5c7aea45b9637a1817be246688fd980" title="local copy of actual counts so only our mutex is needed to read">actual_pos_cnts</a>;
<a name="l01299"></a>01299     }
<a name="l01300"></a>01300   }
<a name="l01301"></a>01301   snprintf( s, <span class="keyword">sizeof</span>(s)-1, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#aba3d9d00271187128506bbbb1d77da19" title="printf format">format</a>, 8, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#af8ffb3aed907d8664b65b37601954411" title="scaled position">position</a>);
<a name="l01302"></a>01302 
<a name="l01303"></a>01303   <span class="comment">// set flag if we are not homed</span>
<a name="l01304"></a>01304   homing1 = 0;
<a name="l01305"></a>01305   <span class="comment">//                        ~(homed flag)</span>
<a name="l01306"></a>01306   <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#aa74108855693f94fc2ff76333c9fb6ac" title="Homing routine started.">homing</a> == 0  &amp;&amp; (~mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6a412224c09268c1dc92de9c2a1a2512" title="local copy of status2">status2</a> &amp; 0x000400) != 0) {
<a name="l01307"></a>01307     homing1 = 1;
<a name="l01308"></a>01308   }
<a name="l01309"></a>01309 
<a name="l01310"></a>01310   <span class="comment">// set flag if we are homing and in open loop</span>
<a name="l01311"></a>01311   homing2 = 0;
<a name="l01312"></a>01312   <span class="comment">//                         open loop</span>
<a name="l01313"></a>01313   <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#aa74108855693f94fc2ff76333c9fb6ac" title="Homing routine started.">homing</a> == 1 &amp;&amp; (mp-&gt;<a class="code" href="structlspmac__motor__struct.html#acb52b612b9237e8eec0b97fb1e76a35d" title="local copy of status1">status1</a> &amp; 0x040000) != 0) {
<a name="l01314"></a>01314     homing2 = 1;
<a name="l01315"></a>01315   }
<a name="l01316"></a>01316   <span class="comment">// maybe reset homing flag</span>
<a name="l01317"></a>01317   <span class="comment">//                        homed flag                       in position flag</span>
<a name="l01318"></a>01318   <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#aa74108855693f94fc2ff76333c9fb6ac" title="Homing routine started.">homing</a> == 2 &amp;&amp; (mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6a412224c09268c1dc92de9c2a1a2512" title="local copy of status2">status2</a> &amp; 0x000400 != 0) &amp;&amp; (mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6a412224c09268c1dc92de9c2a1a2512" title="local copy of status2">status2</a> &amp; 0x000001 != 0))
<a name="l01319"></a>01319     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#aa74108855693f94fc2ff76333c9fb6ac" title="Homing routine started.">homing</a> = 0;
<a name="l01320"></a>01320 
<a name="l01321"></a>01321 
<a name="l01322"></a>01322   s[<span class="keyword">sizeof</span>(s)-1] = 0;
<a name="l01323"></a>01323   mvwprintw( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a133775154b0e008f3a2fde6f53bc0eff" title="our ncurses window">win</a>, 3, 1, <span class="stringliteral">&quot;%*s&quot;</span>, <a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>-6, s);
<a name="l01324"></a>01324 
<a name="l01325"></a>01325   mvwprintw( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a133775154b0e008f3a2fde6f53bc0eff" title="our ncurses window">win</a>, 4, 1, <span class="stringliteral">&quot;%*x&quot;</span>, <a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>-2, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#acb52b612b9237e8eec0b97fb1e76a35d" title="local copy of status1">status1</a>);
<a name="l01326"></a>01326   mvwprintw( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a133775154b0e008f3a2fde6f53bc0eff" title="our ncurses window">win</a>, 5, 1, <span class="stringliteral">&quot;%*x&quot;</span>, <a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>-2, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6a412224c09268c1dc92de9c2a1a2512" title="local copy of status2">status2</a>);
<a name="l01327"></a>01327   sp = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01328"></a>01328   <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6a412224c09268c1dc92de9c2a1a2512" title="local copy of status2">status2</a> &amp; 0x000002)
<a name="l01329"></a>01329     sp = <span class="stringliteral">&quot;Following Warning&quot;</span>;
<a name="l01330"></a>01330   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6a412224c09268c1dc92de9c2a1a2512" title="local copy of status2">status2</a> &amp; 0x000004)
<a name="l01331"></a>01331     sp = <span class="stringliteral">&quot;Following Error&quot;</span>;
<a name="l01332"></a>01332   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6a412224c09268c1dc92de9c2a1a2512" title="local copy of status2">status2</a> &amp; 0x000020)
<a name="l01333"></a>01333     sp = <span class="stringliteral">&quot;I2T Amp Fault&quot;</span>;
<a name="l01334"></a>01334   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6a412224c09268c1dc92de9c2a1a2512" title="local copy of status2">status2</a> &amp; 0x000008)
<a name="l01335"></a>01335     sp = <span class="stringliteral">&quot;Amp. Fault&quot;</span>;
<a name="l01336"></a>01336   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6a412224c09268c1dc92de9c2a1a2512" title="local copy of status2">status2</a> &amp; 0x000800)
<a name="l01337"></a>01337     sp = <span class="stringliteral">&quot;Stopped on Limit&quot;</span>;
<a name="l01338"></a>01338   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#acb52b612b9237e8eec0b97fb1e76a35d" title="local copy of status1">status1</a> &amp; 0x040000)
<a name="l01339"></a>01339     sp = <span class="stringliteral">&quot;Open Loop&quot;</span>;
<a name="l01340"></a>01340   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( ~(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#acb52b612b9237e8eec0b97fb1e76a35d" title="local copy of status1">status1</a>) &amp; 0x080000)
<a name="l01341"></a>01341     sp = <span class="stringliteral">&quot;Motor Disabled&quot;</span>;
<a name="l01342"></a>01342   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#acb52b612b9237e8eec0b97fb1e76a35d" title="local copy of status1">status1</a> &amp; 0x000400)
<a name="l01343"></a>01343     sp = <span class="stringliteral">&quot;Homing&quot;</span>;
<a name="l01344"></a>01344   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (mp-&gt;<a class="code" href="structlspmac__motor__struct.html#acb52b612b9237e8eec0b97fb1e76a35d" title="local copy of status1">status1</a> &amp; 0x600000) == 0x600000)
<a name="l01345"></a>01345     sp = <span class="stringliteral">&quot;Both Limits Tripped&quot;</span>;
<a name="l01346"></a>01346   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#acb52b612b9237e8eec0b97fb1e76a35d" title="local copy of status1">status1</a> &amp; 0x200000)
<a name="l01347"></a>01347     sp = <span class="stringliteral">&quot;Positive Limit&quot;</span>;
<a name="l01348"></a>01348   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#acb52b612b9237e8eec0b97fb1e76a35d" title="local copy of status1">status1</a> &amp; 0x400000)
<a name="l01349"></a>01349     sp = <span class="stringliteral">&quot;Negative Limit&quot;</span>;
<a name="l01350"></a>01350   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( ~(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6a412224c09268c1dc92de9c2a1a2512" title="local copy of status2">status2</a>) &amp; 0x000400)
<a name="l01351"></a>01351     sp = <span class="stringliteral">&quot;Not Homed&quot;</span>;
<a name="l01352"></a>01352   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6a412224c09268c1dc92de9c2a1a2512" title="local copy of status2">status2</a> &amp; 0x000001)
<a name="l01353"></a>01353     sp = <span class="stringliteral">&quot;In Position&quot;</span>;
<a name="l01354"></a>01354 
<a name="l01355"></a>01355   mvwprintw( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a133775154b0e008f3a2fde6f53bc0eff" title="our ncurses window">win</a>, 6, 1, <span class="stringliteral">&quot;%*s&quot;</span>, <a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>-2, sp);
<a name="l01356"></a>01356   wnoutrefresh( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a133775154b0e008f3a2fde6f53bc0eff" title="our ncurses window">win</a>);
<a name="l01357"></a>01357   
<a name="l01358"></a>01358   strncpy( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae4a6f54a98e7758d66228efebe8f3baa" title="short text summarizing status">statuss</a>, sp, <span class="keyword">sizeof</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae4a6f54a98e7758d66228efebe8f3baa" title="short text summarizing status">statuss</a>)-1);
<a name="l01359"></a>01359   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae4a6f54a98e7758d66228efebe8f3baa" title="short text summarizing status">statuss</a>[<span class="keyword">sizeof</span>(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae4a6f54a98e7758d66228efebe8f3baa" title="short text summarizing status">statuss</a>)-1] = 0;
<a name="l01360"></a>01360 
<a name="l01361"></a>01361   pthread_mutex_unlock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01362"></a>01362 
<a name="l01363"></a>01363   <span class="keywordflow">if</span>( homing1)
<a name="l01364"></a>01364     <a class="code" href="lspmac_8c.html#a9fbadf816a842c8f131cf8ee47b54e29" title="Homing method for steppers and servos.">lspmac_home1_queue</a>( mp);
<a name="l01365"></a>01365 
<a name="l01366"></a>01366   <span class="keywordflow">if</span>( homing2)
<a name="l01367"></a>01367     <a class="code" href="lspmac_8c.html#a43e54631dc8de372854ebbb63ff28f70" title="Second stage of homing.">lspmac_home2_queue</a>( mp);
<a name="l01368"></a>01368 
<a name="l01369"></a>01369 }
<a name="l01370"></a>01370 
<a name="l01374"></a><a class="code" href="lspmac_8c.html#ad060fd55c9e2411fd4fd4e946aff23c6">01374</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#ad060fd55c9e2411fd4fd4e946aff23c6" title="Service routing for status upate This updates positions and status information.">lspmac_get_status_cb</a>(
<a name="l01375"></a>01375                           <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *cmd,                
<a name="l01376"></a>01376                           <span class="keywordtype">int</span> nreceived,                        
<a name="l01377"></a>01377                           <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buff                   
<a name="l01378"></a>01378                           ) {
<a name="l01379"></a>01379   <span class="keyword">static</span> <span class="keywordtype">int</span> cnt = 0;
<a name="l01380"></a>01380   <span class="keyword">static</span> <span class="keywordtype">char</span> s[256];
<a name="l01381"></a>01381   <span class="keyword">static</span> <span class="keyword">struct </span>timeval ts1, ts2;
<a name="l01382"></a>01382 
<a name="l01383"></a>01383   <span class="keywordtype">char</span> *sp;
<a name="l01384"></a>01384   <span class="keywordtype">int</span> i, pos;
<a name="l01385"></a>01385   <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *mp;
<a name="l01386"></a>01386 
<a name="l01387"></a>01387   <span class="keywordflow">if</span>( cnt == 0) {
<a name="l01388"></a>01388     gettimeofday( &amp;ts1, NULL);
<a name="l01389"></a>01389   }
<a name="l01390"></a>01390 
<a name="l01391"></a>01391   pthread_mutex_lock( &amp;<a class="code" href="lspmac_8c.html#a7a3e763682bd7f987d07f149e94b3bf8" title="Synchronize reading/writting status buffer.">md2_status_mutex</a>);
<a name="l01392"></a>01392   memcpy( &amp;md2_status, buff, <span class="keyword">sizeof</span>(md2_status));
<a name="l01393"></a>01393   pthread_mutex_unlock( &amp;<a class="code" href="lspmac_8c.html#a7a3e763682bd7f987d07f149e94b3bf8" title="Synchronize reading/writting status buffer.">md2_status_mutex</a>);
<a name="l01394"></a>01394 
<a name="l01395"></a>01395 
<a name="l01396"></a>01396   <span class="comment">//</span>
<a name="l01397"></a>01397   <span class="comment">// track the coordinate system moving flags</span>
<a name="l01398"></a>01398   <span class="comment">//</span>
<a name="l01399"></a>01399   pthread_mutex_lock( &amp;<a class="code" href="lspmac_8c.html#a85679cac947e199c88794f8e5a12bf5f" title="Coordinate moving motors between threads.">lspmac_moving_mutex</a>);
<a name="l01400"></a>01400   <span class="keywordflow">if</span>( md2_status.<a class="code" href="structmd2StatusStruct.html#aac82f8e97fa39ea9be7823dd1d308986">moving_flags</a> != <a class="code" href="lspmac_8c.html#a7a32c617c183166308241e270959df56" title="Flag used to implement motor moving condition.">lspmac_moving_flags</a>) {
<a name="l01401"></a>01401     <a class="code" href="lspmac_8c.html#a7a32c617c183166308241e270959df56" title="Flag used to implement motor moving condition.">lspmac_moving_flags</a> = md2_status.<a class="code" href="structmd2StatusStruct.html#aac82f8e97fa39ea9be7823dd1d308986">moving_flags</a>;
<a name="l01402"></a>01402     pthread_cond_signal( &amp;<a class="code" href="lspmac_8c.html#a57547d211906c981ef20257eba99f8df" title="Wait for motor(s) to finish moving condition.">lspmac_moving_cond</a>);
<a name="l01403"></a>01403   }
<a name="l01404"></a>01404   pthread_mutex_unlock( &amp;<a class="code" href="lspmac_8c.html#a85679cac947e199c88794f8e5a12bf5f" title="Coordinate moving motors between threads.">lspmac_moving_mutex</a>);
<a name="l01405"></a>01405 
<a name="l01406"></a>01406 
<a name="l01407"></a>01407 
<a name="l01408"></a>01408   <span class="keywordflow">for</span>( i=0; i&lt;<a class="code" href="lspmac_8c.html#a56260f012c50a591ee7f97e500f16994" title="The number of motors we manage.">lspmac_nmotors</a>; i++) {
<a name="l01409"></a>01409     lspmac_motors[i].<a class="code" href="structlspmac__motor__struct.html#ac62692eb939c04ca35e939d1c3acfe8f" title="function to read the motor status and position">read</a>(&amp;(lspmac_motors[i]));
<a name="l01410"></a>01410   }
<a name="l01411"></a>01411 
<a name="l01412"></a>01412   pthread_mutex_lock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l01413"></a>01413 
<a name="l01414"></a>01414   <span class="comment">// acc11c_1</span>
<a name="l01415"></a>01415   <span class="comment">// mask  bit</span>
<a name="l01416"></a>01416   <span class="comment">// 0x01  0    Air pressure OK</span>
<a name="l01417"></a>01417   <span class="comment">// 0x02  1    Air bearing OK</span>
<a name="l01418"></a>01418   <span class="comment">// 0x04  2    Cryo switch</span>
<a name="l01419"></a>01419   <span class="comment">// 0x08  3</span>
<a name="l01420"></a>01420   <span class="comment">// 0x10  4</span>
<a name="l01421"></a>01421   <span class="comment">// 0x20  5</span>
<a name="l01422"></a>01422   <span class="comment">// 0x40  6    Cryo is back</span>
<a name="l01423"></a>01423 
<a name="l01424"></a>01424   <span class="keywordflow">if</span>( md2_status.<a class="code" href="structmd2StatusStruct.html#a69fc2e30a5de0a11c992d133e7a761cd">acc11c_1</a> &amp; 0x40)
<a name="l01425"></a>01425     mvwprintw( <a class="code" href="pgpmac_8c.html#ae2d7da3afeb756716e6e4ee9cab78f8a" title="shutter, lamp, air, etc status">term_status2</a>, 3, 1, <span class="stringliteral">&quot;%*s&quot;</span>, -8, <span class="stringliteral">&quot;Cryo Out&quot;</span>);
<a name="l01426"></a>01426   <span class="keywordflow">else</span>
<a name="l01427"></a>01427     mvwprintw( <a class="code" href="pgpmac_8c.html#ae2d7da3afeb756716e6e4ee9cab78f8a" title="shutter, lamp, air, etc status">term_status2</a>, 3, 1, <span class="stringliteral">&quot;%*s&quot;</span>, -8, <span class="stringliteral">&quot;Cryo In &quot;</span>);
<a name="l01428"></a>01428 
<a name="l01429"></a>01429   <span class="comment">//</span>
<a name="l01430"></a>01430   <span class="comment">// acc11c_2</span>
<a name="l01431"></a>01431   <span class="comment">// mask  bit</span>
<a name="l01432"></a>01432   <span class="comment">// 0x01  0    Fluor Dector back</span>
<a name="l01433"></a>01433   <span class="comment">// 0x02  1    Sample Detected</span>
<a name="l01434"></a>01434   <span class="comment">// 0x04  2</span>
<a name="l01435"></a>01435   <span class="comment">// 0x08  3</span>
<a name="l01436"></a>01436   <span class="comment">// 0x10  4</span>
<a name="l01437"></a>01437   <span class="comment">// 0x20  5    Etel Ready</span>
<a name="l01438"></a>01438   <span class="comment">// 0x40  6    Etel On</span>
<a name="l01439"></a>01439   <span class="comment">// 0x80  7    Etel Init OK</span>
<a name="l01440"></a>01440 
<a name="l01441"></a>01441   <span class="keywordflow">if</span>( md2_status.<a class="code" href="structmd2StatusStruct.html#ad186f06cb4670b00b8af8264d1da66a4">acc11c_2</a> &amp; 0x01)
<a name="l01442"></a>01442     mvwprintw( <a class="code" href="pgpmac_8c.html#ae2d7da3afeb756716e6e4ee9cab78f8a" title="shutter, lamp, air, etc status">term_status2</a>, 3, 10, <span class="stringliteral">&quot;%*s&quot;</span>, -8, <span class="stringliteral">&quot;Fluor Out&quot;</span>);
<a name="l01443"></a>01443   <span class="keywordflow">else</span>
<a name="l01444"></a>01444     mvwprintw( <a class="code" href="pgpmac_8c.html#ae2d7da3afeb756716e6e4ee9cab78f8a" title="shutter, lamp, air, etc status">term_status2</a>, 3, 10, <span class="stringliteral">&quot;%*s&quot;</span>, -8, <span class="stringliteral">&quot;Fluor In&quot;</span>);
<a name="l01445"></a>01445 
<a name="l01446"></a>01446   <span class="keywordflow">if</span>( md2_status.<a class="code" href="structmd2StatusStruct.html#ab09c1342dc12052b8f5b35f78ef95000">acc11c_5</a> &amp; 0x08)
<a name="l01447"></a>01447     mvwprintw( <a class="code" href="pgpmac_8c.html#ae2d7da3afeb756716e6e4ee9cab78f8a" title="shutter, lamp, air, etc status">term_status2</a>, 4, 1, <span class="stringliteral">&quot;%*s&quot;</span>, -(<a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>-2), <span class="stringliteral">&quot;Dryer On&quot;</span>);
<a name="l01448"></a>01448   <span class="keywordflow">else</span>
<a name="l01449"></a>01449     mvwprintw( <a class="code" href="pgpmac_8c.html#ae2d7da3afeb756716e6e4ee9cab78f8a" title="shutter, lamp, air, etc status">term_status2</a>, 4, 1, <span class="stringliteral">&quot;%*s&quot;</span>, -(<a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>-2), <span class="stringliteral">&quot;Dryer Off&quot;</span>);
<a name="l01450"></a>01450 
<a name="l01451"></a>01451   <span class="keywordflow">if</span>( md2_status.<a class="code" href="structmd2StatusStruct.html#ad186f06cb4670b00b8af8264d1da66a4">acc11c_2</a> &amp; 0x02)
<a name="l01452"></a>01452     mvwprintw( <a class="code" href="pgpmac_8c.html#ae2d7da3afeb756716e6e4ee9cab78f8a" title="shutter, lamp, air, etc status">term_status2</a>, 2, 1, <span class="stringliteral">&quot;%*s&quot;</span>, -(<a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>-2), <span class="stringliteral">&quot;Cap Dectected&quot;</span>);
<a name="l01453"></a>01453   <span class="keywordflow">else</span>
<a name="l01454"></a>01454     mvwprintw( <a class="code" href="pgpmac_8c.html#ae2d7da3afeb756716e6e4ee9cab78f8a" title="shutter, lamp, air, etc status">term_status2</a>, 2, 1, <span class="stringliteral">&quot;%*s&quot;</span>, -(<a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>-2), <span class="stringliteral">&quot;Cap Not Dectected&quot;</span>);
<a name="l01455"></a>01455   wnoutrefresh( <a class="code" href="pgpmac_8c.html#ae2d7da3afeb756716e6e4ee9cab78f8a" title="shutter, lamp, air, etc status">term_status2</a>);
<a name="l01456"></a>01456 
<a name="l01457"></a>01457 
<a name="l01458"></a>01458   <span class="comment">// acc11c_3</span>
<a name="l01459"></a>01459   <span class="comment">// mask  bit</span>
<a name="l01460"></a>01460   <span class="comment">// 0x01  0    Minikappa OK</span>
<a name="l01461"></a>01461   <span class="comment">// 0x02  1</span>
<a name="l01462"></a>01462   <span class="comment">// 0x04  2</span>
<a name="l01463"></a>01463   <span class="comment">// 0x08  3    Arm Parked</span>
<a name="l01464"></a>01464 
<a name="l01465"></a>01465   <span class="comment">// acc11c_5</span>
<a name="l01466"></a>01466   <span class="comment">// mask  bit</span>
<a name="l01467"></a>01467   <span class="comment">// 0x01  0    Mag Off</span>
<a name="l01468"></a>01468   <span class="comment">// 0x02  1    Condenser Out</span>
<a name="l01469"></a>01469   <span class="comment">// 0x04  2    Cryo Back</span>
<a name="l01470"></a>01470   <span class="comment">// 0x08  3    Dryer On</span>
<a name="l01471"></a>01471   <span class="comment">// 0x10  4    FluoDet Out</span>
<a name="l01472"></a>01472   <span class="comment">// 0x20  5</span>
<a name="l01473"></a>01473   <span class="comment">// 0x40  6    1=SmartMag, 0=Permanent Mag</span>
<a name="l01474"></a>01474   <span class="comment">//</span>
<a name="l01475"></a>01475 
<a name="l01476"></a>01476   <span class="comment">// acc11c_6</span>
<a name="l01477"></a>01477   <span class="comment">// mask   bit</span>
<a name="l01478"></a>01478   <span class="comment">// 0x0080   7   Etel Enable</span>
<a name="l01479"></a>01479   <span class="comment">// 0x0100   8   Fast Shutter Enable</span>
<a name="l01480"></a>01480   <span class="comment">// 0x0200   9   Fast Shutter Manual Enable</span>
<a name="l01481"></a>01481   <span class="comment">// 0x0400  10   Fast Shutter On</span>
<a name="l01482"></a>01482 
<a name="l01483"></a>01483 
<a name="l01484"></a>01484 
<a name="l01485"></a>01485   <span class="keywordflow">if</span>( md2_status.<a class="code" href="structmd2StatusStruct.html#ab09c1342dc12052b8f5b35f78ef95000">acc11c_5</a> &amp; 0x02)
<a name="l01486"></a>01486     mvwprintw( <a class="code" href="pgpmac_8c.html#ae746a6903fb8a4ea216def88eccedc3c" title="shutter, lamp, air, etc status">term_status</a>,  3, 1, <span class="stringliteral">&quot;%*s&quot;</span>, -(<a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>-2), <span class="stringliteral">&quot;Backlight Up&quot;</span>);
<a name="l01487"></a>01487   <span class="keywordflow">else</span>
<a name="l01488"></a>01488     mvwprintw( <a class="code" href="pgpmac_8c.html#ae746a6903fb8a4ea216def88eccedc3c" title="shutter, lamp, air, etc status">term_status</a>,  3, 1, <span class="stringliteral">&quot;%*s&quot;</span>, -(<a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>-2), <span class="stringliteral">&quot;Backlight Down&quot;</span>);
<a name="l01489"></a>01489 
<a name="l01490"></a>01490   mvwprintw( <a class="code" href="pgpmac_8c.html#ae746a6903fb8a4ea216def88eccedc3c" title="shutter, lamp, air, etc status">term_status</a>, 4, 1, <span class="stringliteral">&quot;Front: %*u&quot;</span>, <a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>-2-8, (<span class="keywordtype">int</span>)flight-&gt;<a class="code" href="structlspmac__motor__struct.html#af8ffb3aed907d8664b65b37601954411" title="scaled position">position</a>);
<a name="l01491"></a>01491   mvwprintw( <a class="code" href="pgpmac_8c.html#ae746a6903fb8a4ea216def88eccedc3c" title="shutter, lamp, air, etc status">term_status</a>, 5, 1, <span class="stringliteral">&quot;Back: %*u&quot;</span>, <a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>-2-7,  (<span class="keywordtype">int</span>)blight-&gt;<a class="code" href="structlspmac__motor__struct.html#af8ffb3aed907d8664b65b37601954411" title="scaled position">position</a>);
<a name="l01492"></a>01492   mvwprintw( <a class="code" href="pgpmac_8c.html#ae746a6903fb8a4ea216def88eccedc3c" title="shutter, lamp, air, etc status">term_status</a>, 6, 1, <span class="stringliteral">&quot;Piezo: %*u&quot;</span>, <a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>-2-8, (<span class="keywordtype">int</span>)fscint-&gt;<a class="code" href="structlspmac__motor__struct.html#af8ffb3aed907d8664b65b37601954411" title="scaled position">position</a>);
<a name="l01493"></a>01493   wnoutrefresh( <a class="code" href="pgpmac_8c.html#ae746a6903fb8a4ea216def88eccedc3c" title="shutter, lamp, air, etc status">term_status</a>);
<a name="l01494"></a>01494 
<a name="l01495"></a>01495   wnoutrefresh( <a class="code" href="pgpmac_8c.html#ab0487111dbe3c05d0bd835eb2fb9a3f7" title="place to put the cursor">term_input</a>);
<a name="l01496"></a>01496   doupdate();
<a name="l01497"></a>01497   pthread_mutex_unlock( &amp;<a class="code" href="pgpmac_8c.html#ad128c64890c7c0d4f836d9ec6e99216a" title="allow more than one thread access to the screen">ncurses_mutex</a>);
<a name="l01498"></a>01498 
<a name="l01499"></a>01499   <span class="comment">/*</span>
<a name="l01500"></a>01500 <span class="comment">  if( ++cnt % 1000 == 0) {</span>
<a name="l01501"></a>01501 <span class="comment">    gettimeofday( &amp;ts2, NULL);</span>
<a name="l01502"></a>01502 <span class="comment"></span>
<a name="l01503"></a>01503 <span class="comment">    lslogging_log_message( &quot;Refresh Rate: %0.1f Hz&quot;, 1000000.*(cnt)/(ts2.tv_sec*1000000 + ts2.tv_usec - ts1.tv_sec*1000000 - ts1.tv_usec));</span>
<a name="l01504"></a>01504 <span class="comment"></span>
<a name="l01505"></a>01505 <span class="comment">    cnt = 0;</span>
<a name="l01506"></a>01506 <span class="comment">  }</span>
<a name="l01507"></a>01507 <span class="comment">  */</span>
<a name="l01508"></a>01508 }
<a name="l01509"></a>01509 
<a name="l01512"></a><a class="code" href="lspmac_8c.html#a6dedca923b3a6904395ad02158e2e96f">01512</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#a6dedca923b3a6904395ad02158e2e96f" title="Request a status update from the PMAC.">lspmac_get_status</a>() {
<a name="l01513"></a>01513   <a class="code" href="lspmac_8c.html#a1e472a11df3765763c2fe92dd358bf0c" title="Compose a packet and send it to the PMAC.">lspmac_send_command</a>( <a class="code" href="lspmac_8c.html#a5485d08fdc80533b5cebadff63696ed2">VR_UPLOAD</a>, <a class="code" href="lspmac_8c.html#af9c53e7c5b2681a5ca1c5410a914a2dc">VR_PMAC_GETMEM</a>, 0x400, 0, <span class="keyword">sizeof</span>(<a class="code" href="structmd2StatusStruct.html" title="The block of memory retrieved in a status request.">md2_status_t</a>), NULL, <a class="code" href="lspmac_8c.html#ad060fd55c9e2411fd4fd4e946aff23c6" title="Service routing for status upate This updates positions and status information.">lspmac_get_status_cb</a>, 0);
<a name="l01514"></a>01514 }
<a name="l01515"></a>01515 
<a name="l01516"></a>01516 
<a name="l01520"></a><a class="code" href="lspmac_8c.html#add86d60f9d192563fc9a357dc90f7f75">01520</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#add86d60f9d192563fc9a357dc90f7f75" title="Receive the values of all the I variables Update our Postgresql database with the...">lspmac_GetAllIVarsCB</a>(
<a name="l01521"></a>01521                           <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *cmd,        
<a name="l01522"></a>01522                           <span class="keywordtype">int</span> nreceived,                
<a name="l01523"></a>01523                           <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buff           
<a name="l01524"></a>01524                           ) {
<a name="l01525"></a>01525   <span class="keyword">static</span> <span class="keywordtype">char</span> qs[<a class="code" href="pgpmac_8h.html#a3a8ef1b4b5994d6dd12bf74454ea891b" title="Fixed length postgresql query strings. Queries should all be function calls so this...">LS_PG_QUERY_STRING_LENGTH</a>];
<a name="l01526"></a>01526   <span class="keywordtype">char</span> *sp;
<a name="l01527"></a>01527   <span class="keywordtype">int</span> i;
<a name="l01528"></a>01528   <span class="keywordflow">for</span>( i=0, sp=strtok(buff, <span class="stringliteral">&quot;\r&quot;</span>); sp != NULL; sp=strtok( NULL, <span class="stringliteral">&quot;\r&quot;</span>), i++) {
<a name="l01529"></a>01529     snprintf( qs, <span class="keyword">sizeof</span>( qs)-1, <span class="stringliteral">&quot;SELECT pmac.md2_ivar_set( %d, &apos;%s&apos;)&quot;</span>, i, sp);
<a name="l01530"></a>01530     qs[<span class="keyword">sizeof</span>( qs)-1]=0;
<a name="l01531"></a>01531     <a class="code" href="lspg_8c.html#a0bb9ef42da8fa21c4df48ec384ab69f4" title="Place a query on the queue.">lspg_query_push</a>( NULL, qs);
<a name="l01532"></a>01532   }
<a name="l01533"></a>01533 }
<a name="l01534"></a>01534 
<a name="l01537"></a><a class="code" href="lspmac_8c.html#ac24bdffa893a9bf7c9cb084fe1417f6f">01537</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#ac24bdffa893a9bf7c9cb084fe1417f6f" title="Request the values of all the I variables.">lspmac_GetAllIVars</a>() {
<a name="l01538"></a>01538   <span class="keyword">static</span> <span class="keywordtype">char</span> *cmds = <span class="stringliteral">&quot;I0..8191&quot;</span>;
<a name="l01539"></a>01539   <a class="code" href="lspmac_8c.html#a1e472a11df3765763c2fe92dd358bf0c" title="Compose a packet and send it to the PMAC.">lspmac_send_command</a>( <a class="code" href="lspmac_8c.html#af24ecdc10723dc8fd6320fef416ae514">VR_DOWNLOAD</a>, <a class="code" href="lspmac_8c.html#a772b2ea2ad93989ae4275c79a93525ee">VR_PMAC_SENDLINE</a>, 0, 0, strlen( cmds), cmds, <a class="code" href="lspmac_8c.html#add86d60f9d192563fc9a357dc90f7f75" title="Receive the values of all the I variables Update our Postgresql database with the...">lspmac_GetAllIVarsCB</a>, 0);
<a name="l01540"></a>01540 }
<a name="l01541"></a>01541 
<a name="l01545"></a><a class="code" href="lspmac_8c.html#ac585cd63a433c86843eb51b15017c3da">01545</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#ac585cd63a433c86843eb51b15017c3da" title="Receive the values of all the M variables Update our database with the results.">lspmac_GetAllMVarsCB</a>(
<a name="l01546"></a>01546                           <a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *cmd,        
<a name="l01547"></a>01547                           <span class="keywordtype">int</span> nreceived,                
<a name="l01548"></a>01548                           <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buff           
<a name="l01549"></a>01549                           ) {
<a name="l01550"></a>01550   <span class="keyword">static</span> <span class="keywordtype">char</span> qs[<a class="code" href="pgpmac_8h.html#a3a8ef1b4b5994d6dd12bf74454ea891b" title="Fixed length postgresql query strings. Queries should all be function calls so this...">LS_PG_QUERY_STRING_LENGTH</a>];
<a name="l01551"></a>01551   <span class="keywordtype">char</span> *sp;
<a name="l01552"></a>01552   <span class="keywordtype">int</span> i;
<a name="l01553"></a>01553   <span class="keywordflow">for</span>( i=0, sp=strtok(buff, <span class="stringliteral">&quot;\r&quot;</span>); sp != NULL; sp=strtok( NULL, <span class="stringliteral">&quot;\r&quot;</span>), i++) {
<a name="l01554"></a>01554     snprintf( qs, <span class="keyword">sizeof</span>( qs)-1, <span class="stringliteral">&quot;SELECT pmac.md2_mvar_set( %d, &apos;%s&apos;)&quot;</span>, i, sp);
<a name="l01555"></a>01555     qs[<span class="keyword">sizeof</span>( qs)-1]=0;
<a name="l01556"></a>01556     <a class="code" href="lspg_8c.html#a0bb9ef42da8fa21c4df48ec384ab69f4" title="Place a query on the queue.">lspg_query_push</a>( NULL, qs);
<a name="l01557"></a>01557   }
<a name="l01558"></a>01558 }
<a name="l01559"></a>01559 
<a name="l01562"></a><a class="code" href="lspmac_8c.html#a983d291506dc387ba5d71a97766e8a25">01562</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#a983d291506dc387ba5d71a97766e8a25" title="Request the values of all the M variables.">lspmac_GetAllMVars</a>() {
<a name="l01563"></a>01563   <span class="keyword">static</span> <span class="keywordtype">char</span> *cmds = <span class="stringliteral">&quot;M0..8191-&gt;&quot;</span>;
<a name="l01564"></a>01564   <a class="code" href="lspmac_8c.html#a1e472a11df3765763c2fe92dd358bf0c" title="Compose a packet and send it to the PMAC.">lspmac_send_command</a>( <a class="code" href="lspmac_8c.html#af24ecdc10723dc8fd6320fef416ae514">VR_DOWNLOAD</a>, <a class="code" href="lspmac_8c.html#a772b2ea2ad93989ae4275c79a93525ee">VR_PMAC_SENDLINE</a>, 0, 0, strlen( cmds), cmds, <a class="code" href="lspmac_8c.html#ac585cd63a433c86843eb51b15017c3da" title="Receive the values of all the M variables Update our database with the results.">lspmac_GetAllMVarsCB</a>, 0);
<a name="l01565"></a>01565 }
<a name="l01566"></a>01566 
<a name="l01567"></a>01567 
<a name="l01568"></a>01568 
<a name="l01571"></a><a class="code" href="lspmac_8c.html#aa9bbf5ae34ce793d3d72945c64c43948">01571</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#aa9bbf5ae34ce793d3d72945c64c43948" title="Send a command that does not need to deal with the reply.">lspmac_sendcmd_nocb</a>(
<a name="l01572"></a>01572                          <span class="keywordtype">char</span> *fmt,             
<a name="l01573"></a>01573                          ...                    <span class="comment">/*        Arguments required by the format string       */</span>
<a name="l01574"></a>01574                          ) {
<a name="l01575"></a>01575   <span class="keyword">static</span> <span class="keywordtype">char</span> tmps[1024];
<a name="l01576"></a>01576   va_list arg_ptr;
<a name="l01577"></a>01577 
<a name="l01578"></a>01578   va_start( arg_ptr, fmt);
<a name="l01579"></a>01579   vsnprintf( tmps, <span class="keyword">sizeof</span>(tmps)-1, fmt, arg_ptr);
<a name="l01580"></a>01580   tmps[<span class="keyword">sizeof</span>(tmps)-1]=0;
<a name="l01581"></a>01581   va_end( arg_ptr);
<a name="l01582"></a>01582 
<a name="l01583"></a>01583   <a class="code" href="lspmac_8c.html#a1e472a11df3765763c2fe92dd358bf0c" title="Compose a packet and send it to the PMAC.">lspmac_send_command</a>( <a class="code" href="lspmac_8c.html#af24ecdc10723dc8fd6320fef416ae514">VR_DOWNLOAD</a>, <a class="code" href="lspmac_8c.html#a772b2ea2ad93989ae4275c79a93525ee">VR_PMAC_SENDLINE</a>, 0, 0, strlen(tmps), tmps, NULL, 0);
<a name="l01584"></a>01584 }
<a name="l01585"></a>01585 
<a name="l01586"></a>01586 
<a name="l01587"></a>01587 
<a name="l01590"></a><a class="code" href="lspmac_8c.html#abc3ef9890ab5c4e00d14ccd0d360fb05">01590</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#abc3ef9890ab5c4e00d14ccd0d360fb05" title="PMAC command with call back.">lspmac_sendcmd</a>(
<a name="l01591"></a>01591                         <span class="keywordtype">void</span> (*responseCB)(<a class="code" href="structlspmac__cmd__queue__struct.html" title="PMAC command queue item.">pmac_cmd_queue_t</a> *, <span class="keywordtype">int</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *),           
<a name="l01592"></a>01592                         <span class="keywordtype">char</span> *fmt,                                                              
<a name="l01593"></a>01593                         ...                                                                     <span class="comment">/*        Arguments specified by format string */</span>
<a name="l01594"></a>01594                         ) {
<a name="l01595"></a>01595   <span class="keyword">static</span> <span class="keywordtype">char</span> tmps[1024];
<a name="l01596"></a>01596   va_list arg_ptr;
<a name="l01597"></a>01597 
<a name="l01598"></a>01598   va_start( arg_ptr, fmt);
<a name="l01599"></a>01599   vsnprintf( tmps, <span class="keyword">sizeof</span>(tmps)-1, fmt, arg_ptr);
<a name="l01600"></a>01600   tmps[<span class="keyword">sizeof</span>(tmps)-1]=0;
<a name="l01601"></a>01601   va_end( arg_ptr);
<a name="l01602"></a>01602 
<a name="l01603"></a>01603   <a class="code" href="lspmac_8c.html#a1e472a11df3765763c2fe92dd358bf0c" title="Compose a packet and send it to the PMAC.">lspmac_send_command</a>( <a class="code" href="lspmac_8c.html#af24ecdc10723dc8fd6320fef416ae514">VR_DOWNLOAD</a>, <a class="code" href="lspmac_8c.html#a772b2ea2ad93989ae4275c79a93525ee">VR_PMAC_SENDLINE</a>, 0, 0, strlen(tmps), tmps, responseCB, 0);
<a name="l01604"></a>01604 }
<a name="l01605"></a>01605 
<a name="l01606"></a>01606 
<a name="l01610"></a><a class="code" href="lspmac_8c.html#a68886d1b658e7b1d996c07e9dbcd9c15">01610</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#a68886d1b658e7b1d996c07e9dbcd9c15" title="State machine logic.">lspmac_next_state</a>() {
<a name="l01611"></a>01611 
<a name="l01612"></a>01612 
<a name="l01613"></a>01613   <span class="comment">//</span>
<a name="l01614"></a>01614   <span class="comment">// Connect to the pmac and perhaps initialize it.</span>
<a name="l01615"></a>01615   <span class="comment">// OK, this is slightly more than just the state</span>
<a name="l01616"></a>01616   <span class="comment">// machine logic...</span>
<a name="l01617"></a>01617   <span class="comment">//</span>
<a name="l01618"></a>01618   <span class="keywordflow">if</span>( <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> == <a class="code" href="lspmac_8c.html#a7eb86ecf0789ab9555de1e03a4c73567">LS_PMAC_STATE_DETACHED</a>) {
<a name="l01619"></a>01619     <span class="comment">//</span>
<a name="l01620"></a>01620     <span class="comment">// TODO (eventually)</span>
<a name="l01621"></a>01621     <span class="comment">// This ip address wont change in a single PMAC installation</span>
<a name="l01622"></a>01622     <span class="comment">// We&apos;ll need to audit the code if we decide to implement</span>
<a name="l01623"></a>01623     <span class="comment">// multiple PMACs so might as well wait til then.</span>
<a name="l01624"></a>01624     <span class="comment">//</span>
<a name="l01625"></a>01625     <a class="code" href="lspmac_8c.html#aae020ea2478b41702ce8b7d20b2560be" title="Connect to the PMAC socket.">lsConnect</a>( <span class="stringliteral">&quot;192.6.94.5&quot;</span>);
<a name="l01626"></a>01626 
<a name="l01627"></a>01627     <span class="comment">//</span>
<a name="l01628"></a>01628     <span class="comment">// If the connect was successful we can proceed with the initialization</span>
<a name="l01629"></a>01629     <span class="comment">//</span>
<a name="l01630"></a>01630     <span class="keywordflow">if</span>( <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> != <a class="code" href="lspmac_8c.html#a7eb86ecf0789ab9555de1e03a4c73567">LS_PMAC_STATE_DETACHED</a>) {
<a name="l01631"></a>01631       <a class="code" href="lspmac_8c.html#ac5745f25f242edf02f7b9b7c77ed6126" title="Reset the PMAC socket from the PMAC side.">lspmac_SockFlush</a>();
<a name="l01632"></a>01632       
<a name="l01633"></a>01633       <span class="comment">//</span>
<a name="l01634"></a>01634       <span class="comment">// Harvest the I and M variables in case we need them</span>
<a name="l01635"></a>01635       <span class="comment">// one day.</span>
<a name="l01636"></a>01636       <span class="comment">//</span>
<a name="l01637"></a>01637       <span class="keywordflow">if</span>( <a class="code" href="lspmac_8c.html#a50e9c0a06654fd81b3446a6e54ff12c3" title="flag set at initialization to send m vars to db">getmvars</a>) {
<a name="l01638"></a>01638         <a class="code" href="lspmac_8c.html#a983d291506dc387ba5d71a97766e8a25" title="Request the values of all the M variables.">lspmac_GetAllMVars</a>();
<a name="l01639"></a>01639         <a class="code" href="lspmac_8c.html#a50e9c0a06654fd81b3446a6e54ff12c3" title="flag set at initialization to send m vars to db">getmvars</a> = 0;
<a name="l01640"></a>01640       }
<a name="l01641"></a>01641       
<a name="l01642"></a>01642       <span class="keywordflow">if</span>( <a class="code" href="lspmac_8c.html#a07b7b8254772075e6a4ced500b589c36" title="flag set at initialization to send i vars to db">getivars</a>) {
<a name="l01643"></a>01643         <a class="code" href="lspmac_8c.html#ac24bdffa893a9bf7c9cb084fe1417f6f" title="Request the values of all the I variables.">lspmac_GetAllIVars</a>();
<a name="l01644"></a>01644         <a class="code" href="lspmac_8c.html#a07b7b8254772075e6a4ced500b589c36" title="flag set at initialization to send i vars to db">getivars</a> = 0;
<a name="l01645"></a>01645       }
<a name="l01646"></a>01646     }
<a name="l01647"></a>01647   }
<a name="l01648"></a>01648 
<a name="l01649"></a>01649   <span class="comment">//</span>
<a name="l01650"></a>01650   <span class="comment">// Check the command queue and perhaps go to the &quot;Send Command&quot; state.</span>
<a name="l01651"></a>01651   <span class="comment">//</span>
<a name="l01652"></a>01652   <span class="keywordflow">if</span>( <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> == <a class="code" href="lspmac_8c.html#a37741af675425d61c876cc30ae6c99d0">LS_PMAC_STATE_IDLE</a> &amp;&amp; <a class="code" href="lspmac_8c.html#ad62b1f9e907acc3de9f3d6a05d55829e" title="points to next empty PMAC command queue position">ethCmdOn</a> != <a class="code" href="lspmac_8c.html#ae85caec6f4ddb2fc52ca14a26549ab08" title="points to current command (or none if == ethCmdOn)">ethCmdOff</a>)
<a name="l01653"></a>01653     <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a> = <a class="code" href="lspmac_8c.html#a7d8f34fc599cc08c1a9d2cd62ccbb20a">LS_PMAC_STATE_SC</a>;
<a name="l01654"></a>01654 
<a name="l01655"></a>01655 
<a name="l01656"></a>01656   <span class="comment">//</span>
<a name="l01657"></a>01657   <span class="comment">// Set the events flag</span>
<a name="l01658"></a>01658   <span class="comment">// to tell poll what we are waiting for.</span>
<a name="l01659"></a>01659   <span class="comment">//</span>
<a name="l01660"></a>01660   <span class="keywordflow">switch</span>( <a class="code" href="lspmac_8c.html#a6d9261680ee01b1e106d1ea1d7ffa390" title="Current state of the PMAC communications state machine.">ls_pmac_state</a>) {
<a name="l01661"></a>01661   <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a7eb86ecf0789ab9555de1e03a4c73567">LS_PMAC_STATE_DETACHED</a>:
<a name="l01662"></a>01662     <span class="comment">//</span>
<a name="l01663"></a>01663     <span class="comment">// there shouldn&apos;t be a valid fd, so ignore the events</span>
<a name="l01664"></a>01664     <span class="comment">//</span>
<a name="l01665"></a>01665     <a class="code" href="lspmac_8c.html#adba7f5f4bbeabc4dac859221d4c684ba" title="our poll structure">pmacfd</a>.events = 0;
<a name="l01666"></a>01666     <span class="keywordflow">break</span>;
<a name="l01667"></a>01667 
<a name="l01668"></a>01668   <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a37741af675425d61c876cc30ae6c99d0">LS_PMAC_STATE_IDLE</a>:
<a name="l01669"></a>01669     <span class="keywordflow">if</span>( <a class="code" href="lspmac_8c.html#ad62b1f9e907acc3de9f3d6a05d55829e" title="points to next empty PMAC command queue position">ethCmdOn</a> == <a class="code" href="lspmac_8c.html#ae85caec6f4ddb2fc52ca14a26549ab08" title="points to current command (or none if == ethCmdOn)">ethCmdOff</a>) {
<a name="l01670"></a>01670       <span class="comment">//</span>
<a name="l01671"></a>01671       <span class="comment">// Anytime we are idle we want to</span>
<a name="l01672"></a>01672       <span class="comment">// get the status of the PMAC</span>
<a name="l01673"></a>01673       <span class="comment">//</span>
<a name="l01674"></a>01674 
<a name="l01675"></a>01675       <a class="code" href="lspmac_8c.html#a6dedca923b3a6904395ad02158e2e96f" title="Request a status update from the PMAC.">lspmac_get_status</a>();
<a name="l01676"></a>01676     }
<a name="l01677"></a>01677 
<a name="l01678"></a>01678 
<a name="l01679"></a>01679 
<a name="l01680"></a>01680   <span class="comment">//</span>
<a name="l01681"></a>01681   <span class="comment">// These state require that we listen for packets</span>
<a name="l01682"></a>01682   <span class="comment">//</span>
<a name="l01683"></a>01683   <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a63356b0c18fcb186f456c12c6e927d84">LS_PMAC_STATE_WACK_NFR</a>:
<a name="l01684"></a>01684   <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a5eba9ef09d4316e803b9d75bd3104f43">LS_PMAC_STATE_WACK</a>:
<a name="l01685"></a>01685   <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#adef540911028fda73e8bbf0aa6ad39e9">LS_PMAC_STATE_WACK_CC</a>:
<a name="l01686"></a>01686   <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a3e0a62cd9a1212419ad3615c34bdc65a">LS_PMAC_STATE_WACK_RR</a>:
<a name="l01687"></a>01687   <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a27ee6c39d58604c8aa9bd6c249c4833f">LS_PMAC_STATE_WCR</a>:
<a name="l01688"></a>01688   <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a591822cc92f76a39b293c2e90b322db2">LS_PMAC_STATE_WGB</a>:
<a name="l01689"></a>01689   <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a220b39710719cfe8b500d51819e8efeb">LS_PMAC_STATE_GMR</a>:
<a name="l01690"></a>01690     <a class="code" href="lspmac_8c.html#adba7f5f4bbeabc4dac859221d4c684ba" title="our poll structure">pmacfd</a>.events = POLLIN;
<a name="l01691"></a>01691     <span class="keywordflow">break</span>;
<a name="l01692"></a>01692     
<a name="l01693"></a>01693   <span class="comment">//</span>
<a name="l01694"></a>01694   <span class="comment">// These state require that we send packets out.</span>
<a name="l01695"></a>01695   <span class="comment">//</span>
<a name="l01696"></a>01696   <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a7d8f34fc599cc08c1a9d2cd62ccbb20a">LS_PMAC_STATE_SC</a>:
<a name="l01697"></a>01697   <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#abbd709b56a71eb1fc6adc9063605d243">LS_PMAC_STATE_CR</a>:
<a name="l01698"></a>01698   <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#add5325f4a84e4fe05f558880349485ea">LS_PMAC_STATE_RR</a>:
<a name="l01699"></a>01699   <span class="keywordflow">case</span> <a class="code" href="lspmac_8c.html#a5f4ff8874677aac48a4c675f2c1ca4e9">LS_PMAC_STATE_GB</a>:
<a name="l01700"></a>01700     <span class="comment">//</span>
<a name="l01701"></a>01701     <span class="comment">// Sad fact: PMAC will fail to process commands if we send them too quickly.</span>
<a name="l01702"></a>01702     <span class="comment">// We deal with that by waiting a tad before we let poll tell us the PMAC socket is ready to write.</span>
<a name="l01703"></a>01703     <span class="comment">//</span>
<a name="l01704"></a>01704     gettimeofday( &amp;<a class="code" href="lspmac_8c.html#a4bed9053319d1d2cad5cc03d0549e17f" title="used to ensure we do not send commands to the pmac too often. Only needed for non-DB...">now</a>, NULL);
<a name="l01705"></a>01705     <span class="keywordflow">if</span>(  ((<a class="code" href="lspmac_8c.html#a4bed9053319d1d2cad5cc03d0549e17f" title="used to ensure we do not send commands to the pmac too often. Only needed for non-DB...">now</a>.tv_sec * 1000000. + <a class="code" href="lspmac_8c.html#a4bed9053319d1d2cad5cc03d0549e17f" title="used to ensure we do not send commands to the pmac too often. Only needed for non-DB...">now</a>.tv_usec) - (pmac_time_sent.tv_sec * 1000000. + pmac_time_sent.tv_usec)) &lt; <a class="code" href="lspmac_8c.html#a59f5f5218e25332dbf64f216aec116e5" title="Minimum time between commands to the pmac.">PMAC_MIN_CMD_TIME</a>) {
<a name="l01706"></a>01706       <a class="code" href="lspmac_8c.html#adba7f5f4bbeabc4dac859221d4c684ba" title="our poll structure">pmacfd</a>.events = 0;
<a name="l01707"></a>01707     } <span class="keywordflow">else</span> {
<a name="l01708"></a>01708       <a class="code" href="lspmac_8c.html#adba7f5f4bbeabc4dac859221d4c684ba" title="our poll structure">pmacfd</a>.events = POLLOUT;
<a name="l01709"></a>01709     }
<a name="l01710"></a>01710     <span class="keywordflow">break</span>;
<a name="l01711"></a>01711   }
<a name="l01712"></a>01712 }
<a name="l01713"></a>01713 
<a name="l01714"></a>01714 
<a name="l01717"></a><a class="code" href="lspmac_8c.html#abdec5883055967b1eda043670870f55f">01717</a> <span class="keywordtype">void</span> *<a class="code" href="lspmac_8c.html#abdec5883055967b1eda043670870f55f" title="Our lspmac worker thread.">lspmac_worker</a>(
<a name="l01718"></a>01718                     <span class="keywordtype">void</span> *dummy         
<a name="l01719"></a>01719                     ) {
<a name="l01720"></a>01720 
<a name="l01721"></a>01721   <span class="keywordflow">while</span>( 1) {
<a name="l01722"></a>01722     <span class="keywordtype">int</span> pollrtn;
<a name="l01723"></a>01723 
<a name="l01724"></a>01724     <a class="code" href="lspmac_8c.html#a68886d1b658e7b1d996c07e9dbcd9c15" title="State machine logic.">lspmac_next_state</a>();
<a name="l01725"></a>01725 
<a name="l01726"></a>01726     <span class="keywordflow">if</span>( <a class="code" href="lspmac_8c.html#adba7f5f4bbeabc4dac859221d4c684ba" title="our poll structure">pmacfd</a>.fd == -1) {
<a name="l01727"></a>01727       sleep( 10);       <span class="comment">// The pmac is not connected.  Should we warn someone?</span>
<a name="l01728"></a>01728       <span class="comment">//</span>
<a name="l01729"></a>01729       <span class="comment">// This just puts us into a holding pattern until the pmac becomes connected again</span>
<a name="l01730"></a>01730       <span class="comment">//</span>
<a name="l01731"></a>01731       <span class="comment">// TODO:</span>
<a name="l01732"></a>01732       <span class="comment">// Check PMAC initialization logic and our queues to ensure that it is sane to</span>
<a name="l01733"></a>01733       <span class="comment">// re-initialize things.  Probably bad things will happen.</span>
<a name="l01734"></a>01734       <span class="comment">//</span>
<a name="l01735"></a>01735       <span class="keywordflow">continue</span>;
<a name="l01736"></a>01736     }
<a name="l01737"></a>01737 
<a name="l01738"></a>01738     pollrtn = poll( &amp;<a class="code" href="lspmac_8c.html#adba7f5f4bbeabc4dac859221d4c684ba" title="our poll structure">pmacfd</a>, 1, 10);
<a name="l01739"></a>01739     <span class="keywordflow">if</span>( pollrtn) {
<a name="l01740"></a>01740       <a class="code" href="lspmac_8c.html#af3fa79868ba88f7c37f7b8f7d53149ff" title="Service routine for packet coming from the PMAC.">lspmac_Service</a>( &amp;<a class="code" href="lspmac_8c.html#adba7f5f4bbeabc4dac859221d4c684ba" title="our poll structure">pmacfd</a>);
<a name="l01741"></a>01741     }
<a name="l01742"></a>01742   }
<a name="l01743"></a>01743 }
<a name="l01744"></a>01744 
<a name="l01745"></a>01745 
<a name="l01746"></a>01746 
<a name="l01747"></a>01747 
<a name="l01748"></a>01748 
<a name="l01751"></a><a class="code" href="lspmac_8c.html#a7d601716497857c2b5c072c1aed37b71">01751</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#a7d601716497857c2b5c072c1aed37b71" title="Move method for dac motor objects (ie, lights).">lspmac_movedac_queue</a>(
<a name="l01752"></a>01752                           <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *mp,           
<a name="l01753"></a>01753                           <span class="keywordtype">double</span> requested_position     
<a name="l01754"></a>01754                           ) {
<a name="l01755"></a>01755   <span class="keywordtype">char</span> s[512];
<a name="l01756"></a>01756   <span class="keywordtype">double</span> y;
<a name="l01757"></a>01757 
<a name="l01758"></a>01758   pthread_mutex_lock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01759"></a>01759 
<a name="l01760"></a>01760   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#af8cdc94c6e2478b12ce942d4cf1d7499" title="The position as requested by the user.">requested_position</a> = requested_position;
<a name="l01761"></a>01761 
<a name="l01762"></a>01762   <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a11cbc6f50c150ed446e9a901cf7cc12b" title="length of lut">nlut</a> &gt; 0 &amp;&amp; mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a7b43671f7f3e06521f6cf91fb9ac707d" title="lookup table (instead of u2c)">lut</a> != NULL) {
<a name="l01763"></a>01763     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6e8dc9c11dc52a439fe9837230f93ce2" title="requested position">requested_pos_cnts</a> = <a class="code" href="lspmac_8c.html#a55b882be15d56a2a777f2b1f92901b7d" title="Look up table support for motor positions (think x=zoom, y=light intensity) use a...">lspmac_lut</a>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a11cbc6f50c150ed446e9a901cf7cc12b" title="length of lut">nlut</a>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a7b43671f7f3e06521f6cf91fb9ac707d" title="lookup table (instead of u2c)">lut</a>, requested_position);
<a name="l01764"></a>01764     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ab7bd8bff48953ce05c758598d75877ac" title="set to 1 when request is queued, zero after motion has toggled">not_done</a>    = 1;
<a name="l01765"></a>01765     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a68c471836f52707fa8582f7860cf500f" title="set to 1 when motion has been verified to have started">motion_seen</a> = 0;
<a name="l01766"></a>01766 
<a name="l01767"></a>01767 
<a name="l01768"></a>01768     <span class="comment">//</span>
<a name="l01769"></a>01769     <span class="comment">//  By convention requested_pos_cnts scales from 0 to 100</span>
<a name="l01770"></a>01770     <span class="comment">//  for the lights u2c converts this to 0 to 16,000</span>
<a name="l01771"></a>01771     <span class="comment">//  for the scintilator focus this is   0 to 32,000</span>
<a name="l01772"></a>01772     <span class="comment">//</span>
<a name="l01773"></a>01773     snprintf( s, <span class="keyword">sizeof</span>(s)-1, <span class="stringliteral">&quot;%s=%d&quot;</span>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a05dff021221abbc1bf656039fffb3275" title="controlling mvariable as a string">dac_mvar</a>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6e8dc9c11dc52a439fe9837230f93ce2" title="requested position">requested_pos_cnts</a>);
<a name="l01774"></a>01774     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae0a0c9264f49f51bf72168c3b62f8723" title="the queue item requesting motion. Used to check time request was made">pq</a> = <a class="code" href="lspmac_8c.html#ac4cf3a79186859714d8a8293377526ba" title="Send a command and ignore the response.">lspmac_SockSendline_nr</a>( s);
<a name="l01775"></a>01775 
<a name="l01776"></a>01776   }
<a name="l01777"></a>01777 
<a name="l01778"></a>01778   pthread_mutex_unlock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01779"></a>01779 }
<a name="l01780"></a>01780 
<a name="l01781"></a>01781 
<a name="l01784"></a><a class="code" href="lspmac_8c.html#ad6ae1e37afd118f24ab1c6878da53878">01784</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#ad6ae1e37afd118f24ab1c6878da53878" title="Move method for the zoom motor.">lspmac_movezoom_queue</a>(
<a name="l01785"></a>01785                            <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *mp,                  
<a name="l01786"></a>01786                            <span class="keywordtype">double</span> requested_position            
<a name="l01787"></a>01787                            ) {
<a name="l01788"></a>01788   <span class="keywordtype">char</span> s[512];
<a name="l01789"></a>01789   <span class="keywordtype">double</span> y;
<a name="l01790"></a>01790   <span class="keywordtype">int</span> blud;
<a name="l01791"></a>01791   pthread_mutex_lock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01792"></a>01792 
<a name="l01793"></a>01793   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#af8cdc94c6e2478b12ce942d4cf1d7499" title="The position as requested by the user.">requested_position</a> = requested_position;
<a name="l01794"></a>01794 
<a name="l01795"></a>01795   <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a11cbc6f50c150ed446e9a901cf7cc12b" title="length of lut">nlut</a> &gt; 0 &amp;&amp; mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a7b43671f7f3e06521f6cf91fb9ac707d" title="lookup table (instead of u2c)">lut</a> != NULL) {
<a name="l01796"></a>01796     y = <a class="code" href="lspmac_8c.html#a55b882be15d56a2a777f2b1f92901b7d" title="Look up table support for motor positions (think x=zoom, y=light intensity) use a...">lspmac_lut</a>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a11cbc6f50c150ed446e9a901cf7cc12b" title="length of lut">nlut</a>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a7b43671f7f3e06521f6cf91fb9ac707d" title="lookup table (instead of u2c)">lut</a>, requested_position);
<a name="l01797"></a>01797 
<a name="l01798"></a>01798     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6e8dc9c11dc52a439fe9837230f93ce2" title="requested position">requested_pos_cnts</a> = (int)y;
<a name="l01799"></a>01799     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ab7bd8bff48953ce05c758598d75877ac" title="set to 1 when request is queued, zero after motion has toggled">not_done</a>    = 1;
<a name="l01800"></a>01800     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a68c471836f52707fa8582f7860cf500f" title="set to 1 when motion has been verified to have started">motion_seen</a> = 0;
<a name="l01801"></a>01801 
<a name="l01802"></a>01802 
<a name="l01803"></a>01803     snprintf( s, <span class="keyword">sizeof</span>(s)-1, <span class="stringliteral">&quot;#%d j=%d&quot;</span>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a45fae17618f0c0827e97060dc04f79cb" title="pmac motor number">motor_num</a>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6e8dc9c11dc52a439fe9837230f93ce2" title="requested position">requested_pos_cnts</a>);
<a name="l01804"></a>01804     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae0a0c9264f49f51bf72168c3b62f8723" title="the queue item requesting motion. Used to check time request was made">pq</a> = <a class="code" href="lspmac_8c.html#ac4cf3a79186859714d8a8293377526ba" title="Send a command and ignore the response.">lspmac_SockSendline_nr</a>( s);
<a name="l01805"></a>01805 
<a name="l01806"></a>01806   }
<a name="l01807"></a>01807   pthread_mutex_unlock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01808"></a>01808 
<a name="l01809"></a>01809   <span class="comment">//</span>
<a name="l01810"></a>01810   <span class="comment">// the lights should &quot;move&quot; with the zoom motor</span>
<a name="l01811"></a>01811   <span class="comment">//</span>
<a name="l01812"></a>01812   <a class="code" href="lspmac_8c.html#a7d601716497857c2b5c072c1aed37b71" title="Move method for dac motor objects (ie, lights).">lspmac_movedac_queue</a>( flight, requested_position);
<a name="l01813"></a>01813 
<a name="l01814"></a>01814   pthread_mutex_lock( &amp;(blight_ud-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01815"></a>01815   blud = blight_ud-&gt;<a class="code" href="structlspmac__motor__struct.html#af8ffb3aed907d8664b65b37601954411" title="scaled position">position</a>;
<a name="l01816"></a>01816   pthread_mutex_unlock( &amp;(blight_ud-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01817"></a>01817 
<a name="l01818"></a>01818   <span class="keywordflow">if</span>( blud &gt; 0) {
<a name="l01819"></a>01819     <a class="code" href="lspmac_8c.html#a7d601716497857c2b5c072c1aed37b71" title="Move method for dac motor objects (ie, lights).">lspmac_movedac_queue</a>( blight, requested_position);
<a name="l01820"></a>01820   }
<a name="l01821"></a>01821 }
<a name="l01822"></a>01822 
<a name="l01828"></a><a class="code" href="lspmac_8c.html#ab9f114bba58e685760a518bd5f115d74">01828</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#ab9f114bba58e685760a518bd5f115d74" title="Move method for the fast shutter.">lspmac_moveabs_fshut_queue</a>(
<a name="l01829"></a>01829                                 <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *mp,             
<a name="l01830"></a>01830                                 <span class="keywordtype">double</span> requested_position       
<a name="l01831"></a>01831                                 ) {
<a name="l01832"></a>01832   pthread_mutex_lock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01833"></a>01833 
<a name="l01834"></a>01834   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#af8cdc94c6e2478b12ce942d4cf1d7499" title="The position as requested by the user.">requested_position</a> = requested_position;
<a name="l01835"></a>01835   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ab7bd8bff48953ce05c758598d75877ac" title="set to 1 when request is queued, zero after motion has toggled">not_done</a>    = 1;
<a name="l01836"></a>01836   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a68c471836f52707fa8582f7860cf500f" title="set to 1 when motion has been verified to have started">motion_seen</a> = 0;
<a name="l01837"></a>01837   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6e8dc9c11dc52a439fe9837230f93ce2" title="requested position">requested_pos_cnts</a> = requested_position;
<a name="l01838"></a>01838   <span class="keywordflow">if</span>( requested_position != 0) {
<a name="l01839"></a>01839     <span class="comment">//</span>
<a name="l01840"></a>01840     <span class="comment">// ScanEnable=0, ManualEnable=1, ManualOn=1</span>
<a name="l01841"></a>01841     <span class="comment">//</span>
<a name="l01842"></a>01842     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae0a0c9264f49f51bf72168c3b62f8723" title="the queue item requesting motion. Used to check time request was made">pq</a> = <a class="code" href="lspmac_8c.html#ac4cf3a79186859714d8a8293377526ba" title="Send a command and ignore the response.">lspmac_SockSendline_nr</a>( <span class="stringliteral">&quot;M1124=0 M1125=1 M1126=1&quot;</span>);
<a name="l01843"></a>01843   } <span class="keywordflow">else</span> {
<a name="l01844"></a>01844     <span class="comment">//</span>
<a name="l01845"></a>01845     <span class="comment">// ManualOn=0, ManualEnable=0, ScanEnable=1</span>
<a name="l01846"></a>01846     <span class="comment">//</span>
<a name="l01847"></a>01847     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae0a0c9264f49f51bf72168c3b62f8723" title="the queue item requesting motion. Used to check time request was made">pq</a> = <a class="code" href="lspmac_8c.html#ac4cf3a79186859714d8a8293377526ba" title="Send a command and ignore the response.">lspmac_SockSendline_nr</a>( <span class="stringliteral">&quot;M1126=0 M1125=0 M1124=1&quot;</span>);
<a name="l01848"></a>01848   }
<a name="l01849"></a>01849 
<a name="l01850"></a>01850   pthread_mutex_unlock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01851"></a>01851 }
<a name="l01852"></a>01852 
<a name="l01855"></a><a class="code" href="lspmac_8c.html#ad1167f01262cf6387e7e82a14d3e1a9d">01855</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#ad1167f01262cf6387e7e82a14d3e1a9d" title="Move method for binary i/o motor objects.">lspmac_moveabs_bio_queue</a>(
<a name="l01856"></a>01856                               <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *mp,               
<a name="l01857"></a>01857                               <span class="keywordtype">double</span> requested_position         
<a name="l01858"></a>01858                               ) {
<a name="l01859"></a>01859   pthread_mutex_lock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01860"></a>01860   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#af8cdc94c6e2478b12ce942d4cf1d7499" title="The position as requested by the user.">requested_position</a> = requested_position;
<a name="l01861"></a>01861   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ab7bd8bff48953ce05c758598d75877ac" title="set to 1 when request is queued, zero after motion has toggled">not_done</a>    = 1;
<a name="l01862"></a>01862   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a68c471836f52707fa8582f7860cf500f" title="set to 1 when motion has been verified to have started">motion_seen</a> = 0;
<a name="l01863"></a>01863   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6e8dc9c11dc52a439fe9837230f93ce2" title="requested position">requested_pos_cnts</a> = requested_position;
<a name="l01864"></a>01864   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae0a0c9264f49f51bf72168c3b62f8723" title="the queue item requesting motion. Used to check time request was made">pq</a> = <a class="code" href="lspmac_8c.html#ac4cf3a79186859714d8a8293377526ba" title="Send a command and ignore the response.">lspmac_SockSendline_nr</a>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a70291ddfe7994c0bec7fc2287cb6dd89" title="Format string to write requested position to PMAC used for binary io.">write_fmt</a>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6e8dc9c11dc52a439fe9837230f93ce2" title="requested position">requested_pos_cnts</a>);
<a name="l01865"></a>01865   pthread_mutex_unlock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01866"></a>01866 
<a name="l01867"></a>01867   <span class="keywordflow">if</span>( mp == blight_ud) {
<a name="l01868"></a>01868     <span class="keywordflow">if</span>( requested_position == 0) {
<a name="l01869"></a>01869       <a class="code" href="lspmac_8c.html#a7d601716497857c2b5c072c1aed37b71" title="Move method for dac motor objects (ie, lights).">lspmac_movedac_queue</a>( blight, 0);
<a name="l01870"></a>01870     } <span class="keywordflow">else</span> {
<a name="l01871"></a>01871       pthread_mutex_lock( &amp;(zoom-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01872"></a>01872       <a class="code" href="lspmac_8c.html#a7d601716497857c2b5c072c1aed37b71" title="Move method for dac motor objects (ie, lights).">lspmac_movedac_queue</a>( blight, zoom-&gt;<a class="code" href="structlspmac__motor__struct.html#af8ffb3aed907d8664b65b37601954411" title="scaled position">position</a>);
<a name="l01873"></a>01873       pthread_mutex_unlock( &amp;(zoom-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01874"></a>01874     }
<a name="l01875"></a>01875   }
<a name="l01876"></a>01876 }
<a name="l01877"></a>01877 
<a name="l01878"></a>01878 
<a name="l01881"></a><a class="code" href="lspmac_8c.html#aa4ea5a4c387ef167702c58eaddcb4151">01881</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#aa4ea5a4c387ef167702c58eaddcb4151" title="Move method for normal stepper and servo motor objects.">lspmac_moveabs_queue</a>(
<a name="l01882"></a>01882                           <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *mp,                   
<a name="l01883"></a>01883                           <span class="keywordtype">double</span> requested_position             
<a name="l01884"></a>01884                           ) {
<a name="l01885"></a>01885   <span class="keywordtype">char</span> s[512];
<a name="l01886"></a>01886 
<a name="l01887"></a>01887   pthread_mutex_lock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01888"></a>01888   mp-&gt;<a class="code" href="structlspmac__motor__struct.html#af8cdc94c6e2478b12ce942d4cf1d7499" title="The position as requested by the user.">requested_position</a> = requested_position;
<a name="l01889"></a>01889   <span class="keywordflow">if</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a61415627ab2dc0f438b190d117e532db" title="conversion from counts to units: 0.0 means not loaded yet">u2c</a> != 0.0) {
<a name="l01890"></a>01890     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ab7bd8bff48953ce05c758598d75877ac" title="set to 1 when request is queued, zero after motion has toggled">not_done</a>    = 1;
<a name="l01891"></a>01891     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a68c471836f52707fa8582f7860cf500f" title="set to 1 when motion has been verified to have started">motion_seen</a> = 0;
<a name="l01892"></a>01892     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6e8dc9c11dc52a439fe9837230f93ce2" title="requested position">requested_pos_cnts</a> = mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a61415627ab2dc0f438b190d117e532db" title="conversion from counts to units: 0.0 means not loaded yet">u2c</a> * requested_position;  
<a name="l01893"></a>01893     snprintf( s, <span class="keyword">sizeof</span>(s)-1, <span class="stringliteral">&quot;#%d j=%d&quot;</span>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a45fae17618f0c0827e97060dc04f79cb" title="pmac motor number">motor_num</a>, mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a6e8dc9c11dc52a439fe9837230f93ce2" title="requested position">requested_pos_cnts</a>);
<a name="l01894"></a>01894     mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae0a0c9264f49f51bf72168c3b62f8723" title="the queue item requesting motion. Used to check time request was made">pq</a> = <a class="code" href="lspmac_8c.html#ac4cf3a79186859714d8a8293377526ba" title="Send a command and ignore the response.">lspmac_SockSendline_nr</a>( s);
<a name="l01895"></a>01895   }
<a name="l01896"></a>01896   pthread_mutex_unlock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01897"></a>01897 }
<a name="l01898"></a>01898 
<a name="l01899"></a>01899 
<a name="l01900"></a>01900 
<a name="l01904"></a><a class="code" href="lspmac_8c.html#aae2282edace621ee65c682d03b7ccc36">01904</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#aae2282edace621ee65c682d03b7ccc36" title="Wait for motor to finish moving.">lspmac_moveabs_wait</a>(
<a name="l01905"></a>01905                          <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *mp             
<a name="l01906"></a>01906                          ) {
<a name="l01907"></a>01907   <span class="keyword">struct </span>timespec wt;
<a name="l01908"></a>01908   <span class="keywordtype">int</span> return_code;
<a name="l01909"></a>01909 
<a name="l01910"></a>01910   pthread_mutex_lock( &amp;<a class="code" href="lspmac_8c.html#acc1bb77b9bcbc4d970f841a41fd274b3" title="manage access to the pmac command queue">pmac_queue_mutex</a>);
<a name="l01911"></a>01911 
<a name="l01912"></a>01912   <span class="comment">//</span>
<a name="l01913"></a>01913   <span class="comment">// wait for the command to be sent</span>
<a name="l01914"></a>01914   <span class="comment">//</span>
<a name="l01915"></a>01915   <span class="keywordflow">while</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae0a0c9264f49f51bf72168c3b62f8723" title="the queue item requesting motion. Used to check time request was made">pq</a>-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a276ebc4b35c2554e4cb7377b60fd89b7" title="time this item was dequeued and sent to the pmac">time_sent</a>.tv_sec==0)
<a name="l01916"></a>01916     pthread_cond_wait( &amp;<a class="code" href="lspmac_8c.html#a8a25bd9c593c6985107f90f999ce0b08" title="wait for a command to be sent to PMAC before continuing">pmac_queue_cond</a>, &amp;<a class="code" href="lspmac_8c.html#acc1bb77b9bcbc4d970f841a41fd274b3" title="manage access to the pmac command queue">pmac_queue_mutex</a>);
<a name="l01917"></a>01917 
<a name="l01918"></a>01918   <span class="comment">//</span>
<a name="l01919"></a>01919   <span class="comment">// set the timeout to be long enough after we sent the motion request to ensure that</span>
<a name="l01920"></a>01920   <span class="comment">// we will have read back the motor moving status but not so long that the timeout causes</span>
<a name="l01921"></a>01921   <span class="comment">// problems;</span>
<a name="l01922"></a>01922   <span class="comment">//</span>
<a name="l01923"></a>01923   wt.tv_sec  = mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae0a0c9264f49f51bf72168c3b62f8723" title="the queue item requesting motion. Used to check time request was made">pq</a>-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a276ebc4b35c2554e4cb7377b60fd89b7" title="time this item was dequeued and sent to the pmac">time_sent</a>.tv_sec;
<a name="l01924"></a>01924   wt.tv_nsec = mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ae0a0c9264f49f51bf72168c3b62f8723" title="the queue item requesting motion. Used to check time request was made">pq</a>-&gt;<a class="code" href="structlspmac__cmd__queue__struct.html#a276ebc4b35c2554e4cb7377b60fd89b7" title="time this item was dequeued and sent to the pmac">time_sent</a>.tv_nsec + 500000000;
<a name="l01925"></a>01925 
<a name="l01926"></a>01926   pthread_mutex_unlock( &amp;<a class="code" href="lspmac_8c.html#acc1bb77b9bcbc4d970f841a41fd274b3" title="manage access to the pmac command queue">pmac_queue_mutex</a>);
<a name="l01927"></a>01927 
<a name="l01928"></a>01928   <span class="keywordflow">if</span>( wt.tv_nsec &gt;= 1000000000) {
<a name="l01929"></a>01929     wt.tv_nsec -= 1000000000;
<a name="l01930"></a>01930     wt.tv_sec += 1;
<a name="l01931"></a>01931   }
<a name="l01932"></a>01932 
<a name="l01933"></a>01933   <span class="comment">//</span>
<a name="l01934"></a>01934   <span class="comment">// wait for the motion to have started</span>
<a name="l01935"></a>01935   <span class="comment">// This will time out if the motion ends before we can read the status back</span>
<a name="l01936"></a>01936   <span class="comment">// hence the added complication of time stamp of the sent packet.</span>
<a name="l01937"></a>01937   <span class="comment">//</span>
<a name="l01938"></a>01938 
<a name="l01939"></a>01939   return_code=0;
<a name="l01940"></a>01940 
<a name="l01941"></a>01941   pthread_mutex_lock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01942"></a>01942   <span class="keywordflow">while</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a68c471836f52707fa8582f7860cf500f" title="set to 1 when motion has been verified to have started">motion_seen</a> == 0 &amp;&amp; return_code == 0)
<a name="l01943"></a>01943     return_code = pthread_cond_timedwait( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#aa0ea4108b8fed5b41ff91ca7266f3d84">cond</a>), &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>), &amp;wt);
<a name="l01944"></a>01944 
<a name="l01945"></a>01945   <span class="keywordflow">if</span>( return_code == 0) {
<a name="l01946"></a>01946     <span class="comment">//</span>
<a name="l01947"></a>01947     <span class="comment">// wait for the motion that we know has started to finish</span>
<a name="l01948"></a>01948     <span class="comment">//</span>
<a name="l01949"></a>01949     <span class="keywordflow">while</span>( mp-&gt;<a class="code" href="structlspmac__motor__struct.html#ab7bd8bff48953ce05c758598d75877ac" title="set to 1 when request is queued, zero after motion has toggled">not_done</a>)
<a name="l01950"></a>01950       pthread_cond_wait( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#aa0ea4108b8fed5b41ff91ca7266f3d84">cond</a>), &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01951"></a>01951 
<a name="l01952"></a>01952   }
<a name="l01953"></a>01953 
<a name="l01954"></a>01954   <span class="comment">//</span>
<a name="l01955"></a>01955   <span class="comment">// if return code was not 0 then we know we shouldn&apos;t wait for not_done flag.</span>
<a name="l01956"></a>01956   <span class="comment">// In this case the motion ended before we read the status that should the motor moving.</span>
<a name="l01957"></a>01957   <span class="comment">//</span>
<a name="l01958"></a>01958   pthread_mutex_unlock( &amp;(mp-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>));
<a name="l01959"></a>01959 
<a name="l01960"></a>01960 }
<a name="l01961"></a>01961 
<a name="l01962"></a>01962 
<a name="l01965"></a><a class="code" href="lspmac_8c.html#a45becc46f46e5aea14a388d3ec1b8b13">01965</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#a45becc46f46e5aea14a388d3ec1b8b13" title="Initialize a pmac stepper or servo motor.">lspmac_motor_init</a>(
<a name="l01966"></a>01966                                   <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *d,                            
<a name="l01967"></a>01967                                   <span class="keywordtype">int</span> motor_number,                             
<a name="l01968"></a>01968                                   <span class="keywordtype">int</span> wy,                                       
<a name="l01969"></a>01969                                   <span class="keywordtype">int</span> wx,                                       
<a name="l01970"></a>01970                                   <span class="keywordtype">int</span> *posp,                                    
<a name="l01971"></a>01971                                   <span class="keywordtype">int</span> *stat1p,                                  
<a name="l01972"></a>01972                                   <span class="keywordtype">int</span> *stat2p,                                  
<a name="l01973"></a>01973                                   <span class="keywordtype">char</span> *wtitle,                                 
<a name="l01974"></a>01974                                   <span class="keywordtype">char</span> *name,                                   
<a name="l01975"></a>01975                                   <span class="keywordtype">void</span> (*moveAbs)(<a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *,<span class="keywordtype">double</span>)      
<a name="l01976"></a>01976                                   ) {
<a name="l01977"></a>01977   <a class="code" href="lspmac_8c.html#a56260f012c50a591ee7f97e500f16994" title="The number of motors we manage.">lspmac_nmotors</a>++;
<a name="l01978"></a>01978 
<a name="l01979"></a>01979   pthread_mutex_init( &amp;(d-&gt;<a class="code" href="structlspmac__motor__struct.html#a188c5b1e991750ce2ffd53e0192e0907" title="coordinate waiting for motor to be done">mutex</a>), NULL);
<a name="l01980"></a>01980   pthread_cond_init(  &amp;(d-&gt;<a class="code" href="structlspmac__motor__struct.html#aa0ea4108b8fed5b41ff91ca7266f3d84">cond</a>), NULL);
<a name="l01981"></a>01981 
<a name="l01982"></a>01982   d-&gt;<a class="code" href="structlspmac__motor__struct.html#aa90af2f6f1489f1befe1d0891e51575a" title="Name of motor as refered by ls database kvs table.">name</a> = strdup(name);
<a name="l01983"></a>01983   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a20db3de86854b627815b3d940555ea75" title="function to move the motor">moveAbs</a> = moveAbs;
<a name="l01984"></a>01984   d-&gt;<a class="code" href="structlspmac__motor__struct.html#ac62692eb939c04ca35e939d1c3acfe8f" title="function to read the motor status and position">read</a> = <a class="code" href="lspmac_8c.html#a637fc023d1255f3519b2eee01913d64d" title="Read the position and status of a normal PMAC motor.">lspmac_pmacmotor_read</a>;
<a name="l01985"></a>01985   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a7b43671f7f3e06521f6cf91fb9ac707d" title="lookup table (instead of u2c)">lut</a> = NULL;
<a name="l01986"></a>01986   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a11cbc6f50c150ed446e9a901cf7cc12b" title="length of lut">nlut</a> = 0;
<a name="l01987"></a>01987   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a312047bb71def5cd2443fecd875eaea5" title="pointer to the md2_status structure to the actual position">actual_pos_cnts_p</a> = posp;
<a name="l01988"></a>01988   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a56c41875faf19c643e97c10519e6eb8c" title="First 24 bit PMAC motor status word.">status1_p</a>           = stat1p;
<a name="l01989"></a>01989   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a2b33ef6e12717459c1e9967cc6e659c6" title="Sectond 24 bit PMAC motor status word.">status2_p</a>           = stat2p;
<a name="l01990"></a>01990   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a45fae17618f0c0827e97060dc04f79cb" title="pmac motor number">motor_num</a> = motor_number;
<a name="l01991"></a>01991   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a05dff021221abbc1bf656039fffb3275" title="controlling mvariable as a string">dac_mvar</a>          = NULL;
<a name="l01992"></a>01992   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a133775154b0e008f3a2fde6f53bc0eff" title="our ncurses window">win</a> = newwin( <a class="code" href="pgpmac_8h.html#a3bae94e8e4e4347dd5f87b6bda058de6" title="Number of status box rows.">LS_DISPLAY_WINDOW_HEIGHT</a>, <a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>, wy*<a class="code" href="pgpmac_8h.html#a3bae94e8e4e4347dd5f87b6bda058de6" title="Number of status box rows.">LS_DISPLAY_WINDOW_HEIGHT</a>, wx*<a class="code" href="pgpmac_8h.html#a1f96754f00a1f82414cebc66f75ded78" title="Number of status box columns.">LS_DISPLAY_WINDOW_WIDTH</a>);
<a name="l01993"></a>01993   box( d-&gt;<a class="code" href="structlspmac__motor__struct.html#a133775154b0e008f3a2fde6f53bc0eff" title="our ncurses window">win</a>, 0, 0);
<a name="l01994"></a>01994   mvwprintw( d-&gt;<a class="code" href="structlspmac__motor__struct.html#a133775154b0e008f3a2fde6f53bc0eff" title="our ncurses window">win</a>, 1, 1, <span class="stringliteral">&quot;%s&quot;</span>, wtitle);
<a name="l01995"></a>01995   wnoutrefresh( d-&gt;<a class="code" href="structlspmac__motor__struct.html#a133775154b0e008f3a2fde6f53bc0eff" title="our ncurses window">win</a>);
<a name="l01996"></a>01996   d-&gt;<a class="code" href="structlspmac__motor__struct.html#aa74108855693f94fc2ff76333c9fb6ac" title="Homing routine started.">homing</a> = 0;
<a name="l01997"></a>01997   d-&gt;<a class="code" href="structlspmac__motor__struct.html#af11e5f75c1cf88ed6842d04154d27a31" title="bit flags: bit 0 = motor initialized by database, bit 1 = px.kvs value initialized...">lspg_initialized</a> = 0;
<a name="l01998"></a>01998 
<a name="l01999"></a>01999   <span class="keywordflow">return</span> d;
<a name="l02000"></a>02000 }
<a name="l02001"></a>02001 
<a name="l02004"></a><a class="code" href="lspmac_8c.html#a40aa4aeb5c799a6a3a089137da4fd6a8">02004</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#a40aa4aeb5c799a6a3a089137da4fd6a8" title="Initalize the fast shutter motor.">lspmac_fshut_init</a>(
<a name="l02005"></a>02005                                   <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *d             
<a name="l02006"></a>02006                                   ) {
<a name="l02007"></a>02007   <a class="code" href="lspmac_8c.html#a56260f012c50a591ee7f97e500f16994" title="The number of motors we manage.">lspmac_nmotors</a>++;
<a name="l02008"></a>02008   d-&gt;<a class="code" href="structlspmac__motor__struct.html#aa90af2f6f1489f1befe1d0891e51575a" title="Name of motor as refered by ls database kvs table.">name</a>           = strdup(<span class="stringliteral">&quot;fastShutter&quot;</span>);
<a name="l02009"></a>02009   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a20db3de86854b627815b3d940555ea75" title="function to move the motor">moveAbs</a>        = <a class="code" href="lspmac_8c.html#ab9f114bba58e685760a518bd5f115d74" title="Move method for the fast shutter.">lspmac_moveabs_fshut_queue</a>;
<a name="l02010"></a>02010   d-&gt;<a class="code" href="structlspmac__motor__struct.html#ac62692eb939c04ca35e939d1c3acfe8f" title="function to read the motor status and position">read</a>           = <a class="code" href="lspmac_8c.html#ab81f07dea6bb0e88103a05a380de1034" title="Fast shutter read routine The shutter is mildly complicated in that we need to take...">lspmac_shutter_read</a>;
<a name="l02011"></a>02011   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a7b43671f7f3e06521f6cf91fb9ac707d" title="lookup table (instead of u2c)">lut</a>            = NULL;
<a name="l02012"></a>02012   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a11cbc6f50c150ed446e9a901cf7cc12b" title="length of lut">nlut</a>           = 0;
<a name="l02013"></a>02013   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a312047bb71def5cd2443fecd875eaea5" title="pointer to the md2_status structure to the actual position">actual_pos_cnts_p</a> = NULL;
<a name="l02014"></a>02014   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a56c41875faf19c643e97c10519e6eb8c" title="First 24 bit PMAC motor status word.">status1_p</a>         = NULL;
<a name="l02015"></a>02015   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a2b33ef6e12717459c1e9967cc6e659c6" title="Sectond 24 bit PMAC motor status word.">status2_p</a>         = NULL;
<a name="l02016"></a>02016   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a45fae17618f0c0827e97060dc04f79cb" title="pmac motor number">motor_num</a>         = -1;
<a name="l02017"></a>02017   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a05dff021221abbc1bf656039fffb3275" title="controlling mvariable as a string">dac_mvar</a>          = NULL;
<a name="l02018"></a>02018   d-&gt;<a class="code" href="structlspmac__motor__struct.html#aa74108855693f94fc2ff76333c9fb6ac" title="Homing routine started.">homing</a>            = 0;
<a name="l02019"></a>02019   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a133775154b0e008f3a2fde6f53bc0eff" title="our ncurses window">win</a>               = NULL;
<a name="l02020"></a>02020 
<a name="l02021"></a>02021   d-&gt;<a class="code" href="structlspmac__motor__struct.html#af11e5f75c1cf88ed6842d04154d27a31" title="bit flags: bit 0 = motor initialized by database, bit 1 = px.kvs value initialized...">lspg_initialized</a> = 0;
<a name="l02022"></a>02022   <span class="keywordflow">return</span> d;
<a name="l02023"></a>02023 }
<a name="l02024"></a>02024 
<a name="l02025"></a>02025 
<a name="l02026"></a>02026 
<a name="l02027"></a>02027 
<a name="l02028"></a>02028 
<a name="l02032"></a><a class="code" href="lspmac_8c.html#a50e22adfb4d14499c1f5647458ca2ad9">02032</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#a50e22adfb4d14499c1f5647458ca2ad9" title="Initialize binary i/o motor.">lspmac_bio_init</a>(
<a name="l02033"></a>02033                                 <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *d,              
<a name="l02034"></a>02034                                 <span class="keywordtype">char</span> *name,                     
<a name="l02035"></a>02035                                 <span class="keywordtype">char</span> *write_fmt,                
<a name="l02036"></a>02036                                 <span class="keywordtype">int</span> *read_ptr,                  
<a name="l02037"></a>02037                                 <span class="keywordtype">int</span> read_mask                   
<a name="l02038"></a>02038                                 ) {
<a name="l02039"></a>02039   <a class="code" href="lspmac_8c.html#a56260f012c50a591ee7f97e500f16994" title="The number of motors we manage.">lspmac_nmotors</a>++;
<a name="l02040"></a>02040 
<a name="l02041"></a>02041   d-&gt;<a class="code" href="structlspmac__motor__struct.html#aa90af2f6f1489f1befe1d0891e51575a" title="Name of motor as refered by ls database kvs table.">name</a>              = strdup( name);
<a name="l02042"></a>02042   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a20db3de86854b627815b3d940555ea75" title="function to move the motor">moveAbs</a>           = <a class="code" href="lspmac_8c.html#ad1167f01262cf6387e7e82a14d3e1a9d" title="Move method for binary i/o motor objects.">lspmac_moveabs_bio_queue</a>;
<a name="l02043"></a>02043   d-&gt;<a class="code" href="structlspmac__motor__struct.html#ac62692eb939c04ca35e939d1c3acfe8f" title="function to read the motor status and position">read</a>              = <a class="code" href="lspmac_8c.html#a5945488310a5a8f616e6605782c7f1c9" title="Read the state of a binary i/o motor This is the read method for the binary i/o motor...">lspmac_bio_read</a>;
<a name="l02044"></a>02044   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a7b43671f7f3e06521f6cf91fb9ac707d" title="lookup table (instead of u2c)">lut</a>               = NULL;
<a name="l02045"></a>02045   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a11cbc6f50c150ed446e9a901cf7cc12b" title="length of lut">nlut</a>              = 0;
<a name="l02046"></a>02046   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a312047bb71def5cd2443fecd875eaea5" title="pointer to the md2_status structure to the actual position">actual_pos_cnts_p</a> = NULL;
<a name="l02047"></a>02047   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a56c41875faf19c643e97c10519e6eb8c" title="First 24 bit PMAC motor status word.">status1_p</a>         = NULL;
<a name="l02048"></a>02048   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a2b33ef6e12717459c1e9967cc6e659c6" title="Sectond 24 bit PMAC motor status word.">status2_p</a>         = NULL;
<a name="l02049"></a>02049   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a45fae17618f0c0827e97060dc04f79cb" title="pmac motor number">motor_num</a>         = -1;
<a name="l02050"></a>02050   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a05dff021221abbc1bf656039fffb3275" title="controlling mvariable as a string">dac_mvar</a>          = NULL;
<a name="l02051"></a>02051   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a133775154b0e008f3a2fde6f53bc0eff" title="our ncurses window">win</a>               = NULL;
<a name="l02052"></a>02052   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a70291ddfe7994c0bec7fc2287cb6dd89" title="Format string to write requested position to PMAC used for binary io.">write_fmt</a>         = strdup( write_fmt);
<a name="l02053"></a>02053   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a844b28ccabab5048ca216db074fb9704" title="With read_mask finds bit to read for binary i/o.">read_ptr</a>          = read_ptr;
<a name="l02054"></a>02054   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a3c24ed30c5a3ad490c6139b2780b2af7" title="WIth read_ptr find bit to read for binary i/o.">read_mask</a>         = read_mask;
<a name="l02055"></a>02055   d-&gt;<a class="code" href="structlspmac__motor__struct.html#aa74108855693f94fc2ff76333c9fb6ac" title="Homing routine started.">homing</a>            = 0;
<a name="l02056"></a>02056   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a133775154b0e008f3a2fde6f53bc0eff" title="our ncurses window">win</a>               = NULL;
<a name="l02057"></a>02057   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a61415627ab2dc0f438b190d117e532db" title="conversion from counts to units: 0.0 means not loaded yet">u2c</a>               = 1.0;
<a name="l02058"></a>02058 
<a name="l02059"></a>02059   d-&gt;<a class="code" href="structlspmac__motor__struct.html#af11e5f75c1cf88ed6842d04154d27a31" title="bit flags: bit 0 = motor initialized by database, bit 1 = px.kvs value initialized...">lspg_initialized</a> = 0;
<a name="l02060"></a>02060   <span class="keywordflow">return</span> d;
<a name="l02061"></a>02061 }
<a name="l02062"></a>02062 
<a name="l02063"></a>02063 
<a name="l02070"></a><a class="code" href="lspmac_8c.html#a6d88f6db90e4a7219a237b183d10a27d">02070</a> <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *<a class="code" href="lspmac_8c.html#a6d88f6db90e4a7219a237b183d10a27d" title="Initialize DAC motor Note that some motors require further initialization from a...">lspmac_dac_init</a>(
<a name="l02072"></a>02072                                 <a class="code" href="structlspmac__motor__struct.html" title="Motor information.">lspmac_motor_t</a> *d,              
<a name="l02073"></a>02073                                 <span class="keywordtype">int</span> *posp,                      
<a name="l02074"></a>02074                                 <span class="keywordtype">double</span> scale,                   
<a name="l02075"></a>02075                                 <span class="keywordtype">char</span> *mvar,                     
<a name="l02076"></a>02076                                 <span class="keywordtype">char</span> *name                      
<a name="l02077"></a>02077                                 ) {
<a name="l02078"></a>02078   <a class="code" href="lspmac_8c.html#a56260f012c50a591ee7f97e500f16994" title="The number of motors we manage.">lspmac_nmotors</a>++;
<a name="l02079"></a>02079   d-&gt;<a class="code" href="structlspmac__motor__struct.html#aa90af2f6f1489f1befe1d0891e51575a" title="Name of motor as refered by ls database kvs table.">name</a>     = strdup( name);
<a name="l02080"></a>02080   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a20db3de86854b627815b3d940555ea75" title="function to move the motor">moveAbs</a>  = <a class="code" href="lspmac_8c.html#a7d601716497857c2b5c072c1aed37b71" title="Move method for dac motor objects (ie, lights).">lspmac_movedac_queue</a>;
<a name="l02081"></a>02081   d-&gt;<a class="code" href="structlspmac__motor__struct.html#ac62692eb939c04ca35e939d1c3acfe8f" title="function to read the motor status and position">read</a>     = <a class="code" href="lspmac_8c.html#a200bc9306d54fca566eb5e29d8e82308" title="Read a DAC motor position.">lspmac_dac_read</a>;
<a name="l02082"></a>02082   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a7b43671f7f3e06521f6cf91fb9ac707d" title="lookup table (instead of u2c)">lut</a>      = NULL;
<a name="l02083"></a>02083   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a11cbc6f50c150ed446e9a901cf7cc12b" title="length of lut">nlut</a>     = 0;
<a name="l02084"></a>02084   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a312047bb71def5cd2443fecd875eaea5" title="pointer to the md2_status structure to the actual position">actual_pos_cnts_p</a> = posp;
<a name="l02085"></a>02085   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a56c41875faf19c643e97c10519e6eb8c" title="First 24 bit PMAC motor status word.">status1_p</a>         = NULL;
<a name="l02086"></a>02086   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a2b33ef6e12717459c1e9967cc6e659c6" title="Sectond 24 bit PMAC motor status word.">status2_p</a>         = NULL;
<a name="l02087"></a>02087   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a45fae17618f0c0827e97060dc04f79cb" title="pmac motor number">motor_num</a>         = -1;
<a name="l02088"></a>02088   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a05dff021221abbc1bf656039fffb3275" title="controlling mvariable as a string">dac_mvar</a>          = strdup(mvar);
<a name="l02089"></a>02089   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a61415627ab2dc0f438b190d117e532db" title="conversion from counts to units: 0.0 means not loaded yet">u2c</a>               = scale;
<a name="l02090"></a>02090   d-&gt;<a class="code" href="structlspmac__motor__struct.html#aa74108855693f94fc2ff76333c9fb6ac" title="Homing routine started.">homing</a>            = 0;
<a name="l02091"></a>02091   d-&gt;<a class="code" href="structlspmac__motor__struct.html#a133775154b0e008f3a2fde6f53bc0eff" title="our ncurses window">win</a>               = NULL;
<a name="l02092"></a>02092 
<a name="l02093"></a>02093   d-&gt;<a class="code" href="structlspmac__motor__struct.html#af11e5f75c1cf88ed6842d04154d27a31" title="bit flags: bit 0 = motor initialized by database, bit 1 = px.kvs value initialized...">lspg_initialized</a> = 0;
<a name="l02094"></a>02094   <span class="keywordflow">return</span> d;
<a name="l02095"></a>02095 }
<a name="l02096"></a>02096 
<a name="l02097"></a>02097 
<a name="l02100"></a><a class="code" href="pgpmac_8h.html#ae3e30b0ba9b5d5a291fa29b77ba920d8">02100</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#a236945579e57dbb30c0b64f5b9184e9d" title="Initialize this module.">lspmac_init</a>(
<a name="l02101"></a>02101                  <span class="keywordtype">int</span> ivarsflag,         
<a name="l02102"></a>02102                  <span class="keywordtype">int</span> mvarsflag          
<a name="l02103"></a>02103                  ) {
<a name="l02104"></a>02104   <a class="code" href="structmd2StatusStruct.html" title="The block of memory retrieved in a status request.">md2_status_t</a> *p;
<a name="l02105"></a>02105 
<a name="l02106"></a>02106   <span class="comment">// Set our global harvest flags</span>
<a name="l02107"></a>02107   <a class="code" href="lspmac_8c.html#a07b7b8254772075e6a4ced500b589c36" title="flag set at initialization to send i vars to db">getivars</a> = ivarsflag;
<a name="l02108"></a>02108   <a class="code" href="lspmac_8c.html#a50e9c0a06654fd81b3446a6e54ff12c3" title="flag set at initialization to send m vars to db">getmvars</a> = mvarsflag;
<a name="l02109"></a>02109 
<a name="l02110"></a>02110   <span class="comment">// All important status mutex</span>
<a name="l02111"></a>02111   pthread_mutex_init( &amp;<a class="code" href="lspmac_8c.html#a7a3e763682bd7f987d07f149e94b3bf8" title="Synchronize reading/writting status buffer.">md2_status_mutex</a>, NULL);
<a name="l02112"></a>02112 
<a name="l02113"></a>02113   <span class="comment">//</span>
<a name="l02114"></a>02114   <span class="comment">// Initialize the motor objects</span>
<a name="l02115"></a>02115   <span class="comment">//</span>
<a name="l02116"></a>02116 
<a name="l02117"></a>02117   p = &amp;md2_status;
<a name="l02118"></a>02118 
<a name="l02119"></a>02119   omega  = <a class="code" href="lspmac_8c.html#a45becc46f46e5aea14a388d3ec1b8b13" title="Initialize a pmac stepper or servo motor.">lspmac_motor_init</a>( &amp;(lspmac_motors[ 0]),  1, 0, 0, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a6ce303bec89082cae1e9b1fddf6b6c10">omega_act_pos</a>,     &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#af6cf3cd65b9ef205685a0d970f168907">omega_status_1</a>,     &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a8577c9df7b663b548b2759ac3db721cd">omega_status_2</a>,     <span class="stringliteral">&quot;Omega   #1 &amp;1 X&quot;</span>, <span class="stringliteral">&quot;omega&quot;</span>,       <a class="code" href="lspmac_8c.html#aa4ea5a4c387ef167702c58eaddcb4151" title="Move method for normal stepper and servo motor objects.">lspmac_moveabs_queue</a>);
<a name="l02120"></a>02120   alignx = <a class="code" href="lspmac_8c.html#a45becc46f46e5aea14a388d3ec1b8b13" title="Initialize a pmac stepper or servo motor.">lspmac_motor_init</a>( &amp;(lspmac_motors[ 1]),  2, 0, 1, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a9653a75bc0b66c5f86d8b0206dc39b4f">alignx_act_pos</a>,    &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a56accf8cb00c59bff87ed75df7dafbbe">alignx_status_1</a>,    &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a2feb35ceab8129fd2cc34d1104af8b8f">alignx_status_2</a>,    <span class="stringliteral">&quot;Align X #2 &amp;3 X&quot;</span>, <span class="stringliteral">&quot;align.x&quot;</span>,     <a class="code" href="lspmac_8c.html#aa4ea5a4c387ef167702c58eaddcb4151" title="Move method for normal stepper and servo motor objects.">lspmac_moveabs_queue</a>);
<a name="l02121"></a>02121   aligny = <a class="code" href="lspmac_8c.html#a45becc46f46e5aea14a388d3ec1b8b13" title="Initialize a pmac stepper or servo motor.">lspmac_motor_init</a>( &amp;(lspmac_motors[ 2]),  3, 0, 2, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a0d40a01d2aa93c443526e826440f77fc">aligny_act_pos</a>,    &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a2f2a11fe2fc7a446323def2be465185a">aligny_status_1</a>,    &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a1f98d8b9831e32d77129f9b0f1d7d255">aligny_status_2</a>,    <span class="stringliteral">&quot;Align Y #3 &amp;3 Y&quot;</span>, <span class="stringliteral">&quot;align.y&quot;</span>,     <a class="code" href="lspmac_8c.html#aa4ea5a4c387ef167702c58eaddcb4151" title="Move method for normal stepper and servo motor objects.">lspmac_moveabs_queue</a>);
<a name="l02122"></a>02122   alignz = <a class="code" href="lspmac_8c.html#a45becc46f46e5aea14a388d3ec1b8b13" title="Initialize a pmac stepper or servo motor.">lspmac_motor_init</a>( &amp;(lspmac_motors[ 3]),  4, 0, 3, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a480f892fe91b05b2980fb00064807e2b">alignz_act_pos</a>,    &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#aadbfac5709de57e449a37e2937d6ade7">alignz_status_1</a>,    &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#ac378da16eeaab2bc47f3f8f88f7411ed">alignz_status_2</a>,    <span class="stringliteral">&quot;Align Z #4 &amp;3 Z&quot;</span>, <span class="stringliteral">&quot;align.z&quot;</span>,     <a class="code" href="lspmac_8c.html#aa4ea5a4c387ef167702c58eaddcb4151" title="Move method for normal stepper and servo motor objects.">lspmac_moveabs_queue</a>);
<a name="l02123"></a>02123   anal   = <a class="code" href="lspmac_8c.html#a45becc46f46e5aea14a388d3ec1b8b13" title="Initialize a pmac stepper or servo motor.">lspmac_motor_init</a>( &amp;(lspmac_motors[ 4]),  5, 0, 4, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a49d1151b0e819646587be0ca9c9d612a">analyzer_act_pos</a>,  &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#ab876b484f55bcce576fcd89dcc3f7267">analyzer_status_1</a>,  &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a4f88bb778e4e18f1fbf7672ac11e7433">analyzer_status_2</a>,  <span class="stringliteral">&quot;Anal    #5&quot;</span>,      <span class="stringliteral">&quot;lightPolar&quot;</span>,  <a class="code" href="lspmac_8c.html#aa4ea5a4c387ef167702c58eaddcb4151" title="Move method for normal stepper and servo motor objects.">lspmac_moveabs_queue</a>);
<a name="l02124"></a>02124   zoom   = <a class="code" href="lspmac_8c.html#a45becc46f46e5aea14a388d3ec1b8b13" title="Initialize a pmac stepper or servo motor.">lspmac_motor_init</a>( &amp;(lspmac_motors[ 5]),  6, 1, 0, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a920b80e9f5f08aedac3ad541d5ffc8ae">zoom_act_pos</a>,      &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#af28e978b761dc07eefed3971547cfd4d">zoom_status_1</a>,      &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a34e4200315a083deb8a970e21bbbe277">zoom_status_2</a>,      <span class="stringliteral">&quot;Zoom    #6 &amp;4 Z&quot;</span>, <span class="stringliteral">&quot;zoom&quot;</span>,        <a class="code" href="lspmac_8c.html#ad6ae1e37afd118f24ab1c6878da53878" title="Move method for the zoom motor.">lspmac_movezoom_queue</a>);
<a name="l02125"></a>02125   apery  = <a class="code" href="lspmac_8c.html#a45becc46f46e5aea14a388d3ec1b8b13" title="Initialize a pmac stepper or servo motor.">lspmac_motor_init</a>( &amp;(lspmac_motors[ 6]),  7, 1, 1, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a2a434d2b57dbb669de0765486a1516ff">aperturey_act_pos</a>, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a2ef953eaddf7058bf4276585e6ff066b">aperturey_status_1</a>, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a0a7738f13a0fa80626cafc2299b104b4">aperturey_status_2</a>, <span class="stringliteral">&quot;Aper Y  #7 &amp;5 Y&quot;</span>, <span class="stringliteral">&quot;appy&quot;</span>,        <a class="code" href="lspmac_8c.html#aa4ea5a4c387ef167702c58eaddcb4151" title="Move method for normal stepper and servo motor objects.">lspmac_moveabs_queue</a>);
<a name="l02126"></a>02126   aperz  = <a class="code" href="lspmac_8c.html#a45becc46f46e5aea14a388d3ec1b8b13" title="Initialize a pmac stepper or servo motor.">lspmac_motor_init</a>( &amp;(lspmac_motors[ 7]),  8, 1, 2, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a62d584ce23cfd9aa626d3c03649b455c">aperturez_act_pos</a>, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a27880dd795e1ba4fea4870c64ee3aa84">aperturez_status_1</a>, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#ae407a99e428d9f4a7444a02c8bc3414e">aperturez_status_2</a>, <span class="stringliteral">&quot;Aper Z  #8 &amp;5 Z&quot;</span>, <span class="stringliteral">&quot;appz&quot;</span>,        <a class="code" href="lspmac_8c.html#aa4ea5a4c387ef167702c58eaddcb4151" title="Move method for normal stepper and servo motor objects.">lspmac_moveabs_queue</a>);
<a name="l02127"></a>02127   capy   = <a class="code" href="lspmac_8c.html#a45becc46f46e5aea14a388d3ec1b8b13" title="Initialize a pmac stepper or servo motor.">lspmac_motor_init</a>( &amp;(lspmac_motors[ 8]),  9, 1, 3, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#ae25122a6db146501b51609b9cb59b044">capy_act_pos</a>,      &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a7f4e945e80b1980b9e69366a69ad79cc">capy_status_1</a>,      &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a5d7c10d9a16ebcc53ac4a0770ab2ef62">capy_status_2</a>,      <span class="stringliteral">&quot;Cap Y   #9 &amp;5 U&quot;</span>, <span class="stringliteral">&quot;capy&quot;</span>,        <a class="code" href="lspmac_8c.html#aa4ea5a4c387ef167702c58eaddcb4151" title="Move method for normal stepper and servo motor objects.">lspmac_moveabs_queue</a>);
<a name="l02128"></a>02128   capz   = <a class="code" href="lspmac_8c.html#a45becc46f46e5aea14a388d3ec1b8b13" title="Initialize a pmac stepper or servo motor.">lspmac_motor_init</a>( &amp;(lspmac_motors[ 9]), 10, 1, 4, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a257c04efac3a33d5d34b21d64c6f1266">capz_act_pos</a>,      &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a719db4477f35331eaa8b7b44150e88a2">capz_status_1</a>,      &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a3abb998bb89433aed16121d0dae6275a">capz_status_2</a>,      <span class="stringliteral">&quot;Cap Z  #10 &amp;5 V&quot;</span>, <span class="stringliteral">&quot;capz&quot;</span>,        <a class="code" href="lspmac_8c.html#aa4ea5a4c387ef167702c58eaddcb4151" title="Move method for normal stepper and servo motor objects.">lspmac_moveabs_queue</a>);
<a name="l02129"></a>02129   scinz  = <a class="code" href="lspmac_8c.html#a45becc46f46e5aea14a388d3ec1b8b13" title="Initialize a pmac stepper or servo motor.">lspmac_motor_init</a>( &amp;(lspmac_motors[10]), 11, 2, 0, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a1c146fc792c4285eed5b2c446c214f98">scint_act_pos</a>,     &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a1723870357f428ac5c2758a2c9a475c7">scint_status_1</a>,     &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a4e5bc72e2f4007370f1c29ea272c952f">scint_status_2</a>,     <span class="stringliteral">&quot;Scin Z #11 &amp;5 W&quot;</span>, <span class="stringliteral">&quot;scint&quot;</span>,       <a class="code" href="lspmac_8c.html#aa4ea5a4c387ef167702c58eaddcb4151" title="Move method for normal stepper and servo motor objects.">lspmac_moveabs_queue</a>);
<a name="l02130"></a>02130   cenx   = <a class="code" href="lspmac_8c.html#a45becc46f46e5aea14a388d3ec1b8b13" title="Initialize a pmac stepper or servo motor.">lspmac_motor_init</a>( &amp;(lspmac_motors[11]), 17, 2, 1, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#ae7924b6e91e1de82f6f7910cb3a9c9bd">centerx_act_pos</a>,   &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#aa619cdbd7a563408c6b825ddc4f74ebb">centerx_status_1</a>,   &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#ae4fad6debe138ed7815d463e83f8d0f6">centerx_status_2</a>,   <span class="stringliteral">&quot;Cen X  #17 &amp;2 X&quot;</span>, <span class="stringliteral">&quot;centering.x&quot;</span>, <a class="code" href="lspmac_8c.html#aa4ea5a4c387ef167702c58eaddcb4151" title="Move method for normal stepper and servo motor objects.">lspmac_moveabs_queue</a>);
<a name="l02131"></a>02131   ceny   = <a class="code" href="lspmac_8c.html#a45becc46f46e5aea14a388d3ec1b8b13" title="Initialize a pmac stepper or servo motor.">lspmac_motor_init</a>( &amp;(lspmac_motors[12]), 18, 2, 2, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a6be71a92a599d490ca808af8c7e7faa0">centery_act_pos</a>,   &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a57f65ebe28ef88f1c632d9f35d9167eb">centery_status_1</a>,   &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#aa242098c185cce8f852cd6e081ef0b1d">centery_status_2</a>,   <span class="stringliteral">&quot;Cen Y  #18 &amp;2 Y&quot;</span>, <span class="stringliteral">&quot;centering.y&quot;</span>, <a class="code" href="lspmac_8c.html#aa4ea5a4c387ef167702c58eaddcb4151" title="Move method for normal stepper and servo motor objects.">lspmac_moveabs_queue</a>);
<a name="l02132"></a>02132   kappa  = <a class="code" href="lspmac_8c.html#a45becc46f46e5aea14a388d3ec1b8b13" title="Initialize a pmac stepper or servo motor.">lspmac_motor_init</a>( &amp;(lspmac_motors[13]), 19, 2, 3, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#ac384fb7073387dd5dcb2e85a00ec8a77">kappa_act_pos</a>,     &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#ab152694bc32d37c1d180f55e8d282020">kappa_status_1</a>,     &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#af6891f5f8dcfc62668f64c583042c6bc">kappa_status_2</a>,     <span class="stringliteral">&quot;Kappa  #19 &amp;7 X&quot;</span>, <span class="stringliteral">&quot;kappa&quot;</span>,       <a class="code" href="lspmac_8c.html#aa4ea5a4c387ef167702c58eaddcb4151" title="Move method for normal stepper and servo motor objects.">lspmac_moveabs_queue</a>);
<a name="l02133"></a>02133   phi    = <a class="code" href="lspmac_8c.html#a45becc46f46e5aea14a388d3ec1b8b13" title="Initialize a pmac stepper or servo motor.">lspmac_motor_init</a>( &amp;(lspmac_motors[14]), 20, 2, 4, &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a4de22995a72ff6e72a1a9ccab6d00620">phi_act_pos</a>,       &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#ad8b8fd90ffff43016e2adaab5ccbfa02">phi_status_1</a>,       &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a0e6cea4c32cb34e602b9ac3d21259219">phi_status_2</a>,       <span class="stringliteral">&quot;Phi    #20 &amp;7 Y&quot;</span>, <span class="stringliteral">&quot;phi&quot;</span>,         <a class="code" href="lspmac_8c.html#aa4ea5a4c387ef167702c58eaddcb4151" title="Move method for normal stepper and servo motor objects.">lspmac_moveabs_queue</a>);
<a name="l02134"></a>02134 
<a name="l02135"></a>02135   fshut  = <a class="code" href="lspmac_8c.html#a40aa4aeb5c799a6a3a089137da4fd6a8" title="Initalize the fast shutter motor.">lspmac_fshut_init</a>( &amp;(lspmac_motors[15]));
<a name="l02136"></a>02136   flight = <a class="code" href="lspmac_8c.html#a6d88f6db90e4a7219a237b183d10a27d" title="Initialize DAC motor Note that some motors require further initialization from a...">lspmac_dac_init</a>( &amp;(lspmac_motors[16]), &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a3be73c48b09190241a2bcb801af5b97c">front_dac</a>,   160.0, <span class="stringliteral">&quot;M1200&quot;</span>, <span class="stringliteral">&quot;frontLight.intensity&quot;</span>);
<a name="l02137"></a>02137   blight = <a class="code" href="lspmac_8c.html#a6d88f6db90e4a7219a237b183d10a27d" title="Initialize DAC motor Note that some motors require further initialization from a...">lspmac_dac_init</a>( &amp;(lspmac_motors[17]), &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a33ce490348c8de255cf49b96469d3d4e">back_dac</a>,    160.0, <span class="stringliteral">&quot;M1201&quot;</span>, <span class="stringliteral">&quot;backLight.intensity&quot;</span>);
<a name="l02138"></a>02138   fscint = <a class="code" href="lspmac_8c.html#a6d88f6db90e4a7219a237b183d10a27d" title="Initialize DAC motor Note that some motors require further initialization from a...">lspmac_dac_init</a>( &amp;(lspmac_motors[18]), &amp;p-&gt;<a class="code" href="structmd2StatusStruct.html#a031be48adfa016c637d6eae49054c435">scint_piezo</a>, 320.0, <span class="stringliteral">&quot;M1203&quot;</span>, <span class="stringliteral">&quot;scint.focus&quot;</span>);
<a name="l02139"></a>02139 
<a name="l02140"></a>02140   blight_ud = <a class="code" href="lspmac_8c.html#a50e22adfb4d14499c1f5647458ca2ad9" title="Initialize binary i/o motor.">lspmac_bio_init</a>( &amp;(lspmac_motors[19]), <span class="stringliteral">&quot;backLight&quot;</span>, <span class="stringliteral">&quot;M1101=%d&quot;</span>, &amp;(md2_status.<a class="code" href="structmd2StatusStruct.html#ab09c1342dc12052b8f5b35f78ef95000">acc11c_5</a>), 0x02);
<a name="l02141"></a>02141   cryo      = <a class="code" href="lspmac_8c.html#a50e22adfb4d14499c1f5647458ca2ad9" title="Initialize binary i/o motor.">lspmac_bio_init</a>( &amp;(lspmac_motors[20]), <span class="stringliteral">&quot;cryo&quot;</span>,      <span class="stringliteral">&quot;M1102=%d&quot;</span>, &amp;(md2_status.<a class="code" href="structmd2StatusStruct.html#a69fc2e30a5de0a11c992d133e7a761cd">acc11c_1</a>), 0x40);
<a name="l02142"></a>02142   dryer     = <a class="code" href="lspmac_8c.html#a50e22adfb4d14499c1f5647458ca2ad9" title="Initialize binary i/o motor.">lspmac_bio_init</a>( &amp;(lspmac_motors[21]), <span class="stringliteral">&quot;dryer&quot;</span>,     <span class="stringliteral">&quot;M1103=%d&quot;</span>, &amp;(md2_status.<a class="code" href="structmd2StatusStruct.html#ab09c1342dc12052b8f5b35f78ef95000">acc11c_5</a>), 0x08);
<a name="l02143"></a>02143 
<a name="l02144"></a>02144 
<a name="l02145"></a>02145 
<a name="l02146"></a>02146 
<a name="l02147"></a>02147   <span class="comment">//</span>
<a name="l02148"></a>02148   <span class="comment">// Initialize several commands that get called, perhaps, alot</span>
<a name="l02149"></a>02149   <span class="comment">//</span>
<a name="l02150"></a>02150   rr_cmd.<a class="code" href="structtagEthernetCmd.html#a6a155eb3ae546dd29369c4a33ddb3310" title="VR_UPLOAD or VR_DOWNLOAD.">RequestType</a> = <a class="code" href="lspmac_8c.html#a5485d08fdc80533b5cebadff63696ed2">VR_UPLOAD</a>;
<a name="l02151"></a>02151   rr_cmd.<a class="code" href="structtagEthernetCmd.html#a0dc566e7edbb226f1a4ea443d93d56e2" title="The command to run (VR_PMAC_GETMEM, etc).">Request</a>     = <a class="code" href="lspmac_8c.html#aad3c7b4a9403e56c09eceadcf21252c0">VR_PMAC_READREADY</a>;
<a name="l02152"></a>02152   rr_cmd.<a class="code" href="structtagEthernetCmd.html#aec0ee9a5f6c7e3bc6e4bd98f1bd52783" title="Command parameter 1.">wValue</a>      = 0;
<a name="l02153"></a>02153   rr_cmd.<a class="code" href="structtagEthernetCmd.html#a92f5a374e87d4f496b64b4888850d6e6" title="Command parameter 2.">wIndex</a>      = 0;
<a name="l02154"></a>02154   rr_cmd.<a class="code" href="structtagEthernetCmd.html#af5df25ff13ca30fa33719d0df1ab7e97" title="Number of bytes in bData.">wLength</a>     = htons(2);
<a name="l02155"></a>02155   memset( rr_cmd.<a class="code" href="structtagEthernetCmd.html#a872dab798127d6f589974a79c5d0aef1" title="The data buffer, if required.">bData</a>, 0, <span class="keyword">sizeof</span>(rr_cmd.<a class="code" href="structtagEthernetCmd.html#a872dab798127d6f589974a79c5d0aef1" title="The data buffer, if required.">bData</a>));
<a name="l02156"></a>02156 
<a name="l02157"></a>02157   gb_cmd.<a class="code" href="structtagEthernetCmd.html#a6a155eb3ae546dd29369c4a33ddb3310" title="VR_UPLOAD or VR_DOWNLOAD.">RequestType</a> = <a class="code" href="lspmac_8c.html#a5485d08fdc80533b5cebadff63696ed2">VR_UPLOAD</a>;
<a name="l02158"></a>02158   gb_cmd.<a class="code" href="structtagEthernetCmd.html#a0dc566e7edbb226f1a4ea443d93d56e2" title="The command to run (VR_PMAC_GETMEM, etc).">Request</a>     = <a class="code" href="lspmac_8c.html#a50e444b5ceb6d62a1be43c88c55c549c">VR_PMAC_GETBUFFER</a>;
<a name="l02159"></a>02159   gb_cmd.<a class="code" href="structtagEthernetCmd.html#aec0ee9a5f6c7e3bc6e4bd98f1bd52783" title="Command parameter 1.">wValue</a>      = 0;
<a name="l02160"></a>02160   gb_cmd.<a class="code" href="structtagEthernetCmd.html#a92f5a374e87d4f496b64b4888850d6e6" title="Command parameter 2.">wIndex</a>      = 0;
<a name="l02161"></a>02161   gb_cmd.<a class="code" href="structtagEthernetCmd.html#af5df25ff13ca30fa33719d0df1ab7e97" title="Number of bytes in bData.">wLength</a>     = htons(1400);
<a name="l02162"></a>02162   memset( gb_cmd.<a class="code" href="structtagEthernetCmd.html#a872dab798127d6f589974a79c5d0aef1" title="The data buffer, if required.">bData</a>, 0, <span class="keyword">sizeof</span>(gb_cmd.<a class="code" href="structtagEthernetCmd.html#a872dab798127d6f589974a79c5d0aef1" title="The data buffer, if required.">bData</a>));
<a name="l02163"></a>02163 
<a name="l02164"></a>02164   cr_cmd.<a class="code" href="structtagEthernetCmd.html#a6a155eb3ae546dd29369c4a33ddb3310" title="VR_UPLOAD or VR_DOWNLOAD.">RequestType</a> = <a class="code" href="lspmac_8c.html#a5485d08fdc80533b5cebadff63696ed2">VR_UPLOAD</a>;
<a name="l02165"></a>02165   cr_cmd.<a class="code" href="structtagEthernetCmd.html#a0dc566e7edbb226f1a4ea443d93d56e2" title="The command to run (VR_PMAC_GETMEM, etc).">Request</a>     = <a class="code" href="lspmac_8c.html#a8f4ce4666a23a3fb153d680bd1cb6556">VR_CTRL_RESPONSE</a>;
<a name="l02166"></a>02166   cr_cmd.<a class="code" href="structtagEthernetCmd.html#aec0ee9a5f6c7e3bc6e4bd98f1bd52783" title="Command parameter 1.">wValue</a>      = 0;
<a name="l02167"></a>02167   cr_cmd.<a class="code" href="structtagEthernetCmd.html#a92f5a374e87d4f496b64b4888850d6e6" title="Command parameter 2.">wIndex</a>      = 0;
<a name="l02168"></a>02168   cr_cmd.<a class="code" href="structtagEthernetCmd.html#af5df25ff13ca30fa33719d0df1ab7e97" title="Number of bytes in bData.">wLength</a>     = htons(1400);
<a name="l02169"></a>02169   memset( cr_cmd.<a class="code" href="structtagEthernetCmd.html#a872dab798127d6f589974a79c5d0aef1" title="The data buffer, if required.">bData</a>, 0, <span class="keyword">sizeof</span>(cr_cmd.<a class="code" href="structtagEthernetCmd.html#a872dab798127d6f589974a79c5d0aef1" title="The data buffer, if required.">bData</a>));
<a name="l02170"></a>02170 
<a name="l02171"></a>02171   <span class="comment">//</span>
<a name="l02172"></a>02172   <span class="comment">// Initialize some mutexs and conditions</span>
<a name="l02173"></a>02173   <span class="comment">//</span>
<a name="l02174"></a>02174 
<a name="l02175"></a>02175   pthread_mutex_init( &amp;<a class="code" href="lspmac_8c.html#acc1bb77b9bcbc4d970f841a41fd274b3" title="manage access to the pmac command queue">pmac_queue_mutex</a>, NULL);
<a name="l02176"></a>02176   pthread_cond_init(  &amp;<a class="code" href="lspmac_8c.html#a8a25bd9c593c6985107f90f999ce0b08" title="wait for a command to be sent to PMAC before continuing">pmac_queue_cond</a>, NULL);
<a name="l02177"></a>02177 
<a name="l02178"></a>02178   <a class="code" href="lspmac_8c.html#a112158e0cd50449a440ac55c7af7bea2" title="State of the shutter, used to detect changes.">lspmac_shutter_state</a> = 0;                             <span class="comment">// assume the shutter is now closed: not a big deal if we are wrong</span>
<a name="l02179"></a>02179   pthread_mutex_init( &amp;<a class="code" href="lspmac_8c.html#a1b78a13c654409333569815e1c109d38" title="Coordinates threads reading shutter status.">lspmac_shutter_mutex</a>, NULL);
<a name="l02180"></a>02180   pthread_cond_init(  &amp;<a class="code" href="lspmac_8c.html#afbd51c2cefcee87afe994c9e9f372241" title="Allows waiting for the shutter status to change.">lspmac_shutter_cond</a>, NULL);
<a name="l02181"></a>02181   <a class="code" href="lspmac_8c.html#adba7f5f4bbeabc4dac859221d4c684ba" title="our poll structure">pmacfd</a>.fd = -1;
<a name="l02182"></a>02182 
<a name="l02183"></a>02183   pthread_mutex_init( &amp;<a class="code" href="lspmac_8c.html#a85679cac947e199c88794f8e5a12bf5f" title="Coordinate moving motors between threads.">lspmac_moving_mutex</a>, NULL);
<a name="l02184"></a>02184   pthread_cond_init(  &amp;<a class="code" href="lspmac_8c.html#a57547d211906c981ef20257eba99f8df" title="Wait for motor(s) to finish moving condition.">lspmac_moving_cond</a>, NULL);
<a name="l02185"></a>02185 
<a name="l02186"></a>02186 }
<a name="l02187"></a>02187 
<a name="l02190"></a><a class="code" href="pgpmac_8h.html#a3a7fb93fb3fb9c4454613f30bfb0b1ee">02190</a> <span class="keywordtype">void</span> <a class="code" href="lspmac_8c.html#a3a7fb93fb3fb9c4454613f30bfb0b1ee" title="Start up the lspmac thread.">lspmac_run</a>() {
<a name="l02191"></a>02191   pthread_create( &amp;<a class="code" href="lspmac_8c.html#a6b7011dd7d2c2d3afadff8d3e50e7677" title="our thread to manage access and communication to the pmac">pmac_thread</a>, NULL, <a class="code" href="lspmac_8c.html#abdec5883055967b1eda043670870f55f" title="Our lspmac worker thread.">lspmac_worker</a>, NULL);
<a name="l02192"></a>02192 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 14 Nov 2012 for LS-CAT PGPMAC by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
