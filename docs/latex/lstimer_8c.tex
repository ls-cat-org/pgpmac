\hypertarget{lstimer_8c}{\section{lstimer.\-c File Reference}
\label{lstimer_8c}\index{lstimer.\-c@{lstimer.\-c}}
}


Support for delayed and periodic events.  


{\ttfamily \#include \char`\"{}pgpmac.\-h\char`\"{}}\\*
\subsection*{Data Structures}
\begin{DoxyCompactItemize}
\item 
struct \hyperlink{structlstimer__list__struct}{lstimer\-\_\-list\-\_\-struct}
\begin{DoxyCompactList}\small\item\em Everything we need to know about a timer. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{lstimer_8c_af020a0f708e86162a32d2ca6373c96bb}{L\-S\-T\-I\-M\-E\-R\-\_\-\-L\-I\-S\-T\-\_\-\-L\-E\-N\-G\-T\-H}~1024
\begin{DoxyCompactList}\small\item\em We'll allow this many timers. This should be way more than enough. \end{DoxyCompactList}\item 
\#define \hyperlink{lstimer_8c_a602d98fa617eb9f4ab49e4b9c7f5d4d9}{L\-S\-T\-I\-M\-E\-R\-\_\-\-R\-E\-S\-O\-L\-U\-T\-I\-O\-N\-\_\-\-N\-S\-E\-C\-S}~100000
\begin{DoxyCompactList}\small\item\em times within this amount in the future are considered \char`\"{}now\char`\"{} and the events should be called \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Typedefs}
\begin{DoxyCompactItemize}
\item 
typedef struct \hyperlink{structlstimer__list__struct}{lstimer\-\_\-list\-\_\-struct} \hyperlink{lstimer_8c_abae36af84be0a2f4529aa0424edc6fbf}{lstimer\-\_\-list\-\_\-t}
\begin{DoxyCompactList}\small\item\em Everything we need to know about a timer. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{lstimer_8c_a5738e4146b4691aad038b622b0381cac}{lstimer\-\_\-unset\-\_\-timer} (char $\ast$event)
\begin{DoxyCompactList}\small\item\em Unsets all timers for the given event. \end{DoxyCompactList}\item 
void \hyperlink{lstimer_8c_a7b3e725fbe1bb3cc9f8465941cf1e381}{lstimer\-\_\-set\-\_\-timer} (char $\ast$event, int shots, unsigned long int secs, unsigned long int nsecs)
\begin{DoxyCompactList}\small\item\em Create a timer. \end{DoxyCompactList}\item 
static void \hyperlink{lstimer_8c_a7796321359df34cb827ffa51bbc44e9c}{service\-\_\-timers} ()
\begin{DoxyCompactList}\small\item\em Send events that are past due, due, or just about to be due. \end{DoxyCompactList}\item 
static void \hyperlink{lstimer_8c_afa91bbd2fdb257d80ad65a5ce8abb845}{handler} (int sig, siginfo\-\_\-t $\ast$si, void $\ast$dummy)
\begin{DoxyCompactList}\small\item\em Service the signal. \end{DoxyCompactList}\item 
static void $\ast$ \hyperlink{lstimer_8c_ab8b409bb2a7ff78da22d988cfb3b537a}{lstimer\-\_\-worker} (void $\ast$dummy)
\begin{DoxyCompactList}\small\item\em Our worker. \end{DoxyCompactList}\item 
void \hyperlink{lstimer_8c_a8cd37a8fb0f061456456a5d79bdd5189}{lstimer\-\_\-init} ()
\begin{DoxyCompactList}\small\item\em Initialize the timer list and pthread stuff. \end{DoxyCompactList}\item 
void \hyperlink{lstimer_8c_a0b918acc1a4bf737cb62b5a70f8b553a}{lstimer\-\_\-run} ()
\begin{DoxyCompactList}\small\item\em Start up our thread. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
static int \hyperlink{lstimer_8c_a1a47dadbec1776920ab83409234c1833}{lstimer\-\_\-active\-\_\-timers} = 0
\begin{DoxyCompactList}\small\item\em count of the number timers we are tracking \end{DoxyCompactList}\item 
static \hyperlink{lstimer_8c_abae36af84be0a2f4529aa0424edc6fbf}{lstimer\-\_\-list\-\_\-t} \hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\-\_\-list} \mbox{[}\hyperlink{lstimer_8c_af020a0f708e86162a32d2ca6373c96bb}{L\-S\-T\-I\-M\-E\-R\-\_\-\-L\-I\-S\-T\-\_\-\-L\-E\-N\-G\-T\-H}\mbox{]}
\begin{DoxyCompactList}\small\item\em Our timer list. \end{DoxyCompactList}\item 
static pthread\-\_\-t \hyperlink{lstimer_8c_a76660e8720b08f4adee2be9f44b5f419}{lstimer\-\_\-thread}
\begin{DoxyCompactList}\small\item\em the timer thread \end{DoxyCompactList}\item 
static pthread\-\_\-mutex\-\_\-t \hyperlink{lstimer_8c_a170993cbed9b9ec8bc64b6642a3ed581}{lstimer\-\_\-mutex}
\begin{DoxyCompactList}\small\item\em protect the timer list \end{DoxyCompactList}\item 
static pthread\-\_\-cond\-\_\-t \hyperlink{lstimer_8c_a96b7516e4a15c4b879de82a569cd5f0a}{lstimer\-\_\-cond}
\begin{DoxyCompactList}\small\item\em allows us to be idle when there is nothing to do \end{DoxyCompactList}\item 
static timer\-\_\-t \hyperlink{lstimer_8c_a3394b0c23c3c962dc15cb88499f4358c}{lstimer\-\_\-timerid}
\begin{DoxyCompactList}\small\item\em our real time timer \end{DoxyCompactList}\item 
static int \hyperlink{lstimer_8c_a5a3c6ef3507448d284d91958878d3f75}{new\-\_\-timer} = 0
\begin{DoxyCompactList}\small\item\em indicate that a new timer exists and a call to service\-\_\-timers is required \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Detailed Description}
Support for delayed and periodic events. \begin{DoxyDate}{Date}
2012 
\end{DoxyDate}
\begin{DoxyAuthor}{Author}
Keith Brister 
\end{DoxyAuthor}
\begin{DoxyCopyright}{Copyright}
All Rights Reserved 
\end{DoxyCopyright}


Definition in file \hyperlink{lstimer_8c_source}{lstimer.\-c}.



\subsection{Macro Definition Documentation}
\hypertarget{lstimer_8c_af020a0f708e86162a32d2ca6373c96bb}{\index{lstimer.\-c@{lstimer.\-c}!L\-S\-T\-I\-M\-E\-R\-\_\-\-L\-I\-S\-T\-\_\-\-L\-E\-N\-G\-T\-H@{L\-S\-T\-I\-M\-E\-R\-\_\-\-L\-I\-S\-T\-\_\-\-L\-E\-N\-G\-T\-H}}
\index{L\-S\-T\-I\-M\-E\-R\-\_\-\-L\-I\-S\-T\-\_\-\-L\-E\-N\-G\-T\-H@{L\-S\-T\-I\-M\-E\-R\-\_\-\-L\-I\-S\-T\-\_\-\-L\-E\-N\-G\-T\-H}!lstimer.c@{lstimer.\-c}}
\subsubsection[{L\-S\-T\-I\-M\-E\-R\-\_\-\-L\-I\-S\-T\-\_\-\-L\-E\-N\-G\-T\-H}]{\setlength{\rightskip}{0pt plus 5cm}\#define L\-S\-T\-I\-M\-E\-R\-\_\-\-L\-I\-S\-T\-\_\-\-L\-E\-N\-G\-T\-H~1024}}\label{lstimer_8c_af020a0f708e86162a32d2ca6373c96bb}


We'll allow this many timers. This should be way more than enough. 



Definition at line 11 of file lstimer.\-c.

\hypertarget{lstimer_8c_a602d98fa617eb9f4ab49e4b9c7f5d4d9}{\index{lstimer.\-c@{lstimer.\-c}!L\-S\-T\-I\-M\-E\-R\-\_\-\-R\-E\-S\-O\-L\-U\-T\-I\-O\-N\-\_\-\-N\-S\-E\-C\-S@{L\-S\-T\-I\-M\-E\-R\-\_\-\-R\-E\-S\-O\-L\-U\-T\-I\-O\-N\-\_\-\-N\-S\-E\-C\-S}}
\index{L\-S\-T\-I\-M\-E\-R\-\_\-\-R\-E\-S\-O\-L\-U\-T\-I\-O\-N\-\_\-\-N\-S\-E\-C\-S@{L\-S\-T\-I\-M\-E\-R\-\_\-\-R\-E\-S\-O\-L\-U\-T\-I\-O\-N\-\_\-\-N\-S\-E\-C\-S}!lstimer.c@{lstimer.\-c}}
\subsubsection[{L\-S\-T\-I\-M\-E\-R\-\_\-\-R\-E\-S\-O\-L\-U\-T\-I\-O\-N\-\_\-\-N\-S\-E\-C\-S}]{\setlength{\rightskip}{0pt plus 5cm}\#define L\-S\-T\-I\-M\-E\-R\-\_\-\-R\-E\-S\-O\-L\-U\-T\-I\-O\-N\-\_\-\-N\-S\-E\-C\-S~100000}}\label{lstimer_8c_a602d98fa617eb9f4ab49e4b9c7f5d4d9}


times within this amount in the future are considered \char`\"{}now\char`\"{} and the events should be called 



Definition at line 16 of file lstimer.\-c.



\subsection{Typedef Documentation}
\hypertarget{lstimer_8c_abae36af84be0a2f4529aa0424edc6fbf}{\index{lstimer.\-c@{lstimer.\-c}!lstimer\-\_\-list\-\_\-t@{lstimer\-\_\-list\-\_\-t}}
\index{lstimer\-\_\-list\-\_\-t@{lstimer\-\_\-list\-\_\-t}!lstimer.c@{lstimer.\-c}}
\subsubsection[{lstimer\-\_\-list\-\_\-t}]{\setlength{\rightskip}{0pt plus 5cm}typedef struct {\bf lstimer\-\_\-list\-\_\-struct}  {\bf lstimer\-\_\-list\-\_\-t}}}\label{lstimer_8c_abae36af84be0a2f4529aa0424edc6fbf}


Everything we need to know about a timer. 



\subsection{Function Documentation}
\hypertarget{lstimer_8c_afa91bbd2fdb257d80ad65a5ce8abb845}{\index{lstimer.\-c@{lstimer.\-c}!handler@{handler}}
\index{handler@{handler}!lstimer.c@{lstimer.\-c}}
\subsubsection[{handler}]{\setlength{\rightskip}{0pt plus 5cm}static void handler (
\begin{DoxyParamCaption}
\item[{int}]{sig, }
\item[{siginfo\-\_\-t $\ast$}]{si, }
\item[{void $\ast$}]{dummy}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{lstimer_8c_afa91bbd2fdb257d80ad65a5ce8abb845}


Service the signal. 



Definition at line 190 of file lstimer.\-c.


\begin{DoxyCode}
                                                          \{
  pthread\_mutex\_lock( &\hyperlink{lstimer_8c_a170993cbed9b9ec8bc64b6642a3ed581}{lstimer\_mutex});
  \hyperlink{lstimer_8c_a7796321359df34cb827ffa51bbc44e9c}{service\_timers}();
  pthread\_mutex\_unlock( &\hyperlink{lstimer_8c_a170993cbed9b9ec8bc64b6642a3ed581}{lstimer\_mutex});
\}
\end{DoxyCode}
\hypertarget{lstimer_8c_a8cd37a8fb0f061456456a5d79bdd5189}{\index{lstimer.\-c@{lstimer.\-c}!lstimer\-\_\-init@{lstimer\-\_\-init}}
\index{lstimer\-\_\-init@{lstimer\-\_\-init}!lstimer.c@{lstimer.\-c}}
\subsubsection[{lstimer\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}void lstimer\-\_\-init (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{lstimer_8c_a8cd37a8fb0f061456456a5d79bdd5189}


Initialize the timer list and pthread stuff. 



Definition at line 270 of file lstimer.\-c.


\begin{DoxyCode}
                    \{
  \textcolor{keywordtype}{int} \hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i};

  \textcolor{keywordflow}{for}( i=0; i<\hyperlink{lstimer_8c_af020a0f708e86162a32d2ca6373c96bb}{LSTIMER\_LIST\_LENGTH}; i++) \{
    \hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\_list}[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}].\hyperlink{structlstimer__list__struct_ac7ab4cd1f3065156f95b49e66bf05283}{shots} = 0;
  \}


  pthread\_mutex\_init( &\hyperlink{lstimer_8c_a170993cbed9b9ec8bc64b6642a3ed581}{lstimer\_mutex}, NULL);
  pthread\_cond\_init(  &\hyperlink{lstimer_8c_a96b7516e4a15c4b879de82a569cd5f0a}{lstimer\_cond}, NULL);
\}
\end{DoxyCode}
\hypertarget{lstimer_8c_a0b918acc1a4bf737cb62b5a70f8b553a}{\index{lstimer.\-c@{lstimer.\-c}!lstimer\-\_\-run@{lstimer\-\_\-run}}
\index{lstimer\-\_\-run@{lstimer\-\_\-run}!lstimer.c@{lstimer.\-c}}
\subsubsection[{lstimer\-\_\-run}]{\setlength{\rightskip}{0pt plus 5cm}void lstimer\-\_\-run (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{lstimer_8c_a0b918acc1a4bf737cb62b5a70f8b553a}


Start up our thread. 



Definition at line 284 of file lstimer.\-c.


\begin{DoxyCode}
                   \{
  pthread\_create( &\hyperlink{lstimer_8c_a76660e8720b08f4adee2be9f44b5f419}{lstimer\_thread}, NULL, \hyperlink{lstimer_8c_ab8b409bb2a7ff78da22d988cfb3b537a}{lstimer\_worker}
      , NULL);
\}
\end{DoxyCode}
\hypertarget{lstimer_8c_a7b3e725fbe1bb3cc9f8465941cf1e381}{\index{lstimer.\-c@{lstimer.\-c}!lstimer\-\_\-set\-\_\-timer@{lstimer\-\_\-set\-\_\-timer}}
\index{lstimer\-\_\-set\-\_\-timer@{lstimer\-\_\-set\-\_\-timer}!lstimer.c@{lstimer.\-c}}
\subsubsection[{lstimer\-\_\-set\-\_\-timer}]{\setlength{\rightskip}{0pt plus 5cm}void lstimer\-\_\-set\-\_\-timer (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{event, }
\item[{int}]{shots, }
\item[{unsigned long int}]{secs, }
\item[{unsigned long int}]{nsecs}
\end{DoxyParamCaption}
)}}\label{lstimer_8c_a7b3e725fbe1bb3cc9f8465941cf1e381}


Create a timer. 


\begin{DoxyParams}{Parameters}
{\em event} & Name of the event to send when the timer goes off \\
\hline
{\em shots} & Number of times to run. 0 means never, -\/1 means forever \\
\hline
{\em secs} & Number of seconds to wait \\
\hline
{\em nsecs} & Number of nano-\/seconds to run in addition to secs \\
\hline
\end{DoxyParams}


Definition at line 63 of file lstimer.\-c.


\begin{DoxyCode}
                                                                               
                        \{
  \textcolor{keywordtype}{int} \hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i};
  \textcolor{keyword}{struct }timespec \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now};

  \textcolor{comment}{// Time we were called.  Delay is based on call time, not queued time}
  \textcolor{comment}{//}
  clock\_gettime( CLOCK\_REALTIME, &\hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now});
  

  \textcolor{comment}{// Make sure our event is registered (saves a tiny bit of time later)}
  \textcolor{comment}{//}
  \hyperlink{lsevents_8c_ae09cfa92dba806d8f8808e5822ea713c}{lsevents\_preregister\_event}( event);

  pthread\_mutex\_lock( &\hyperlink{lstimer_8c_a170993cbed9b9ec8bc64b6642a3ed581}{lstimer\_mutex});

  \textcolor{keywordflow}{for}( i=0; i<\hyperlink{lstimer_8c_af020a0f708e86162a32d2ca6373c96bb}{LSTIMER\_LIST\_LENGTH}; i++) \{
    \textcolor{keywordflow}{if}( \hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\_list}[i].shots == 0)
      \textcolor{keywordflow}{break};
  \}

  \textcolor{keywordflow}{if}( i == LSTIMER\_LIST\_LENGTH) \{
    pthread\_mutex\_unlock( &\hyperlink{lstimer_8c_a170993cbed9b9ec8bc64b6642a3ed581}{lstimer\_mutex});
    
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"lstimer\_set\_timer: out of
       timers for event: %s, shots: %d,  secs: %u, nsecs: %u"},
                          event, shots, secs, nsecs);
    \textcolor{keywordflow}{return};
  \}

  strncpy( \hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\_list}[i].event, event, \hyperlink{pgpmac_8h_ab61d790b5572f116e091babfda53627b}{LSEVENTS\_EVENT\_LENGTH}
       - 1);
  \hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\_list}[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}].\hyperlink{structlstimer__list__struct_a54d564e392315b2730278bb925803184}{event}[\hyperlink{pgpmac_8h_ab61d790b5572f116e091babfda53627b}{LSEVENTS\_EVENT\_LENGTH}
       - 1] = 0;
  \hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\_list}[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}].\hyperlink{structlstimer__list__struct_ac7ab4cd1f3065156f95b49e66bf05283}{shots}        = shots;
  \hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\_list}[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}].\hyperlink{structlstimer__list__struct_aa5eac664fe8159916bc3cdfbf583f818}{delay\_secs}   = secs;
  \hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\_list}[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}].\hyperlink{structlstimer__list__struct_a45e9fc0b669a1b2831d46b465822344c}{delay\_nsecs}  = nsecs;

  \hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\_list}[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}].\hyperlink{structlstimer__list__struct_a6a7538fafa77c5769c8dd2bdd34500b7}{next\_secs}    = secs + \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_sec + (
      \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_nsec + nsecs) / 1000000000;
  \hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\_list}[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}].\hyperlink{structlstimer__list__struct_acf993c87ab0ee8ffd74c3907022d6996}{next\_nsecs}   = (\hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_nsec + nsecs
      ) % 1000000000;
  \hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\_list}[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}].\hyperlink{structlstimer__list__struct_a8f881e66431efbed84b6ad029757bc67}{last\_secs}    = 0;
  \hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\_list}[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}].\hyperlink{structlstimer__list__struct_a0b2ab04246481397116ac9770c3c6603}{last\_nsecs}   = 0;
  
  \hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\_list}[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}].\hyperlink{structlstimer__list__struct_aa56c5b8ce7fa0ae93132cb9908195836}{ncalls}       = 0;
  \hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\_list}[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}].\hyperlink{structlstimer__list__struct_a9633d830ecdce7852530079bb09a6d3c}{init\_secs}    = \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_sec;
  \hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\_list}[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}].\hyperlink{structlstimer__list__struct_a72665e0a227b5ee0c82aee43dfaf440a}{init\_nsecs}   = \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_nsec;

  \textcolor{keywordflow}{if}( shots != 0) \{
    \hyperlink{lstimer_8c_a1a47dadbec1776920ab83409234c1833}{lstimer\_active\_timers}++;
    \hyperlink{lstimer_8c_a5a3c6ef3507448d284d91958878d3f75}{new\_timer}++;
  \}

  pthread\_cond\_signal(  &\hyperlink{lstimer_8c_a96b7516e4a15c4b879de82a569cd5f0a}{lstimer\_cond});
  pthread\_mutex\_unlock( &\hyperlink{lstimer_8c_a170993cbed9b9ec8bc64b6642a3ed581}{lstimer\_mutex});
\}
\end{DoxyCode}
\hypertarget{lstimer_8c_a5738e4146b4691aad038b622b0381cac}{\index{lstimer.\-c@{lstimer.\-c}!lstimer\-\_\-unset\-\_\-timer@{lstimer\-\_\-unset\-\_\-timer}}
\index{lstimer\-\_\-unset\-\_\-timer@{lstimer\-\_\-unset\-\_\-timer}!lstimer.c@{lstimer.\-c}}
\subsubsection[{lstimer\-\_\-unset\-\_\-timer}]{\setlength{\rightskip}{0pt plus 5cm}void lstimer\-\_\-unset\-\_\-timer (
\begin{DoxyParamCaption}
\item[{char $\ast$}]{event}
\end{DoxyParamCaption}
)}}\label{lstimer_8c_a5738e4146b4691aad038b622b0381cac}


Unsets all timers for the given event. 



Definition at line 46 of file lstimer.\-c.


\begin{DoxyCode}
                                       \{
  \textcolor{keywordtype}{int} \hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i};

  \textcolor{keywordflow}{for}( i=0; i<\hyperlink{lstimer_8c_af020a0f708e86162a32d2ca6373c96bb}{LSTIMER\_LIST\_LENGTH}; i++) \{
    \textcolor{keywordflow}{if}( strcmp( event, \hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\_list}[i].event) == 0) \{
      \hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\_list}[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}].\hyperlink{structlstimer__list__struct_ac7ab4cd1f3065156f95b49e66bf05283}{shots} = 0;
    \}
  \}
\}
\end{DoxyCode}
\hypertarget{lstimer_8c_ab8b409bb2a7ff78da22d988cfb3b537a}{\index{lstimer.\-c@{lstimer.\-c}!lstimer\-\_\-worker@{lstimer\-\_\-worker}}
\index{lstimer\-\_\-worker@{lstimer\-\_\-worker}!lstimer.c@{lstimer.\-c}}
\subsubsection[{lstimer\-\_\-worker}]{\setlength{\rightskip}{0pt plus 5cm}static void$\ast$ lstimer\-\_\-worker (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{dummy}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{lstimer_8c_ab8b409bb2a7ff78da22d988cfb3b537a}


Our worker. 

The main loop runs when a new timer is added. The service routine deals with maintenance. 
\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em dummy} & required by protocol \\
\hline
\end{DoxyParams}


Definition at line 200 of file lstimer.\-c.


\begin{DoxyCode}
                       \{
  \textcolor{keyword}{struct }sigevent  sev;
  \textcolor{keyword}{struct }sigaction sa;
  sigset\_t mask;

  \textcolor{comment}{// See example at
       http://www.kernel.org/doc/man-pages/online/pages/man2/timer\_create.2.html}
  \textcolor{comment}{//}

  \textcolor{comment}{// Set up hander}
  \textcolor{comment}{//}
  sa.sa\_flags = SA\_SIGINFO;
  sa.sa\_sigaction = \hyperlink{lstimer_8c_afa91bbd2fdb257d80ad65a5ce8abb845}{handler};
  sigemptyset(&sa.sa\_mask);
  \textcolor{keywordflow}{if} (sigaction(SIGRTMIN, &sa, NULL) == -1) \{
    \hyperlink{lslogging_8c_a0e756b36671055ef02a8f04d2ba8a93b}{lslogging\_log\_message}( \textcolor{stringliteral}{"lstimer\_worker: sigaction
       failed"});
    exit( -1);
  \}

  \textcolor{comment}{// Create the timer}
  \textcolor{comment}{//}
  sev.sigev\_notify = SIGEV\_SIGNAL;
  sev.sigev\_signo  = SIGRTMIN;
  sev.sigev\_value.sival\_ptr = &\hyperlink{lstimer_8c_a3394b0c23c3c962dc15cb88499f4358c}{lstimer\_timerid};
  timer\_create( CLOCK\_REALTIME, &sev, &\hyperlink{lstimer_8c_a3394b0c23c3c962dc15cb88499f4358c}{lstimer\_timerid});


  \textcolor{comment}{// Block timer signal for now since we really }
  \textcolor{comment}{// want to be sure we do not own a lock on the timer mutex}
  \textcolor{comment}{// while servicing the signal}
  \textcolor{comment}{//}
  sigemptyset( &mask);
  sigaddset( &mask, SIGRTMIN);
  
  \textcolor{keywordflow}{while}( 1) \{
    pthread\_mutex\_lock( &\hyperlink{lstimer_8c_a170993cbed9b9ec8bc64b6642a3ed581}{lstimer\_mutex});

    \textcolor{keywordflow}{while}( \hyperlink{lstimer_8c_a5a3c6ef3507448d284d91958878d3f75}{new\_timer} == 0)
      pthread\_cond\_wait( &\hyperlink{lstimer_8c_a96b7516e4a15c4b879de82a569cd5f0a}{lstimer\_cond}, &\hyperlink{lstimer_8c_a170993cbed9b9ec8bc64b6642a3ed581}{lstimer\_mutex}
      );

    \textcolor{comment}{// ignore signals so we don't service the signal while we are already in
       the}
    \textcolor{comment}{// service routine}
    \textcolor{comment}{//}
    sigprocmask( SIG\_SETMASK, &mask, NULL);
    

    \textcolor{comment}{//}
    \textcolor{comment}{// Setting up the timer interval is in the handler}
    \textcolor{comment}{// so just call it}
    \textcolor{comment}{//}
    \hyperlink{lstimer_8c_a7796321359df34cb827ffa51bbc44e9c}{service\_timers}();

    \textcolor{comment}{//}
    \textcolor{comment}{// Reset our flag}
    \textcolor{comment}{//}
    \hyperlink{lstimer_8c_a5a3c6ef3507448d284d91958878d3f75}{new\_timer} = 0;

    pthread\_mutex\_unlock( &\hyperlink{lstimer_8c_a170993cbed9b9ec8bc64b6642a3ed581}{lstimer\_mutex});


    \textcolor{comment}{// Let the signals rain down}
    \textcolor{comment}{//}
    sigprocmask( SIG\_UNBLOCK, &mask, NULL);
  \}
\}
\end{DoxyCode}
\hypertarget{lstimer_8c_a7796321359df34cb827ffa51bbc44e9c}{\index{lstimer.\-c@{lstimer.\-c}!service\-\_\-timers@{service\-\_\-timers}}
\index{service\-\_\-timers@{service\-\_\-timers}!lstimer.c@{lstimer.\-c}}
\subsubsection[{service\-\_\-timers}]{\setlength{\rightskip}{0pt plus 5cm}static void service\-\_\-timers (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{lstimer_8c_a7796321359df34cb827ffa51bbc44e9c}


Send events that are past due, due, or just about to be due. 



Definition at line 118 of file lstimer.\-c.


\begin{DoxyCode}
                             \{
  \textcolor{keywordtype}{int}
    \hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i},
    found\_active;

  \hyperlink{structlstimer__list__struct}{lstimer\_list\_t} *\hyperlink{namespacemk__pgpmac__redis_a11daf2847f2dc94562b5b61b3f412574}{p};
  \textcolor{keyword}{struct }timespec \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}, then, soonest;
  \textcolor{keyword}{struct }itimerspec its;

  \textcolor{comment}{//}
  \textcolor{comment}{// Did I remind you not to let this thread own the lstimer mutex outside of
       this}
  \textcolor{comment}{// service routine when SIGRTMIN is active?}
  \textcolor{comment}{//}

  \textcolor{comment}{// Call with lstimer\_mutex locked}

  clock\_gettime( CLOCK\_REALTIME, &\hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now});
  \textcolor{comment}{//}
  \textcolor{comment}{// Project a tad into the future}
  then.tv\_sec  = \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_sec + (\hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_nsec + \hyperlink{lstimer_8c_a602d98fa617eb9f4ab49e4b9c7f5d4d9}{LSTIMER\_RESOLUTION\_NSECS}
      ) / 1000000000;
  then.tv\_nsec = (\hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_nsec + \hyperlink{lstimer_8c_a602d98fa617eb9f4ab49e4b9c7f5d4d9}{LSTIMER\_RESOLUTION\_NSECS}
      ) % 1000000000;

  found\_active = 0;
  \textcolor{keywordflow}{for}( i=0; i<\hyperlink{lstimer_8c_a1a47dadbec1776920ab83409234c1833}{lstimer\_active\_timers}; i++) \{
    p = &(\hyperlink{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{lstimer\_list}[\hyperlink{namespacemk__pgpmac__redis_afa643a23a5984fe44c2182ada3dfa401}{i}]);
    \textcolor{keywordflow}{if}( p->\hyperlink{structlstimer__list__struct_ac7ab4cd1f3065156f95b49e66bf05283}{shots} != 0) \{
      found\_active++;
      \textcolor{keywordflow}{if}(  p->\hyperlink{structlstimer__list__struct_a6a7538fafa77c5769c8dd2bdd34500b7}{next\_secs} < then.tv\_sec || (p->\hyperlink{structlstimer__list__struct_a6a7538fafa77c5769c8dd2bdd34500b7}{next\_secs} == 
      then.tv\_sec && p->\hyperlink{structlstimer__list__struct_acf993c87ab0ee8ffd74c3907022d6996}{next\_nsecs} <= then.tv\_nsec)) \{
        \hyperlink{lsevents_8c_a5c6f122382dea3dcc231b772e5e75b46}{lsevents\_send\_event}( p->\hyperlink{structlstimer__list__struct_a54d564e392315b2730278bb925803184}{event});
        \textcolor{comment}{//}
        \textcolor{comment}{// After sending the event, compute the next time we need to do this}
        \textcolor{comment}{//}
        p->\hyperlink{structlstimer__list__struct_a8f881e66431efbed84b6ad029757bc67}{last\_secs}  = \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_sec;
        p->\hyperlink{structlstimer__list__struct_a0b2ab04246481397116ac9770c3c6603}{last\_nsecs} = \hyperlink{lspg_8c_ad40ac52086f6b774928af45b09d54c6e}{now}.tv\_nsec;
        p->\hyperlink{structlstimer__list__struct_aa56c5b8ce7fa0ae93132cb9908195836}{ncalls}++;
        \textcolor{comment}{//}
        \textcolor{comment}{// Decrement non-infinite loops}
        \textcolor{keywordflow}{if}( p->\hyperlink{structlstimer__list__struct_ac7ab4cd1f3065156f95b49e66bf05283}{shots} != -1)
          p->\hyperlink{structlstimer__list__struct_ac7ab4cd1f3065156f95b49e66bf05283}{shots}--;
        \textcolor{keywordflow}{if}( p->\hyperlink{structlstimer__list__struct_ac7ab4cd1f3065156f95b49e66bf05283}{shots} == 0) \{
          \textcolor{comment}{//}
          \textcolor{comment}{// Take this timer out of the mix}
          lstimer\_active\_timers--;
        \} \textcolor{keywordflow}{else} \{
          p->\hyperlink{structlstimer__list__struct_a6a7538fafa77c5769c8dd2bdd34500b7}{next\_secs}  = p->\hyperlink{structlstimer__list__struct_a9633d830ecdce7852530079bb09a6d3c}{init\_secs} + (p->\hyperlink{structlstimer__list__struct_aa56c5b8ce7fa0ae93132cb9908195836}{ncalls}+1) 
      * p->\hyperlink{structlstimer__list__struct_aa5eac664fe8159916bc3cdfbf583f818}{delay\_secs} + (p->\hyperlink{structlstimer__list__struct_a72665e0a227b5ee0c82aee43dfaf440a}{init\_nsecs} + (p->\hyperlink{structlstimer__list__struct_aa56c5b8ce7fa0ae93132cb9908195836}{ncalls}+1)*p->
      \hyperlink{structlstimer__list__struct_a45e9fc0b669a1b2831d46b465822344c}{delay\_nsecs})/1000000000;
          p->\hyperlink{structlstimer__list__struct_acf993c87ab0ee8ffd74c3907022d6996}{next\_nsecs} = (p->\hyperlink{structlstimer__list__struct_a72665e0a227b5ee0c82aee43dfaf440a}{init\_nsecs} + (p->\hyperlink{structlstimer__list__struct_aa56c5b8ce7fa0ae93132cb9908195836}{ncalls}
      +1)*p->\hyperlink{structlstimer__list__struct_a45e9fc0b669a1b2831d46b465822344c}{delay\_nsecs}) % 1000000000;
        \}
      \}

      \textcolor{keywordflow}{if}( found\_active == 1) \{
        soonest.tv\_sec  = p->\hyperlink{structlstimer__list__struct_a6a7538fafa77c5769c8dd2bdd34500b7}{next\_secs};
        soonest.tv\_nsec = p->\hyperlink{structlstimer__list__struct_acf993c87ab0ee8ffd74c3907022d6996}{next\_nsecs};
      \} \textcolor{keywordflow}{else} \{
        \textcolor{keywordflow}{if}( soonest.tv\_sec > p->\hyperlink{structlstimer__list__struct_a6a7538fafa77c5769c8dd2bdd34500b7}{next\_secs} || (soonest.tv\_sec == p->
      \hyperlink{structlstimer__list__struct_a6a7538fafa77c5769c8dd2bdd34500b7}{next\_secs} && soonest.tv\_nsec > p->\hyperlink{structlstimer__list__struct_acf993c87ab0ee8ffd74c3907022d6996}{next\_nsecs})) \{
          soonest.tv\_sec  = p->\hyperlink{structlstimer__list__struct_a6a7538fafa77c5769c8dd2bdd34500b7}{next\_secs};
          soonest.tv\_nsec = p->\hyperlink{structlstimer__list__struct_acf993c87ab0ee8ffd74c3907022d6996}{next\_nsecs};
        \}
      \}
    \}
  \}

  \textcolor{keywordflow}{if}( soonest.tv\_sec != 0) \{
    its.it\_value.tv\_sec     = soonest.tv\_sec;
    its.it\_value.tv\_nsec    = soonest.tv\_nsec;
    its.it\_interval.tv\_sec  = 0;
    its.it\_interval.tv\_nsec = 0;
    timer\_settime( \hyperlink{lstimer_8c_a3394b0c23c3c962dc15cb88499f4358c}{lstimer\_timerid}, TIMER\_ABSTIME, &its, NULL);
  \}
\}
\end{DoxyCode}


\subsection{Variable Documentation}
\hypertarget{lstimer_8c_a1a47dadbec1776920ab83409234c1833}{\index{lstimer.\-c@{lstimer.\-c}!lstimer\-\_\-active\-\_\-timers@{lstimer\-\_\-active\-\_\-timers}}
\index{lstimer\-\_\-active\-\_\-timers@{lstimer\-\_\-active\-\_\-timers}!lstimer.c@{lstimer.\-c}}
\subsubsection[{lstimer\-\_\-active\-\_\-timers}]{\setlength{\rightskip}{0pt plus 5cm}int lstimer\-\_\-active\-\_\-timers = 0\hspace{0.3cm}{\ttfamily [static]}}}\label{lstimer_8c_a1a47dadbec1776920ab83409234c1833}


count of the number timers we are tracking 



Definition at line 18 of file lstimer.\-c.

\hypertarget{lstimer_8c_a96b7516e4a15c4b879de82a569cd5f0a}{\index{lstimer.\-c@{lstimer.\-c}!lstimer\-\_\-cond@{lstimer\-\_\-cond}}
\index{lstimer\-\_\-cond@{lstimer\-\_\-cond}!lstimer.c@{lstimer.\-c}}
\subsubsection[{lstimer\-\_\-cond}]{\setlength{\rightskip}{0pt plus 5cm}pthread\-\_\-cond\-\_\-t lstimer\-\_\-cond\hspace{0.3cm}{\ttfamily [static]}}}\label{lstimer_8c_a96b7516e4a15c4b879de82a569cd5f0a}


allows us to be idle when there is nothing to do 



Definition at line 40 of file lstimer.\-c.

\hypertarget{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}{\index{lstimer.\-c@{lstimer.\-c}!lstimer\-\_\-list@{lstimer\-\_\-list}}
\index{lstimer\-\_\-list@{lstimer\-\_\-list}!lstimer.c@{lstimer.\-c}}
\subsubsection[{lstimer\-\_\-list}]{\setlength{\rightskip}{0pt plus 5cm}{\bf lstimer\-\_\-list\-\_\-t} lstimer\-\_\-list\mbox{[}{\bf L\-S\-T\-I\-M\-E\-R\-\_\-\-L\-I\-S\-T\-\_\-\-L\-E\-N\-G\-T\-H}\mbox{]}\hspace{0.3cm}{\ttfamily [static]}}}\label{lstimer_8c_a35b456765fe2c955cef445768d12ca6c}


Our timer list. 



Definition at line 36 of file lstimer.\-c.

\hypertarget{lstimer_8c_a170993cbed9b9ec8bc64b6642a3ed581}{\index{lstimer.\-c@{lstimer.\-c}!lstimer\-\_\-mutex@{lstimer\-\_\-mutex}}
\index{lstimer\-\_\-mutex@{lstimer\-\_\-mutex}!lstimer.c@{lstimer.\-c}}
\subsubsection[{lstimer\-\_\-mutex}]{\setlength{\rightskip}{0pt plus 5cm}pthread\-\_\-mutex\-\_\-t lstimer\-\_\-mutex\hspace{0.3cm}{\ttfamily [static]}}}\label{lstimer_8c_a170993cbed9b9ec8bc64b6642a3ed581}


protect the timer list 



Definition at line 39 of file lstimer.\-c.

\hypertarget{lstimer_8c_a76660e8720b08f4adee2be9f44b5f419}{\index{lstimer.\-c@{lstimer.\-c}!lstimer\-\_\-thread@{lstimer\-\_\-thread}}
\index{lstimer\-\_\-thread@{lstimer\-\_\-thread}!lstimer.c@{lstimer.\-c}}
\subsubsection[{lstimer\-\_\-thread}]{\setlength{\rightskip}{0pt plus 5cm}pthread\-\_\-t lstimer\-\_\-thread\hspace{0.3cm}{\ttfamily [static]}}}\label{lstimer_8c_a76660e8720b08f4adee2be9f44b5f419}


the timer thread 



Definition at line 38 of file lstimer.\-c.

\hypertarget{lstimer_8c_a3394b0c23c3c962dc15cb88499f4358c}{\index{lstimer.\-c@{lstimer.\-c}!lstimer\-\_\-timerid@{lstimer\-\_\-timerid}}
\index{lstimer\-\_\-timerid@{lstimer\-\_\-timerid}!lstimer.c@{lstimer.\-c}}
\subsubsection[{lstimer\-\_\-timerid}]{\setlength{\rightskip}{0pt plus 5cm}timer\-\_\-t lstimer\-\_\-timerid\hspace{0.3cm}{\ttfamily [static]}}}\label{lstimer_8c_a3394b0c23c3c962dc15cb88499f4358c}


our real time timer 



Definition at line 41 of file lstimer.\-c.

\hypertarget{lstimer_8c_a5a3c6ef3507448d284d91958878d3f75}{\index{lstimer.\-c@{lstimer.\-c}!new\-\_\-timer@{new\-\_\-timer}}
\index{new\-\_\-timer@{new\-\_\-timer}!lstimer.c@{lstimer.\-c}}
\subsubsection[{new\-\_\-timer}]{\setlength{\rightskip}{0pt plus 5cm}int new\-\_\-timer = 0\hspace{0.3cm}{\ttfamily [static]}}}\label{lstimer_8c_a5a3c6ef3507448d284d91958878d3f75}


indicate that a new timer exists and a call to service\-\_\-timers is required 



Definition at line 42 of file lstimer.\-c.

